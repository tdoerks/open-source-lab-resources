<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Workflow Tracker - Working Version</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #ddd;
            --header-bg: #ffffff;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --header-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        
        .header {
            background: var(--header-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            transition: background-color 0.3s;
        }

        .add-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .sample-list {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        input, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        button {
            padding: 8px 12px;
            margin: 5px;
            border: none;
            border-radius: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .sample-item {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 15px;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .sample-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sample-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .sample-item:hover::before {
            opacity: 1;
        }

        .sample-info {
            flex: 1;
        }

        .sample-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sample-actions button {
            padding: 8px 14px;
            font-size: 13px;
            border-radius: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sample-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-received { background: #e9ecef; color: #495057; }
        .status-bap-in-progress { background: #fff9c4; color: #f57f17; font-weight: bold; }
        .status-bap-complete { background: #d4edda; color: #155724; }
        .status-tsb-in-progress { background: #ffe0b2; color: #e65100; font-weight: bold; }
        .status-tsb-complete { background: #fff3cd; color: #856404; }
        .status-extraction-complete { background: #f3e5f5; color: #7b1fa2; }
        .status-clean-extraction-complete { background: #e8f5e8; color: #2e7d32; }
        .status-indexing-complete { background: #e3f2fd; color: #1976d2; }
        .status-qubit-complete { background: #fff3e0; color: #f57c00; }
        .status-clean-extraction-qubit-complete { background: #e8f4fd; color: #1565c0; }
        .status-qc-failed { background: #f8d7da; color: #721c24; font-weight: bold; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .btn-cancel {
            background: #6c757d;
        }

        kbd {
            display: inline-block;
            padding: 3px 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            line-height: 1.4;
            color: #333;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), inset 0 0 0 2px #fff;
            white-space: nowrap;
        }

        /* Sidebar Navigation Styles */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar.collapsed {
            display: none;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }

        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-nav {
            padding: 10px 0;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section-title {
            padding: 10px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
            padding-left: 25px;
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #3498db;
        }

        .nav-icon {
            font-size: 18px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .main-content {
            margin-left: 260px;
            flex: 1;
            transition: margin-left 0.3s ease;
            padding: 10px 25px;
            min-height: 100vh;
            max-width: 100%;
            width: 100%;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .hamburger-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .hamburger-btn:hover {
            background: #2980b9;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-260px);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            min-width: 150px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .bar-wrapper {
            flex: 1;
            height: 30px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-date {
            min-width: 120px;
            font-weight: bold;
            color: var(--text-secondary);
            padding-right: 20px;
            text-align: right;
        }

        .timeline-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid var(--bg-secondary);
            position: relative;
            flex-shrink: 0;
            margin: 0 20px;
            z-index: 1;
        }

        .timeline-marker::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 50px;
            background: #ddd;
        }

        .timeline-item:last-child .timeline-marker::before {
            display: none;
        }

        .timeline-content {
            flex: 1;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .timeline-content h4 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .timeline-content p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .timeline-stage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Kanban Pipeline View Styles */
        .kanban-column {
            min-width: 280px;
            max-width: 320px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .kanban-column:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .kanban-header {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-count {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .kanban-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        .kanban-card-header {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-card-meta {
            font-size: 11px;
            color: #6c757d;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .kanban-card-meta span {
            background: #f1f3f5;
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* Plate Map Styles */
        .plate-map {
            display: inline-block;
            border: 2px solid #333;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .plate-map table {
            border-collapse: collapse;
            font-size: 10px;
        }

        .plate-map th, .plate-map td {
            width: 40px;
            height: 40px;
            border: 1px solid #999;
            text-align: center;
            vertical-align: middle;
            padding: 2px;
            position: relative;
        }

        .plate-map th {
            background: #e9ecef;
            font-weight: bold;
        }

        .plate-map td {
            background: #f8f9fa;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .plate-map td:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .plate-map .well-occupied {
            background: #d4edda;
            font-weight: bold;
        }

        .plate-map .well-id {
            display: block;
            font-size: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .batch-controls {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }
        
        .batch-controls h4 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .sample-checkbox {
            margin-right: 8px;
        }
        
        .btn-batch {
            background: #ff9800;
            color: white;
        }
        
        .btn-batch:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Dropdown Menu Styles */
        .dropdown-menu button:hover {
            background: #f8f9fa !important;
        }

        .dropdown-menu button:last-child {
            border-bottom: none !important;
        }

        .menu-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .menu-btn:active {
            transform: translateY(0);
        }

        /* Print Stylesheet */
        @media print {
            /* Hide interactive elements */
            .add-section,
            button,
            input[type="text"],
            input[type="radio"],
            select,
            #searchInput,
            .modal,
            #quickStats,
            .close-btn {
                display: none !important;
            }

            /* Page setup */
            body {
                background: white;
                margin: 0;
                padding: 10mm;
                font-size: 11pt;
            }

            /* Header formatting */
            .header {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 18pt;
                margin: 0;
            }

            /* Dashboard cards - show as text */
            .dashboard-grid {
                display: block !important;
                margin-bottom: 20px;
            }

            .dashboard-card {
                display: inline-block;
                width: auto;
                margin-right: 20px;
                padding: 5px 10px;
                border: 1px solid #333;
                page-break-inside: avoid;
            }

            /* Sample list formatting */
            .sample-list {
                padding: 0;
                border: none;
            }

            .sample-item {
                border: 1px solid #333;
                margin-bottom: 10px;
                padding: 10px;
                page-break-inside: avoid;
                display: block !important;
            }

            /* Sample details */
            .sample-item strong {
                font-size: 12pt;
            }

            .status {
                border: 1px solid #333 !important;
                background: white !important;
                color: #000 !important;
                padding: 2px 5px;
            }

            /* Compact layout for sample details */
            .sample-item br {
                display: none;
            }

            .sample-item span {
                display: inline-block;
                margin-right: 15px;
            }

            /* Page breaks */
            h2, h3 {
                page-break-after: avoid;
            }

            /* Print timestamp */
            .header::after {
                content: "Printed: " attr(data-print-date);
                display: block;
                font-size: 9pt;
                color: #666;
                margin-top: 5px;
            }

            /* Ensure links show full URL */
            a[href]::after {
                content: " (" attr(href) ")";
            }
        }

        /* Print button - only show when not printing */
        @media screen {
            .print-btn {
                background: #17a2b8;
                margin-left: 5px;
            }

            .print-btn:hover {
                background: #138496;
            }
        }

        /* Drag and drop animations */
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .kanban-column.drag-over {
            background: #e3f2fd !important;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        .kanban-card[draggable="true"]:hover {
            cursor: move;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .kanban-card.dragging {
            opacity: 0.4;
        }

        /* Quick Actions Floating Toolbar */
        #quickActionsToolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 900;
            transition: all 0.3s;
        }

        #quickActionsToolbar.collapsed {
            padding: 12px 15px;
        }

        #quickActionsToolbar button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        #quickActionsToolbar button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #quickActionsToolbar button:active {
            transform: translateY(0);
        }

        #quickActionsToolbar .toggle-btn {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 50%;
            min-width: auto;
        }

        /* Auto-save indicator */
        #autoSaveIndicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
            font-size: 13px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s;
        }

        #autoSaveIndicator.show {
            opacity: 1;
            transform: translateX(0);
        }

        #autoSaveIndicator.saving {
            background: #ffc107;
        }

        #autoSaveIndicator.error {
            background: #dc3545;
        }

        /* Validation warning */
        .validation-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-warning::before {
            content: "‚ö†Ô∏è";
            font-size: 20px;
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #quickActionsToolbar {
                bottom: 10px;
                right: 10px;
                padding: 10px;
                flex-direction: column;
                border-radius: 20px;
            }

            #quickActionsToolbar button {
                width: 100%;
                padding: 10px;
            }

            .sample {
                font-size: 13px;
            }

            .sample-actions button {
                font-size: 11px !important;
                padding: 6px 10px !important;
            }

            .kanban-container {
                flex-direction: column;
            }

            .kanban-column {
                width: 100% !important;
                min-width: auto !important;
            }

            .sidebar {
                width: 100%;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .stats-panel {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }
        }

        /* Enhanced sample selection */
        .sample.selected {
            box-shadow: 0 0 0 3px #667eea;
            border-left-color: #667eea !important;
        }

        .sample input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Batch action bar */
        #batchActionBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.2);
            z-index: 950;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        #batchActionBar.show {
            transform: translateY(0);
        }

        #batchActionBar button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        #batchActionBar button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Continue to Next Stage button */
        .continue-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            padding: 6px 12px !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            margin-top: 6px !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
            transition: all 0.2s !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            justify-content: center !important;
        }

        .continue-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
        }

        .continue-btn:active {
            transform: translateY(0) !important;
        }

        .continue-btn::after {
            content: "‚Üí";
            font-size: 14px;
            font-weight: bold;
        }

        /* Work Queue Cards */
        .work-queue-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .work-queue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .work-queue-card.urgent {
            border-left-color: #dc3545;
        }

        .work-queue-card.ready {
            border-left-color: #28a745;
        }

        .work-queue-card.waiting {
            border-left-color: #ffc107;
        }

        .work-queue-card.overdue {
            border-left-color: #fd7e14;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .work-queue-number {
            font-size: 32px;
            font-weight: 800;
            color: #333;
            line-height: 1;
            margin-bottom: 5px;
        }

        .work-queue-label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .work-queue-action {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .work-queue-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Main Application Content -->
    <div id="appContent" class="app-container" style="display: block;">

        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üß™ Bacterial Isolation LIMS</h2>
                <button class="sidebar-toggle" onclick="toggleSidebar()">‚úï</button>
            </div>

            <!-- Module Switcher -->
            <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Module</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button id="foodTestingModuleBtn" onclick="switchModule('food-testing')" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">
                        ü•© Food Testing
                    </button>
                    <button id="sequencingModuleBtn" onclick="switchModule('sequencing')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(102,126,234,0.4); transition: all 0.2s;">
                        üß¨ Sequencing
                    </button>
                </div>
            </div>

            <div class="sidebar-nav">
                <!-- Main Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item active" onclick="scrollToSection('samples')">
                        <span class="nav-icon">üß¨</span>
                        <span>Samples</span>
                    </div>
                    <div class="nav-item" onclick="scrollToSection('addSamples')">
                        <span class="nav-icon">‚ûï</span>
                        <span>Add Samples</span>
                    </div>
                </div>

                <!-- Lab Management -->
                <div class="nav-section">
                    <div class="nav-section-title">Lab Management</div>
                    <div class="nav-item" onclick="showInventory()">
                        <span class="nav-icon">üì¶</span>
                        <span>Inventory</span>
                    </div>
                    <div class="nav-item" onclick="showEquipmentLog()">
                        <span class="nav-icon">üîß</span>
                        <span>Equipment Log</span>
                    </div>
                    <div class="nav-item" onclick="showProtocolLibrary()">
                        <span class="nav-icon">üìö</span>
                        <span>Protocols</span>
                    </div>
                    <div class="nav-item" onclick="showReagentTemplates()">
                        <span class="nav-icon">üìã</span>
                        <span>Reagent Templates</span>
                    </div>
                </div>

                <!-- Analytics & Reports -->
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <div class="nav-item" onclick="showAnalytics()">
                        <span class="nav-icon">üìà</span>
                        <span>Analytics</span>
                    </div>
                    <div class="nav-item" onclick="showWeeklyReport()">
                        <span class="nav-icon">üìä</span>
                        <span>Weekly Summary</span>
                    </div>
                    <div class="nav-item" onclick="showTechDashboard()">
                        <span class="nav-icon">üë•</span>
                        <span>Tech Performance</span>
                    </div>
                </div>

                <!-- Search & Tools -->
                <div class="nav-section">
                    <div class="nav-section-title">Search & Tools</div>
                    <div class="nav-item" onclick="showReagentSearch()">
                        <span class="nav-icon">üî¨</span>
                        <span>Reagent Search</span>
                    </div>
                    <div class="nav-item" onclick="showAdvancedSearch()">
                        <span class="nav-icon">üîé</span>
                        <span>Advanced Search</span>
                    </div>
                    <div class="nav-item" onclick="showTimeline()">
                        <span class="nav-icon">üìÖ</span>
                        <span>Timeline</span>
                    </div>
                    <div class="nav-item" onclick="showPlateMap()">
                        <span class="nav-icon">üß´</span>
                        <span>Plate Map</span>
                    </div>
                    <div class="nav-item" onclick="showPrintLabels()">
                        <span class="nav-icon">üè∑Ô∏è</span>
                        <span>Print Labels</span>
                    </div>
                </div>

                <!-- Data -->
                <div class="nav-section">
                    <div class="nav-section-title">Data</div>
                    <div class="nav-item" onclick="exportData()">
                        <span class="nav-icon">üì•</span>
                        <span>Export JSON</span>
                    </div>
                    <div class="nav-item" onclick="exportCSV()">
                        <span class="nav-icon">üìä</span>
                        <span>Export CSV</span>
                    </div>
                    <div class="nav-item" onclick="importData()">
                        <span class="nav-icon">üì§</span>
                        <span>Import Data</span>
                    </div>
                    <div class="nav-item" onclick="window.print()">
                        <span class="nav-icon">üñ®Ô∏è</span>
                        <span>Print</span>
                    </div>
                </div>

                <!-- Settings -->
                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <div class="nav-item" onclick="showKeyboardShortcuts()">
                        <span class="nav-icon">‚å®Ô∏è</span>
                        <span>Shortcuts</span>
                    </div>
                    <div class="nav-item" onclick="undo()">
                        <span class="nav-icon">‚Ü∂</span>
                        <span>Undo</span>
                    </div>
                    <div class="nav-item" onclick="toggleDarkMode()">
                        <span class="nav-icon" id="themeIcon">üåô</span>
                        <span id="themeText">Dark Mode</span>
                    </div>
                    <div class="nav-item" onclick="logout()" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                        <span class="nav-icon">üö™</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">

            <!-- Top Bar -->
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="hamburger-btn" onclick="toggleSidebar()">
                        <span>‚ò∞</span>
                        <span>Menu</span>
                    </button>
                    <div>
                        <h1 style="margin: 0; font-size: 20px;">Lab Workflow Tracker</h1>
                        <p style="margin: 0; font-size: 12px; color: #666;">Complete LIMS ‚Ä¢ Sample Tracking ‚Ä¢ Quality Control</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="autoSaveIndicator" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #e8f5e9; border-radius: 6px; font-size: 12px; color: #2e7d32;">
                        <span id="saveIcon">‚úì</span>
                        <span id="saveText">Auto-saved</span>
                        <span id="saveTime" style="color: #666; font-size: 11px;"></span>
                    </div>
                    <button onclick="undo()" id="undoBtn" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" disabled title="No actions to undo">‚Ü∂ Undo</button>
                </div>
            </div>

        <!-- Sequencing Module UI (wrapped for showing/hiding) -->
        <div id="sequencingUI">

        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">

    <!-- Quick Stats Panel (Sticky) -->
    <div id="stickyStatsPanel" style="position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; color: white;">‚ö° Quick Stats</h3>
            <button onclick="toggleStatsCompact()" id="statsToggle" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                Minimize ‚ñ≤
            </button>
        </div>
        <div id="quickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </div>

    <!-- Work Queue Dashboard - "What to Work On Now" -->
    <div id="workQueuePanel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: white;">üéØ What to Work On Now</h3>
            <button onclick="refreshWorkQueue()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                üîÑ Refresh
            </button>
        </div>
        <div id="workQueue" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
            <!-- Work queue items will be populated by JavaScript -->
        </div>
        <div id="noWorkMessage" style="display: none; text-align: center; padding: 30px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 16px;">
            ‚úÖ All caught up! No urgent items at the moment.
        </div>
    </div>

    <!-- Status Dashboard -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">üìä Status Dashboard</h3>
        <div id="statusDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
            <!-- Dashboard will be populated by JavaScript -->
        </div>
    </div>

    <div class="add-section">
        <h3>Add New Samples</h3>

        <!-- Single Sample Input -->
        <div id="singleInput">
            <h4>Single Sample: <span style="font-size: 12px; font-weight: normal; color: #6c757d;">üì∑ Barcode scanner | üé§ Voice input supported</span></h4>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="sampleId" placeholder="Sample ID (or say it)" onkeyup="checkDuplicateRealtime(this)" style="flex: 1; min-width: 200px;">
                <button onclick="startVoiceInput('sampleId')" id="voiceSampleBtn" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;" title="Click to speak Sample ID">üé§ Speak ID</button>
                <span id="duplicateWarning" style="color: #dc3545; font-weight: 600; display: none;">‚ö†Ô∏è Already exists!</span>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="initials" placeholder="Initials" maxlength="3" style="width: 150px;">
                <button onclick="startVoiceInput('initials')" id="voiceInitialsBtn" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;" title="Click to speak Initials">üé§</button>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="addSample(false)">Add Sample</button>
                <button onclick="addSample(true)" style="background: #28a745;">‚úö Add & Next</button>
            </div>
            <div id="voiceStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none; background: #e3f2fd; color: #1976d2; font-weight: 600;">
                üé§ Listening...
            </div>
            <div id="quickAddFeedback" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
        
        <!-- Toggle Button -->
        <div style="margin: 20px 0; text-align: center;">
            <button id="toggleBulk" onclick="toggleBulkInput()">Switch to Bulk Input</button>
        </div>
        
        <!-- Bulk Sample Input -->
        <div id="bulkInput" style="display: none;">
            <h4>Bulk Sample Input:</h4>
            <p><small>Paste sample IDs (one per line). Your initials will be applied to all samples.</small></p>
            <input type="text" id="bulkInitials" placeholder="Your initials (for all samples)" maxlength="3">
            <textarea id="bulkSamples" rows="6" placeholder="Paste sample IDs here, one per line:&#10;25KS01-001&#10;25KS01-002&#10;25KS01-003" style="width: 100%; margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button onclick="addBulkSamples()">Add All Samples</button>
        </div>
    </div>

    <div class="sample-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Samples</h3>
            <button id="undoButton" onclick="undoLastAction()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; opacity: 0.5;" disabled title="Nothing to undo">
                ‚Ü©Ô∏è Undo (Ctrl+Z)
            </button>
        </div>

        <!-- Bulk Operations Bar -->
        <div id="bulkOpsBar" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                    <strong><span id="selectedCount">0</span> samples selected</strong>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="bulkProcessNext()" style="background: #28a745; color: white;">‚ö° Process Next Stage</button>
                    <button onclick="bulkDelete()" style="background: #dc3545; color: white;">üóëÔ∏è Delete Selected</button>
                    <button onclick="showBulkStatusChange()" style="background: #ffc107; color: #333;">üìù Change Status</button>
                    <button onclick="bulkExport()" style="background: #17a2b8; color: white;">üì• Export Selected</button>
                    <button onclick="clearSelection()" style="background: #6c757d; color: white;">‚úñ Clear Selection</button>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
                <div style="position: relative; flex: 1; min-width: 250px; max-width: 400px;">
                    <input type="text" id="searchInput" placeholder="üîç Search by Sample ID..."
                           onkeyup="handleSearchInput(event)"
                           onfocus="showSearchSuggestions()"
                           style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #ddd; border-radius: 4px;">
                    <div id="searchSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #6366f1; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000;">
                        <!-- Autocomplete suggestions will appear here -->
                    </div>
                </div>

                <button onclick="showAdvancedSearch()" style="padding: 10px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üîé Advanced Search
                </button>

                <button onclick="toggleFilters()" id="toggleFiltersBtn" style="padding: 10px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    ‚öôÔ∏è Show Filters
                </button>
            </div>

            <!-- Collapsible Filters -->
            <div id="advancedFilters" style="display: none; border-top: 2px solid #dee2e6; padding-top: 15px;">

                <select id="sortSelect" onchange="sortSamples()" style="padding: 10px; font-size: 14px;">
                    <option value="dateDesc">Sort: Newest First</option>
                    <option value="dateAsc">Sort: Oldest First</option>
                    <option value="idAsc">Sort: ID (A-Z)</option>
                    <option value="idDesc">Sort: ID (Z-A)</option>
                    <option value="status">Sort: By Status</option>
                </select>

                <label style="padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <strong>Select All</strong>
                </label>

                <button onclick="toggleCompactView()" id="compactViewBtn" style="padding: 10px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üìã Compact View
                </button>

                <button onclick="expandAllSamples()" style="padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;" title="Expand all sample details">
                    ‚ñº Expand All
                </button>

                <button onclick="collapseAllSamples()" style="padding: 10px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;" title="Collapse all sample details">
                    ‚ñ∂ Collapse All
                </button>
            </div>

            <!-- View Mode Toggle -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                <label style="font-weight: 600; margin-right: 15px; color: #495057;">üìä View Mode:</label>
                <button onclick="switchView('kanban')" id="viewKanban" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 8px; transition: all 0.3s;">
                    üéØ Pipeline
                </button>
                <button onclick="switchView('list')" id="viewList" style="padding: 8px 16px; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 8px; transition: all 0.3s;">
                    üìã List
                </button>
                <button onclick="switchView('table')" id="viewTable" style="padding: 8px 16px; background: white; color: #6366f1; border: 2px solid #6366f1; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    üìä Table
                </button>
            </div>

            <div style="margin-top: 10px;">
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="all" checked onchange="filterSamples()"> All
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Received" onchange="filterSamples()"> Received
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="BAP In Progress" onchange="filterSamples()"> BAP Incubating
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="BAP Complete" onchange="filterSamples()"> BAP Complete
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="TSB In Progress" onchange="filterSamples()"> TSB Incubating
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="TSB Complete" onchange="filterSamples()"> TSB Complete
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Extraction Complete" onchange="filterSamples()"> Extraction
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Complete" onchange="filterSamples()"> Complete
                </label>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">üìÖ Date Range:</strong>
                <button onclick="filterByDate('all')" id="dateFilterAll" class="date-filter-btn active" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">All Time</button>
                <button onclick="filterByDate('today')" id="dateFilterToday" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Today</button>
                <button onclick="filterByDate('week')" id="dateFilterWeek" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">This Week</button>
                <button onclick="filterByDate('month')" id="dateFilterMonth" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">This Month</button>
                <button onclick="filterByDate('30days')" id="dateFilter30Days" class="date-filter-btn" style="padding: 6px 12px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Last 30 Days</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">üö© Flag:</strong>
                <button onclick="filterByFlag('all')" id="flagFilterAll" class="flag-filter-btn active" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #28a745; background: #28a745; color: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">All</button>
                <button onclick="filterByFlag('Rush')" id="flagFilterRush" class="flag-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #dc3545; background: white; color: #dc3545; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">üî¥ Rush</button>
                <button onclick="filterByFlag('Hold')" id="flagFilterHold" class="flag-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #ffc107; background: white; color: #856404; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">‚è∏Ô∏è Hold</button>
                <button onclick="filterByFlag('Review')" id="flagFilterReview" class="flag-filter-btn" style="padding: 6px 12px; border: 2px solid #fd7e14; background: white; color: #fd7e14; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">‚ö†Ô∏è Review</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">‚¨áÔ∏è Sort By:</strong>
                <select id="sortSelect" onchange="sortSamples()" style="padding: 6px 12px; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    <option value="dateAdded-desc">Date Added (Newest First)</option>
                    <option value="dateAdded-asc">Date Added (Oldest First)</option>
                    <option value="id-asc">Sample ID (A‚ÜíZ)</option>
                    <option value="id-desc">Sample ID (Z‚ÜíA)</option>
                    <option value="status-asc">Status (A‚ÜíZ)</option>
                    <option value="progress-desc">Progress (High‚ÜíLow)</option>
                    <option value="progress-asc">Progress (Low‚ÜíHigh)</option>
                    <option value="technician-asc">Technician (A‚ÜíZ)</option>
                </select>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">‚ö° Ready for:</strong>
                <button onclick="filterReadyFor('BAP')" id="readyFilterBAP" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">BAP</button>
                <button onclick="filterReadyFor('TSB')" id="readyFilterTSB" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">TSB</button>
                <button onclick="filterReadyFor('Extraction')" id="readyFilterExtraction" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Extraction</button>
                <button onclick="filterReadyFor('CleanExtraction')" id="readyFilterCleanExtraction" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Clean Extraction</button>
                <button onclick="filterReadyFor('CEQubit')" id="readyFilterCEQubit" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">CE Qubit</button>
                <button onclick="filterReadyFor('Indexing')" id="readyFilterIndexing" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Indexing</button>
                <button onclick="filterReadyFor('FinalQubit')" id="readyFilterFinalQubit" class="ready-filter-btn" style="padding: 6px 12px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Final Qubit</button>
            </div>

            </div>
            <!-- End Collapsible Filters -->
        </div>

        <div class="batch-controls" id="batchControls" style="display: none;">
            <h4>üß™ Batch Processing</h4>
            <p><span id="selectedCount">0</span> samples selected</p>
            <button class="btn-batch" id="batchBtn" disabled onclick="startBatchProcess()">Start Batch</button>
            <button onclick="clearSelection()">Clear Selection</button>
        </div>

        <!-- Kanban Pipeline View -->
        <div id="kanbanView" style="display: block;">
            <div id="kanbanContainer" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px 0;">
                <!-- Kanban columns will be rendered here -->
            </div>
        </div>

        <!-- List View (Original) -->
        <div id="listView" style="display: none;">
            <div id="sampleContainer"></div>
        </div>

        <!-- Table View -->
        <div id="tableView" style="display: none;">
            <div id="tableContainer" style="overflow-x: auto;">
                <!-- Table will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBatchModal()">&times;</span>
            <h3 id="batchModalTitle">Batch Processing</h3>
            <p>Processing <strong id="batchSampleCount">0</strong> samples</p>
            <p id="batchNumbers"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="batchTechInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="batchLotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="batchTemperature">
                    <option value="37">37¬∞C</option>
                    <option value="35">35¬∞C</option>
                    <option value="42">42¬∞C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="batchIncubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>Time In:</label>
                <input type="time" id="batchTimeIn" placeholder="HH:MM" onchange="calculateBatchIncubationDuration()">
            </div>

            <div class="form-group">
                <label>Time Out:</label>
                <input type="time" id="batchTimeOut" placeholder="HH:MM" onchange="calculateBatchIncubationDuration()">
            </div>

            <div id="batchIncubationDuration" style="padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; display: none;">
                <strong>Duration:</strong> <span id="batchDurationText"></span>
            </div>

            <button onclick="completeBatchProcess()">Complete Batch</button>
            <button class="btn-cancel" onclick="closeBatchModal()">Cancel</button>
        </div>
    </div>

    <!-- Individual Modal -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Process Sample</h3>
            <p>Sample: <strong id="modalSampleId"></strong></p>
            <p id="modalNumber"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="techInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="lotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="temperature">
                    <option value="37">37¬∞C</option>
                    <option value="35">35¬∞C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="incubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>Time In:</label>
                <input type="time" id="timeIn" placeholder="HH:MM" onchange="calculateIncubationDuration()">
            </div>

            <div class="form-group">
                <label>Time Out:</label>
                <input type="time" id="timeOut" placeholder="HH:MM" onchange="calculateIncubationDuration()">
            </div>

            <div id="incubationDuration" style="padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; display: none;">
                <strong>Duration:</strong> <span id="durationText"></span>
            </div>

            <div id="specificFields"></div>

            <div class="form-group">
                <label>Stage Notes (optional):</label>
                <textarea id="stageNotes" rows="3" placeholder="Any observations or notes about this processing stage..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;"></textarea>
                <small style="color: #6c757d;">e.g., "Sample looked cloudy", "Had to repeat step", "Extra incubation time needed"</small>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="saveAsTemplate()" style="background: #17a2b8; font-size: 13px; padding: 8px 16px;">üíæ Save as Template</button>
                <button onclick="loadTemplate()" style="background: #6c757d; font-size: 13px; padding: 8px 16px;">üìã Load Template</button>
            </div>

            <button onclick="completeProcess()">Complete</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Edit Sample Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>Edit Sample</h3>
            <p>Original Sample ID: <strong id="editOriginalId"></strong></p>

            <div class="form-group">
                <label>Sample ID:</label>
                <input type="text" id="editSampleId">
            </div>

            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="editInitials" maxlength="3">
            </div>

            <div class="form-group">
                <label>Status:</label>
                <select id="editStatus">
                    <option value="Received">Received</option>
                    <option value="BAP Complete">BAP Complete</option>
                    <option value="TSB Complete">TSB Complete</option>
                    <option value="Extraction Complete">Extraction Complete</option>
                    <option value="Clean Extraction Complete">Clean Extraction Complete</option>
                    <option value="Clean Extraction Qubit Complete">Clean Extraction Qubit Complete</option>
                    <option value="Indexing Complete">Indexing Complete</option>
                    <option value="Qubit Complete">Qubit Complete</option>
                </select>
            </div>

            <button onclick="saveEditedSample()">Save Changes</button>
            <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>

    <!-- Audit Trail Modal -->
    <div id="auditTrailModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeAuditTrailModal()">&times;</span>
            <h3>üìã Sample History & Audit Trail</h3>
            <div id="auditTrailContent"></div>
            <button onclick="closeAuditTrailModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Plate Map Modal -->
    <div id="plateMapModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <span class="close-btn" onclick="closePlateMapModal()">&times;</span>
            <h3>üß´ 96-Well Plate Map</h3>

            <div style="margin: 20px 0;">
                <label><strong>Select Plate:</strong></label>
                <select id="plateSelector" onchange="renderPlateMap()">
                    <option value="">-- Select a plate --</option>
                </select>
            </div>

            <div id="plateMapContainer" style="overflow-x: auto;">
                <!-- Plate map will be rendered here -->
            </div>

            <div id="plateMapLegend" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <strong>Legend:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px;">
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e9ecef; border: 1px solid #999;"></span> Empty</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff9c4; border: 1px solid #f57f17;"></span> BAP Incubating</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #d4edda; border: 1px solid #155724;"></span> BAP Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #ffe0b2; border: 1px solid #e65100;"></span> TSB Incubating</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3cd; border: 1px solid #856404;"></span> TSB Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #f3e5f5; border: 1px solid #7b1fa2;"></span> Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f5e8; border: 1px solid #2e7d32;"></span> Clean Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f4fd; border: 1px solid #1565c0;"></span> CE Qubit</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e3f2fd; border: 1px solid #1976d2;"></span> Indexing</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3e0; border: 1px solid #f57c00;"></span> Complete</div>
                </div>
            </div>

            <button class="btn-cancel" onclick="closePlateMapModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-btn" onclick="closeQRCodeModal()">&times;</span>
            <h3>üì± Sample QR Code</h3>

            <div id="qrCodeContainer" style="margin: 20px 0;">
                <!-- QR Code will be generated here -->
            </div>

            <div id="qrSampleInfo" style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                <!-- Sample info will be shown here -->
            </div>

            <button onclick="printQRCode()" style="background: #28a745; color: white; margin-right: 10px;">üñ®Ô∏è Print Label</button>
            <button class="btn-cancel" onclick="closeQRCodeModal()">Close</button>
        </div>
    </div>

    <!-- Batch Print Labels Modal -->
    <div id="printLabelsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-btn" onclick="closePrintLabelsModal()">&times;</span>
            <h3>üè∑Ô∏è Print Sample Labels</h3>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                <strong>üìå Tip:</strong> Labels can be printed on standard Avery 5160 (2.625" x 1") or similar label sheets.
                Each label includes the sample ID and a QR code for easy scanning.
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <label><strong>Filter by Status:</strong></label>
                    <select id="labelFilterStatus" onchange="updateLabelPreview()" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="all">All Samples</option>
                        <option value="Received">Received</option>
                        <option value="BAP Complete">BAP Complete</option>
                        <option value="TSB Complete">TSB Complete</option>
                        <option value="Extraction Complete">Extraction Complete</option>
                        <option value="Clean Extraction Complete">Clean Extraction Complete</option>
                        <option value="Clean Extraction Qubit Complete">CE Qubit Complete</option>
                        <option value="Indexing Complete">Indexing Complete</option>
                        <option value="Qubit Complete">Qubit Complete</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label><strong>Label Size:</strong></label>
                    <select id="labelSize" onchange="updateLabelPreview()" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="medium">Medium (2.625" x 1")</option>
                        <option value="small">Small (1.5" x 0.5")</option>
                        <option value="large">Large (4" x 2")</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="includeQR" checked onchange="updateLabelPreview()">
                    <span><strong>Include QR Code</strong> (recommended for barcode scanning)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                    <input type="checkbox" id="includeDate" checked onchange="updateLabelPreview()">
                    <span><strong>Include Date Added</strong></span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                    <input type="checkbox" id="includeStatus" checked onchange="updateLabelPreview()">
                    <span><strong>Include Current Status</strong></span>
                </label>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">Label Preview (<span id="labelCount">0</span> labels)</h4>
                    <button onclick="printLabels()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        üñ®Ô∏è Print All Labels
                    </button>
                </div>

                <div id="labelPreviewContainer" style="max-height: 500px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Label previews will be rendered here -->
                </div>
            </div>

            <button class="btn-cancel" onclick="closePrintLabelsModal()">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeAnalyticsModal()">&times;</span>
            <h3>üìà Data Analytics Dashboard</h3>

            <div id="analyticsContainer" style="overflow-y: auto; max-height: 70vh;">
                <!-- Analytics will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeAnalyticsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeTimelineModal()">&times;</span>
            <h3>üìÖ Sample Processing Timeline</h3>

            <div style="margin: 20px 0;">
                <label><strong>View:</strong></label>
                <select id="timelineView" onchange="renderTimeline()">
                    <option value="all">All Samples</option>
                    <option value="recent">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="stage">By Stage</option>
                </select>
            </div>

            <div id="timelineContainer" style="overflow-x: auto; overflow-y: auto; max-height: 60vh;">
                <!-- Timeline will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeTimelineModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeShortcutsModal()">&times;</span>
            <h3>‚å®Ô∏è Keyboard Shortcuts</h3>

            <div style="margin-top: 20px;">
                <h4 style="color: #007bff; margin-bottom: 10px;">üîç Navigation</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + F</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus search box</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>1</kbd> - <kbd>5</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Quick status filters (All, Received, BAP, TSB, Extraction)</td>
                    </tr>
                </table>

                <h4 style="color: #28a745; margin-bottom: 10px;">üìä Actions</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export JSON backup</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + Shift + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export CSV</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + I</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Import data</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + N</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus sample input (add new)</td>
                    </tr>
                </table>

                <h4 style="color: #6366f1; margin-bottom: 10px;">üéØ View Switching (NEW!)</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr style="background: #f0f4ff;">
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + 1</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Switch to Kanban (Pipeline) view</strong></td>
                    </tr>
                    <tr style="background: #f0f4ff;">
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + 2</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Switch to List view</strong></td>
                    </tr>
                    <tr style="background: #f0f4ff;">
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + 3</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Switch to Table view</strong></td>
                    </tr>
                </table>

                <h4 style="color: #fd7e14; margin-bottom: 10px;">üìà Views & Tools</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + T</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Timeline view</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + A</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Analytics dashboard</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + R</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Reagent Search</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + P</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Plate Map</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + L</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Print Labels</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + G</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Go to sample (search)</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + S</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Save/Export backup</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + K</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Show this shortcuts dialog</td>
                    </tr>
                </table>

                <h4 style="color: #9c27b0; margin-bottom: 10px;">‚öôÔ∏è Toggles</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + B</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Bulk Input mode</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + D</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Dark Mode</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + M</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Compact View</td>
                    </tr>
                </table>

                <h4 style="color: #6c757d; margin-bottom: 10px;">üö™ Modals</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Esc</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Close any open modal</td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-align: center;">
                <strong style="font-size: 16px;">üí° Pro Tip: Use these shortcuts to navigate 10x faster!</strong><br>
                <small style="opacity: 0.9;">Total shortcuts: 23+ | NEW: Ctrl/Cmd + 1/2/3 for view switching!</small>
            </div>

            <button class="btn-cancel" onclick="closeShortcutsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Reagent Search Modal -->
    <div id="reagentSearchModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <span class="close-btn" onclick="closeReagentSearchModal()">&times;</span>
            <h3>üî¨ Reagent Lot Search & Traceability</h3>

            <div style="margin: 20px 0; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Search for samples using a specific reagent lot number:</label>
                <input type="text" id="reagentSearchInput" placeholder="Enter lot number (e.g., AW1-LOT-2024-123)"
                       style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 4px; margin-bottom: 10px;"
                       onkeyup="if(event.key==='Enter') searchReagentLot()">
                <button onclick="searchReagentLot()" style="padding: 12px 24px; background: #fd7e14; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 16px;">
                    üîç Search
                </button>
            </div>

            <div id="reagentSearchResults" style="margin-top: 20px;">
                <!-- Search results will appear here -->
            </div>

            <button class="btn-cancel" onclick="closeReagentSearchModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Sample History/Audit Trail Modal -->
    <div id="sampleHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeSampleHistoryModal()">&times;</span>
            <div id="sampleHistoryContent">
                <!-- Content will be dynamically inserted -->
            </div>
            <button class="btn-cancel" onclick="closeSampleHistoryModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Reagent Templates Modal -->
    <div id="reagentTemplatesModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <span class="close-btn" onclick="closeReagentTemplatesModal()">&times;</span>
            <h3>üìã Reagent Lot Templates</h3>
            <p style="color: #666; margin-bottom: 20px;">Save commonly used reagent lot combinations and reuse them later. Perfect when using the same lots for days or weeks!</p>

            <div style="margin: 20px 0;">
                <h4>üíæ Saved Templates:</h4>
                <div id="templatesList" style="margin-top: 15px;">
                    <!-- Templates will be listed here -->
                </div>
            </div>

            <button class="btn-cancel" onclick="closeReagentTemplatesModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <span class="close-btn" onclick="closeInventory()">&times;</span>
            <h3>üì¶ Reagent Inventory Management</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <!-- Add New Reagent -->
                <div style="border: 2px solid #28a745; border-radius: 8px; padding: 20px; background: #f0fff4;">
                    <h4 style="margin-top: 0; color: #28a745;">‚ûï Add New Reagent</h4>
                    <div class="form-group">
                        <label>Reagent Name:</label>
                        <input type="text" id="newReagentName" placeholder="e.g., AW1 Buffer, Ethanol">
                    </div>
                    <div class="form-group">
                        <label>Lot Number:</label>
                        <input type="text" id="newReagentLot" placeholder="LOT-2025-001">
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" id="newReagentQty" placeholder="500" style="width: 100px;">
                        <select id="newReagentUnit" style="width: 100px; margin-left: 10px;">
                            <option value="mL">mL</option>
                            <option value="L">L</option>
                            <option value="units">units</option>
                            <option value="tubes">tubes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Expiration Date:</label>
                        <input type="date" id="newReagentExpiry">
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <input type="text" id="newReagentLocation" placeholder="Fridge A, Shelf 2">
                    </div>
                    <button onclick="addReagentToInventory()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        ‚ûï Add Reagent
                    </button>
                </div>

                <!-- Quick Stats -->
                <div style="border: 2px solid #17a2b8; border-radius: 8px; padding: 20px; background: #f0f9ff;">
                    <h4 style="margin-top: 0; color: #17a2b8;">üìä Inventory Stats</h4>
                    <div id="inventoryStats">
                        <!-- Stats will be populated -->
                    </div>
                </div>
            </div>

            <!-- Current Inventory -->
            <div style="margin-top: 20px;">
                <h4>üìã Current Inventory:</h4>
                <div id="inventoryList" style="margin-top: 15px;">
                    <!-- Inventory items will be listed here -->
                </div>
            </div>

            <button class="btn-cancel" onclick="closeInventory()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Monthly Sample Generator Modal -->
    <div id="monthlyGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 700px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; padding-bottom: 25px;">
            <span class="close-btn" onclick="closeMonthlyGeneratorModal()">&times;</span>
            <h3>üìÖ Generate Monthly Samples</h3>

            <!-- Scrollable content area -->
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select Month:</label>
                <select id="generatorMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">Select Samples to Generate:</h4>

                <!-- Retail Meat -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0;">üçó Retail Meat</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CB01" checked> CB01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CB02" checked> CB02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CB03" checked> CB03</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CB04" checked> CB04</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT01" checked> GT01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT02" checked> GT02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT03" checked> GT03</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT04" checked> GT04</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT05" checked> GT05</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GT06" checked> GT06</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GB01" checked> GB01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GB02" checked> GB02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GB03" checked> GB03</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="GB04" checked> GB04</label>
                    </div>
                </div>

                <!-- Giblets -->
                <div style="background: #ffeaa7; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0;">ü´Ä Giblets (Default Set)</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CL01" checked> CL01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CG01" checked> CG01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CH01" checked> CH01</label>
                    </div>
                    <h5 style="margin: 15px 0 10px 0; opacity: 0.7;">Backup Giblets (if needed)</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CL02"> CL02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CG02"> CG02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="CH02"> CH02</label>
                    </div>
                </div>

                <!-- Seafood -->
                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0;">üêü Seafood</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="SA01" checked> SA01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="SA02" checked> SA02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="TI01" checked> TI01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="TI02" checked> TI02</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="SH01" checked> SH01</label>
                        <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="generator-checkbox" value="SH02" checked> SH02</label>
                    </div>
                </div>
            </div>
            </div>
            <!-- End scrollable content area -->

            <!-- Sticky button bar at bottom -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e0e0e0; background: white;">
                <button onclick="generateMonthlySamples()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚ú® Generate Samples</button>
                <button class="btn-cancel" onclick="closeMonthlyGeneratorModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Editor Modal -->
    <div id="bulkEditorModal" class="modal">
        <div class="modal-content" style="max-width: 95%; width: 1400px; max-height: 90vh; display: flex; flex-direction: column;">
            <span class="close-btn" onclick="closeBulkEditorModal()">&times;</span>
            <h3>üìù Bulk Edit Food Samples</h3>
            <p style="color: #666; margin-bottom: 20px;">Edit multiple samples at once. Fill in the details for each sample and click Save All.</p>

            <!-- Tabs for RM and SF -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button id="bulkTabRM" onclick="switchBulkEditorTab('meat')" style="padding: 12px 24px; border: none; border-bottom: 3px solid #667eea; background: transparent; cursor: pointer; font-weight: 600; color: #667eea;">
                    ü•© Retail Meat (<span id="rmCount">0</span>)
                </button>
                <button id="bulkTabSF" onclick="switchBulkEditorTab('seafood')" style="padding: 12px 24px; border: none; border-bottom: 3px solid transparent; background: transparent; cursor: pointer; font-weight: 600; color: #666;">
                    üêü Seafood (<span id="sfCount">0</span>)
                </button>
            </div>

            <!-- Scrollable content area -->
            <div id="bulkEditorContent" style="flex: 1; overflow-x: auto; overflow-y: auto; margin-bottom: 20px;">
                <!-- Table will be rendered here -->
            </div>

            <!-- Fixed buttons at bottom -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e0e0e0; background: var(--bg-secondary); position: sticky; bottom: 0;">
                <button onclick="saveBulkEdits()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save All Changes</button>
                <button class="btn-cancel" onclick="closeBulkEditorModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Export data as JSON file
        function exportData() {
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                exportDate: new Date().toISOString()
            };

            var dataStr = JSON.stringify(data, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            var url = URL.createObjectURL(dataBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bacterial-tracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('JSON data exported successfully!');
        }

        // Export data as CSV file
        function exportCSV() {
            // Header row with ALL fields including 22+ reagent lots
            var csv = 'Sample ID,Status,Date Added,Initials,Flag,Notes,';
            // BAP
            csv += 'BAP Number,BAP Lot,BAP Tech,BAP Date,BAP Temp,BAP Incubator,BAP Time In,BAP Time Out,BAP Notes,';
            // TSB
            csv += 'TSB Number,TSB Lot,TSB Tech,TSB Date,TSB Temp,TSB Incubator,TSB Time In,TSB Time Out,TSB Notes,';
            // Extraction (8 reagent lots)
            csv += 'Extraction Number,Extraction Run,Extraction Tech,Extraction Date,';
            csv += 'Ext AW1 Lot,Ext AW2 Lot,Ext Ethanol Lot,Ext Buffer AL Lot,Ext Buffer ATL Lot,Ext Buffer AE Lot,Ext Proteinase K Lot,Ext DNeasy Lot,Extraction Notes,';
            // Clean Extraction (5 reagent lots + 3 volumes)
            csv += 'Clean Extraction Number,CE Storage Plate,CE Well,CE Tech,CE Date,';
            csv += 'CE Bead Lot,CE NF H2O ETOH Lot,CE ETOH Dilution Lot,CE NF H2O Elution Lot,CE Qubit Reagent Lot,';
            csv += 'CE Cleanup Volume,CE Elution In Volume,CE Elution Out Volume,CE Notes,';
            // CE Qubit
            csv += 'CE Qubit Concentration (ng/uL),CE Qubit Reagent Lot,CE Qubit Date,CE Qubit Tech,CE Qubit Notes,';
            // Indexing (9 reagent lots + 2 cleanup concentrations)
            csv += 'Indexing Number,Index Storage Plate,Index Well,Index Tech,Index Date,';
            csv += 'i5 Index,i7 Index,i5 Thaws,i7 Thaws,';
            csv += 'Index TD Buffer Lot,Index ATM Buffer Lot,Index NT Buffer Lot,Index NPM Lot,Index Resuspension Buffer Lot,Index Kit Lot,Index Beads Lot,Index ETOH Lot,Index NF H2O Lot,';
            csv += 'Index Cleanup Step1,Index Cleanup Step2,Index Notes,';
            // Final Qubit
            csv += 'Final Qubit Concentration (ng/uL),Final Qubit Reagent Lot,Final Qubit Date,Final Qubit Tech,Final Qubit Notes,';
            // QC and turnaround
            csv += 'QC Failures,Reprocess Count,Turnaround Days\n';

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var row = [
                    // Basic info
                    s.id,
                    s.status,
                    s.dateAdded,
                    s.initials,
                    s.flag || 'None',
                    s.notes || '',
                    // BAP
                    s.bapNumber || '',
                    s.bapDetails ? s.bapDetails.lot : '',
                    s.bapDetails ? s.bapDetails.technician : '',
                    s.bapDetails ? s.bapDetails.completedDate : '',
                    s.bapDetails ? s.bapDetails.temperature : '',
                    s.bapDetails ? s.bapDetails.incubator : '',
                    s.bapDetails ? s.bapDetails.timeIn : '',
                    s.bapDetails ? s.bapDetails.timeOut : '',
                    s.bapDetails ? (s.bapDetails.stageNotes || '') : '',
                    // TSB
                    s.tsbNumber || '',
                    s.tsbDetails ? s.tsbDetails.lot : '',
                    s.tsbDetails ? s.tsbDetails.technician : '',
                    s.tsbDetails ? s.tsbDetails.completedDate : '',
                    s.tsbDetails ? s.tsbDetails.temperature : '',
                    s.tsbDetails ? s.tsbDetails.incubator : '',
                    s.tsbDetails ? s.tsbDetails.timeIn : '',
                    s.tsbDetails ? s.tsbDetails.timeOut : '',
                    s.tsbDetails ? (s.tsbDetails.stageNotes || '') : '',
                    // Extraction
                    s.extractionNumber || '',
                    s.extractionDetails ? s.extractionDetails.extractionRun : '',
                    s.extractionDetails ? s.extractionDetails.technician : '',
                    s.extractionDetails ? s.extractionDetails.completedDate : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.aw1 : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.aw2 : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.ethanol : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferAL : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferATL : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferAE : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.proteinaseK : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.dneasy : '',
                    s.extractionDetails ? (s.extractionDetails.stageNotes || '') : '',
                    // Clean Extraction
                    s.cleanExtractionNumber || '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.storagePlate : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.wellPosition : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.technician : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.completedDate : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.bead : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.nfH2oEtoh : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.etohDilution : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.nfH2oElution : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.qubitReagent : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.cleanup : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.elutionIn : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.elutionOut : '',
                    s.cleanExtractionDetails ? (s.cleanExtractionDetails.stageNotes || '') : '',
                    // CE Qubit
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.concentration : '',
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.reagentLot : '',
                    s.cleanExtractionQubitDetails ? (s.cleanExtractionQubitDetails.dateQubited || s.cleanExtractionQubitDetails.completedDate) : '',
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.technician : '',
                    s.cleanExtractionQubitDetails ? (s.cleanExtractionQubitDetails.stageNotes || '') : '',
                    // Indexing
                    s.indexingNumber || '',
                    s.indexingDetails ? s.indexingDetails.storagePlate : '',
                    s.indexingDetails ? s.indexingDetails.wellPosition : '',
                    s.indexingDetails ? s.indexingDetails.technician : '',
                    s.indexingDetails ? s.indexingDetails.completedDate : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i5 : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i7 : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i5Thaws : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i7Thaws : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.tdBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.atmBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.ntBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.npm : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.resuspensionBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.indexesKit : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.beads : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.etoh : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.nfH2o : '',
                    s.indexingDetails && s.indexingDetails.cleanupConcentrations ? s.indexingDetails.cleanupConcentrations.step1 : '',
                    s.indexingDetails && s.indexingDetails.cleanupConcentrations ? s.indexingDetails.cleanupConcentrations.step2 : '',
                    s.indexingDetails ? (s.indexingDetails.stageNotes || '') : '',
                    // Final Qubit
                    s.qubitDetails ? s.qubitDetails.concentration : '',
                    s.qubitDetails ? s.qubitDetails.reagentLot : '',
                    s.qubitDetails ? (s.qubitDetails.dateQubited || s.qubitDetails.completedDate) : '',
                    s.qubitDetails ? s.qubitDetails.technician : '',
                    s.qubitDetails ? (s.qubitDetails.stageNotes || '') : '',
                    // QC and turnaround
                    s.qcFailures ? s.qcFailures.length : '0',
                    s.reprocessCount || '0',
                    calculateTurnaroundDays(s) || ''
                ];

                // Escape commas and quotes in CSV
                row = row.map(function(cell) {
                    if (cell && cell.toString().indexOf(',') > -1) {
                        return '"' + cell.toString().replace(/"/g, '""') + '"';
                    }
                    return cell;
                });

                csv += row.join(',') + '\n';
            }

            var csvBlob = new Blob([csv], {type: 'text/csv'});
            var url = URL.createObjectURL(csvBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bacterial-tracker-export-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('CSV exported successfully! Open in Excel or Google Sheets.');
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Are you sure?')) {
                        samples = data.samples || [];
                        nextBapNumber = data.nextBapNumber || 1;
                        nextTsbNumber = data.nextTsbNumber || 1;
                        nextExtractionNumber = data.nextExtractionNumber || 1;
                        nextExtractionRun = data.nextExtractionRun || 1;
                        nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                        nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                        nextIndexingNumber = data.nextIndexingNumber || 1;
                        nextIndexingPlate = data.nextIndexingPlate || 1;
                        saveData();
                        renderSamples();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Clear all data
        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?\n\nConsider exporting your data first!')) {
                if (confirm('Really delete everything? This cannot be undone!')) {
                    localStorage.removeItem('bacterialTrackerData');
                    initializeDefaults();
                    renderSamples();
                    alert('All data has been cleared.');
                }
            }
        }

        // Load data from localStorage or initialize with defaults
        function loadData() {
            var savedData = localStorage.getItem('bacterialTrackerData');
            if (savedData) {
                try {
                    var data = JSON.parse(savedData);
                    samples = data.samples || [];
                    nextBapNumber = data.nextBapNumber || 1;
                    nextTsbNumber = data.nextTsbNumber || 1;
                    nextExtractionNumber = data.nextExtractionNumber || 1;
                    nextExtractionRun = data.nextExtractionRun || 1;
                    nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                    nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                    nextIndexingNumber = data.nextIndexingNumber || 1;
                    nextIndexingPlate = data.nextIndexingPlate || 1;
                    // Load food testing module data
                    foodSamples = data.foodSamples || [];
                    pathogenWorkflows = data.pathogenWorkflows || [];
                    isolates = data.isolates || [];
                    currentModule = data.currentModule || 'food-testing';
                    storeNames = data.storeNames || [];
                    brandNames = data.brandNames || [];
                    brandCodeMap = data.brandCodeMap || {};
                    packingTypes = data.packingTypes || [];
                    producedByNames = data.producedByNames || [];
                    countryNames = data.countryNames || [];
                    raisingClaims = data.raisingClaims || [];
                    meatTypes = data.meatTypes || [];
                    fatPercentages = data.fatPercentages || [];
                    // Load seafood specific fields
                    seafoodBrands = data.seafoodBrands || [];
                    seafoodProducedBy = data.seafoodProducedBy || [];
                    seafoodPackagedFor = data.seafoodPackagedFor || [];
                    seafoodCountries = data.seafoodCountries || [];
                    seafoodOrganicClaims = data.seafoodOrganicClaims || [];
                    seafoodMeatCuts = data.seafoodMeatCuts || [];
                    deletedSamples = data.deletedSamples || [];

                    // DATA MIGRATION: Add day1BPW stage to existing E. coli workflows
                    migrateEcoliWorkflows();

                    console.log('Data loaded from localStorage');
                } catch (e) {
                    console.error('Error loading data:', e);
                    initializeDefaults();
                }
            } else {
                initializeDefaults();
            }

            // Load reagent lot history
            var savedLotHistory = localStorage.getItem('reagentLotHistory');
            if (savedLotHistory) {
                try {
                    reagentLotHistory = JSON.parse(savedLotHistory);
                } catch (e) {
                    console.error('Error loading lot history:', e);
                    reagentLotHistory = {};
                }
            }

            // Initialize common brand codes if map is empty
            initializeCommonBrandCodes();
        }

        // Initialize commonly used brand codes
        function initializeCommonBrandCodes() {
            // Only add if not already in the map (don't overwrite user's data)
            var commonBrands = {
                'El Mercado Fresco': 'BGH',
                'Festive': 'BP',
                'Pine Manor': 'TD',
                'Bichelmeyer Meats': 'BFP',
                'Yoder Meats': 'BFO',
                'Afghan Halal Market': 'BFN',
                'Asian Groceries': 'BFM',
                "Sprouts Farmers Market": 'UM',
                'Sterling Silver': 'TR',
                "Kier's Thriftway": 'AEX',
                'Perdue Reserve': 'BBF',
                'Apple Market': 'IN',
                'El Torito': 'AMD',
                "Dillon's": 'VJ',
                "Britt's Farm": 'BBU',
                'Animal Sciences and Industry': 'AYY',
                'Aldi': 'NG',
                'Marketside Butcher': 'ADT',
                'Farm to Family': 'ACZ',
                'Sun Fresh': 'AWQ',
                'Good and Gather': 'AOZ',
                "Laura's Lean Beef": 'DA',
                "Ray's Apple Market": 'AUJ',
                'Simply Nature': 'AVF',
                'Heritage Farm': 'YK',
                'Private Selection': 'NQ',
                'Simple Truth': 'YB',
                'Hy-Vee': 'WM',
                'Just Bare': 'XK',
                'Asian Market of Manhattan KS': 'AYX',
                'Kroger': 'CZ',
                'Jennie-O': 'CR',
                'Kirkwood': 'VH',
                'The Best Dressed Chicken': 'AXI',
                'Hormel': 'CL',
                "Mary's Organic": 'SO',
                'Whole Foods': 'GD',
                'Walmart': 'IR',
                'Honest Turkey': 'AGP',
                'Honeysuckle White': 'CK',
                'Perdue Harvestland': 'DU',
                'Hen House': 'ADU',
                'Prairie Fresh': 'DZ',
                'Tyson': 'FS',
                'Sanderson Farms': 'EP',
                'Butterball': 'AQ',
                'Price Chopper': 'ARD',
                'Smart Chicken': 'GR'
            };

            for (var brand in commonBrands) {
                if (!brandCodeMap[brand]) {
                    brandCodeMap[brand] = commonBrands[brand];
                }
            }
        }

        function initializeDefaults() {
            samples = [];
            nextBapNumber = 1;
            nextTsbNumber = 1;
            nextExtractionNumber = 1;
            nextExtractionRun = 1;
            nextCleanExtractionNumber = 1;
            nextCleanExtractionPlate = 1;
            nextIndexingNumber = 1;
            nextIndexingPlate = 1;
        }

        // Data migration: Update E. coli workflows to new Day 1A/1B structure
        function migrateEcoliWorkflows() {
            var migrated = 0;
            pathogenWorkflows.forEach(function(wf) {
                if (wf.pathogenCode === 'EC' && wf.stages) {
                    // Check if using old structure (day1BPW or day2MacBroth keys)
                    if (wf.stages.day1BPW !== undefined || wf.stages.day2MacBroth !== undefined) {
                        // Old structure - convert to new Day 1A/1B structure
                        var newStages = {
                            day1A_BPWPrep: wf.stages.day1BPW || {completed: false},
                            day1B_MacBroth: wf.stages.day2MacBroth || {completed: false},
                            day2_MacAgar: wf.stages.day2MacAgar || {completed: false},
                            day3_PinkColonies: wf.stages.day3PinkColonies || {completed: false},
                            day4_BAP: wf.stages.day4BAP || {completed: false},
                            day5_MALDI: wf.stages.day5MALDI || {completed: false}
                        };
                        wf.stages = newStages;
                        migrated++;
                        console.log('Migrated E. coli workflow: ' + wf.id + ' - Updated to Day 1A/1B structure');
                    }
                }
            });

            if (migrated > 0) {
                console.log('Migration complete: Updated ' + migrated + ' E. coli workflow(s) to Day 1A/1B structure');
                saveData(); // Save migrated data
            }
        }

        // Save data to localStorage
        function saveData() {
            var now = new Date();
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                // Food testing module data
                foodSamples: foodSamples,
                pathogenWorkflows: pathogenWorkflows,
                isolates: isolates,
                currentModule: currentModule,
                storeNames: storeNames,
                brandNames: brandNames,
                brandCodeMap: brandCodeMap,
                packingTypes: packingTypes,
                producedByNames: producedByNames,
                countryNames: countryNames,
                raisingClaims: raisingClaims,
                meatTypes: meatTypes,
                fatPercentages: fatPercentages,
                // Seafood specific fields
                seafoodBrands: seafoodBrands,
                seafoodProducedBy: seafoodProducedBy,
                seafoodPackagedFor: seafoodPackagedFor,
                seafoodCountries: seafoodCountries,
                seafoodOrganicClaims: seafoodOrganicClaims,
                seafoodMeatCuts: seafoodMeatCuts,
                deletedSamples: deletedSamples,
                lastSaved: now.toISOString()
            };
            localStorage.setItem('bacterialTrackerData', JSON.stringify(data));
            console.log('Data saved to localStorage');

            // Update auto-save indicator with animation
            updateSaveIndicator(now);
        }

        function updateSaveIndicator(saveTime) {
            var indicator = document.getElementById('autoSaveIndicator');
            var icon = document.getElementById('saveIcon');
            var text = document.getElementById('saveText');
            var timeSpan = document.getElementById('saveTime');

            if (!indicator) return;

            // Show "Saving..." briefly
            indicator.style.background = '#fff3cd';
            indicator.style.color = '#856404';
            icon.textContent = '‚è≥';
            text.textContent = 'Saving...';

            setTimeout(function() {
                // Show "Saved!" with checkmark
                indicator.style.background = '#e8f5e9';
                indicator.style.color = '#2e7d32';
                icon.textContent = '‚úì';
                text.textContent = 'Auto-saved';

                // Format time
                var hours = saveTime.getHours();
                var minutes = saveTime.getMinutes();
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12
                minutes = minutes < 10 ? '0' + minutes : minutes;
                var timeStr = hours + ':' + minutes + ' ' + ampm;

                timeSpan.textContent = 'at ' + timeStr;
            }, 300);
        }

        var samples = [];
        var deletedSamples = []; // Audit trail for deleted samples
        var nextBapNumber = 1;
        var nextTsbNumber = 1;
        var nextExtractionNumber = 1;
        var nextExtractionRun = 1;
        var nextCleanExtractionNumber = 1;
        var nextCleanExtractionPlate = 1;
        var nextIndexingNumber = 1;
        var nextIndexingPlate = 1;
        var currentProcessType = '';
        var selectedSamples = [];
        var undoStack = []; // Track last 10 actions for undo
        var reagentLotHistory = {}; // Store recently used lot numbers by field name with timestamps: {fieldName: [{lot: 'LOT-001', timestamp: 1234567890, dateUsed: '2025-11-13'}]}
        var currentBatchSamples = [];
        var currentBatchType = '';
        var currentDateFilter = 'all'; // Track current date filter
        var lastWellPositions = {}; // Track last well position used per plate type
        var isCompactView = false; // Track compact view state
        var expandedSamples = {}; // Track which samples are expanded (default: all expanded)

        // FOOD TESTING MODULE - Data Structures
        var foodSamples = []; // Food samples (meat/seafood)
        var currentUser = 'Lab User'; // Current user (can be updated with login system)
        var storeNames = []; // Autocomplete store names history
        var reagentLotHistory = {}; // Track recently used reagent lots by type (e.g., {bpwLot: ['LOT-001', 'LOT-002'], macBrothLot: [...]})

        // Retail Meat specific fields
        var brandNames = []; // Autocomplete brand names history
        var brandCodeMap = {}; // Map of brand names to brand codes
        var packingTypes = []; // Autocomplete packing types history (retail meat)
        var producedByNames = []; // Autocomplete produced by history
        var countryNames = []; // Autocomplete country history
        var raisingClaims = []; // Autocomplete raising claims history (retail meat)
        var meatTypes = []; // Autocomplete meat types history
        var fatPercentages = []; // Autocomplete fat % history

        // Seafood specific fields
        var seafoodBrands = []; // Autocomplete brand names for seafood
        var seafoodProducedBy = []; // Autocomplete produced by for seafood
        var seafoodPackagedFor = []; // Autocomplete packaged for/distributed by
        var seafoodCountries = []; // Autocomplete countries for seafood
        var seafoodOrganicClaims = []; // Autocomplete organic/antibiotic claims for seafood
        var seafoodMeatCuts = []; // Autocomplete meat cuts (fillet, steak, whole, etc.)

        var pathogenWorkflows = []; // E. coli, Campylobacter, Salmonella, etc.
        var isolates = []; // Generated isolates that go to sequencing
        var currentModule = 'food-testing'; // 'sequencing' or 'food-testing'
        var selectedSamplesForDelete = []; // Track selected samples for bulk delete

        // Sample type definitions
        var sampleTypes = {
            // Meat types
            'CB': {name: 'Chicken Breast', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            'GT': {name: 'Ground Turkey', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            'GB': {name: 'Ground Beef', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            'CL': {name: 'Chicken Liver', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            'CG': {name: 'Chicken Gizzard', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            'CH': {name: 'Chicken Heart', category: 'meat', pathogens: ['EC', 'C1', 'S1', 'E']},
            // Seafood types
            'SA': {name: 'Salmon', category: 'seafood', pathogens: ['V1', 'V2', 'E', 'A']},
            'SH': {name: 'Shrimp', category: 'seafood', pathogens: ['V1', 'V2', 'E', 'A']},
            'TI': {name: 'Tilapia', category: 'seafood', pathogens: ['V1', 'V2', 'E', 'A']}
        };

        // Pathogen definitions
        var pathogens = {
            'EC': {name: 'E. coli', fullName: 'Escherichia coli', sequenced: true, color: '#e91e63'},
            'C1': {name: 'Campylobacter', fullName: 'Campylobacter spp.', sequenced: true, color: '#9c27b0'},
            'S1': {name: 'Salmonella', fullName: 'Salmonella spp.', sequenced: true, color: '#f44336'},
            'E': {name: 'Enterococcus', fullName: 'Enterococcus spp.', sequenced: false, color: '#ff9800'},
            'V1': {name: 'Vibrio (Yellow)', fullName: 'Vibrio spp. (Yellow colonies)', sequenced: false, color: '#ffc107'},
            'V2': {name: 'Vibrio (Green)', fullName: 'Vibrio spp. (Green colonies)', sequenced: false, color: '#4caf50'},
            'A': {name: 'Aeromonas', fullName: 'Aeromonas spp.', sequenced: false, color: '#00bcd4'}
        };

        function generateWellPosition(index) {
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var row = rows[index % 8];
            var col = String(Math.floor(index / 8) + 1);
            if (col.length === 1) col = '0' + col;
            return row + col;
        }

        // Get next well position based on last used
        function getNextWellPosition(plateType) {
            if (!lastWellPositions[plateType]) {
                return 'A01'; // Start at A01 if no history
            }

            var last = lastWellPositions[plateType];
            var row = last.charAt(0);
            var col = parseInt(last.substring(1));
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

            // Increment column first (A01 ‚Üí A02 ‚Üí A03...)
            col++;

            // If we exceed 12 columns, go to next row
            if (col > 12) {
                col = 1;
                var rowIndex = rows.indexOf(row);
                rowIndex++;

                // If we exceed H row, wrap back to A01
                if (rowIndex >= rows.length) {
                    rowIndex = 0;
                }
                row = rows[rowIndex];
            }

            var colStr = String(col);
            if (colStr.length === 1) colStr = '0' + colStr;
            return row + colStr;
        }

        // Track well position usage
        function trackWellPosition(plateType, wellPosition) {
            lastWellPositions[plateType] = wellPosition;
        }

        // Calculate incubation duration
        function calculateIncubationDuration() {
            var timeIn = document.getElementById('timeIn').value;
            var timeOut = document.getElementById('timeOut').value;
            var durationDiv = document.getElementById('incubationDuration');
            var durationText = document.getElementById('durationText');

            if (!timeIn || !timeOut) {
                durationDiv.style.display = 'none';
                return;
            }

            // Parse times
            var inParts = timeIn.split(':');
            var outParts = timeOut.split(':');
            var inMinutes = parseInt(inParts[0]) * 60 + parseInt(inParts[1]);
            var outMinutes = parseInt(outParts[0]) * 60 + parseInt(outParts[1]);

            // Calculate difference (handle overnight incubations)
            var diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Add 24 hours if overnight
            }

            var hours = Math.floor(diffMinutes / 60);
            var minutes = diffMinutes % 60;

            var durationStr = hours + 'h ' + minutes + 'm';

            // Check if duration seems unusual (less than 1h or more than 24h)
            var warning = '';
            if (diffMinutes < 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Very short incubation!</span>';
            } else if (diffMinutes > 24 * 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Over 24 hours!</span>';
            }

            durationText.innerHTML = durationStr + warning;
            durationDiv.style.display = 'block';
        }

        function calculateBatchIncubationDuration() {
            var timeIn = document.getElementById('batchTimeIn').value;
            var timeOut = document.getElementById('batchTimeOut').value;
            var durationDiv = document.getElementById('batchIncubationDuration');
            var durationText = document.getElementById('batchDurationText');

            if (!timeIn || !timeOut) {
                durationDiv.style.display = 'none';
                return;
            }

            // Parse times
            var inParts = timeIn.split(':');
            var outParts = timeOut.split(':');
            var inMinutes = parseInt(inParts[0]) * 60 + parseInt(inParts[1]);
            var outMinutes = parseInt(outParts[0]) * 60 + parseInt(outParts[1]);

            // Calculate difference (handle overnight incubations)
            var diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Add 24 hours if overnight
            }

            var hours = Math.floor(diffMinutes / 60);
            var minutes = diffMinutes % 60;

            var durationStr = hours + 'h ' + minutes + 'm';

            // Check if duration seems unusual
            var warning = '';
            if (diffMinutes < 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Very short incubation!</span>';
            } else if (diffMinutes > 24 * 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Over 24 hours!</span>';
            }

            durationText.innerHTML = durationStr + warning;
            durationDiv.style.display = 'block';
        }

        // Calculate turnaround time in days
        function calculateTurnaroundDays(sample) {
            if (sample.status !== 'Qubit Complete') return null;

            var startDate = new Date(sample.dateAdded);
            var endDate = sample.qubitDetails && sample.qubitDetails.completedDate
                ? new Date(sample.qubitDetails.completedDate)
                : new Date();

            var diffTime = Math.abs(endDate - startDate);
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays;
        }

        // Toggle compact view
        function toggleCompactView() {
            isCompactView = !isCompactView;
            var btn = document.getElementById('compactViewBtn');

            if (isCompactView) {
                btn.textContent = 'üìÑ Detailed View';
                btn.style.background = '#28a745';
            } else {
                btn.textContent = 'üìã Compact View';
                btn.style.background = '#6c757d';
            }

            renderSamples();
        }

        // Toggle individual sample expansion
        function toggleSampleExpansion(sampleId) {
            // Default is expanded, so if not in object, it's expanded
            if (expandedSamples[sampleId] === undefined) {
                expandedSamples[sampleId] = false; // Collapse it
            } else {
                expandedSamples[sampleId] = !expandedSamples[sampleId];
            }

            // Save to localStorage
            try {
                localStorage.setItem('expandedSamples', JSON.stringify(expandedSamples));
            } catch (e) {
                console.log('Could not save expansion state');
            }

            // Update just this sample's display
            var detailsDiv = document.getElementById('sample-details-' + sampleId);
            var toggleBtn = document.getElementById('toggle-btn-' + sampleId);

            if (detailsDiv && toggleBtn) {
                var isExpanded = expandedSamples[sampleId] !== false;
                detailsDiv.style.display = isExpanded ? 'block' : 'none';
                toggleBtn.textContent = isExpanded ? '‚ñº' : '‚ñ∂';
                toggleBtn.title = isExpanded ? 'Collapse' : 'Expand';
            }
        }

        // Expand all samples
        function expandAllSamples() {
            expandedSamples = {};
            try {
                localStorage.setItem('expandedSamples', JSON.stringify(expandedSamples));
            } catch (e) {}
            renderSamples();
        }

        // Collapse all samples
        function collapseAllSamples() {
            expandedSamples = {};
            for (var i = 0; i < samples.length; i++) {
                expandedSamples[samples[i].id] = false;
            }
            try {
                localStorage.setItem('expandedSamples', JSON.stringify(expandedSamples));
            } catch (e) {}
            renderSamples();
        }

        // Load expansion state from localStorage
        function loadExpansionState() {
            try {
                var saved = localStorage.getItem('expandedSamples');
                if (saved) {
                    expandedSamples = JSON.parse(saved);
                }
            } catch (e) {
                expandedSamples = {};
            }
        }

        // Calculate sample progress (how many stages completed)
        function getSampleProgress(sample) {
            var stages = [
                {key: 'bapDetails', name: 'BAP'},
                {key: 'tsbDetails', name: 'TSB'},
                {key: 'extractionDetails', name: 'Extraction'},
                {key: 'cleanExtractionDetails', name: 'Clean Extraction'},
                {key: 'cleanExtractionQubitDetails', name: 'CE Qubit'},
                {key: 'indexingDetails', name: 'Indexing'},
                {key: 'qubitDetails', name: 'Final Qubit'}
            ];

            var completed = 0;
            for (var i = 0; i < stages.length; i++) {
                if (sample[stages[i].key]) {
                    completed++;
                }
            }

            var total = stages.length;
            var percentage = Math.round((completed / total) * 100);

            return {
                completed: completed,
                total: total,
                percentage: percentage
            };
        }

        // Generate progress bar HTML
        function getProgressBarHTML(sample) {
            var progress = getSampleProgress(sample);
            var color = progress.percentage === 100 ? '#28a745' :
                       progress.percentage >= 75 ? '#17a2b8' :
                       progress.percentage >= 50 ? '#ffc107' :
                       progress.percentage >= 25 ? '#fd7e14' : '#6c757d';

            var html = '<div style="margin: 8px 0;">';
            html += '<div style="display: flex; align-items: center; gap: 10px;">';
            html += '<div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">';
            html += '<div style="background: ' + color + '; height: 100%; width: ' + progress.percentage + '%; transition: width 0.3s ease;"></div>';
            html += '</div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: ' + color + '; min-width: 60px;">';
            html += progress.completed + '/' + progress.total + ' (' + progress.percentage + '%)';
            html += '</span>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        // Date filtering functions
        function filterByDate(period) {
            currentDateFilter = period;

            // Update button styles
            var buttons = document.querySelectorAll('.date-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].style.background = 'white';
                buttons[i].style.color = '#007bff';
            }

            var activeBtn = document.getElementById('dateFilter' + period.charAt(0).toUpperCase() + period.slice(1));
            if (period === 'all') activeBtn = document.getElementById('dateFilterAll');
            if (period === '30days') activeBtn = document.getElementById('dateFilter30Days');

            if (activeBtn) {
                activeBtn.style.background = '#007bff';
                activeBtn.style.color = 'white';
            }

            // Apply filter based on current module
            if (currentModule === 'food' && currentFoodTab === 'samples') {
                renderFoodSamplesTab();
            } else {
                filterSamples(); // For Bacterial Isolation sequencing module
            }
        }

        function isWithinDateFilter(dateString) {
            if (currentDateFilter === 'all') return true;

            var sampleDate = new Date(dateString);
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if (currentDateFilter === 'today') {
                sampleDate.setHours(0, 0, 0, 0);
                return sampleDate.getTime() === today.getTime();
            }

            if (currentDateFilter === 'week') {
                var weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                return sampleDate >= weekAgo;
            }

            if (currentDateFilter === 'month') {
                var monthAgo = new Date(today);
                monthAgo.setMonth(today.getMonth() - 1);
                return sampleDate >= monthAgo;
            }

            if (currentDateFilter === '30days') {
                var thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                return sampleDate >= thirtyDaysAgo;
            }

            return true;
        }

        // Flag filtering
        var currentFlagFilter = 'all';

        function filterByFlag(flag) {
            currentFlagFilter = flag;

            // Update button styles
            var buttons = document.querySelectorAll('.flag-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                if (btn.id === 'flagFilterAll') {
                    btn.style.background = flag === 'all' ? '#28a745' : 'white';
                    btn.style.color = flag === 'all' ? 'white' : '#28a745';
                } else if (btn.id === 'flagFilterRush') {
                    btn.style.background = flag === 'Rush' ? '#dc3545' : 'white';
                    btn.style.color = flag === 'Rush' ? 'white' : '#dc3545';
                } else if (btn.id === 'flagFilterHold') {
                    btn.style.background = flag === 'Hold' ? '#ffc107' : 'white';
                    btn.style.color = flag === 'Hold' ? '#212529' : '#856404';
                } else if (btn.id === 'flagFilterReview') {
                    btn.style.background = flag === 'Review' ? '#fd7e14' : 'white';
                    btn.style.color = flag === 'Review' ? 'white' : '#fd7e14';
                }
            }

            filterSamples();
        }

        // Ready for stage filtering
        var currentReadyFilter = null;

        function filterReadyFor(stage) {
            currentReadyFilter = stage;

            // Update button styles
            var buttons = document.querySelectorAll('.ready-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                btn.style.background = 'white';
                btn.style.color = '#17a2b8';
            }

            var activeBtn = document.getElementById('readyFilter' + stage);
            if (activeBtn) {
                activeBtn.style.background = '#17a2b8';
                activeBtn.style.color = 'white';
            }

            // Determine what status to show
            var targetStatus = '';
            if (stage === 'BAP') targetStatus = 'Received';
            else if (stage === 'TSB') targetStatus = 'BAP Complete';
            else if (stage === 'Extraction') targetStatus = 'TSB Complete';
            else if (stage === 'CleanExtraction') targetStatus = 'Extraction Complete';
            else if (stage === 'CEQubit') targetStatus = 'Clean Extraction Complete';
            else if (stage === 'Indexing') targetStatus = 'Clean Extraction Qubit Complete';
            else if (stage === 'FinalQubit') targetStatus = 'Indexing Complete';

            // Set the status filter radio button
            var radios = document.getElementsByName('statusFilter');
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].value === targetStatus) {
                    radios[i].checked = true;
                    break;
                }
            }

            filterSamples();
        }

        // Change sample flag
        function changeFlag(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            var currentFlag = sample.flag || 'None';
            var options = ['None', 'Rush', 'Hold', 'Review'];
            var message = 'Current flag: ' + currentFlag + '\n\nSelect new flag:\n\n';
            message += '1 = None (no flag)\n';
            message += '2 = Rush üî¥ (expedited processing)\n';
            message += '3 = Hold ‚è∏Ô∏è (do not process)\n';
            message += '4 = Review ‚ö†Ô∏è (needs QC review)';

            var choice = prompt(message, currentFlag === 'None' ? '1' : currentFlag === 'Rush' ? '2' : currentFlag === 'Hold' ? '3' : '4');

            if (choice === null) return; // Cancelled

            var newFlag = 'None';
            if (choice === '1') newFlag = 'None';
            else if (choice === '2') newFlag = 'Rush';
            else if (choice === '3') newFlag = 'Hold';
            else if (choice === '4') newFlag = 'Review';
            else if (choice === 'None') newFlag = 'None';
            else if (choice === 'Rush') newFlag = 'Rush';
            else if (choice === 'Hold') newFlag = 'Hold';
            else if (choice === 'Review') newFlag = 'Review';

            sample.flag = newFlag;
            saveData();
            renderSamples();

            alert('Flag changed to: ' + newFlag);
        }

        // Clone/duplicate sample
        function cloneSample(sampleId) {
            var original = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    original = samples[i];
                    break;
                }
            }

            if (!original) return;

            var newId = prompt('Clone sample: ' + sampleId + '\n\nEnter new sample ID:', sampleId + '-COPY');
            if (!newId) return;

            newId = newId.trim();

            // Check for duplicates
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === newId) {
                    alert('Sample ID already exists: ' + newId);
                    return;
                }
            }

            // Create a deep copy of the sample
            var cloned = JSON.parse(JSON.stringify(original));
            cloned.id = newId;
            cloned.dateAdded = new Date().toLocaleDateString();

            samples.push(cloned);
            saveData();
            renderSamples();

            alert('Sample cloned successfully!\nOriginal: ' + sampleId + '\nNew: ' + newId);
        }

        // QC Fail tracking
        function markQCFailed(sampleId, stage) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            var reasons = [
                'Concentration too low',
                'Concentration too high',
                'No amplification',
                'Contamination suspected',
                'Reagent issue',
                'Equipment malfunction',
                'User error',
                'Other'
            ];

            var message = '‚ö†Ô∏è MARK AS QC FAILED\n\n';
            message += 'Sample: ' + sampleId + '\n';
            message += 'Stage: ' + stage + '\n\n';
            message += 'Select failure reason:\n\n';
            for (var i = 0; i < reasons.length; i++) {
                message += (i + 1) + ' = ' + reasons[i] + '\n';
            }

            var choice = prompt(message + '\nOr type a custom reason:');
            if (choice === null) return; // Cancelled

            var failReason = '';
            var choiceNum = parseInt(choice);
            if (!isNaN(choiceNum) && choiceNum >= 1 && choiceNum <= reasons.length) {
                failReason = reasons[choiceNum - 1];
            } else {
                failReason = choice.trim();
            }

            if (!failReason) {
                alert('QC failure reason is required!');
                return;
            }

            // Add additional notes
            var notes = prompt('Additional notes (optional):');

            sample.status = 'QC Failed';
            if (!sample.qcFailures) sample.qcFailures = [];

            sample.qcFailures.push({
                stage: stage,
                reason: failReason,
                notes: notes || '',
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            });

            saveData();
            renderSamples();

            alert('Sample marked as QC Failed\nReason: ' + failReason);
        }

        function reprocessSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            if (!sample.qcFailures || sample.qcFailures.length === 0) {
                alert('No QC failure history found');
                return;
            }

            var lastFailure = sample.qcFailures[sample.qcFailures.length - 1];

            var message = 'üîÑ RE-PROCESS SAMPLE\n\n';
            message += 'Sample: ' + sampleId + '\n';
            message += 'Last failure: ' + lastFailure.stage + '\n';
            message += 'Reason: ' + lastFailure.reason + '\n\n';
            message += 'Reset to which stage?\n\n';
            message += '1 = Received (start over)\n';
            message += '2 = Extraction Complete (redo clean extraction)\n';
            message += '3 = Clean Extraction Complete (redo Qubit)\n';
            message += '4 = Clean Extraction Qubit Complete (redo indexing)\n';
            message += '5 = Indexing Complete (redo final Qubit)\n';

            var choice = prompt(message, '3');
            if (choice === null) return; // Cancelled

            var newStatus = 'Received';
            if (choice === '1') newStatus = 'Received';
            else if (choice === '2') newStatus = 'Extraction Complete';
            else if (choice === '3') newStatus = 'Clean Extraction Complete';
            else if (choice === '4') newStatus = 'Clean Extraction Qubit Complete';
            else if (choice === '5') newStatus = 'Indexing Complete';

            sample.status = newStatus;

            // Track re-processing
            if (!sample.reprocessCount) sample.reprocessCount = 0;
            sample.reprocessCount++;

            saveData();
            renderSamples();

            alert('Sample reset to: ' + newStatus + '\nRe-process count: ' + sample.reprocessCount);
        }

        // Undo functionality
        function trackAction(actionType, data) {
            undoStack.push({
                type: actionType,
                data: JSON.parse(JSON.stringify(data)), // Deep copy
                timestamp: new Date().toISOString()
            });

            // Keep only last 10 actions
            if (undoStack.length > 10) {
                undoStack.shift();
            }

            updateUndoButton();
        }

        function updateUndoButton() {
            var btn = document.getElementById('undoBtn');
            if (undoStack.length > 0) {
                btn.disabled = false;
                btn.style.background = '#ffc107';
                btn.style.color = '#212529';
                var lastAction = undoStack[undoStack.length - 1];
                btn.title = 'Undo: ' + lastAction.type;
            } else {
                btn.disabled = true;
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
                btn.title = 'No actions to undo';
            }
        }

        function undo() {
            if (undoStack.length === 0) {
                alert('Nothing to undo');
                return;
            }

            var action = undoStack.pop();

            if (action.type === 'Add Sample' || action.type === 'Add Bulk Samples') {
                // Remove the samples that were added
                var addedIds = action.data.sampleIds;
                samples = samples.filter(function(s) {
                    return addedIds.indexOf(s.id) === -1;
                });
                alert('Undone: ' + action.type + '\nRemoved ' + addedIds.length + ' sample(s)');
            } else if (action.type === 'Delete Sample') {
                // Restore the deleted sample
                samples.push(action.data.sample);
                alert('Undone: Delete Sample\nRestored sample: ' + action.data.sample.id);
            } else if (action.type === 'Complete Process') {
                // Restore sample to previous state
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.sampleId) {
                        samples[i] = JSON.parse(JSON.stringify(action.data.previousState));
                        break;
                    }
                }
                alert('Undone: Process completion for ' + action.data.sampleId);
            } else if (action.type === 'Batch Complete Process') {
                // Restore multiple samples
                for (var j = 0; j < action.data.samples.length; j++) {
                    var oldSample = action.data.samples[j];
                    for (var i = 0; i < samples.length; i++) {
                        if (samples[i].id === oldSample.id) {
                            samples[i] = JSON.parse(JSON.stringify(oldSample));
                            break;
                        }
                    }
                }
                alert('Undone: Batch process\nRestored ' + action.data.samples.length + ' samples');
            } else if (action.type === 'Edit Sample') {
                // Restore original values
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.newId || samples[i].id === action.data.originalId) {
                        samples[i].id = action.data.originalId;
                        samples[i].initials = action.data.originalInitials;
                        samples[i].status = action.data.originalStatus;
                        break;
                    }
                }
                alert('Undone: Edit\nRestored sample: ' + action.data.originalId);
            } else if (action.type === 'Change Flag') {
                // Restore original flag
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.sampleId) {
                        samples[i].flag = action.data.oldFlag;
                        break;
                    }
                }
                alert('Undone: Flag change for ' + action.data.sampleId);
            }

            saveData();
            renderSamples();
            updateUndoButton();
        }

        // Track recently used lot numbers
        function trackLotNumber(fieldName, value) {
            if (!value || value.trim() === '') return;

            if (!reagentLotHistory[fieldName]) {
                reagentLotHistory[fieldName] = [];
            }

            // Remove if already exists (move to front)
            var index = reagentLotHistory[fieldName].indexOf(value);
            if (index > -1) {
                reagentLotHistory[fieldName].splice(index, 1);
            }

            // Add to front, keep only last 5
            reagentLotHistory[fieldName].unshift(value);
            if (reagentLotHistory[fieldName].length > 5) {
                reagentLotHistory[fieldName].pop();
            }

            // Save to localStorage
            localStorage.setItem('reagentLotHistory', JSON.stringify(reagentLotHistory));
        }

        // Get recent lot numbers for autocomplete
        function getRecentLots(fieldName) {
            return reagentLotHistory[fieldName] || [];
        }

        // Add datalist for autocomplete to an input field
        function addAutocomplete(inputId, fieldName) {
            var input = document.getElementById(inputId);
            if (!input) return;

            var datalistId = inputId + 'List';
            var existingDatalist = document.getElementById(datalistId);
            if (existingDatalist) {
                existingDatalist.remove();
            }

            var datalist = document.createElement('datalist');
            datalist.id = datalistId;

            var recentLots = getRecentLots(fieldName);
            for (var i = 0; i < recentLots.length; i++) {
                var option = document.createElement('option');
                option.value = recentLots[i];
                datalist.appendChild(option);
            }

            document.body.appendChild(datalist);
            input.setAttribute('list', datalistId);
        }

        function createReferenceTable(sampleIds, sourceType, targetType, targetStartNumber) {
            var html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Sample ID</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Use ' + sourceType.toUpperCase() + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">New ' + targetType.toUpperCase() + '</th>';
            html += '</tr>';
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                var sourceNumber = 'N/A';
                var targetNumber = 'N/A';
                
                if (sourceType === 'bap' && sample && sample.bapNumber) {
                    sourceNumber = sample.bapNumber;
                } else if (sourceType === 'tsb' && sample && sample.tsbNumber) {
                    sourceNumber = sample.tsbNumber;
                } else if (sourceType === 'extraction' && sample && sample.extractionNumber) {
                    sourceNumber = sample.extractionNumber;
                } else if (sourceType === 'cleanExtraction' && sample && sample.cleanExtractionNumber) {
                    sourceNumber = sample.cleanExtractionNumber;
                } else if (sourceType === 'indexing' && sample && sample.indexingNumber) {
                    sourceNumber = sample.indexingNumber;
                }
                
                if (targetType === 'TSB') {
                    targetNumber = '25T' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Extraction') {
                    targetNumber = '25E' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Clean Extraction') {
                    targetNumber = '25CE' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Indexing') {
                    targetNumber = '25XT' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Qubit') {
                    targetNumber = 'Qubit Analysis';
                }
                
                html += '<tr>';
                html += '<td style="padding: 8px; border: 1px solid #ddd;"><strong>' + sampleId + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #1976d2;"><strong>' + sourceNumber + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #2e7d32;"><strong>' + targetNumber + '</strong></td>';
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            return html;
        }

        // Real-time duplicate check as user types
        function checkDuplicateRealtime(input) {
            var sampleId = input.value.trim();
            var warning = document.getElementById('duplicateWarning');

            if (!sampleId) {
                warning.style.display = 'none';
                input.style.border = '';
                input.style.background = '';
                return;
            }

            var isDuplicate = false;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                warning.style.display = 'inline';
                input.style.border = '2px solid #dc3545';
                input.style.background = '#ffe6e6';
            } else {
                warning.style.display = 'none';
                input.style.border = '2px solid #28a745';
                input.style.background = '#e6ffe6';
            }
        }

        // Voice Input Feature
        var voiceRecognition = null;
        var currentVoiceTarget = null;

        function initializeVoiceRecognition() {
            // Check if browser supports speech recognition
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.log('Speech recognition not supported in this browser');
                return false;
            }

            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = false;
            voiceRecognition.lang = 'en-US';

            voiceRecognition.onstart = function() {
                var statusDiv = document.getElementById('voiceStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = 'üé§ Listening... Speak now!';
                    statusDiv.style.background = '#e3f2fd';
                    statusDiv.style.color = '#1976d2';
                }

                // Visual feedback on button
                if (currentVoiceTarget === 'sampleId') {
                    document.getElementById('voiceSampleBtn').style.background = '#d32f2f';
                    document.getElementById('voiceSampleBtn').innerHTML = 'üî¥ Listening...';
                } else if (currentVoiceTarget === 'initials') {
                    document.getElementById('voiceInitialsBtn').style.background = '#d32f2f';
                    document.getElementById('voiceInitialsBtn').innerHTML = 'üî¥';
                }
            };

            voiceRecognition.onresult = function(event) {
                var transcript = event.results[0][0].transcript;
                var confidence = event.results[0][0].confidence;

                console.log('Voice recognition result:', transcript, 'Confidence:', confidence);

                // Clean up the transcript
                var cleanedText = transcript.trim();

                // For initials, take first 3 characters and uppercase
                if (currentVoiceTarget === 'initials') {
                    cleanedText = cleanedText.replace(/\s/g, '').substring(0, 3).toUpperCase();
                }

                // Fill the target field
                var targetField = document.getElementById(currentVoiceTarget);
                if (targetField) {
                    targetField.value = cleanedText;

                    // Trigger duplicate check if it's the sample ID field
                    if (currentVoiceTarget === 'sampleId') {
                        checkDuplicateRealtime(targetField);
                    }
                }

                // Show success feedback
                var statusDiv = document.getElementById('voiceStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '‚úÖ Heard: "' + transcript + '"' +
                                        (confidence < 0.8 ? ' (Low confidence: ' + Math.round(confidence * 100) + '%)' : '');
                    statusDiv.style.background = '#e8f5e9';
                    statusDiv.style.color = '#2e7d32';

                    setTimeout(function() {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
            };

            voiceRecognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);

                var statusDiv = document.getElementById('voiceStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';

                    if (event.error === 'no-speech') {
                        statusDiv.innerHTML = '‚ùå No speech detected. Try again!';
                    } else if (event.error === 'not-allowed') {
                        statusDiv.innerHTML = '‚ùå Microphone access denied. Please allow microphone access.';
                    } else {
                        statusDiv.innerHTML = '‚ùå Error: ' + event.error;
                    }

                    setTimeout(function() {
                        statusDiv.style.display = 'none';
                    }, 4000);
                }

                // Reset button state
                resetVoiceButton();
            };

            voiceRecognition.onend = function() {
                resetVoiceButton();
            };

            return true;
        }

        function resetVoiceButton() {
            if (currentVoiceTarget === 'sampleId') {
                var btn = document.getElementById('voiceSampleBtn');
                if (btn) {
                    btn.style.background = '#17a2b8';
                    btn.innerHTML = 'üé§ Speak ID';
                }
            } else if (currentVoiceTarget === 'initials') {
                var btn = document.getElementById('voiceInitialsBtn');
                if (btn) {
                    btn.style.background = '#17a2b8';
                    btn.innerHTML = 'üé§';
                }
            }
        }

        function startVoiceInput(targetFieldId) {
            currentVoiceTarget = targetFieldId;

            // Initialize voice recognition if not already done
            if (!voiceRecognition) {
                var initialized = initializeVoiceRecognition();
                if (!initialized) {
                    alert('Voice recognition is not supported in this browser.\n\nPlease use Chrome, Edge, or Safari for voice input.');
                    return;
                }
            }

            try {
                voiceRecognition.start();
            } catch (e) {
                console.error('Error starting voice recognition:', e);

                // If already running, stop and restart
                if (e.message && e.message.includes('already started')) {
                    voiceRecognition.stop();
                    setTimeout(function() {
                        voiceRecognition.start();
                    }, 100);
                }
            }
        }

        function addSample(keepOpen) {
            var sampleId = document.getElementById('sampleId').value.trim();
            var initials = document.getElementById('initials').value.trim().toUpperCase();
            var feedbackDiv = document.getElementById('quickAddFeedback');

            if (!sampleId || !initials) {
                if (keepOpen && feedbackDiv) {
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.background = '#ffe6e6';
                    feedbackDiv.style.color = '#dc3545';
                    feedbackDiv.innerHTML = '‚ùå Please fill in both fields';
                    setTimeout(function() { feedbackDiv.style.display = 'none'; }, 2000);
                } else {
                    alert('Please fill in both fields');
                }
                return;
            }

            // Check for duplicates with detailed info
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    var existingSample = samples[i];

                    if (keepOpen && feedbackDiv) {
                        feedbackDiv.style.display = 'block';
                        feedbackDiv.style.background = '#ffe6e6';
                        feedbackDiv.style.color = '#dc3545';
                        feedbackDiv.innerHTML = '‚ùå Duplicate: ' + sampleId + ' already exists (added ' + existingSample.dateAdded + ')';
                    } else {
                        var msg = '‚ö†Ô∏è DUPLICATE SAMPLE ID\n\n';
                        msg += 'Sample ID: ' + sampleId + '\n';
                        msg += 'Already exists with:\n';
                        msg += '‚Ä¢ Status: ' + existingSample.status + '\n';
                        msg += '‚Ä¢ Added: ' + existingSample.dateAdded + '\n';
                        msg += '‚Ä¢ By: ' + existingSample.initials + '\n\n';
                        msg += 'Cannot add duplicate sample ID!';
                        alert(msg);
                    }

                    // Highlight the input field
                    var inputField = document.getElementById('sampleId');
                    inputField.style.border = '3px solid #dc3545';
                    inputField.style.background = '#ffe6e6';
                    setTimeout(function() {
                        inputField.style.border = '';
                        inputField.style.background = '';
                    }, 3000);

                    return;
                }
            }

            var newSample = {
                id: sampleId,
                initials: initials,
                status: 'Received',
                dateAdded: new Date().toLocaleDateString(),
                notes: '',
                flag: 'None',
                bapNumber: null,
                bapDetails: null,
                tsbNumber: null,
                tsbDetails: null,
                extractionNumber: null,
                extractionDetails: null,
                cleanExtractionNumber: null,
                cleanExtractionDetails: null,
                indexingNumber: null,
                indexingDetails: null,
                qubitDetails: null
            };

            samples.push(newSample);
            trackAction('Add Sample', {sampleIds: [sampleId]});
            saveData();
            renderSamples();

            if (keepOpen) {
                // Quick Add Mode: Keep initials, clear sample ID, show feedback, focus on ID field
                document.getElementById('sampleId').value = '';
                if (feedbackDiv) {
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.background = '#e6ffe6';
                    feedbackDiv.style.color = '#28a745';
                    feedbackDiv.innerHTML = '‚úÖ Added: ' + sampleId + ' (' + samples.length + ' samples total)';
                    setTimeout(function() { feedbackDiv.style.display = 'none'; }, 2000);
                }
                document.getElementById('sampleId').focus();
            } else {
                // Normal mode: Clear both fields
                document.getElementById('sampleId').value = '';
                document.getElementById('initials').value = '';
            }
        }

        function toggleBulkInput() {
            var single = document.getElementById('singleInput');
            var bulk = document.getElementById('bulkInput');
            var btn = document.getElementById('toggleBulk');
            
            if (single.style.display === 'none') {
                single.style.display = 'block';
                bulk.style.display = 'none';
                btn.textContent = 'Switch to Bulk Input';
            } else {
                single.style.display = 'none';
                bulk.style.display = 'block';
                btn.textContent = 'Switch to Single Input';
            }
        }

        function addBulkSamples() {
            var text = document.getElementById('bulkSamples').value.trim();
            var initials = document.getElementById('bulkInitials').value.trim().toUpperCase();
            
            if (!text || !initials) {
                alert('Please enter initials and paste sample IDs');
                return;
            }
            
            var lines = text.split('\n');
            var sampleIds = [];
            
            // Clean up the input lines
            for (var i = 0; i < lines.length; i++) {
                var id = lines[i].trim();
                if (id.length > 0) {
                    sampleIds.push(id);
                }
            }
            
            if (sampleIds.length === 0) {
                alert('No valid sample IDs found');
                return;
            }
            
            var added = 0;
            var duplicates = [];
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                
                // Check for duplicates
                var isDuplicate = false;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        duplicates.push(sampleId);
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    var newSample = {
                        id: sampleId,
                        initials: initials,
                        status: 'Received',
                        dateAdded: new Date().toLocaleDateString(),
                        notes: '',
                        flag: 'None',
                        bapNumber: null,
                        bapDetails: null,
                        tsbNumber: null,
                        tsbDetails: null,
                        extractionNumber: null,
                        extractionDetails: null,
                        cleanExtractionNumber: null,
                        cleanExtractionDetails: null,
                        indexingNumber: null,
                        indexingDetails: null,
                        qubitDetails: null
                    };
                    
                    samples.push(newSample);
                    added++;
                }
            }

            saveData();
            renderSamples();

            // Clear the form
            document.getElementById('bulkSamples').value = '';
            document.getElementById('bulkInitials').value = '';

            // Show results
            var message = 'Successfully added ' + added + ' new samples!';
            if (duplicates.length > 0) {
                message += '\n\nSkipped ' + duplicates.length + ' duplicates: ' + duplicates.join(', ');
            }
            alert(message);
        }

        function startProcess(sampleId, type) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentProcessType = type;
            var number = '';

            if (type === 'BAP') {
                number = '25B' + String(nextBapNumber).padStart(3, '0');
            } else if (type === 'TSB') {
                number = '25T' + String(nextTsbNumber).padStart(3, '0');
            } else if (type === 'Extraction') {
                number = '25E' + String(nextExtractionNumber).padStart(3, '0');
            } else if (type === 'Clean Extraction') {
                number = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
            } else if (type === 'Indexing') {
                number = '25XT' + String(nextIndexingNumber).padStart(3, '0');
            } else if (type === 'Qubit') {
                number = 'Qubit Analysis';
            }

            document.getElementById('modalTitle').textContent = 'Start ' + type;
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';

            showSpecificFields(type);
            document.getElementById('processModal').style.display = 'block';

            // Add autocomplete to lot number field
            setTimeout(function() {
                addAutocomplete('lotNumber', 'lotNumber');
            }, 100);
        }

        function finishProcess(sampleId, type) {
            // This function handles FINISHING incubation for BAP and TSB
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentProcessType = type + '_FINISH';
            var number = '';

            if (type === 'BAP') {
                number = sample.bapNumber || '';
            } else if (type === 'TSB') {
                number = sample.tsbNumber || '';
            }

            document.getElementById('modalTitle').textContent = 'Finish ' + type + ' Incubation';
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';

            // Pre-fill existing data from the start phase
            if (type === 'BAP' && sample.bapDetails) {
                document.getElementById('techInitials').value = sample.bapDetails.technician || '';
                document.getElementById('lotNumber').value = sample.bapDetails.lot || '';
                document.getElementById('temperature').value = sample.bapDetails.temperature || '37';
                document.getElementById('incubator').value = sample.bapDetails.incubator || 'INC-1';
                document.getElementById('timeIn').value = sample.bapDetails.timeIn || '';
                document.getElementById('stageNotes').value = sample.bapDetails.stageNotes || '';
            } else if (type === 'TSB' && sample.tsbDetails) {
                document.getElementById('techInitials').value = sample.tsbDetails.technician || '';
                document.getElementById('lotNumber').value = sample.tsbDetails.lot || '';
                document.getElementById('temperature').value = sample.tsbDetails.temperature || '37';
                document.getElementById('incubator').value = sample.tsbDetails.incubator || 'INC-1';
                document.getElementById('timeIn').value = sample.tsbDetails.timeIn || '';
                document.getElementById('stageNotes').value = sample.tsbDetails.stageNotes || '';
            }

            // Clear time out field and focus it
            document.getElementById('timeOut').value = '';

            showSpecificFields('');  // No specific fields needed for finish
            document.getElementById('processModal').style.display = 'block';

            // Focus on Time Out field after a brief delay
            setTimeout(function() {
                document.getElementById('timeOut').focus();
            }, 100);
        }

        function showSpecificFields(type) {
            var container = document.getElementById('specificFields');
            var html = '';
            
            if (type === 'TSB') {
                // Add BAP reference for TSB
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.bapDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã BAP Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use BAP:</strong> ' + sample.bapNumber + '</div>';
                    html += '<div><strong>BAP Tech:</strong> ' + sample.bapDetails.technician + '</div>';
                    html += '<div><strong>BAP Date:</strong> ' + sample.bapDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Extraction') {
                // Add TSB reference for Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.tsbDetails) {
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #856404;">üß´ TSB Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use TSB:</strong> ' + sample.tsbNumber + '</div>';
                    html += '<div><strong>TSB Tech:</strong> ' + sample.tsbDetails.technician + '</div>';
                    html += '<div><strong>TSB Date:</strong> ' + sample.tsbDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add extraction-specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #7b1fa2;">Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Extraction Run:</label>';
                html += '<input type="text" id="extractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW1 Lot:</label>';
                html += '<input type="text" id="aw1Lot" placeholder="AW1LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW2 Lot:</label>';
                html += '<input type="text" id="aw2Lot" placeholder="AW2LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Ethanol Lot:</label>';
                html += '<input type="text" id="ethanolLot" placeholder="ETH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AL Lot:</label>';
                html += '<input type="text" id="bufferALLot" placeholder="AL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer ATL Lot:</label>';
                html += '<input type="text" id="bufferATLLot" placeholder="ATL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AE Lot:</label>';
                html += '<input type="text" id="bufferAELot" placeholder="AE123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Proteinase K Lot:</label>';
                html += '<input type="text" id="proteinaseKLot" placeholder="PK123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">DNeasy Column Lot:</label>';
                html += '<input type="text" id="dneasyLot" placeholder="COL123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Clean Extraction') {
                // Add Extraction reference for Clean Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.extractionDetails) {
                    html += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #9c27b0;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Extraction:</strong> ' + sample.extractionNumber + '</div>';
                    html += '<div><strong>Extraction Tech:</strong> ' + sample.extractionDetails.technician + '</div>';
                    html += '<div><strong>Extraction Date:</strong> ' + sample.extractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add clean extraction specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #2e7d32;">Clean Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="storagePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                var nextWell = getNextWellPosition('cleanExtraction');
                html += '<input type="text" id="wellPosition" value="' + nextWell + '" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-incremented from last: ' + (lastWellPositions['cleanExtraction'] || 'none') + '</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Bead Lot:</label>';
                html += '<input type="text" id="beadLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O ETOH Dilution:</label>';
                html += '<input type="text" id="nfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH Dilution:</label>';
                html += '<input type="text" id="etohDilutionLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O Elution:</label>';
                html += '<input type="text" id="nfH2oElutionLot" placeholder="ELUT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Qubit Reagent:</label>';
                html += '<input type="text" id="qubitReagentLot" placeholder="QUBIT123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Cleanup Volume:</label>';
                html += '<input type="text" id="cleanupVolume" placeholder="1.2x" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution In:</label>';
                html += '<input type="text" id="elutionVolumeIn" placeholder="50uL" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution Out:</label>';
                html += '<input type="text" id="elutionVolumeOut" placeholder="45uL" style="width: 80px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Indexing') {
                // Add Clean Extraction reference for Indexing
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.cleanExtractionDetails) {
                    html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
                    html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
                    html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add indexing specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #1976d2;">Indexing (XT) Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="indexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                var nextIndexWell = getNextWellPosition('indexing');
                html += '<input type="text" id="indexingWellPosition" value="' + nextIndexWell + '" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-incremented from last: ' + (lastWellPositions['indexing'] || 'none') + '</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Index Assignment:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Index:</label>';
                html += '<input type="text" id="i5Index" placeholder="i5-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Index:</label>';
                html += '<input type="text" id="i7Index" placeholder="i7-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Thaws:</label>';
                html += '<input type="number" id="i5Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Thaws:</label>';
                html += '<input type="number" id="i7Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">TD Buffer:</label>';
                html += '<input type="text" id="tdBufferLot" placeholder="TD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">ATM Buffer:</label>';
                html += '<input type="text" id="atmBufferLot" placeholder="ATM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NT Buffer:</label>';
                html += '<input type="text" id="ntBufferLot" placeholder="NT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NPM:</label>';
                html += '<input type="text" id="npmLot" placeholder="NPM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Resuspension Buffer:</label>';
                html += '<input type="text" id="resuspensionBufferLot" placeholder="RES123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Indexes Kit:</label>';
                html += '<input type="text" id="indexesKitLot" placeholder="IDX123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Beads:</label>';
                html += '<input type="text" id="indexingBeadsLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH:</label>';
                html += '<input type="text" id="indexingEtohLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O:</label>';
                html += '<input type="text" id="indexingNfH2oLot" placeholder="H2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Double-Sided Clean Up:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 1 Concentrations:</label>';
                html += '<input type="text" id="cleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 2 Concentrations:</label>';
                html += '<input type="text" id="cleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;">';
                html += '</div>';
                
                html += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    // Add Clean Extraction reference for Clean Extraction Qubit
    var sampleId = document.getElementById('modalSampleId').textContent;
    var sample = null;
    for (var i = 0; i < samples.length; i++) {
        if (samples[i].id === sampleId) {
            sample = samples[i];
            break;
        }
    }
    
    if (sample && sample.cleanExtractionDetails) {
        html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
        html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reference</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
        html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
        html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
        html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
        html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    // Add Clean Extraction Qubit-specific fields
    html += '<h4 style="margin: 20px 0 10px 0; color: #1565c0;">üìä Clean Extraction Qubit Analysis</h4>';
    
    html += '<div class="form-group">';
    html += '<label>Concentration (ng/uL):</label>';
    html += '<input type="number" id="qubitConcentration" step="0.1" onchange="validateQubitValue(this, \'cleanExtractionQubit\')">';
    html += '<div id="qubitValidation" style="margin-top: 5px; font-size: 12px;"></div>';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Qubit Reagent Lot:</label>';
    html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Date Qubited:</label>';
    html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    html += '</div>';
            } else if (type === 'Final Qubit') {
                            // Add Indexing reference for Qubit
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.indexingDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Indexing:</strong> ' + sample.indexingNumber + '</div>';
                    html += '<div><strong>Indexing Tech:</strong> ' + sample.indexingDetails.technician + '</div>';
                    html += '<div><strong>Indexing Date:</strong> ' + sample.indexingDetails.completedDate + '</div>';
                    if (sample.indexingDetails.i5 && sample.indexingDetails.i7) {
                        html += '<div><strong>i5 Index:</strong> ' + sample.indexingDetails.i5 + '</div>';
                        html += '<div><strong>i7 Index:</strong> ' + sample.indexingDetails.i7 + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '<h4 style="margin: 20px 0 10px 0; color: #f57c00;">üìä Qubit Analysis</h4>';

html += '<div class="form-group">';
html += '<label>Concentration (ng/uL):</label>';
html += '<input type="number" id="qubitConcentration" step="0.1" onchange="validateQubitValue(this, \'finalQubit\')">';
html += '<div id="qubitValidation" style="margin-top: 5px; font-size: 12px;"></div>';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Qubit Reagent Lot:</label>';
html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Date Qubited:</label>';
html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
html += '</div>';
            }

            container.innerHTML = html;

            // Add autocomplete to all reagent lot fields after a short delay
            setTimeout(function() {
                // Extraction reagent lots
                addAutocomplete('aw1Lot', 'aw1Lot');
                addAutocomplete('aw2Lot', 'aw2Lot');
                addAutocomplete('ethanolLot', 'ethanolLot');
                addAutocomplete('bufferALLot', 'bufferALLot');
                addAutocomplete('bufferATLLot', 'bufferATLLot');
                addAutocomplete('bufferAELot', 'bufferAELot');
                addAutocomplete('proteinaseKLot', 'proteinaseKLot');
                addAutocomplete('dneasyLot', 'dneasyLot');

                // Clean Extraction reagent lots
                addAutocomplete('beadLot', 'beadLot');
                addAutocomplete('nfH2oEtohLot', 'nfH2oEtohLot');
                addAutocomplete('etohDilutionLot', 'etohDilutionLot');
                addAutocomplete('nfH2oElutionLot', 'nfH2oElutionLot');
                addAutocomplete('qubitReagentLot', 'qubitReagentLot');

                // Indexing reagent lots
                addAutocomplete('tdBufferLot', 'tdBufferLot');
                addAutocomplete('atmBufferLot', 'atmBufferLot');
                addAutocomplete('ntBufferLot', 'ntBufferLot');
                addAutocomplete('npmLot', 'npmLot');
                addAutocomplete('resuspensionBufferLot', 'resuspensionBufferLot');
                addAutocomplete('indexesKitLot', 'indexesKitLot');
                addAutocomplete('indexingBeadsLot', 'indexingBeadsLot');
                addAutocomplete('indexingEtohLot', 'indexingEtohLot');
                addAutocomplete('indexingNfH2oLot', 'indexingNfH2oLot');
            }, 100);
        }

        function completeProcess() {
            var tech = document.getElementById('techInitials').value.trim();
            var lot = document.getElementById('lotNumber').value.trim();
            var temp = document.getElementById('temperature').value;
            var inc = document.getElementById('incubator').value;
            var timeIn = document.getElementById('timeIn').value;
            var timeOut = document.getElementById('timeOut').value;
            var stageNotes = document.getElementById('stageNotes').value.trim();

            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var sampleId = document.getElementById('modalSampleId').textContent;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            
            if (sample) {
                var today = new Date().toLocaleDateString();
                
                if (currentProcessType === 'BAP') {
                    // START BAP - Starting incubation
                    if (!timeIn) {
                        alert('Please enter Time In to start incubation');
                        return;
                    }
                    sample.bapNumber = '25B' + String(nextBapNumber).padStart(3, '0');
                    sample.status = 'BAP In Progress';
                    sample.bapDetails = {
                        technician: tech,
                        lot: lot,
                        startedDate: today,
                        temperature: temp,
                        incubator: inc,
                        timeIn: timeIn,
                        timeOut: '',
                        stageNotes: stageNotes
                    };
                    nextBapNumber++;
                    trackAction('process', sample.id, 'Started BAP incubation');
                } else if (currentProcessType === 'BAP_FINISH') {
                    // FINISH BAP - Finishing incubation
                    if (!timeOut) {
                        alert('Please enter Time Out to finish incubation');
                        return;
                    }
                    sample.status = 'BAP Complete';
                    sample.bapDetails.timeOut = timeOut;
                    sample.bapDetails.completedDate = today;
                    // Update stage notes if changed
                    if (stageNotes) {
                        sample.bapDetails.stageNotes = stageNotes;
                    }
                    trackAction('process', sample.id, 'Finished BAP incubation');
                } else if (currentProcessType === 'TSB') {
                    // START TSB - Starting incubation
                    if (!timeIn) {
                        alert('Please enter Time In to start incubation');
                        return;
                    }
                    sample.tsbNumber = '25T' + String(nextTsbNumber).padStart(3, '0');
                    sample.status = 'TSB In Progress';
                    sample.tsbDetails = {
                        technician: tech,
                        lot: lot,
                        startedDate: today,
                        temperature: temp,
                        incubator: inc,
                        timeIn: timeIn,
                        timeOut: '',
                        stageNotes: stageNotes
                    };
                    nextTsbNumber++;
                    trackAction('process', sample.id, 'Started TSB incubation');
                } else if (currentProcessType === 'TSB_FINISH') {
                    // FINISH TSB - Finishing incubation
                    if (!timeOut) {
                        alert('Please enter Time Out to finish incubation');
                        return;
                    }
                    sample.status = 'TSB Complete';
                    sample.tsbDetails.timeOut = timeOut;
                    sample.tsbDetails.completedDate = today;
                    // Update stage notes if changed
                    if (stageNotes) {
                        sample.tsbDetails.stageNotes = stageNotes;
                    }
                    trackAction('process', sample.id, 'Finished TSB incubation');
                } else if (currentProcessType === 'Extraction') {
                    sample.extractionNumber = '25E' + String(nextExtractionNumber).padStart(3, '0');
                    sample.status = 'Extraction Complete';
                    sample.extractionDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        extractionRun: document.getElementById('extractionRun').value,
                        reagentLots: {
                            aw1: document.getElementById('aw1Lot').value,
                            aw2: document.getElementById('aw2Lot').value,
                            ethanol: document.getElementById('ethanolLot').value,
                            bufferAL: document.getElementById('bufferALLot').value,
                            bufferATL: document.getElementById('bufferATLLot').value,
                            bufferAE: document.getElementById('bufferAELot').value,
                            proteinaseK: document.getElementById('proteinaseKLot').value,
                            dneasy: document.getElementById('dneasyLot').value
                        },
                        stageNotes: stageNotes
                    };
                    nextExtractionNumber++;
                    if (nextExtractionNumber % 24 === 1) {
                        nextExtractionRun++;
                    }
                } else if (currentProcessType === 'Clean Extraction') {
                    sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
                    sample.status = 'Clean Extraction Complete';
                    var ceWellPos = document.getElementById('wellPosition').value;
                    sample.cleanExtractionDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        storagePlate: document.getElementById('storagePlate').value,
                        wellPosition: ceWellPos,
                        reagentLots: {
                            bead: document.getElementById('beadLot').value,
                            nfH2oEtoh: document.getElementById('nfH2oEtohLot').value,
                            etohDilution: document.getElementById('etohDilutionLot').value,
                            nfH2oElution: document.getElementById('nfH2oElutionLot').value,
                            qubitReagent: document.getElementById('qubitReagentLot').value
                        },
                        volumes: {
                            cleanup: document.getElementById('cleanupVolume').value,
                            elutionIn: document.getElementById('elutionVolumeIn').value,
                            elutionOut: document.getElementById('elutionVolumeOut').value
                        },
                        stageNotes: stageNotes
                    };
                    trackWellPosition('cleanExtraction', ceWellPos);
                    nextCleanExtractionNumber++;
                    nextCleanExtractionPlate++;
                } else if (currentProcessType === 'Indexing') {
                    sample.indexingNumber = '25XT' + String(nextIndexingNumber).padStart(3, '0');
                    sample.status = 'Indexing Complete';
                    var indexWellPos = document.getElementById('indexingWellPosition').value;
                    sample.indexingDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        storagePlate: document.getElementById('indexingStoragePlate').value,
                        wellPosition: indexWellPos,
                        indexes: {
                            i5: document.getElementById('i5Index').value,
                            i7: document.getElementById('i7Index').value,
                            i5Thaws: document.getElementById('i5Thaws').value,
                            i7Thaws: document.getElementById('i7Thaws').value
                        },
                        reagentLots: {
                            tdBuffer: document.getElementById('tdBufferLot').value,
                            atmBuffer: document.getElementById('atmBufferLot').value,
                            ntBuffer: document.getElementById('ntBufferLot').value,
                            npm: document.getElementById('npmLot').value,
                            resuspensionBuffer: document.getElementById('resuspensionBufferLot').value,
                            indexesKit: document.getElementById('indexesKitLot').value,
                            beads: document.getElementById('indexingBeadsLot').value,
                            etoh: document.getElementById('indexingEtohLot').value,
                            nfH2o: document.getElementById('indexingNfH2oLot').value
                        },
                        cleanupConcentrations: {
                            step1: document.getElementById('cleanup1Concentrations').value,
                            step2: document.getElementById('cleanup2Concentrations').value
                        },
                        stageNotes: stageNotes
                    };
                    trackWellPosition('indexing', indexWellPos);
                    nextIndexingNumber++;
                    nextIndexingPlate++;
                } else if (currentProcessType === 'Clean Extraction Qubit') {
                    sample.status = 'Clean Extraction Qubit Complete';
                    sample.cleanExtractionQubitDetails = {
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today,
                        stageNotes: stageNotes
                    };
                } else if (currentProcessType === 'Final Qubit') {
                    sample.status = 'Qubit Complete';
                    sample.qubitDetails = {
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today,
                        stageNotes: stageNotes
                    };
                }

                // Track all lot numbers used in this process
                trackLotNumber('lotNumber', lot);

                if (currentProcessType === 'Extraction') {
                    trackLotNumber('aw1Lot', document.getElementById('aw1Lot').value);
                    trackLotNumber('aw2Lot', document.getElementById('aw2Lot').value);
                    trackLotNumber('ethanolLot', document.getElementById('ethanolLot').value);
                    trackLotNumber('bufferALLot', document.getElementById('bufferALLot').value);
                    trackLotNumber('bufferATLLot', document.getElementById('bufferATLLot').value);
                    trackLotNumber('bufferAELot', document.getElementById('bufferAELot').value);
                    trackLotNumber('proteinaseKLot', document.getElementById('proteinaseKLot').value);
                    trackLotNumber('dneasyLot', document.getElementById('dneasyLot').value);
                } else if (currentProcessType === 'Clean Extraction') {
                    trackLotNumber('beadLot', document.getElementById('beadLot').value);
                    trackLotNumber('nfH2oEtohLot', document.getElementById('nfH2oEtohLot').value);
                    trackLotNumber('etohDilutionLot', document.getElementById('etohDilutionLot').value);
                    trackLotNumber('nfH2oElutionLot', document.getElementById('nfH2oElutionLot').value);
                    trackLotNumber('qubitReagentLot', document.getElementById('qubitReagentLot').value);
                } else if (currentProcessType === 'Indexing') {
                    trackLotNumber('tdBufferLot', document.getElementById('tdBufferLot').value);
                    trackLotNumber('atmBufferLot', document.getElementById('atmBufferLot').value);
                    trackLotNumber('ntBufferLot', document.getElementById('ntBufferLot').value);
                    trackLotNumber('npmLot', document.getElementById('npmLot').value);
                    trackLotNumber('resuspensionBufferLot', document.getElementById('resuspensionBufferLot').value);
                    trackLotNumber('indexesKitLot', document.getElementById('indexesKitLot').value);
                    trackLotNumber('indexingBeadsLot', document.getElementById('indexingBeadsLot').value);
                    trackLotNumber('indexingEtohLot', document.getElementById('indexingEtohLot').value);
                    trackLotNumber('indexingNfH2oLot', document.getElementById('indexingNfH2oLot').value);
                } else if (currentProcessType === 'Clean Extraction Qubit' || currentProcessType === 'Final Qubit') {
                    trackLotNumber('qubitReagentLot', document.getElementById('qubitReagentLot').value);
                }

                saveData();
                renderSamples();
                closeModal();
                alert(currentProcessType + ' completed!');
            }
        }

        function startBatchProcess() {
            console.log('Batch process started');
            
            var receivedSamples = [];
            var bapSamples = [];
            var tsbSamples = [];
            var extractionSamples = [];
            var cleanExtractionSamples = [];
            var indexingSamples = [];
            var cleanExtractionQubitSamples = [];
            
            for (var i = 0; i < selectedSamples.length; i++) {
                var id = selectedSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === id) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
    if (sample.status === 'Received') receivedSamples.push(id);
    else if (sample.status === 'BAP Complete') bapSamples.push(id);
    else if (sample.status === 'TSB Complete') tsbSamples.push(id);
    else if (sample.status === 'Extraction Complete') extractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Complete') cleanExtractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Qubit Complete') cleanExtractionQubitSamples.push(id);
    else if (sample.status === 'Indexing Complete') indexingSamples.push(id);
}
            }
            
            console.log('Batch counts: received=' + receivedSamples.length + ' indexing=' + indexingSamples.length);
            
            if (receivedSamples.length >= 2) {
    openBatchModal(receivedSamples, 'BAP');
} else if (bapSamples.length >= 2) {
    openBatchModal(bapSamples, 'TSB');
} else if (tsbSamples.length >= 2) {
    openBatchModal(tsbSamples, 'Extraction');
} else if (extractionSamples.length >= 2) {
    openBatchModal(extractionSamples, 'Clean Extraction');
} else if (cleanExtractionSamples.length >= 2) {
    openBatchModal(cleanExtractionSamples, 'Clean Extraction Qubit');
} else if (cleanExtractionQubitSamples.length >= 2) {
    openBatchModal(cleanExtractionQubitSamples, 'Indexing');
} else if (indexingSamples.length >= 2) {
    openBatchModal(indexingSamples, 'Final Qubit');
} else {
    alert('Please select samples of the same type');
}
        }

        function openBatchModal(sampleIds, type) {
            console.log('Opening batch modal for type: ' + type);
            currentBatchSamples = sampleIds;
            currentBatchType = type;
            
            document.getElementById('batchModalTitle').textContent = 'Batch ' + type;
            document.getElementById('batchSampleCount').textContent = sampleIds.length;
            
            var numbersHtml = '<strong>Processing ' + sampleIds.length + ' samples</strong>';
            
            // Add reference tables for each workflow step
            if (type === 'TSB') {
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã BAP ‚Üí TSB Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'bap', 'TSB', nextTsbNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the BAP plates listed above for each corresponding TSB</p>';
                numbersHtml += '</div>';
            } else if (type === 'Extraction') {
                numbersHtml += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #856404;">üß´ TSB ‚Üí Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'tsb', 'Extraction', nextExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the TSB plates listed above for each corresponding Extraction</p>';
                numbersHtml += '</div>';
                
                // Add extraction reagent fields
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction Reagent Lots</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Extraction Run:</label>';
                numbersHtml += '<input type="text" id="batchExtractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW1 Lot:</label><input type="text" id="batchAw1Lot" placeholder="AW1LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW2 Lot:</label><input type="text" id="batchAw2Lot" placeholder="AW2LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Ethanol Lot:</label><input type="text" id="batchEthanolLot" placeholder="ETH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AL Lot:</label><input type="text" id="batchBufferALLot" placeholder="AL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer ATL Lot:</label><input type="text" id="batchBufferATLLot" placeholder="ATL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AE Lot:</label><input type="text" id="batchBufferAELot" placeholder="AE123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Proteinase K Lot:</label><input type="text" id="batchProteinaseKLot" placeholder="PK123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">DNeasy Column Lot:</label><input type="text" id="batchDneasyLot" placeholder="COL123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Clean Extraction') {
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction ‚Üí Clean Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'extraction', 'Clean Extraction', nextCleanExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Extraction plates listed above for each corresponding Clean Extraction</p>';
                numbersHtml += '</div>';
                
                // Add clean extraction reagent fields
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reagents & Volumes</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchStoragePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Bead Lot:</label><input type="text" id="batchBeadLot" placeholder="BEAD123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O ETOH:</label><input type="text" id="batchNfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">EtOH Dilution:</label><input type="text" id="batchEtohDilutionLot" placeholder="ETOH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O Elution:</label><input type="text" id="batchNfH2oElutionLot" placeholder="ELUT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Qubit Reagent:</label><input type="text" id="batchQubitReagentLot" placeholder="QUBIT123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Cleanup Volume:</label><input type="text" id="batchCleanupVolume" placeholder="1.2x" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution In:</label><input type="text" id="batchElutionVolumeIn" placeholder="50uL" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution Out:</label><input type="text" id="batchElutionVolumeOut" placeholder="45uL" style="width: 80px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Indexing') {
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction ‚Üí Indexing Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Indexing', nextIndexingNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Indexing</p>';
                numbersHtml += '</div>';
                
                // Add indexing reagent fields with well positions and indexes
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing (XT) Details</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchIndexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                
                // Well positions and indexes for each sample
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Well Positions & Indexes (unique per sample):</h5>';
                numbersHtml += '<div id="batchIndexingWellPositions" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                
                for (var i = 0; i < sampleIds.length; i++) {
                    var sampleId = sampleIds[i];
                    var autoWell = generateWellPosition(i);
                    numbersHtml += '<div style="display: grid; grid-template-columns: 100px 60px 80px 80px 40px 40px; gap: 5px; align-items: center; margin-bottom: 8px; padding: 5px; background: white; border-radius: 4px;">';
                    numbersHtml += '<span style="font-weight: bold; font-size: 11px;">' + sampleId + '</span>';
                    numbersHtml += '<input type="text" id="batchIndexingWell_' + i + '" value="' + autoWell + '" style="width: 50px; font-size: 11px;" placeholder="A01">';
                    numbersHtml += '<input type="text" id="batchI5Index_' + i + '" placeholder="i5-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="text" id="batchI7Index_' + i + '" placeholder="i7-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI5Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI7Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '</div>';
                }
                
                numbersHtml += '</div>';
                numbersHtml += '<small style="color: #666; font-size: 11px;">Each sample needs unique i5/i7 combination</small>';
                
                // Shared reagent lots
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Shared Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">TD Buffer:</label><input type="text" id="batchTdBufferLot" placeholder="TD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">ATM Buffer:</label><input type="text" id="batchAtmBufferLot" placeholder="ATM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NT Buffer:</label><input type="text" id="batchNtBufferLot" placeholder="NT123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NPM:</label><input type="text" id="batchNpmLot" placeholder="NPM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Resuspension Buffer:</label><input type="text" id="batchResuspensionBufferLot" placeholder="RES123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Indexes Kit:</label><input type="text" id="batchIndexesKitLot" placeholder="IDX123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Beads:</label><input type="text" id="batchIndexingBeadsLot" placeholder="BEAD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">EtOH:</label><input type="text" id="batchIndexingEtohLot" placeholder="ETOH123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NF H2O:</label><input type="text" id="batchIndexingNfH2oLot" placeholder="H2O123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '</div>';
                
                // Cleanup concentrations
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Cleanup Concentrations:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 1:</label><input type="text" id="batchCleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 2:</label><input type="text" id="batchCleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction ‚Üí Clean Extraction Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Clean Extraction Qubit specific fields
    numbersHtml += '<div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #1565c0;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1565c0;">üìä Batch Clean Extraction Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchCleanExtractionQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchCleanExtractionQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
            } else if (type === 'Final Qubit') {
    numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing ‚Üí Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'indexing', 'Final Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Indexing plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Qubit specific fields
    numbersHtml += '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ff9800;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #f57c00;">üìä Batch Final Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
}
            
            document.getElementById('batchNumbers').innerHTML = numbersHtml;
            document.getElementById('batchModal').style.display = 'block';
        }

        function completeBatchProcess() {
            var tech = document.getElementById('batchTechInitials').value.trim();
            var lot = document.getElementById('batchLotNumber').value.trim();
            var temp = document.getElementById('batchTemperature').value;
            var inc = document.getElementById('batchIncubator').value;
            var timeIn = document.getElementById('batchTimeIn').value;
            var timeOut = document.getElementById('batchTimeOut').value;

            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }

            var today = new Date().toLocaleDateString();
            
            for (var i = 0; i < currentBatchSamples.length; i++) {
                var sampleId = currentBatchSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
                    if (currentBatchType === 'BAP') {
                        sample.bapNumber = '25B' + String(nextBapNumber + i).padStart(3, '0');
                        sample.status = 'BAP Complete';
                        sample.bapDetails = {
                            technician: tech,
                            lot: lot,
                            completedDate: today,
                            temperature: temp,
                            incubator: inc,
                            timeIn: timeIn,
                            timeOut: timeOut
                        };
                    } else if (currentBatchType === 'TSB') {
                        sample.tsbNumber = '25T' + String(nextTsbNumber + i).padStart(3, '0');
                        sample.status = 'TSB Complete';
                        sample.tsbDetails = {
                            technician: tech,
                            lot: lot,
                            completedDate: today,
                            temperature: temp,
                            incubator: inc,
                            timeIn: timeIn,
                            timeOut: timeOut
                        };
                    } else if (currentBatchType === 'Extraction') {
                        sample.extractionNumber = '25E' + String(nextExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Extraction Complete';
                        sample.extractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            extractionRun: document.getElementById('batchExtractionRun') ? document.getElementById('batchExtractionRun').value : '25-' + nextExtractionRun,
                            reagentLots: {
                                aw1: document.getElementById('batchAw1Lot') ? document.getElementById('batchAw1Lot').value : '',
                                aw2: document.getElementById('batchAw2Lot') ? document.getElementById('batchAw2Lot').value : '',
                                ethanol: document.getElementById('batchEthanolLot') ? document.getElementById('batchEthanolLot').value : '',
                                bufferAL: document.getElementById('batchBufferALLot') ? document.getElementById('batchBufferALLot').value : '',
                                bufferATL: document.getElementById('batchBufferATLLot') ? document.getElementById('batchBufferATLLot').value : '',
                                bufferAE: document.getElementById('batchBufferAELot') ? document.getElementById('batchBufferAELot').value : '',
                                proteinaseK: document.getElementById('batchProteinaseKLot') ? document.getElementById('batchProteinaseKLot').value : '',
                                dneasy: document.getElementById('batchDneasyLot') ? document.getElementById('batchDneasyLot').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Clean Extraction') {
                        sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Clean Extraction Complete';
                        sample.cleanExtractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchStoragePlate') ? document.getElementById('batchStoragePlate').value : '25CEP' + String(nextCleanExtractionPlate).padStart(2, '0'),
                            wellPosition: generateWellPosition(i),
                            reagentLots: {
                                bead: document.getElementById('batchBeadLot') ? document.getElementById('batchBeadLot').value : '',
                                nfH2oEtoh: document.getElementById('batchNfH2oEtohLot') ? document.getElementById('batchNfH2oEtohLot').value : '',
                                etohDilution: document.getElementById('batchEtohDilutionLot') ? document.getElementById('batchEtohDilutionLot').value : '',
                                nfH2oElution: document.getElementById('batchNfH2oElutionLot') ? document.getElementById('batchNfH2oElutionLot').value : '',
                                qubitReagent: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : ''
                            },
                            volumes: {
                                cleanup: document.getElementById('batchCleanupVolume') ? document.getElementById('batchCleanupVolume').value : '',
                                elutionIn: document.getElementById('batchElutionVolumeIn') ? document.getElementById('batchElutionVolumeIn').value : '',
                                elutionOut: document.getElementById('batchElutionVolumeOut') ? document.getElementById('batchElutionVolumeOut').value : ''
                            }
                        };
                        } else if (currentBatchType === 'Clean Extraction Qubit') {
    sample.status = 'Clean Extraction Qubit Complete';
    sample.cleanExtractionQubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchCleanExtractionQubitReagentLot') ? document.getElementById('batchCleanExtractionQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchCleanExtractionQubitDate') ? document.getElementById('batchCleanExtractionQubitDate').value : today
    };
                    } else if (currentBatchType === 'Indexing') {
                        sample.indexingNumber = '25XT' + String(nextIndexingNumber + i).padStart(3, '0');
                        sample.status = 'Indexing Complete';
                        
                        // Get custom well position and indexes from inputs
                        var wellPosition = generateWellPosition(i);
                        var wellInput = document.getElementById('batchIndexingWell_' + i);
                        if (wellInput && wellInput.value.trim()) {
                            wellPosition = wellInput.value.trim().toUpperCase();
                        }
                        
                        var i5Index = document.getElementById('batchI5Index_' + i) ? document.getElementById('batchI5Index_' + i).value : '';
                        var i7Index = document.getElementById('batchI7Index_' + i) ? document.getElementById('batchI7Index_' + i).value : '';
                        var i5Thaws = document.getElementById('batchI5Thaws_' + i) ? document.getElementById('batchI5Thaws_' + i).value : '1';
                        var i7Thaws = document.getElementById('batchI7Thaws_' + i) ? document.getElementById('batchI7Thaws_' + i).value : '1';
                        
                        sample.indexingDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchIndexingStoragePlate') ? document.getElementById('batchIndexingStoragePlate').value : '25XLP' + String(nextIndexingPlate).padStart(2, '0'),
                            wellPosition: wellPosition,
                            indexes: {
                                i5: i5Index,
                                i7: i7Index,
                                i5Thaws: i5Thaws,
                                i7Thaws: i7Thaws
                            },
                            reagentLots: {
                                tdBuffer: document.getElementById('batchTdBufferLot') ? document.getElementById('batchTdBufferLot').value : '',
                                atmBuffer: document.getElementById('batchAtmBufferLot') ? document.getElementById('batchAtmBufferLot').value : '',
                                ntBuffer: document.getElementById('batchNtBufferLot') ? document.getElementById('batchNtBufferLot').value : '',
                                npm: document.getElementById('batchNpmLot') ? document.getElementById('batchNpmLot').value : '',
                                resuspensionBuffer: document.getElementById('batchResuspensionBufferLot') ? document.getElementById('batchResuspensionBufferLot').value : '',
                                indexesKit: document.getElementById('batchIndexesKitLot') ? document.getElementById('batchIndexesKitLot').value : '',
                                beads: document.getElementById('batchIndexingBeadsLot') ? document.getElementById('batchIndexingBeadsLot').value : '',
                                etoh: document.getElementById('batchIndexingEtohLot') ? document.getElementById('batchIndexingEtohLot').value : '',
                                nfH2o: document.getElementById('batchIndexingNfH2oLot') ? document.getElementById('batchIndexingNfH2oLot').value : ''
                            },
                            cleanupConcentrations: {
                                step1: document.getElementById('batchCleanup1Concentrations') ? document.getElementById('batchCleanup1Concentrations').value : '',
                                step2: document.getElementById('batchCleanup2Concentrations') ? document.getElementById('batchCleanup2Concentrations').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Final Qubit') {
    sample.status = 'Qubit Complete';
    sample.qubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchQubitDate') ? document.getElementById('batchQubitDate').value : today
    };
}
                }
            }
            
            if (currentBatchType === 'BAP') nextBapNumber += currentBatchSamples.length;
            else if (currentBatchType === 'TSB') nextTsbNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Extraction') nextExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Clean Extraction') nextCleanExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Indexing') nextIndexingNumber += currentBatchSamples.length;
            
            clearSelection();
            saveData();
            renderSamples();
            closeBatchModal();
            alert('Batch ' + currentBatchType + ' completed!');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            currentBatchSamples = [];
            currentBatchType = '';
        }

        function closeModal() {
            document.getElementById('processModal').style.display = 'none';
        }

        function updateSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            selectedSamples = [];
            for (var i = 0; i < checkboxes.length; i++) {
                selectedSamples.push(checkboxes[i].value);
            }
            
            console.log('Selected samples: ' + selectedSamples.join(','));
            
            var count = document.getElementById('selectedCount');
            var batchBtn = document.getElementById('batchBtn');
            var batchControls = document.getElementById('batchControls');
            
            count.textContent = selectedSamples.length;
            
            if (selectedSamples.length >= 2) {
                batchControls.style.display = 'block';
                batchBtn.disabled = false;
                batchBtn.textContent = 'Start Batch Processing';
            } else {
                batchControls.style.display = 'none';
                batchBtn.disabled = true;
            }
        }

        function clearSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            selectedSamples = [];
            updateSelection();
        }

        // Search autocomplete functions
        function handleSearchInput(event) {
            filterSamples();

            // Show suggestions as user types
            if (event.key !== 'Enter' && event.key !== 'Escape' && event.key !== 'ArrowDown' && event.key !== 'ArrowUp') {
                showSearchSuggestions();
            }

            // Navigate suggestions with arrow keys
            var suggestionsDiv = document.getElementById('searchSuggestions');
            if (suggestionsDiv.style.display === 'block') {
                var suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (suggestions.length > 0) {
                        suggestions[0].focus();
                    }
                } else if (event.key === 'Escape') {
                    hideSuggestions();
                } else if (event.key === 'Enter' && suggestions.length === 1) {
                    // If only one match, select it
                    selectSuggestion(suggestions[0].getAttribute('data-sample-id'));
                }
            }
        }

        function showSearchSuggestions() {
            var searchText = document.getElementById('searchInput').value.toLowerCase();
            var suggestionsDiv = document.getElementById('searchSuggestions');

            if (searchText.length === 0) {
                hideSuggestions();
                return;
            }

            // Find matching samples
            var matches = samples.filter(function(s) {
                return s.id.toLowerCase().includes(searchText);
            }).slice(0, 10); // Limit to 10 suggestions

            if (matches.length === 0) {
                hideSuggestions();
                return;
            }

            // Build suggestions HTML
            var html = '';
            matches.forEach(function(sample, index) {
                var statusColor = getStatusColor(sample.status);
                var flagIcon = sample.flag && sample.flag !== 'None' ? (sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è') : '';

                html += '<div class="suggestion-item" data-sample-id="' + sample.id + '" ';
                html += 'onclick="selectSuggestion(\'' + sample.id.replace(/'/g, "\\'") + '\')" ';
                html += 'tabindex="0" ';
                html += 'onkeydown="if(event.key===\'Enter\') selectSuggestion(\'' + sample.id.replace(/'/g, "\\'") + '\')" ';
                html += 'style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;" ';
                html += 'onmouseover="this.style.background=\'#f0f4ff\'" ';
                html += 'onmouseout="this.style.background=\'white\'">';
                html += '<div>';
                html += '<span style="font-weight: 600; color: #333;">' + flagIcon + ' ' + sample.id + '</span>';
                html += '<div style="font-size: 11px; color: #666; margin-top: 2px;">' + sample.dateAdded + '</div>';
                html += '</div>';
                html += '<span style="background: ' + statusColor + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">' + sample.status + '</span>';
                html += '</div>';
            });

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        function selectSuggestion(sampleId) {
            document.getElementById('searchInput').value = sampleId;
            hideSuggestions();
            filterSamples();

            // Scroll to the sample if in list view
            setTimeout(function() {
                var sampleItems = document.querySelectorAll('.sample-item');
                for (var i = 0; i < sampleItems.length; i++) {
                    if (sampleItems[i].querySelector('strong').textContent.trim() === sampleId) {
                        sampleItems[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        sampleItems[i].style.background = '#fff9c4';
                        setTimeout(function() {
                            sampleItems[i].style.background = '';
                        }, 2000);
                        break;
                    }
                }
            }, 100);
        }

        function hideSuggestions() {
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        function getStatusColor(status) {
            var colors = {
                'Received': '#6c757d',
                'BAP In Progress': '#ffc107',
                'BAP Complete': '#28a745',
                'TSB In Progress': '#fd7e14',
                'TSB Complete': '#ffc107',
                'Extraction Complete': '#9c27b0',
                'Clean Extraction Complete': '#4caf50',
                'Clean Extraction Qubit Complete': '#17a2b8',
                'Indexing Complete': '#007bff',
                'Qubit Complete': '#10b981'
            };
            return colors[status] || '#6c757d';
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            var searchInput = document.getElementById('searchInput');
            var suggestionsDiv = document.getElementById('searchSuggestions');
            if (searchInput && suggestionsDiv && !searchInput.contains(event.target) && !suggestionsDiv.contains(event.target)) {
                hideSuggestions();
            }
        });

        function filterSamples() {
            var searchText = document.getElementById('searchInput').value.toLowerCase();
            var statusFilter = document.querySelector('input[name="statusFilter"]:checked').value;

            var sampleItems = document.querySelectorAll('.sample-item');
            for (var i = 0; i < sampleItems.length; i++) {
                var item = sampleItems[i];
                var sampleId = item.querySelector('strong').textContent.trim();
                var sampleIdLower = sampleId.toLowerCase();
                var status = item.querySelector('.status').textContent;

                // Find the actual sample object to get the date and flag
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }

                var matchesSearch = sampleIdLower.includes(searchText);
                var matchesStatus = statusFilter === 'all' ||
                                  status === statusFilter ||
                                  (statusFilter === 'Complete' && status === 'Qubit Complete');
                var matchesDate = sample ? isWithinDateFilter(sample.dateAdded) : true;
                var matchesFlag = currentFlagFilter === 'all' ||
                                (sample && sample.flag === currentFlagFilter) ||
                                (currentFlagFilter === 'None' && (!sample || !sample.flag || sample.flag === 'None'));

                if (matchesSearch && matchesStatus && matchesDate && matchesFlag) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            }
        }

        var currentEditingSampleId = null;

        // QC Thresholds
        var QC_THRESHOLDS = {
            cleanExtractionQubit: {min: 5, max: 200, unit: 'ng/uL'},
            finalQubit: {min: 1, max: 50, unit: 'ng/uL'}
        };

        function checkQCThreshold(value, type) {
            var threshold = QC_THRESHOLDS[type];
            if (!threshold) return {pass: true, message: ''};

            var numValue = parseFloat(value);
            if (isNaN(numValue)) return {pass: true, message: ''};

            if (numValue < threshold.min) {
                return {
                    pass: false,
                    message: '‚ö†Ô∏è Below minimum (' + threshold.min + ' ' + threshold.unit + ')'
                };
            } else if (numValue > threshold.max) {
                return {
                    pass: false,
                    message: '‚ö†Ô∏è Above maximum (' + threshold.max + ' ' + threshold.unit + ')'
                };
            }
            return {pass: true, message: '‚úÖ Within range'};
        }

        function validateQubitValue(inputElement, type) {
            var value = parseFloat(inputElement.value);
            var validationDiv = document.getElementById('qubitValidation');

            if (!validationDiv) return;

            // Check for obviously wrong values
            if (isNaN(value) || value === '') {
                validationDiv.innerHTML = '';
                inputElement.style.borderColor = '';
                return;
            }

            if (value < 0) {
                validationDiv.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå Negative value not possible!</span>';
                inputElement.style.borderColor = '#dc3545';
                inputElement.style.background = '#ffe6e6';
                return;
            }

            if (value === 0) {
                validationDiv.innerHTML = '<span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è Zero concentration - no DNA detected</span>';
                inputElement.style.borderColor = '#ffc107';
                inputElement.style.background = '#fff9e6';
                return;
            }

            if (value > 1000) {
                validationDiv.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå Unusually high (>1000 ng/uL) - check dilution!</span>';
                inputElement.style.borderColor = '#dc3545';
                inputElement.style.background = '#ffe6e6';
                return;
            }

            // Use existing QC threshold check
            var qc = checkQCThreshold(value, type);
            if (qc.pass) {
                validationDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">' + qc.message + '</span>';
                inputElement.style.borderColor = '#28a745';
                inputElement.style.background = '#e6ffe6';
            } else {
                validationDiv.innerHTML = '<span style="color: #ffc107; font-weight: bold;">' + qc.message + '</span>';
                inputElement.style.borderColor = '#ffc107';
                inputElement.style.background = '#fff9e6';
            }
        }

        function editSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentEditingSampleId = sampleId;
            document.getElementById('editOriginalId').textContent = sampleId;
            document.getElementById('editSampleId').value = sample.id;
            document.getElementById('editInitials').value = sample.initials;
            document.getElementById('editStatus').value = sample.status;

            document.getElementById('editModal').style.display = 'block';
        }

        function saveEditedSample() {
            var newId = document.getElementById('editSampleId').value.trim();
            var newInitials = document.getElementById('editInitials').value.trim().toUpperCase();
            var newStatus = document.getElementById('editStatus').value;

            if (!newId || !newInitials) {
                alert('Sample ID and Initials are required');
                return;
            }

            // Check if new ID already exists (and it's not the current sample)
            if (newId !== currentEditingSampleId) {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === newId) {
                        alert('Sample ID ' + newId + ' already exists!');
                        return;
                    }
                }
            }

            // Find and update the sample
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === currentEditingSampleId) {
                    samples[i].id = newId;
                    samples[i].initials = newInitials;
                    samples[i].status = newStatus;
                    break;
                }
            }

            saveData();
            renderSamples();
            closeEditModal();
            alert('Sample updated successfully!');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingSampleId = null;
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').style.display = 'none';
        }

        function showPlateMap() {
            // Get all unique plates from samples
            var plates = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                // Check for plate assignments in various stages
                if (s.tsbDetails && s.tsbDetails.storagePlate) {
                    plates['TSB - ' + s.tsbDetails.storagePlate] = s.tsbDetails.storagePlate;
                }
                if (s.extractionDetails && s.extractionDetails.storagePlate) {
                    plates['Extraction - ' + s.extractionDetails.storagePlate] = s.extractionDetails.storagePlate;
                }
                if (s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate) {
                    plates['Clean Extraction - ' + s.cleanExtractionDetails.storagePlate] = s.cleanExtractionDetails.storagePlate;
                }
                if (s.indexingDetails && s.indexingDetails.storagePlate) {
                    plates['Indexing - ' + s.indexingDetails.storagePlate] = s.indexingDetails.storagePlate;
                }
            }

            // Populate plate selector
            var selector = document.getElementById('plateSelector');
            selector.innerHTML = '<option value="">-- Select a plate --</option>';
            for (var plateName in plates) {
                var option = document.createElement('option');
                option.value = plateName;
                option.textContent = plateName;
                selector.appendChild(option);
            }

            // Show modal
            document.getElementById('plateMapModal').style.display = 'block';

            // If there's only one plate, auto-select it
            if (Object.keys(plates).length === 1) {
                selector.value = Object.keys(plates)[0];
                renderPlateMap();
            }
        }

        function closePlateMapModal() {
            document.getElementById('plateMapModal').style.display = 'none';
        }

        function renderPlateMap() {
            var selectedPlate = document.getElementById('plateSelector').value;
            if (!selectedPlate) {
                document.getElementById('plateMapContainer').innerHTML = '<p style="text-align: center; color: #999;">Please select a plate to view</p>';
                return;
            }

            // Extract plate type and name
            var parts = selectedPlate.split(' - ');
            var plateType = parts[0];
            var plateName = parts[1];

            // Build a map of well positions to samples
            var wellMap = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var wellPos = null;
                var details = null;

                if (plateType === 'TSB' && s.tsbDetails && s.tsbDetails.storagePlate === plateName) {
                    wellPos = s.tsbDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Extraction' && s.extractionDetails && s.extractionDetails.storagePlate === plateName) {
                    wellPos = s.extractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Clean Extraction' && s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate === plateName) {
                    wellPos = s.cleanExtractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Indexing' && s.indexingDetails && s.indexingDetails.storagePlate === plateName) {
                    wellPos = s.indexingDetails.wellPosition;
                    details = s;
                }

                if (wellPos) {
                    wellMap[wellPos] = details;
                }
            }

            // Generate 96-well plate HTML
            var html = '<div class="plate-map"><table>';

            // Header row with column numbers
            html += '<tr><th></th>';
            for (var col = 1; col <= 12; col++) {
                html += '<th>' + col + '</th>';
            }
            html += '</tr>';

            // Data rows
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            for (var r = 0; r < rows.length; r++) {
                html += '<tr>';
                html += '<th>' + rows[r] + '</th>';

                for (var col = 1; col <= 12; col++) {
                    var wellPos = rows[r] + col;
                    var sample = wellMap[wellPos];

                    if (sample) {
                        var bgColor = getStatusColor(sample.status);
                        var title = sample.id + ' - ' + sample.status;
                        html += '<td style="background: ' + bgColor + ';" title="' + title + '" onclick="viewSample(\'' + sample.id.replace(/'/g, "\\'") + '\')">';
                        html += '<span class="well-id">' + sample.id + '</span>';
                        html += '</td>';
                    } else {
                        html += '<td title="Empty well ' + wellPos + '">';
                        html += '<span style="font-size: 8px; color: #999;">' + wellPos + '</span>';
                        html += '</td>';
                    }
                }
                html += '</tr>';
            }

            html += '</table></div>';
            document.getElementById('plateMapContainer').innerHTML = html;
        }

        function getStatusColor(status) {
            var colors = {
                'Received': '#e9ecef',
                'BAP Complete': '#d4edda',
                'TSB Complete': '#fff3cd',
                'Extraction Complete': '#f3e5f5',
                'Clean Extraction Complete': '#e8f5e8',
                'Clean Extraction Qubit Complete': '#e8f4fd',
                'Indexing Complete': '#e3f2fd',
                'Qubit Complete': '#fff3e0'
            };
            return colors[status] || '#f8f9fa';
        }

        // Dropdown Menu Functions
        function toggleDropdown(menuId) {
            // Close all other dropdowns first
            var allDropdowns = document.querySelectorAll('.dropdown-menu');
            for (var i = 0; i < allDropdowns.length; i++) {
                if (allDropdowns[i].id !== menuId) {
                    allDropdowns[i].style.display = 'none';
                }
            }

            // Toggle the clicked dropdown
            var menu = document.getElementById(menuId);
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
            }
        }

        function closeAllDropdowns() {
            var allDropdowns = document.querySelectorAll('.dropdown-menu');
            for (var i = 0; i < allDropdowns.length; i++) {
                allDropdowns[i].style.display = 'none';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            var isDropdownButton = event.target.closest('.menu-btn');
            var isDropdownMenu = event.target.closest('.dropdown-menu');

            if (!isDropdownButton && !isDropdownMenu) {
                closeAllDropdowns();
            }
        });

        // Sidebar Toggle
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // Module Switching
        function switchModule(module) {
            currentModule = module;

            // Update button styles
            var foodBtn = document.getElementById('foodTestingModuleBtn');
            var seqBtn = document.getElementById('sequencingModuleBtn');

            if (module === 'food-testing') {
                foodBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                foodBtn.style.border = '1px solid rgba(255,255,255,0.3)';
                foodBtn.style.boxShadow = '0 2px 8px rgba(255,107,107,0.4)';

                seqBtn.style.background = 'rgba(255,255,255,0.1)';
                seqBtn.style.border = '1px solid rgba(255,255,255,0.2)';
                seqBtn.style.boxShadow = 'none';
            } else {
                seqBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                seqBtn.style.border = '1px solid rgba(255,255,255,0.3)';
                seqBtn.style.boxShadow = '0 2px 8px rgba(102,126,234,0.4)';

                foodBtn.style.background = 'rgba(255,255,255,0.1)';
                foodBtn.style.border = '1px solid rgba(255,255,255,0.2)';
                foodBtn.style.boxShadow = 'none';
            }

            // Show/hide appropriate interface
            renderCurrentModule();
            saveData();
        }

        // Render current module interface
        function renderCurrentModule() {
            var container = document.querySelector('.main-content');

            if (currentModule === 'food-testing') {
                renderFoodTestingModule();
            } else {
                // Show normal sequencing interface - already handled by existing code
                // Just need to make sure food testing UI is hidden
                var foodUI = document.getElementById('foodTestingUI');
                if (foodUI) {
                    foodUI.style.display = 'none';
                }
                // Show sequencing UI
                var seqUI = document.getElementById('sequencingUI');
                if (seqUI) {
                    seqUI.style.display = 'block';
                }
            }
        }

        // FOOD TESTING MODULE - Reagent Lot Autocomplete Functions

        // Add reagent lot to history (max 20 recent lots per type)
        function addReagentLotToHistory(lotType, lotValue) {
            if (!lotValue || lotValue.trim() === '') return;

            lotValue = lotValue.trim();

            if (!reagentLotHistory[lotType]) {
                reagentLotHistory[lotType] = [];
            }

            // Remove if already exists (to move to front and update timestamp)
            var existingIndex = -1;
            for (var i = 0; i < reagentLotHistory[lotType].length; i++) {
                var item = reagentLotHistory[lotType][i];
                var itemLot = typeof item === 'string' ? item : item.lot;
                if (itemLot === lotValue) {
                    existingIndex = i;
                    break;
                }
            }
            if (existingIndex !== -1) {
                reagentLotHistory[lotType].splice(existingIndex, 1);
            }

            // Add to front with timestamp
            var now = new Date();
            reagentLotHistory[lotType].unshift({
                lot: lotValue,
                timestamp: now.getTime(),
                dateUsed: now.toLocaleDateString()
            });

            // Keep only last 20
            if (reagentLotHistory[lotType].length > 20) {
                reagentLotHistory[lotType] = reagentLotHistory[lotType].slice(0, 20);
            }

            saveData();
        }

        // Calculate days ago from timestamp
        function getDaysAgo(timestamp) {
            var now = Date.now();
            var diffMs = now - timestamp;
            var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return diffDays + ' days ago';
            if (diffDays < 30) return Math.floor(diffDays / 7) + ' weeks ago';
            return Math.floor(diffDays / 30) + ' months ago';
        }

        // Show reagent lot autocomplete dropdown
        function showReagentLotAutocomplete(inputId, lotType) {
            var input = document.getElementById(inputId);
            if (!input) return;

            var dropdownId = inputId + '_autocomplete';
            var dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            var value = input.value.toLowerCase().trim();
            var history = reagentLotHistory[lotType] || [];

            // Filter based on input
            var matches = history.filter(function(item) {
                var lotValue = typeof item === 'string' ? item : item.lot;
                return lotValue.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || (value === '' && history.length > 0)) {
                var html = '';
                var displayLots = value === '' ? history : matches;
                displayLots.slice(0, 10).forEach(function(item) {
                    var lotValue = typeof item === 'string' ? item : item.lot;
                    var timestamp = typeof item === 'string' ? null : item.timestamp;
                    var daysAgo = timestamp ? getDaysAgo(timestamp) : null;
                    var isExpired = timestamp && (Date.now() - timestamp) > (30 * 24 * 60 * 60 * 1000); // 30 days

                    html += '<div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background=\'#e7f3ff\'" onmouseout="this.style.background=\'white\'">';
                    html += '<span onclick="selectReagentLot(\'' + inputId + '\', \'' + lotValue.replace(/'/g, "\\'") + '\')" style="flex: 1; font-family: monospace; font-weight: 600;">' + lotValue + '</span>';
                    if (daysAgo) {
                        var textColor = isExpired ? '#dc3545' : '#6c757d';
                        var icon = isExpired ? '‚ö†Ô∏è ' : '';
                        html += '<span style="font-size: 11px; color: ' + textColor + '; margin-right: 8px;">' + icon + daysAgo + '</span>';
                    }
                    html += '<button onclick="event.stopPropagation(); viewLotUsageHistory(\'' + lotValue.replace(/'/g, "\\'") + '\', \'' + lotType + '\')" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="View all samples using this lot">üìä</button>';
                    html += '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        // View lot usage history - show all samples using this lot
        function viewLotUsageHistory(lotNumber, lotType) {
            hideReagentLotAutocomplete(''); // Close dropdown

            // Search all samples for this lot number
            var results = [];

            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var found = false;
                var usedIn = [];

                // Check BAP
                if (sample.bapDetails && sample.bapDetails.lotNumber && sample.bapDetails.lotNumber.toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                    found = true;
                    usedIn.push('BAP');
                }
                // Check TSB
                if (sample.tsbDetails && sample.tsbDetails.lotNumber && sample.tsbDetails.lotNumber.toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                    found = true;
                    usedIn.push('TSB');
                }
                // Check Extraction reagents
                if (sample.extractionDetails && sample.extractionDetails.reagentLots) {
                    for (var key in sample.extractionDetails.reagentLots) {
                        if (sample.extractionDetails.reagentLots[key] && sample.extractionDetails.reagentLots[key].toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                            found = true;
                            usedIn.push('Extraction (' + key + ')');
                        }
                    }
                }
                // Check Clean Extraction
                if (sample.cleanExtractionDetails && sample.cleanExtractionDetails.reagentLots) {
                    for (var key in sample.cleanExtractionDetails.reagentLots) {
                        if (sample.cleanExtractionDetails.reagentLots[key] && sample.cleanExtractionDetails.reagentLots[key].toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                            found = true;
                            usedIn.push('Clean Extraction (' + key + ')');
                        }
                    }
                }
                // Check Qubit
                if (sample.cleanExtractionQubitDetails && sample.cleanExtractionQubitDetails.reagentLot && sample.cleanExtractionQubitDetails.reagentLot.toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                    found = true;
                    usedIn.push('CE Qubit');
                }
                if (sample.qubitDetails && sample.qubitDetails.reagentLot && sample.qubitDetails.reagentLot.toLowerCase().indexOf(lotNumber.toLowerCase()) !== -1) {
                    found = true;
                    usedIn.push('Final Qubit');
                }

                if (found) {
                    results.push({sample: sample, usedIn: usedIn});
                }
            }

            // Create modal
            var modal = document.createElement('div');
            modal.id = 'lotUsageModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';

            var html = '';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            html += '<h2 style="margin: 0; color: #17a2b8;">üìä Lot Usage History</h2>';
            html += '<button onclick="closeLotUsageModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>';
            html += '</div>';

            html += '<div style="background: #e7f3f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="font-size: 18px; font-weight: 600; color: #17a2b8; margin-bottom: 5px;">Lot Number: ' + lotNumber + '</div>';
            html += '<div style="font-size: 14px; color: #666;">Type: ' + lotType + '</div>';
            html += '</div>';

            if (results.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üîç</div>';
                html += '<div style="font-size: 16px;">No samples found using this lot</div>';
                html += '</div>';
            } else {
                html += '<div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<strong style="color: #155724;">‚úÖ Found ' + results.length + ' sample' + (results.length === 1 ? '' : 's') + ' using this lot:</strong>';
                html += '</div>';

                results.forEach(function(result) {
                    html += '<div style="background: #f8f9fa; border-left: 4px solid #17a2b8; padding: 15px; margin-bottom: 10px; border-radius: 4px;">';
                    html += '<div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">' + result.sample.id + '</div>';
                    html += '<div style="font-size: 13px; color: #666; margin-bottom: 5px;"><strong>Status:</strong> ' + result.sample.status + '</div>';
                    html += '<div style="font-size: 13px; color: #666; margin-bottom: 5px;"><strong>Date Added:</strong> ' + result.sample.dateAdded + '</div>';
                    html += '<div style="font-size: 13px; color: #17a2b8;"><strong>Used In:</strong> ' + result.usedIn.join(', ') + '</div>';
                    html += '<div style="margin-top: 10px;"><button onclick="closeLotUsageModal(); viewSample(\'' + result.sample.id.replace(/'/g, "\\'") + '\')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">View Details</button></div>';
                    html += '</div>';
                });
            }

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeLotUsageModal();
                }
            };
        }

        function closeLotUsageModal() {
            var modal = document.getElementById('lotUsageModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Hide reagent lot autocomplete
        function hideReagentLotAutocomplete(inputId) {
            var dropdownId = inputId + '_autocomplete';
            var dropdown = document.getElementById(dropdownId);
            if (dropdown) dropdown.style.display = 'none';
        }

        // Select a reagent lot from autocomplete
        function selectReagentLot(inputId, lotValue) {
            var input = document.getElementById(inputId);
            if (input) input.value = lotValue;
            hideReagentLotAutocomplete(inputId);
        }

        // FOOD TESTING MODULE - Main Render Function
        function renderFoodTestingModule() {
            // Hide sequencing UI
            var seqUI = document.getElementById('sequencingUI');
            if (seqUI) {
                seqUI.style.display = 'none';
            }

            // Check if food testing UI exists, if not create it
            var foodUI = document.getElementById('foodTestingUI');
            if (!foodUI) {
                // Create new container for food testing
                var mainContent = document.querySelector('.main-content');
                foodUI = document.createElement('div');
                foodUI.id = 'foodTestingUI';
                mainContent.appendChild(foodUI);
            }

            foodUI.style.display = 'block';

            // Build food testing interface
            var html = '';

            // Header
            html += '<div class="top-bar" style="margin-bottom: 20px;">';
            html += '<div><h1 style="margin: 0; font-size: 24px;">ü•© Food Testing Module</h1>';
            html += '<p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Sample Reception ‚Üí Pathogen Detection ‚Üí Isolate Generation ‚Üí Sequencing</p></div>';
            html += '</div>';

            // Tab Navigation
            html += '<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<div style="display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; flex-wrap: wrap;">';
            html += '<button onclick="switchFoodTestingTab(\'samples\')" id="foodTabSamples" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">üì• Food Samples</button>';
            html += '<button onclick="switchFoodTestingTab(\'ecoli\')" id="foodTabEcoli" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üß´ E. coli Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'campylo\')" id="foodTabCampylo" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">ü¶† Campylobacter Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'salmonella\')" id="foodTabSalmonella" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üî¥ Salmonella Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'enterococcus\')" id="foodTabEnterococcus" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üü† Enterococcus Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'aeromonas\')" id="foodTabAeromonas" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üêü Aeromonas Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'vibrioV1\')" id="foodTabVibrioV1" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üåä Vibrio Testing</button>';
            html += '<button onclick="switchFoodTestingTab(\'isolates\')" id="foodTabIsolates" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üß¨ Isolates</button>';
            html += '<button onclick="switchFoodTestingTab(\'results\')" id="foodTabResults" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #666; border-radius: 6px; cursor: pointer; font-weight: 600;">üìä Results Summary</button>';
            html += '</div>';
            html += '</div>';

            // Tab Content Containers
            html += '<div id="foodTabContentSamples"></div>';
            html += '<div id="foodTabContentEcoli" style="display: none;"></div>';
            html += '<div id="foodTabContentCampylo" style="display: none;"></div>';
            html += '<div id="foodTabContentSalmonella" style="display: none;"></div>';
            html += '<div id="foodTabContentEnterococcus" style="display: none;"></div>';
            html += '<div id="foodTabContentAeromonas" style="display: none;"></div>';
            html += '<div id="foodTabContentVibrioV1" style="display: none;"></div>';
            html += '<div id="foodTabContentIsolates" style="display: none;"></div>';
            html += '<div id="foodTabContentResults" style="display: none;"></div>';

            foodUI.innerHTML = html;

            // Render default tab content
            renderFoodSamplesTab();
        }

        // Switch tabs within food testing module
        var currentFoodTab = 'samples';
        function switchFoodTestingTab(tab) {
            currentFoodTab = tab;

            // Update tab button styles
            var tabs = ['samples', 'ecoli', 'campylo', 'salmonella', 'enterococcus', 'aeromonas', 'vibrioV1', 'isolates', 'results'];
            tabs.forEach(function(t) {
                var btn = document.getElementById('foodTab' + t.charAt(0).toUpperCase() + t.slice(1));
                var content = document.getElementById('foodTabContent' + t.charAt(0).toUpperCase() + t.slice(1));

                if (t === tab) {
                    btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                    btn.style.color = 'white';
                    content.style.display = 'block';
                } else {
                    btn.style.background = '#e0e0e0';
                    btn.style.color = '#666';
                    content.style.display = 'none';
                }
            });

            // Render appropriate content
            if (tab === 'samples') {
                renderFoodSamplesTab();
            } else if (tab === 'ecoli') {
                renderEcoliTab();
            } else if (tab === 'campylo') {
                renderCampyloTab();
            } else if (tab === 'salmonella') {
                renderSalmonellaTab();
            } else if (tab === 'enterococcus') {
                renderEnterococcusTab();
            } else if (tab === 'aeromonas') {
                renderAeromonasTab();
            } else if (tab === 'vibrioV1') {
                renderVibrioV1Tab();
            } else if (tab === 'isolates') {
                renderIsolatesTab();
            } else if (tab === 'results') {
                renderResultsSummaryTab();
            }
        }

        // Render Food Samples Tab
        function renderFoodSamplesTab() {
            var container = document.getElementById('foodTabContentSamples');
            var html = '';

            // Work Queue Dashboard for Food Testing
            html += '<div id="foodWorkQueuePanel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h3 style="margin: 0; color: white;">üéØ What to Work On Now - Food Testing</h3>';
            html += '<button onclick="updateFoodWorkQueue()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">üîÑ Refresh</button>';
            html += '</div>';
            html += '<div id="foodWorkQueue" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">';
            html += '<!-- Work queue items will be populated by JavaScript -->';
            html += '</div>';
            html += '<div id="foodNoWorkMessage" style="display: none; text-align: center; padding: 30px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 16px;">‚úÖ All caught up! No urgent items at the moment.</div>';
            html += '</div>';

            // Add Food Sample Form
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h3 style="margin: 0;">üì• Add New Food Sample</h3>';
            html += '<button onclick="openMonthlyGeneratorModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(102,126,234,0.3);">üìÖ Generate Monthly Samples</button>';
            html += '</div>';

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; align-items: start;">';

            // Sample ID
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Sample ID *</label>';
            html += '<input type="text" id="foodSampleId" placeholder="25KS01CB01" oninput="autoDetectSampleType(); showSampleIdAutocomplete();" onfocus="showSampleIdAutocomplete()" onblur="setTimeout(function(){ hideSampleIdAutocomplete(); }, 200)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />';
            html += '<div id="sampleIdAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">Format: YYSSTNN[TYPE]## (e.g., 25KS01CB01) - Type auto-detected from ID</div>';
            html += '</div>';

            // Detected Sample Type (read-only display)
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Detected Type</label>';
            html += '<div id="detectedSampleType" style="padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; color: #666; font-style: italic; box-sizing: border-box; height: 42px; line-height: 22px; display: flex; align-items: center;">Enter Sample ID to detect type...</div>';
            html += '</div>';

            html += '</div>'; // End grid row 1

            // Dynamic fields container (will be populated based on sample type)
            html += '<div id="sampleTypeSpecificFields"></div>';

            // Retail Meat Fields Template (hidden, will be cloned)
            html += '<div id="retailMeatFieldsTemplate" style="display: none;">';

            // Row 1 - Store Name and Date Received
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';

            // Store Name with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Store Name *</label>';
            html += '<input type="text" id="foodStoreNum" placeholder="e.g., Walmart Topeka" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showStoreAutocompleteSingle()" onfocus="showStoreAutocompleteSingle()" onblur="setTimeout(function(){ hideStoreAutocompleteSingle(); }, 200)" />';
            html += '<div id="storeAutocompleteSingle" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Date Received
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Date Received *</label>';
            html += '<input type="date" id="foodDateReceived" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            html += '</div>'; // End row 1

            // Row 2
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

            // Brand with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Brand</label>';
            html += '<input type="text" id="foodBrand" placeholder="e.g., Tyson, Perdue" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showBrandAutocomplete(); autofillBrandCode();" onfocus="showBrandAutocomplete()" onblur="setTimeout(function(){ hideBrandAutocomplete(); }, 200)" />';
            html += '<div id="brandAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Brand Code (auto-fills based on brand)
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Brand Code</label>';
            html += '<input type="text" id="foodBrandCode" placeholder="Auto-fills or enter manually" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            // Sell-By Date
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Sell-By Date</label>';
            html += '<input type="date" id="foodSellByDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            html += '</div>'; // End grid row 2

            // Row 3 - New tracking fields
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

            // Packing Type with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Packing Type</label>';
            html += '<input type="text" id="foodPackingType" placeholder="e.g., Tray, Vacuum" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showPackingTypeAutocomplete()" onfocus="showPackingTypeAutocomplete()" onblur="setTimeout(function(){ hidePackingTypeAutocomplete(); }, 200)" />';
            html += '<div id="packingTypeAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Packed in Store dropdown
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Packed in Store?</label>';
            html += '<select id="foodPackedInStore" onchange="togglePackedInStoreOther()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
            html += '<option value="">-- Select --</option>';
            html += '<option value="Yes">Yes</option>';
            html += '<option value="No">No</option>';
            html += '<option value="Unsure">Unsure</option>';
            html += '<option value="Other">Other</option>';
            html += '</select>';
            html += '</div>';

            // Empty spacer for grid alignment
            html += '<div></div>';

            html += '</div>'; // End grid row 3

            // Packed in Store Other (separate row, shown conditionally)
            html += '<div id="packedInStoreOtherContainer" style="display: none; margin-bottom: 20px;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Specify Other (Packed in Store)</label>';
            html += '<input type="text" id="foodPackedInStoreOther" placeholder="Specify..." style="width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            // Row 4
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

            // Est. ID
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Est. ID</label>';
            html += '<input type="text" id="foodEstId" placeholder="Establishment ID" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            // Produced By with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Produced By</label>';
            html += '<input type="text" id="foodProducedBy" placeholder="Producer name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showProducedByAutocomplete()" onfocus="showProducedByAutocomplete()" onblur="setTimeout(function(){ hideProducedByAutocomplete(); }, 200)" />';
            html += '<div id="producedByAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Country with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Country</label>';
            html += '<input type="text" id="foodCountry" placeholder="e.g., USA, Canada" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showCountryAutocomplete()" onfocus="showCountryAutocomplete()" onblur="setTimeout(function(){ hideCountryAutocomplete(); }, 200)" />';
            html += '<div id="countryAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            html += '</div>'; // End grid row 4

            // Row 5
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

            // Raising Claims with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Raising Claims</label>';
            html += '<input type="text" id="foodRaisingClaims" placeholder="e.g., Organic, No Antibiotics" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showRaisingClaimsAutocomplete()" onfocus="showRaisingClaimsAutocomplete()" onblur="setTimeout(function(){ hideRaisingClaimsAutocomplete(); }, 200)" />';
            html += '<div id="raisingClaimsAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Meat Type with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Meat Type</label>';
            html += '<input type="text" id="foodMeatTypeDetail" placeholder="e.g., Breast, Thigh" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showMeatTypeAutocomplete()" onfocus="showMeatTypeAutocomplete()" onblur="setTimeout(function(){ hideMeatTypeAutocomplete(); }, 200)" />';
            html += '<div id="meatTypeAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Fat % with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Fat %</label>';
            html += '<input type="text" id="foodFatPercent" placeholder="e.g., 80/20, 93/7" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showFatPercentAutocomplete()" onfocus="showFatPercentAutocomplete()" onblur="setTimeout(function(){ hideFatPercentAutocomplete(); }, 200)" />';
            html += '<div id="fatPercentAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            html += '</div>'; // End grid row 5

            html += '</div>'; // End retail meat fields template

            // Seafood Fields Template (hidden, will be cloned)
            html += '<div id="seafoodFieldsTemplate" style="display: none;">';

            // Row 1 - Store Name and Date Received
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';

            // Store Name with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Store Name *</label>';
            html += '<input type="text" id="foodStoreNum" placeholder="e.g., Walmart Topeka" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showStoreAutocompleteSingle()" onfocus="showStoreAutocompleteSingle()" onblur="setTimeout(function(){ hideStoreAutocompleteSingle(); }, 200)" />';
            html += '<div id="storeAutocompleteSingle" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Date Received
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Date Received *</label>';
            html += '<input type="date" id="foodDateReceived" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            html += '</div>'; // End row 1

            // Row 2 - Seafood specific
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

            // Brand with autocomplete (seafood)
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Brand</label>';
            html += '<input type="text" id="foodSeafoodBrand" placeholder="e.g., Sea Best" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showSeafoodBrandAutocomplete()" onfocus="showSeafoodBrandAutocomplete()" onblur="setTimeout(function(){ hideSeafoodBrandAutocomplete(); }, 200)" />';
            html += '<div id="seafoodBrandAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Frozen/Fresh dropdown
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Frozen/Fresh</label>';
            html += '<select id="foodFrozenFresh" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
            html += '<option value="">-- Select --</option>';
            html += '<option value="Frozen">Frozen</option>';
            html += '<option value="Fresh">Fresh</option>';
            html += '<option value="Other">Other</option>';
            html += '</select>';
            html += '</div>';

            // Sell-By Date
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Sell-By Date</label>';
            html += '<input type="date" id="foodSeafoodSellByDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            html += '</div>'; // End row 2

            // Row 3 - Seafood specific
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">';

            // Produced By with autocomplete (seafood)
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Produced By</label>';
            html += '<input type="text" id="foodSeafoodProducedBy" placeholder="Producer name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showSeafoodProducedByAutocomplete()" onfocus="showSeafoodProducedByAutocomplete()" onblur="setTimeout(function(){ hideSeafoodProducedByAutocomplete(); }, 200)" />';
            html += '<div id="seafoodProducedByAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Packaged For / Distributed By with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Packaged For / Distributed By</label>';
            html += '<input type="text" id="foodPackagedFor" placeholder="Distributor name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showPackagedForAutocomplete()" onfocus="showPackagedForAutocomplete()" onblur="setTimeout(function(){ hidePackagedForAutocomplete(); }, 200)" />';
            html += '<div id="packagedForAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Country with autocomplete (seafood)
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Country</label>';
            html += '<input type="text" id="foodSeafoodCountry" placeholder="e.g., USA, Thailand" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showSeafoodCountryAutocomplete()" onfocus="showSeafoodCountryAutocomplete()" onblur="setTimeout(function(){ hideSeafoodCountryAutocomplete(); }, 200)" />';
            html += '<div id="seafoodCountryAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            html += '</div>'; // End row 3

            // Row 4 - Seafood specific
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">';

            // Organic/Antibiotic Claims with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Organic / Antibiotic Claims</label>';
            html += '<input type="text" id="foodOrganicClaims" placeholder="e.g., Organic, No Antibiotics" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showOrganicClaimsAutocomplete()" onfocus="showOrganicClaimsAutocomplete()" onblur="setTimeout(function(){ hideOrganicClaimsAutocomplete(); }, 200)" />';
            html += '<div id="organicClaimsAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            // Raising Claims dropdown (Farm/Wild Caught)
            html += '<div>';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Raising Claims</label>';
            html += '<select id="foodSeafoodRaisingClaim" onchange="toggleSeafoodRaisingClaimOther()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
            html += '<option value="">-- Select --</option>';
            html += '<option value="Farm">Farm</option>';
            html += '<option value="Wild Caught">Wild Caught</option>';
            html += '<option value="Other">Other</option>';
            html += '</select>';
            html += '</div>';

            // Empty spacer for grid alignment
            html += '<div></div>';

            html += '</div>'; // End row 4

            // Raising Claims Other (separate row, shown conditionally)
            html += '<div id="seafoodRaisingClaimOtherContainer" style="display: none; margin-bottom: 15px;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Specify Other (Raising Claims)</label>';
            html += '<input type="text" id="foodSeafoodRaisingClaimOther" placeholder="Specify..." style="width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
            html += '</div>';

            // Row 5 - Seafood specific
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">';

            // Meat Cut with autocomplete
            html += '<div style="position: relative;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Meat Cut</label>';
            html += '<input type="text" id="foodMeatCut" placeholder="e.g., Fillet, Steak, Whole" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" oninput="showMeatCutAutocomplete()" onfocus="showMeatCutAutocomplete()" onblur="setTimeout(function(){ hideMeatCutAutocomplete(); }, 200)" />';
            html += '<div id="meatCutAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
            html += '</div>';

            html += '</div>'; // End row 5

            html += '</div>'; // End seafood fields template

            // Category-specific fields container
            html += '<div id="categorySpecificFields" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;"></div>';

            // Pathogens to Test
            html += '<div style="margin-bottom: 15px;">';
            html += '<label style="display: block; margin-bottom: 8px; font-weight: 600;">Pathogens to Test *</label>';
            html += '<div id="pathogenCheckboxes" style="display: flex; flex-wrap: wrap; gap: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;"></div>';
            html += '</div>';

            // Add button
            html += '<button onclick="addFoodSample()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">‚ûï Add Food Sample & Create Workflows</button>';

            html += '</div>'; // End form section

            // List of Food Samples
            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';

            // Filter samples by date first (before rendering anything)
            var filteredSamples = foodSamples.filter(function(sample) {
                return isWithinDateFilter(sample.dateReceived);
            });

            // Date filter buttons
            html += '<div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">';
            html += '<span style="font-weight: 600; color: #666; display: flex; align-items: center; margin-right: 5px;">üìÖ Filter by Date:</span>';
            html += '<button id="dateFilterAll" class="date-filter-btn" onclick="filterByDate(\'all\')" style="padding: 6px 14px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; background: #007bff; color: white;">All</button>';
            html += '<button id="dateFilterToday" class="date-filter-btn" onclick="filterByDate(\'today\')" style="padding: 6px 14px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; background: white; color: #007bff;">Today</button>';
            html += '<button id="dateFilterWeek" class="date-filter-btn" onclick="filterByDate(\'week\')" style="padding: 6px 14px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; background: white; color: #007bff;">This Week</button>';
            html += '<button id="dateFilterMonth" class="date-filter-btn" onclick="filterByDate(\'month\')" style="padding: 6px 14px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; background: white; color: #007bff;">This Month</button>';
            html += '<button id="dateFilter30Days" class="date-filter-btn" onclick="filterByDate(\'30days\')" style="padding: 6px 14px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; background: white; color: #007bff;">Last 30 Days</button>';
            html += '</div>';

            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            var countText = filteredSamples.length + ' of ' + foodSamples.length;
            if (filteredSamples.length === foodSamples.length) {
                countText = foodSamples.length + '';
            }
            html += '<h3 style="margin: 0;">ü•© Food Samples (' + countText + ')</h3>';

            // Bulk action controls (only show if there are samples)
            if (foodSamples.length > 0) {
                html += '<div style="display: flex; gap: 10px; align-items: center;">';
                html += '<button onclick="selectAllSamples()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">‚òëÔ∏è Select All</button>';
                html += '<button onclick="deselectAllSamples()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">‚òê Deselect All</button>';
                html += '<button id="bulkEditSelectedBtn" onclick="openBulkEditorForSelected()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(240,147,251,0.3); display: none;">üìù Edit Selected (<span id="selectedEditCount">0</span>)</button>';
                html += '<button id="bulkDeleteBtn" onclick="bulkDeleteSamples()" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; display: none;">üóëÔ∏è Delete Selected (<span id="selectedCountFood">0</span>)</button>';
                html += '</div>';
            }

            html += '</div>';

            if (filteredSamples.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>';
                if (foodSamples.length === 0) {
                    html += '<div style="font-size: 16px;">No food samples yet</div>';
                    html += '<div style="font-size: 14px; margin-top: 5px;">Add your first sample above to get started!</div>';
                } else {
                    html += '<div style="font-size: 16px;">No samples match the current filter</div>';
                    html += '<div style="font-size: 14px; margin-top: 5px;">Try selecting a different date range</div>';
                }
                html += '</div>';
            } else {
                // Render filtered samples
                filteredSamples.forEach(function(sample) {
                    var sampleType = sampleTypes[sample.sampleTypeCode];
                    var category = sampleType ? sampleType.category : 'unknown';

                    var isSelected = selectedSamplesForDelete.indexOf(sample.id) !== -1;

                    html += '<div style="border: 2px solid ' + (isSelected ? '#dc3545' : '#e0e0e0') + '; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: linear-gradient(135deg, ' + (isSelected ? '#fff5f5' : '#fff') + ' 0%, ' + (isSelected ? '#ffe6e6' : '#f9f9f9') + ' 100%);">';

                    // Header row
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                    html += '<div style="display: flex; align-items: center; gap: 10px;">';

                    // Checkbox for selection
                    html += '<input type="checkbox" id="sample-checkbox-' + sample.id.replace(/'/g, "\\'") + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleSampleSelectionForDelete(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="width: 20px; height: 20px; cursor: pointer;" title="Select for bulk delete">';

                    html += '<span style="font-size: 24px;">' + (category === 'meat' ? 'ü•©' : 'üêü') + '</span>';
                    html += '<div>';
                    html += '<div style="font-weight: 700; font-size: 16px;">' + sample.id + '</div>';
                    html += '<div style="font-size: 13px; color: #666;">' + (sampleType ? sampleType.name : sample.sampleTypeCode) + '</div>';
                    html += '</div>';
                    html += '</div>';

                    // Pathogen badges and actions
                    html += '<div style="display: flex; gap: 10px; align-items: center;">';

                    // Pathogen badges
                    html += '<div style="display: flex; gap: 5px;">';
                    sample.pathogensToTest.forEach(function(p) {
                        var pathogen = pathogens[p];
                        if (pathogen) {
                            html += '<span style="background: ' + pathogen.color + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">' + p + '</span>';
                        }
                    });
                    html += '</div>';

                    // Action buttons
                    html += '<button onclick="viewSampleHistory(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 5px;" title="View/edit workflow history">üìã History</button>';
                    html += '<button onclick="deleteSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;" title="Delete sample">üóëÔ∏è Delete</button>';

                    html += '</div>';

                    html += '</div>'; // End header row

                    // Details grid
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px; padding-top: 10px; border-top: 1px solid #e0e0e0;">';
                    html += '<div><strong>Store:</strong> ' + sample.storeNum + '</div>';
                    html += '<div><strong>Brand:</strong> ' + (sample.brand || 'N/A') + '</div>';
                    html += '<div><strong>Sell-By:</strong> ' + (sample.sellByDate || 'N/A') + '</div>';
                    html += '<div><strong>Received:</strong> ' + sample.dateReceived + '</div>';
                    html += '</div>';

                    html += '</div>'; // End sample card
                });
            }

            html += '</div>'; // End samples list section

            container.innerHTML = html;

            // Set default date to today
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('foodDateReceived').value = today;

            // Update bulk delete button state
            updateBulkDeleteButton();

            // Update work queue for Food Testing
            updateFoodWorkQueue();
        }

        // Food Testing Work Queue Dashboard
        function updateFoodWorkQueue() {
            var queue = [];

            if (!foodSamples || foodSamples.length === 0) {
                var container = document.getElementById('foodWorkQueue');
                var noWorkMsg = document.getElementById('foodNoWorkMessage');
                if (container) container.style.display = 'none';
                if (noWorkMsg) noWorkMsg.style.display = 'block';
                return;
            }

            // 1. Samples awaiting pathogen testing
            var awaitingTesting = foodSamples.filter(function(s) {
                return s.status === 'Active' && (!s.ecoliTested && !s.campyloTested && !s.salmonellaTested);
            });
            if (awaitingTesting.length > 0) {
                queue.push({
                    type: 'urgent',
                    icon: 'üß´',
                    count: awaitingTesting.length,
                    label: 'Samples Awaiting Pathogen Testing',
                    action: 'Click to view and start testing'
                });
            }

            // 2. Positive samples needing isolate generation
            var needIsolates = foodSamples.filter(function(s) {
                return (s.ecoliResult === 'Positive' || s.campyloResult === 'Positive' ||
                        s.salmonellaResult === 'Positive' || s.enterococcusResult === 'Positive' ||
                        s.aeromonasResult === 'Positive' || s.vibrioResult === 'Positive') &&
                       !s.isolatesGenerated;
            });
            if (needIsolates.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: 'üß¨',
                    count: needIsolates.length,
                    label: 'Positive Samples Need Isolates',
                    action: 'Click to generate isolates'
                });
            }

            // 3. E. coli tests in progress
            var ecoliInProgress = foodSamples.filter(function(s) {
                return s.ecoliTested && !s.ecoliResult;
            });
            if (ecoliInProgress.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: 'üß´',
                    count: ecoliInProgress.length,
                    label: 'E. coli Tests In Progress',
                    action: 'Click to view'
                });
            }

            // 4. Campylobacter tests in progress
            var campyloInProgress = foodSamples.filter(function(s) {
                return s.campyloTested && !s.campyloResult;
            });
            if (campyloInProgress.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: 'ü¶†',
                    count: campyloInProgress.length,
                    label: 'Campylobacter Tests In Progress',
                    action: 'Click to view'
                });
            }

            // 5. Salmonella tests in progress
            var salmonellaInProgress = foodSamples.filter(function(s) {
                return s.salmonellaTested && !s.salmonellaResult;
            });
            if (salmonellaInProgress.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: 'üî¥',
                    count: salmonellaInProgress.length,
                    label: 'Salmonella Tests In Progress',
                    action: 'Click to view'
                });
            }

            // 6. Recently received (last 7 days, not tested)
            var recentUntested = foodSamples.filter(function(s) {
                if (!s.dateReceived) return false;
                var receivedDate = new Date(s.dateReceived);
                var today = new Date();
                var daysDiff = Math.floor((today - receivedDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 7 && s.status === 'Active' && (!s.ecoliTested && !s.campyloTested && !s.salmonellaTested);
            });
            if (recentUntested.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: 'üì•',
                    count: recentUntested.length,
                    label: 'Recently Received (Untested)',
                    action: 'Click to start testing'
                });
            }

            // 7. All positive samples (summary)
            var allPositive = foodSamples.filter(function(s) {
                return s.ecoliResult === 'Positive' || s.campyloResult === 'Positive' ||
                       s.salmonellaResult === 'Positive' || s.enterococcusResult === 'Positive' ||
                       s.aeromonasResult === 'Positive' || s.vibrioResult === 'Positive';
            });
            if (allPositive.length > 0) {
                queue.push({
                    type: 'urgent',
                    icon: '‚ö†Ô∏è',
                    count: allPositive.length,
                    label: 'Total Positive Detections',
                    action: 'Click to view all positives'
                });
            }

            // Render the work queue
            var container = document.getElementById('foodWorkQueue');
            var noWorkMsg = document.getElementById('foodNoWorkMessage');

            if (!container) return; // Safety check

            if (queue.length === 0) {
                container.style.display = 'none';
                if (noWorkMsg) noWorkMsg.style.display = 'block';
            } else {
                container.style.display = 'grid';
                if (noWorkMsg) noWorkMsg.style.display = 'none';

                var html = '';
                queue.forEach(function(item) {
                    html += '<div class="work-queue-card ' + item.type + '" style="cursor: default;">';
                    html += '<div class="work-queue-number">' + item.icon + ' ' + item.count + '</div>';
                    html += '<div class="work-queue-label">' + item.label + '</div>';
                    html += '<div class="work-queue-action">' + item.action + '</div>';
                    html += '</div>';
                });

                container.innerHTML = html;
            }
        }

        // Update form fields based on sample type
        function updateFoodSampleFields() {
            var sampleTypeCode = document.getElementById('foodSampleType').value;
            var categoryFields = document.getElementById('categorySpecificFields');
            var pathogenCheckboxes = document.getElementById('pathogenCheckboxes');

            if (!sampleTypeCode) {
                categoryFields.innerHTML = '';
                pathogenCheckboxes.innerHTML = '';
                return;
            }

            var sampleType = sampleTypes[sampleTypeCode];
            var html = '';

            // Category-specific fields
            if (sampleType.category === 'meat') {
                // Meat-specific fields
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Grind/Whole</label>';
                html += '<select id="foodMeatType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                html += '<option value="Grind">Grind</option>';
                html += '<option value="Whole">Whole</option>';
                html += '</select>';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Organic Claim</label>';
                html += '<select id="foodOrganicClaim" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                html += '<option value="None">None</option>';
                html += '<option value="Organic">Organic</option>';
                html += '<option value="Natural">Natural</option>';
                html += '</select>';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">RWA Claim</label>';
                html += '<input type="text" id="foodRWAClaim" placeholder="e.g., No antibiotics" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                html += '</div>';
            } else if (sampleType.category === 'seafood') {
                // Seafood-specific fields
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Fresh/Frozen</label>';
                html += '<select id="foodSeafoodState" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                html += '<option value="Fresh">Fresh</option>';
                html += '<option value="Frozen">Frozen</option>';
                html += '</select>';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Raising Claim</label>';
                html += '<input type="text" id="foodRaisingClaim" placeholder="e.g., Wild-caught, Farm-raised" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                html += '</div>';

                html += '<div>';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Country of Origin</label>';
                html += '<input type="text" id="foodCountryOrigin" placeholder="e.g., USA, Thailand" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                html += '</div>';
            }

            categoryFields.innerHTML = html;

            // Pathogen checkboxes
            var pathogenHTML = '';
            sampleType.pathogens.forEach(function(p) {
                var pathogen = pathogens[p];
                pathogenHTML += '<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid ' + pathogen.color + ';">';
                pathogenHTML += '<input type="checkbox" name="pathogenTest" value="' + p + '" checked style="width: 18px; height: 18px; cursor: pointer;" />';
                pathogenHTML += '<div>';
                pathogenHTML += '<div style="font-weight: 600; color: ' + pathogen.color + ';">' + p + ' - ' + pathogen.name + '</div>';
                pathogenHTML += '<div style="font-size: 11px; color: #666;">' + pathogen.fullName + '</div>';
                pathogenHTML += '</div>';
                pathogenHTML += '</label>';
            });

            pathogenCheckboxes.innerHTML = pathogenHTML;
        }

        // Auto-detect sample type from Sample ID
        function autoDetectSampleType() {
            var sampleId = document.getElementById('foodSampleId').value.trim().toUpperCase();
            var detectedTypeDiv = document.getElementById('detectedSampleType');

            if (!detectedTypeDiv) return;

            // Extract sample type code from ID (e.g., "25KS01CB01" -> "CB")
            // Pattern: after state code (2 letters) and month (2 digits), extract 2-letter type code
            var match = sampleId.match(/^\d{2}[A-Z]{2}\d{2}([A-Z]{2})\d+$/);

            if (match) {
                var typeCode = match[1]; // Extract CB, GT, GB, SA, SH, TI, etc.
                var sampleType = sampleTypes[typeCode];

                if (sampleType) {
                    // Valid sample type detected
                    detectedTypeDiv.innerHTML = '<span style="color: #28a745; font-weight: 600;">‚úì ' + typeCode + ' - ' + sampleType.name + '</span>';
                    detectedTypeDiv.style.background = '#d4edda';
                    detectedTypeDiv.style.borderColor = '#c3e6cb';

                    // Update form fields based on detected type
                    updateFoodSampleFieldsByType(typeCode);
                } else {
                    // Unknown type code
                    detectedTypeDiv.innerHTML = '<span style="color: #dc3545;">‚úó Unknown type code: ' + typeCode + '</span>';
                    detectedTypeDiv.style.background = '#f8d7da';
                    detectedTypeDiv.style.borderColor = '#f5c6cb';

                    // Clear form fields
                    var container = document.getElementById('sampleTypeSpecificFields');
                    if (container) container.innerHTML = '';
                }
            } else {
                // Invalid ID format
                detectedTypeDiv.innerHTML = '<span style="color: #666; font-style: italic;">Enter Sample ID to detect type...</span>';
                detectedTypeDiv.style.background = '#f8f9fa';
                detectedTypeDiv.style.borderColor = '#ddd';

                // Clear form fields
                var container = document.getElementById('sampleTypeSpecificFields');
                if (container) container.innerHTML = '';
            }
        }

        // Update form fields based on sample type code
        function updateFoodSampleFieldsByType(sampleTypeCode) {
            var sampleType = sampleTypes[sampleTypeCode];
            var container = document.getElementById('sampleTypeSpecificFields');

            if (!sampleType || !container) return;

            // Clear existing fields
            container.innerHTML = '';

            if (sampleType.category === 'meat') {
                // Clone retail meat fields template
                var template = document.getElementById('retailMeatFieldsTemplate');
                if (template) {
                    container.innerHTML = template.innerHTML;
                }

                // Set default pathogen selections for retail meat after a brief delay to ensure checkboxes are rendered
                setTimeout(function() {
                    setDefaultPathogensForRM(sampleTypeCode);
                }, 100);
            } else if (sampleType.category === 'seafood') {
                // Clone seafood fields template
                var template = document.getElementById('seafoodFieldsTemplate');
                if (template) {
                    container.innerHTML = template.innerHTML;
                }

                // Set default pathogens for seafood after template loads
                setTimeout(function() {
                    setDefaultPathogensForSeafood();
                }, 100);
            }
        }

        // Set default pathogen selections for retail meat samples
        function setDefaultPathogensForRM(sampleTypeCode) {
            // Get the sample ID to check for specific numbers (CB01, CB02, etc.)
            var sampleId = document.getElementById('foodSampleId') ? document.getElementById('foodSampleId').value.trim().toUpperCase() : '';

            // Uncheck all pathogens first
            var allCheckboxes = document.querySelectorAll('input[name="pathogenTest"]');
            allCheckboxes.forEach(function(cb) {
                cb.checked = false;
            });

            // Salmonella (S1): ALL RM samples
            var s1Checkbox = document.querySelector('input[name="pathogenTest"][value="S1"]');
            if (s1Checkbox) s1Checkbox.checked = true;

            // E. coli (EC): ALL RM samples
            var ecCheckbox = document.querySelector('input[name="pathogenTest"][value="EC"]');
            if (ecCheckbox) ecCheckbox.checked = true;

            // Campylo (C1): ALL RM samples EXCEPT Ground Turkey (GT)
            if (sampleTypeCode !== 'GT') {
                var c1Checkbox = document.querySelector('input[name="pathogenTest"][value="C1"]');
                if (c1Checkbox) c1Checkbox.checked = true;
            }

            // Entero (E): ONLY CB01, CB02, GT01, GB01, and giblets (CL, CG, CH)
            var giblets = ['CL', 'CG', 'CH'];
            var checkEntero = false;

            if (giblets.indexOf(sampleTypeCode) !== -1) {
                // All giblets get Entero
                checkEntero = true;
            } else if (sampleId) {
                // Check for specific sample numbers: CB01, CB02, GT01, GB01
                if (sampleId.match(/CB01$/) || sampleId.match(/CB02$/) ||
                    sampleId.match(/GT01$/) || sampleId.match(/GB01$/)) {
                    checkEntero = true;
                }
            }

            if (checkEntero) {
                var eCheckbox = document.querySelector('input[name="pathogenTest"][value="E"]');
                if (eCheckbox) eCheckbox.checked = true;
            }
        }

        // Set default pathogen selections for seafood samples
        function setDefaultPathogensForSeafood() {
            // Uncheck all pathogens first
            var allCheckboxes = document.querySelectorAll('input[name="pathogenTest"]');
            allCheckboxes.forEach(function(cb) {
                cb.checked = false;
            });

            // Seafood samples get: Enterococcus (E), Aeromonas (A), Vibrio V1, Vibrio V2
            var eCheckbox = document.querySelector('input[name="pathogenTest"][value="E"]');
            if (eCheckbox) eCheckbox.checked = true;

            var aCheckbox = document.querySelector('input[name="pathogenTest"][value="A"]');
            if (aCheckbox) aCheckbox.checked = true;

            var v1Checkbox = document.querySelector('input[name="pathogenTest"][value="V1"]');
            if (v1Checkbox) v1Checkbox.checked = true;

            var v2Checkbox = document.querySelector('input[name="pathogenTest"][value="V2"]');
            if (v2Checkbox) v2Checkbox.checked = true;
        }

        // Legacy function - kept for compatibility
        function updateFoodSampleFields() {
            autoDetectSampleType();
        }

        // Add Food Sample
        function addFoodSample() {
            // Get common form values
            var id = document.getElementById('foodSampleId').value.trim().toUpperCase();
            var storeNum = document.getElementById('foodStoreNum').value.trim();
            var dateReceived = document.getElementById('foodDateReceived').value;

            // Extract sample type code from Sample ID
            var match = id.match(/^\d{2}[A-Z]{2}\d{2}([A-Z]{2})\d+$/);
            if (!match) {
                alert('Invalid Sample ID format. Expected format: YYSSTNN[TYPE]## (e.g., 25KS01CB01)');
                return;
            }
            var sampleTypeCode = match[1];

            // Check for duplicate Sample ID
            var existingSample = foodSamples.find(function(s) {
                return s.id === id;
            });
            if (existingSample) {
                alert('‚ö†Ô∏è Duplicate Sample ID!\n\nSample ID "' + id + '" already exists in the system.\n\nReceived: ' + existingSample.dateReceived + '\nStore: ' + existingSample.storeNum + '\n\nPlease use a different Sample ID or check if this is a duplicate entry.');
                return;
            }

            // Determine sample category (meat or seafood)
            var sampleType = sampleTypes[sampleTypeCode];
            if (!sampleType) {
                alert('Unknown sample type code: ' + sampleTypeCode);
                return;
            }
            var isSeafood = sampleType.category === 'seafood';

            // Get category-specific form values
            var brand, sellByDate, producedBy, country;
            var brandCode, packingType, packedInStore, estId, raisingClaims, meatTypeDetail, fatPercent;
            var frozenFresh, packagedFor, organicClaims, seafoodRaisingClaim, meatCut;

            if (isSeafood) {
                // Seafood fields
                brand = document.getElementById('foodSeafoodBrand') ? document.getElementById('foodSeafoodBrand').value.trim() : '';
                frozenFresh = document.getElementById('foodFrozenFresh') ? document.getElementById('foodFrozenFresh').value : '';
                sellByDate = document.getElementById('foodSeafoodSellByDate') ? document.getElementById('foodSeafoodSellByDate').value : '';
                producedBy = document.getElementById('foodSeafoodProducedBy') ? document.getElementById('foodSeafoodProducedBy').value.trim() : '';
                packagedFor = document.getElementById('foodPackagedFor') ? document.getElementById('foodPackagedFor').value.trim() : '';
                country = document.getElementById('foodSeafoodCountry') ? document.getElementById('foodSeafoodCountry').value.trim() : '';
                organicClaims = document.getElementById('foodOrganicClaims') ? document.getElementById('foodOrganicClaims').value.trim() : '';
                seafoodRaisingClaim = document.getElementById('foodSeafoodRaisingClaim') ? document.getElementById('foodSeafoodRaisingClaim').value : '';
                var seafoodRaisingClaimOther = document.getElementById('foodSeafoodRaisingClaimOther') ? document.getElementById('foodSeafoodRaisingClaimOther').value.trim() : '';
                if (seafoodRaisingClaim === 'Other') {
                    seafoodRaisingClaim = seafoodRaisingClaimOther;
                }
                meatCut = document.getElementById('foodMeatCut') ? document.getElementById('foodMeatCut').value.trim() : '';
            } else {
                // Retail meat fields
                brand = document.getElementById('foodBrand') ? document.getElementById('foodBrand').value.trim() : '';
                brandCode = document.getElementById('foodBrandCode') ? document.getElementById('foodBrandCode').value.trim() : '';
                sellByDate = document.getElementById('foodSellByDate') ? document.getElementById('foodSellByDate').value : '';
                packingType = document.getElementById('foodPackingType') ? document.getElementById('foodPackingType').value.trim() : '';
                packedInStore = document.getElementById('foodPackedInStore') ? document.getElementById('foodPackedInStore').value : '';
                var packedInStoreOther = document.getElementById('foodPackedInStoreOther') ? document.getElementById('foodPackedInStoreOther').value.trim() : '';
                if (packedInStore === 'Other') {
                    packedInStore = packedInStoreOther;
                }
                estId = document.getElementById('foodEstId') ? document.getElementById('foodEstId').value.trim() : '';
                producedBy = document.getElementById('foodProducedBy') ? document.getElementById('foodProducedBy').value.trim() : '';
                country = document.getElementById('foodCountry') ? document.getElementById('foodCountry').value.trim() : '';
                raisingClaims = document.getElementById('foodRaisingClaims') ? document.getElementById('foodRaisingClaims').value.trim() : '';
                meatTypeDetail = document.getElementById('foodMeatTypeDetail') ? document.getElementById('foodMeatTypeDetail').value.trim() : '';
                fatPercent = document.getElementById('foodFatPercent') ? document.getElementById('foodFatPercent').value.trim() : '';
            }

            // Validation (sample type already validated above)
            if (!storeNum) {
                alert('Please enter Store Name');
                return;
            }
            if (!dateReceived) {
                alert('Please select Date Received');
                return;
            }

            // Get selected pathogens
            var pathogenCheckboxes = document.querySelectorAll('input[name="pathogenTest"]:checked');
            if (pathogenCheckboxes.length === 0) {
                alert('Please select at least one pathogen to test');
                return;
            }

            var pathogensToTest = [];
            pathogenCheckboxes.forEach(function(cb) {
                pathogensToTest.push(cb.value);
            });

            // Create food sample object
            var foodSample = {
                id: id,
                sampleTypeCode: sampleTypeCode,
                category: isSeafood ? 'seafood' : 'meat',
                storeNum: storeNum,
                brand: brand,
                sellByDate: sellByDate,
                producedBy: producedBy,
                country: country,
                dateReceived: dateReceived,
                dateAdded: new Date().toISOString().split('T')[0],
                pathogensToTest: pathogensToTest
            };

            // Add category-specific fields
            if (isSeafood) {
                foodSample.frozenFresh = frozenFresh;
                foodSample.packagedFor = packagedFor;
                foodSample.organicClaims = organicClaims;
                foodSample.seafoodRaisingClaim = seafoodRaisingClaim;
                foodSample.meatCut = meatCut;
            } else {
                foodSample.brandCode = brandCode;
                foodSample.packingType = packingType;
                foodSample.packedInStore = packedInStore;
                foodSample.estId = estId;
                foodSample.raisingClaims = raisingClaims;
                foodSample.meatTypeDetail = meatTypeDetail;
                foodSample.fatPercent = fatPercent;
            }

            foodSamples.push(foodSample);

            // Add values to autocomplete history
            addStoreToHistory(storeNum);
            if (isSeafood) {
                // Seafood autocomplete history
                addSeafoodBrandToHistory(brand);
                addSeafoodProducedByToHistory(producedBy);
                addPackagedForToHistory(packagedFor);
                addSeafoodCountryToHistory(country);
                addOrganicClaimToHistory(organicClaims);
                addMeatCutToHistory(meatCut);
            } else {
                // Retail meat autocomplete history
                addBrandToHistory(brand);
                if (brand && brandCode) saveBrandCodeMapping(brand, brandCode);
                addPackingTypeToHistory(packingType);
                addProducedByToHistory(producedBy);
                addCountryToHistory(country);
                addRaisingClaimToHistory(raisingClaims);
                addMeatTypeToHistory(meatTypeDetail);
                addFatPercentToHistory(fatPercent);
            }

            // Auto-create pathogen workflow entries
            pathogensToTest.forEach(function(pathogenCode) {
                if (pathogenCode === 'EC') {
                    createEcoliWorkflow(id, pathogenCode);
                } else if (pathogenCode === 'C1') {
                    createCampyloWorkflow(id, pathogenCode);
                } else if (pathogenCode === 'S1') {
                    createSalmonellaWorkflow(id, pathogenCode);
                } else if (pathogenCode === 'E') {
                    // Detect if seafood or retail meat
                    if (sampleType.category === 'seafood') {
                        createEnterococcusSeafoodWorkflow(id, pathogenCode);
                    } else {
                        createEnterococcusWorkflow(id, pathogenCode);
                    }
                } else if (pathogenCode === 'A') {
                    createAeromonasWorkflow(id, pathogenCode);
                } else if (pathogenCode === 'V1') {
                    createVibrioV1Workflow(id, pathogenCode);
                } else if (pathogenCode === 'V2') {
                    createVibrioV2Workflow(id, pathogenCode);
                }
            });

            // Save and refresh
            saveData();
            showSuccessNotification('Food sample ' + id + ' added with ' + pathogensToTest.length + ' pathogen workflow(s)!');

            // Clear form
            document.getElementById('foodSampleId').value = '';
            document.getElementById('foodStoreNum').value = '';
            document.getElementById('foodDateReceived').value = '';
            document.getElementById('sampleTypeSpecificFields').innerHTML = '';
            document.getElementById('pathogenCheckboxes').innerHTML = '';

            // Reset detected type display
            var detectedTypeDiv = document.getElementById('detectedSampleType');
            if (detectedTypeDiv) {
                detectedTypeDiv.innerHTML = '<span style="color: #666; font-style: italic;">Enter Sample ID to detect type...</span>';
                detectedTypeDiv.style.background = '#f8f9fa';
                detectedTypeDiv.style.borderColor = '#ddd';
            }

            // Re-render
            renderFoodSamplesTab();
        }

        // Open Monthly Generator Modal
        function openMonthlyGeneratorModal() {
            // Set default month to current month
            var currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('generatorMonth').value = currentMonth;

            document.getElementById('monthlyGeneratorModal').style.display = 'block';
        }

        // Close Monthly Generator Modal
        function closeMonthlyGeneratorModal() {
            document.getElementById('monthlyGeneratorModal').style.display = 'none';
        }

        // Generate Monthly Samples
        function generateMonthlySamples() {
            var selectedMonth = document.getElementById('generatorMonth').value;
            var currentYear = new Date().getFullYear().toString().slice(-2); // Get last 2 digits of year

            // Get all checked checkboxes
            var checkboxes = document.querySelectorAll('.generator-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('Please select at least one sample to generate');
                return;
            }

            // Sample type mapping
            var sampleTypeMap = {
                'CB': {code: 'CB', category: 'meat'},
                'GT': {code: 'GT', category: 'meat'},
                'GB': {code: 'GB', category: 'meat'},
                'CL': {code: 'CL', category: 'meat'},
                'CG': {code: 'CG', category: 'meat'},
                'CH': {code: 'CH', category: 'meat'},
                'SA': {code: 'SA', category: 'seafood'},
                'TI': {code: 'TI', category: 'seafood'},
                'SH': {code: 'SH', category: 'seafood'}
            };

            var generatedCount = 0;
            var skippedCount = 0;
            var today = new Date().toISOString().split('T')[0];

            checkboxes.forEach(function(checkbox) {
                var sampleCode = checkbox.value; // e.g., "CB01"
                var typeCode = sampleCode.substring(0, 2); // e.g., "CB"

                // Build Sample ID: YYKSMMCODE (e.g., 25KS05CB01)
                var sampleId = currentYear + 'KS' + selectedMonth + sampleCode;

                // Check if sample already exists
                var exists = foodSamples.some(function(s) { return s.id === sampleId; });

                if (exists) {
                    skippedCount++;
                    return;
                }

                // Determine category and set default pathogens
                var category = sampleTypeMap[typeCode].category;
                var defaultPathogens = [];

                if (category === 'meat') {
                    // Retail Meat defaults
                    defaultPathogens.push('S1');  // Salmonella - ALL RM
                    defaultPathogens.push('EC');  // E. coli - ALL RM

                    // Campylo - ALL RM EXCEPT Ground Turkey
                    if (typeCode !== 'GT') {
                        defaultPathogens.push('C1');
                    }

                    // Enterococcus - ONLY specific samples (CB01, CB02, GT01, GB01, giblets)
                    var giblets = ['CL', 'CG', 'CH'];
                    if (giblets.indexOf(typeCode) !== -1 || sampleCode === 'CB01' || sampleCode === 'CB02' || sampleCode === 'GT01' || sampleCode === 'GB01') {
                        defaultPathogens.push('E');
                    }
                } else if (category === 'seafood') {
                    // Seafood defaults
                    defaultPathogens.push('E');   // Enterococcus
                    defaultPathogens.push('A');   // Aeromonas
                    defaultPathogens.push('V1');  // Vibrio (yellow)
                    defaultPathogens.push('V2');  // Vibrio (green)
                }

                // Create sample with minimal data - user will fill in details later
                var foodSample = {
                    id: sampleId,
                    sampleTypeCode: typeCode,
                    storeNum: '',
                    brand: '',
                    sellByDate: '',
                    dateReceived: today,
                    dateAdded: today,
                    pathogensToTest: defaultPathogens,
                    categoryData: {}
                };

                foodSamples.push(foodSample);

                // Auto-create pathogen workflow entries for this sample
                defaultPathogens.forEach(function(pathogenCode) {
                    if (pathogenCode === 'EC') {
                        createEcoliWorkflow(sampleId, pathogenCode);
                    } else if (pathogenCode === 'C1') {
                        createCampyloWorkflow(sampleId, pathogenCode);
                    } else if (pathogenCode === 'S1') {
                        createSalmonellaWorkflow(sampleId, pathogenCode);
                    } else if (pathogenCode === 'E') {
                        // Detect if seafood or retail meat
                        if (category === 'seafood') {
                            createEnterococcusSeafoodWorkflow(sampleId, pathogenCode);
                        } else {
                            createEnterococcusWorkflow(sampleId, pathogenCode);
                        }
                    } else if (pathogenCode === 'A') {
                        createAeromonasWorkflow(sampleId, pathogenCode);
                    } else if (pathogenCode === 'V1') {
                        createVibrioV1Workflow(sampleId, pathogenCode);
                    } else if (pathogenCode === 'V2') {
                        createVibrioV2Workflow(sampleId, pathogenCode);
                    }
                });

                generatedCount++;
            });

            // Save and close
            saveData();
            closeMonthlyGeneratorModal();

            // Show success message
            var message = 'Generated ' + generatedCount + ' sample(s)';
            if (skippedCount > 0) {
                message += ' (' + skippedCount + ' already existed)';
            }
            showSuccessNotification(message);

            // Refresh the view
            renderFoodSamplesTab();
        }

        // Track current bulk editor tab and samples being edited
        var currentBulkTab = 'meat';
        var currentBulkEditSamples = []; // Stores the samples currently being edited in bulk editor

        // Open Bulk Editor Modal (for all samples needing editing)
        function openBulkEditorModal() {
            // Find all food samples that have minimal data (need editing)
            var samplesToEdit = foodSamples.filter(function(s) {
                // Include samples with empty store# or no pathogens selected
                return !s.storeNum || s.pathogensToTest.length === 0;
            });

            if (samplesToEdit.length === 0) {
                alert('No samples need editing. All samples have store numbers and pathogens assigned.');
                return;
            }

            // Store samples for bulk editor
            currentBulkEditSamples = samplesToEdit;

            // Separate by category
            var meatSamples = samplesToEdit.filter(function(s) {
                return s.category === 'meat' || (!s.category && sampleTypes[s.sampleTypeCode] && sampleTypes[s.sampleTypeCode].category === 'meat');
            });
            var seafoodSamples = samplesToEdit.filter(function(s) {
                return s.category === 'seafood' || (!s.category && sampleTypes[s.sampleTypeCode] && sampleTypes[s.sampleTypeCode].category === 'seafood');
            });

            // Update counts
            document.getElementById('rmCount').textContent = meatSamples.length;
            document.getElementById('sfCount').textContent = seafoodSamples.length;

            // Start with meat tab if there are meat samples, otherwise seafood
            currentBulkTab = meatSamples.length > 0 ? 'meat' : 'seafood';
            switchBulkEditorTab(currentBulkTab);

            document.getElementById('bulkEditorModal').style.display = 'block';
        }

        // Open Bulk Editor Modal for SELECTED samples only
        function openBulkEditorForSelected() {
            // Check if any samples are selected
            if (selectedSamplesForDelete.length === 0) {
                alert('No samples selected. Please select samples using the checkboxes first.');
                return;
            }

            // Get only the selected samples
            var samplesToEdit = foodSamples.filter(function(s) {
                return selectedSamplesForDelete.indexOf(s.id) !== -1;
            });

            if (samplesToEdit.length === 0) {
                alert('Selected samples not found.');
                return;
            }

            // Store samples for bulk editor
            currentBulkEditSamples = samplesToEdit;

            // Separate by category
            var meatSamples = samplesToEdit.filter(function(s) {
                return s.category === 'meat' || (!s.category && sampleTypes[s.sampleTypeCode] && sampleTypes[s.sampleTypeCode].category === 'meat');
            });
            var seafoodSamples = samplesToEdit.filter(function(s) {
                return s.category === 'seafood' || (!s.category && sampleTypes[s.sampleTypeCode] && sampleTypes[s.sampleTypeCode].category === 'seafood');
            });

            // Update counts
            document.getElementById('rmCount').textContent = meatSamples.length;
            document.getElementById('sfCount').textContent = seafoodSamples.length;

            // Start with meat tab if there are meat samples, otherwise seafood
            currentBulkTab = meatSamples.length > 0 ? 'meat' : 'seafood';
            switchBulkEditorTab(currentBulkTab);

            document.getElementById('bulkEditorModal').style.display = 'block';
        }

        // Switch between bulk editor tabs
        function switchBulkEditorTab(category) {
            currentBulkTab = category;

            // Update tab styling
            var rmTab = document.getElementById('bulkTabRM');
            var sfTab = document.getElementById('bulkTabSF');

            if (category === 'meat') {
                rmTab.style.borderBottom = '3px solid #667eea';
                rmTab.style.color = '#667eea';
                sfTab.style.borderBottom = '3px solid transparent';
                sfTab.style.color = '#666';
            } else {
                sfTab.style.borderBottom = '3px solid #667eea';
                sfTab.style.color = '#667eea';
                rmTab.style.borderBottom = '3px solid transparent';
                rmTab.style.color = '#666';
            }

            // Render the appropriate table
            renderBulkEditor(category);
        }

        // Close Bulk Editor Modal
        function closeBulkEditorModal() {
            document.getElementById('bulkEditorModal').style.display = 'none';
        }

        // Render Bulk Editor Table
        function renderBulkEditor(category) {
            var container = document.getElementById('bulkEditorContent');

            // Use the stored samples (from openBulkEditorModal or openBulkEditorForSelected)
            // Filter by category
            var samplesToEdit = currentBulkEditSamples.filter(function(s) {
                var sampleCategory = s.category || (sampleTypes[s.sampleTypeCode] ? sampleTypes[s.sampleTypeCode].category : null);
                return sampleCategory === category;
            });

            if (samplesToEdit.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No ' + category + ' samples to edit.</div>';
                return;
            }

            var html = '';

            if (category === 'meat') {
                html = renderMeatBulkTable(samplesToEdit);
            } else {
                html = renderSeafoodBulkTable(samplesToEdit);
            }

            container.innerHTML = html;
        }

        // Render Retail Meat Bulk Editor Table
        function renderMeatBulkTable(samplesToEdit) {
            var html = '';

            html += '<div style="width: 100%; overflow-y: auto; max-height: 70vh;">';

            samplesToEdit.forEach(function(sample, index) {
                // Sample container with border
                html += '<div style="border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; padding: 15px; background: white;" data-sample-id="' + sample.id + '">';

                // Sample ID header
                html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-weight: 600; font-size: 14px;">';
                html += 'Sample: ' + sample.id;
                html += '</div>';

                // Row 1: Basic Info
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Type
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Type</label>';
                html += '<select id="bulkType_' + index + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">';
                html += '<option value="">--</option>';
                html += '<optgroup label="Meat">';
                html += '<option value="CB"' + (sample.sampleTypeCode === 'CB' ? ' selected' : '') + '>CB - Chicken Breast</option>';
                html += '<option value="GT"' + (sample.sampleTypeCode === 'GT' ? ' selected' : '') + '>GT - Ground Turkey</option>';
                html += '<option value="GB"' + (sample.sampleTypeCode === 'GB' ? ' selected' : '') + '>GB - Ground Beef</option>';
                html += '<option value="CL"' + (sample.sampleTypeCode === 'CL' ? ' selected' : '') + '>CL - Chicken Liver</option>';
                html += '<option value="CG"' + (sample.sampleTypeCode === 'CG' ? ' selected' : '') + '>CG - Chicken Gizzard</option>';
                html += '<option value="CH"' + (sample.sampleTypeCode === 'CH' ? ' selected' : '') + '>CH - Chicken Heart</option>';
                html += '</optgroup>';
                html += '<optgroup label="Seafood">';
                html += '<option value="SA"' + (sample.sampleTypeCode === 'SA' ? ' selected' : '') + '>SA - Salmon</option>';
                html += '<option value="SH"' + (sample.sampleTypeCode === 'SH' ? ' selected' : '') + '>SH - Shrimp</option>';
                html += '<option value="TI"' + (sample.sampleTypeCode === 'TI' ? ' selected' : '') + '>TI - Tilapia</option>';
                html += '</optgroup>';
                html += '</select>';
                html += '</div>';

                // Store Name
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Store Name</label>';
                html += '<input type="text" id="bulkStore_' + index + '" value="' + (sample.storeNum || '') + '" placeholder="e.g., Walmart Topeka" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showStoreAutocomplete(' + index + ')" onfocus="showStoreAutocomplete(' + index + ')" onblur="setTimeout(function(){ hideStoreAutocomplete(' + index + '); }, 200)" />';
                html += '<div id="storeAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Sell-By Date
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Sell-By Date</label>';
                html += '<input type="date" id="bulkSellBy_' + index + '" value="' + (sample.sellByDate || '') + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />';
                html += '</div>';

                // Packing Type
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Packing Type</label>';
                html += '<input type="text" id="bulkPackingType_' + index + '" value="' + (sample.packingType || '') + '" placeholder="e.g., Tray" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showPackingTypeAutocompleteBulk(' + index + ')" onfocus="showPackingTypeAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hidePackingTypeAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="packingTypeAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '</div>'; // End row 1

                // Row 2: Brand & Producer Info
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Brand
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Brand</label>';
                html += '<input type="text" id="bulkBrand_' + index + '" value="' + (sample.brand || '') + '" placeholder="Brand name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showBrandAutocompleteBulk(' + index + '); autofillBrandCodeBulk(' + index + ')" onfocus="showBrandAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideBrandAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="brandAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Brand Code
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Brand Code</label>';
                html += '<input type="text" id="bulkBrandCode_' + index + '" value="' + (sample.brandCode || '') + '" placeholder="Code" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />';
                html += '</div>';

                // Produced By
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Produced By</label>';
                html += '<input type="text" id="bulkProducedBy_' + index + '" value="' + (sample.producedBy || '') + '" placeholder="Producer" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showProducedByAutocompleteBulk(' + index + ')" onfocus="showProducedByAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideProducedByAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="producedByAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Country
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Country</label>';
                html += '<input type="text" id="bulkCountry_' + index + '" value="' + (sample.country || '') + '" placeholder="Country" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showCountryAutocompleteBulk(' + index + ')" onfocus="showCountryAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideCountryAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="countryAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '</div>'; // End row 2

                // Row 3: Product Details
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Packed in Store
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Packed in Store</label>';
                html += '<select id="bulkPackedInStore_' + index + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">';
                html += '<option value="">--</option>';
                html += '<option value="Yes"' + (sample.packedInStore === 'Yes' ? ' selected' : '') + '>Yes</option>';
                html += '<option value="No"' + (sample.packedInStore === 'No' ? ' selected' : '') + '>No</option>';
                html += '<option value="Unsure"' + (sample.packedInStore === 'Unsure' ? ' selected' : '') + '>Unsure</option>';
                html += '<option value="Other"' + (sample.packedInStore && sample.packedInStore !== 'Yes' && sample.packedInStore !== 'No' && sample.packedInStore !== 'Unsure' ? ' selected' : '') + '>Other</option>';
                html += '</select>';
                html += '</div>';

                // Est. ID
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Est. ID</label>';
                html += '<input type="text" id="bulkEstId_' + index + '" value="' + (sample.estId || '') + '" placeholder="Est. ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />';
                html += '</div>';

                // Raising Claims
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Raising Claims</label>';
                html += '<input type="text" id="bulkRaisingClaims_' + index + '" value="' + (sample.raisingClaims || '') + '" placeholder="Claims" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showRaisingClaimsAutocompleteBulk(' + index + ')" onfocus="showRaisingClaimsAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideRaisingClaimsAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="raisingClaimsAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Meat Type
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Meat Type</label>';
                html += '<input type="text" id="bulkMeatType_' + index + '" value="' + (sample.meatTypeDetail || '') + '" placeholder="Type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showMeatTypeAutocompleteBulk(' + index + ')" onfocus="showMeatTypeAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideMeatTypeAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="meatTypeAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Fat %
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Fat %</label>';
                html += '<input type="text" id="bulkFatPercent_' + index + '" value="' + (sample.fatPercent || '') + '" placeholder="%" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showFatPercentAutocompleteBulk(' + index + ')" onfocus="showFatPercentAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideFatPercentAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="fatPercentAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '</div>'; // End row 3

                // Row 4: Pathogens
                html += '<div style="border-top: 1px solid #e9ecef; padding-top: 15px;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Pathogens to Test</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 20px;">';

                var pathogensList = [
                    {code: 'EC', name: 'E. coli'},
                    {code: 'C1', name: 'Campylo'},
                    {code: 'S1', name: 'Salmonella'},
                    {code: 'E', name: 'Entero'},
                    {code: 'A', name: 'Aero'},
                    {code: 'V1', name: 'Vibrio'}
                ];

                pathogensList.forEach(function(p) {
                    var checked = sample.pathogensToTest.indexOf(p.code) !== -1 ? ' checked' : '';
                    html += '<label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">';
                    html += '<input type="checkbox" class="bulkPathogen_' + index + '" value="' + p.code + '"' + checked + ' style="cursor: pointer;">';
                    html += p.name;
                    html += '</label>';
                });

                html += '</div>';
                html += '</div>'; // End row 4

                html += '</div>'; // End sample container
            });

            html += '</div>'; // End scrollable container

            return html;
        }

        // Render Seafood Bulk Editor Table
        function renderSeafoodBulkTable(samplesToEdit) {
            var html = '';

            html += '<div style="width: 100%; overflow-y: auto; max-height: 70vh;">';

            samplesToEdit.forEach(function(sample, index) {
                // Sample container with border
                html += '<div style="border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; padding: 15px; background: white;" data-sample-id="' + sample.id + '">';

                // Sample ID header
                html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-weight: 600; font-size: 14px;">';
                html += 'Sample: ' + sample.id;
                html += '</div>';

                // Row 1: Basic Info
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Store Name
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Store Name</label>';
                html += '<input type="text" id="bulkStore_' + index + '" value="' + (sample.storeNum || '') + '" placeholder="e.g., Walmart Topeka" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showStoreAutocomplete(' + index + ')" onfocus="showStoreAutocomplete(' + index + ')" onblur="setTimeout(function(){ hideStoreAutocomplete(' + index + '); }, 200)" />';
                html += '<div id="storeAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Brand
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Brand</label>';
                html += '<input type="text" id="bulkSeafoodBrand_' + index + '" value="' + (sample.seafoodBrand || '') + '" placeholder="e.g., Sea Best" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodBrandAutocompleteBulk(' + index + ')" onfocus="showSeafoodBrandAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodBrandAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodBrandAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Frozen/Fresh
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Frozen/Fresh</label>';
                html += '<select id="bulkFrozenFresh_' + index + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">';
                html += '<option value="">--</option>';
                html += '<option value="Frozen"' + (sample.frozenFresh === 'Frozen' ? ' selected' : '') + '>Frozen</option>';
                html += '<option value="Fresh"' + (sample.frozenFresh === 'Fresh' ? ' selected' : '') + '>Fresh</option>';
                html += '</select>';
                html += '</div>';

                // Sell-By Date
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Sell-By Date</label>';
                html += '<input type="date" id="bulkSellBy_' + index + '" value="' + (sample.sellByDate || '') + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />';
                html += '</div>';

                html += '</div>'; // End row 1

                // Row 2: Producer Info
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Produced By
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Produced By</label>';
                html += '<input type="text" id="bulkSeafoodProducedBy_' + index + '" value="' + (sample.seafoodProducedBy || '') + '" placeholder="Producer" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodProducedByAutocompleteBulk(' + index + ')" onfocus="showSeafoodProducedByAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodProducedByAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodProducedByAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Packaged For
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Packaged For</label>';
                html += '<input type="text" id="bulkSeafoodPackagedFor_' + index + '" value="' + (sample.seafoodPackagedFor || '') + '" placeholder="Packaged for" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodPackagedForAutocompleteBulk(' + index + ')" onfocus="showSeafoodPackagedForAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodPackagedForAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodPackagedForAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Country
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Country</label>';
                html += '<input type="text" id="bulkSeafoodCountry_' + index + '" value="' + (sample.seafoodCountry || '') + '" placeholder="Country" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodCountryAutocompleteBulk(' + index + ')" onfocus="showSeafoodCountryAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodCountryAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodCountryAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '</div>'; // End row 2

                // Row 3: Product Details
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">';

                // Organic Claims
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Organic Claims</label>';
                html += '<input type="text" id="bulkSeafoodOrganicClaims_' + index + '" value="' + (sample.seafoodOrganicClaims || '') + '" placeholder="Claims" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodOrganicClaimsAutocompleteBulk(' + index + ')" onfocus="showSeafoodOrganicClaimsAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodOrganicClaimsAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodOrganicClaimsAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                // Raising Claims
                html += '<div>';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Raising Claims</label>';
                html += '<select id="bulkSeafoodRaisingClaims_' + index + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">';
                html += '<option value="">--</option>';
                html += '<option value="Farm"' + (sample.seafoodRaisingClaims === 'Farm' ? ' selected' : '') + '>Farm</option>';
                html += '<option value="Wild Caught"' + (sample.seafoodRaisingClaims === 'Wild Caught' ? ' selected' : '') + '>Wild Caught</option>';
                html += '<option value="Other"' + (sample.seafoodRaisingClaims && sample.seafoodRaisingClaims !== 'Farm' && sample.seafoodRaisingClaims !== 'Wild Caught' ? ' selected' : '') + '>Other</option>';
                html += '</select>';
                html += '</div>';

                // Meat Cut
                html += '<div style="position: relative;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Meat Cut</label>';
                html += '<input type="text" id="bulkSeafoodMeatCut_' + index + '" value="' + (sample.seafoodMeatCut || '') + '" placeholder="Cut type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" oninput="showSeafoodMeatCutAutocompleteBulk(' + index + ')" onfocus="showSeafoodMeatCutAutocompleteBulk(' + index + ')" onblur="setTimeout(function(){ hideSeafoodMeatCutAutocompleteBulk(' + index + '); }, 200)" />';
                html += '<div id="seafoodMeatCutAutocomplete_' + index + '" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '</div>'; // End row 3

                // Row 4: Pathogens
                html += '<div style="border-top: 1px solid #e9ecef; padding-top: 15px;">';
                html += '<label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: #666;">Pathogens to Test</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 20px;">';

                var pathogensList = [
                    {code: 'EC', name: 'E. coli'},
                    {code: 'C1', name: 'Campylo'},
                    {code: 'S1', name: 'Salmonella'},
                    {code: 'E', name: 'Entero'},
                    {code: 'A', name: 'Aero'},
                    {code: 'V1', name: 'Vibrio'}
                ];

                pathogensList.forEach(function(p) {
                    var checked = sample.pathogensToTest.indexOf(p.code) !== -1 ? ' checked' : '';
                    html += '<label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">';
                    html += '<input type="checkbox" class="bulkPathogen_' + index + '" value="' + p.code + '"' + checked + ' style="cursor: pointer;">';
                    html += p.name;
                    html += '</label>';
                });

                html += '</div>';
                html += '</div>'; // End row 4

                html += '</div>'; // End sample container
            });

            html += '</div>'; // End scrollable container

            return html;
        }

        // Save Bulk Edits
        function saveBulkEdits() {
            var rows = document.querySelectorAll('#bulkEditorContent tbody tr');
            var updatedCount = 0;

            rows.forEach(function(row, index) {
                var sampleId = row.getAttribute('data-sample-id');
                var sample = foodSamples.find(function(s) { return s.id === sampleId; });

                if (!sample) return;

                // Determine category
                var isSeafood = currentBulkTab === 'seafood';

                // Get common form values
                var storeNum = document.getElementById('bulkStore_' + index).value.trim();
                var brand = document.getElementById('bulkBrand_' + index).value.trim();
                var sellByDate = document.getElementById('bulkSellBy_' + index).value;
                var producedBy = document.getElementById('bulkProducedBy_' + index).value.trim();

                // Get category-specific values
                if (isSeafood) {
                    // Seafood fields
                    var frozenFresh = document.getElementById('bulkFrozenFresh_' + index).value;
                    var packagedFor = document.getElementById('bulkPackagedFor_' + index).value.trim();
                    var country = document.getElementById('bulkCountry_' + index).value.trim();
                    var organicClaims = document.getElementById('bulkOrganicClaims_' + index).value.trim();
                    var seafoodRaisingClaim = document.getElementById('bulkRaisingClaim_' + index).value;
                    var meatCut = document.getElementById('bulkMeatCut_' + index).value.trim();

                    // Update seafood sample
                    sample.storeNum = storeNum;
                    sample.brand = brand;
                    sample.sellByDate = sellByDate;
                    sample.producedBy = producedBy;
                    sample.frozenFresh = frozenFresh;
                    sample.packagedFor = packagedFor;
                    sample.country = country;
                    sample.organicClaims = organicClaims;
                    sample.seafoodRaisingClaim = seafoodRaisingClaim;
                    sample.meatCut = meatCut;

                    // Add to seafood autocomplete history
                    addStoreToHistory(storeNum);
                    addSeafoodBrandToHistory(brand);
                    addSeafoodProducedByToHistory(producedBy);
                    addPackagedForToHistory(packagedFor);
                    addSeafoodCountryToHistory(country);
                    addOrganicClaimToHistory(organicClaims);
                    addMeatCutToHistory(meatCut);
                } else {
                    // Retail meat fields
                    var brandCode = document.getElementById('bulkBrandCode_' + index).value.trim();
                    var packingType = document.getElementById('bulkPackingType_' + index).value.trim();
                    var packedInStore = document.getElementById('bulkPackedInStore_' + index).value;
                    var estId = document.getElementById('bulkEstId_' + index).value.trim();
                    var country = document.getElementById('bulkCountry_' + index).value.trim();
                    var raisingClaims = document.getElementById('bulkRaisingClaims_' + index).value.trim();
                    var meatTypeDetail = document.getElementById('bulkMeatType_' + index).value.trim();
                    var fatPercent = document.getElementById('bulkFatPercent_' + index).value.trim();

                    // Update retail meat sample
                    sample.storeNum = storeNum;
                    sample.brand = brand;
                    sample.brandCode = brandCode;
                    sample.sellByDate = sellByDate;
                    sample.packingType = packingType;
                    sample.packedInStore = packedInStore;
                    sample.estId = estId;
                    sample.producedBy = producedBy;
                    sample.country = country;
                    sample.raisingClaims = raisingClaims;
                    sample.meatTypeDetail = meatTypeDetail;
                    sample.fatPercent = fatPercent;

                    // Add to retail meat autocomplete history
                    addStoreToHistory(storeNum);
                    addBrandToHistory(brand);
                    if (brand && brandCode) saveBrandCodeMapping(brand, brandCode);
                    addPackingTypeToHistory(packingType);
                    addProducedByToHistory(producedBy);
                    addCountryToHistory(country);
                    addRaisingClaimToHistory(raisingClaims);
                    addMeatTypeToHistory(meatTypeDetail);
                    addFatPercentToHistory(fatPercent);
                }

                // Get selected pathogens
                var pathogenCheckboxes = document.querySelectorAll('.bulkPathogen_' + index + ':checked');
                var pathogensToTest = [];
                pathogenCheckboxes.forEach(function(cb) {
                    pathogensToTest.push(cb.value);
                });

                // Only update pathogens if changed
                var oldPathogens = sample.pathogensToTest || [];
                var newPathogens = pathogensToTest;

                // Find newly added pathogens
                newPathogens.forEach(function(pathogenCode) {
                    if (oldPathogens.indexOf(pathogenCode) === -1) {
                        // Create workflow for this pathogen
                        if (pathogenCode === 'EC') {
                            createEcoliWorkflow(sampleId, pathogenCode);
                        } else if (pathogenCode === 'C1') {
                            createCampyloWorkflow(sampleId, pathogenCode);
                        } else if (pathogenCode === 'S1') {
                            createSalmonellaWorkflow(sampleId, pathogenCode);
                        } else if (pathogenCode === 'E') {
                            var sampleType = sampleTypes[typeCode];
                            if (sampleType && sampleType.category === 'seafood') {
                                createEnterococcusSeafoodWorkflow(sampleId, pathogenCode);
                            } else {
                                createEnterococcusWorkflow(sampleId, pathogenCode);
                            }
                        } else if (pathogenCode === 'A') {
                            createAeromonasWorkflow(sampleId, pathogenCode);
                        } else if (pathogenCode === 'V1') {
                            createVibrioV1Workflow(sampleId, pathogenCode);
                        }
                    }
                });

                sample.pathogensToTest = pathogensToTest;
                updatedCount++;
            });

            // Save and close
            saveData();
            closeBulkEditorModal();
            showSuccessNotification('Updated ' + updatedCount + ' sample(s)!');
            renderFoodSamplesTab();
        }

        // Store Autocomplete Functions
        function showStoreAutocomplete(index) {
            var input = document.getElementById('bulkStore_' + index);
            var dropdown = document.getElementById('storeAutocomplete_' + index);

            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();

            // Filter store names based on input
            var matches = storeNames.filter(function(store) {
                return store.toLowerCase().indexOf(value) !== -1;
            });

            // Show dropdown if there are matches or if input is empty (show all)
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayStores = value === '' ? storeNames : matches;

                // Limit to 10 results
                displayStores.slice(0, 10).forEach(function(store) {
                    html += '<div onclick="selectStore(' + index + ', \'' + store.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + store + '</div>';
                });

                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideStoreAutocomplete(index) {
            var dropdown = document.getElementById('storeAutocomplete_' + index);
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function selectStore(index, storeName) {
            var input = document.getElementById('bulkStore_' + index);
            if (input) {
                input.value = storeName;
            }
            hideStoreAutocomplete(index);
        }

        // Add store name to history if new
        function addStoreToHistory(storeName) {
            if (!storeName || storeName.trim() === '') return;

            var trimmedName = storeName.trim();

            // Check if store already exists (case-insensitive)
            var exists = storeNames.some(function(s) {
                return s.toLowerCase() === trimmedName.toLowerCase();
            });

            if (!exists) {
                storeNames.push(trimmedName);
                // Keep store names sorted for easier browsing
                storeNames.sort();
            }
        }

        // Bulk Editor Autocomplete Functions for New Fields

        // Brand autocomplete for bulk editor
        function showBrandAutocompleteBulk(index) {
            var input = document.getElementById('bulkBrand_' + index);
            var dropdown = document.getElementById('brandAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = brandNames.filter(function(brand) {
                return brand.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayBrands = value === '' ? brandNames : matches;
                displayBrands.slice(0, 10).forEach(function(brand) {
                    html += '<div onclick="selectBrandBulk(' + index + ', \'' + brand.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + brand + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideBrandAutocompleteBulk(index) {
            var dropdown = document.getElementById('brandAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectBrandBulk(index, brandName) {
            var input = document.getElementById('bulkBrand_' + index);
            if (input) input.value = brandName;
            hideBrandAutocompleteBulk(index);
            autofillBrandCodeBulk(index);
        }
        function autofillBrandCodeBulk(index) {
            var brandInput = document.getElementById('bulkBrand_' + index);
            var codeInput = document.getElementById('bulkBrandCode_' + index);
            if (!brandInput || !codeInput) return;
            var brandName = brandInput.value.trim();
            if (brandCodeMap[brandName]) {
                codeInput.value = brandCodeMap[brandName];
            }
        }

        // Packing Type autocomplete for bulk editor
        function showPackingTypeAutocompleteBulk(index) {
            var input = document.getElementById('bulkPackingType_' + index);
            var dropdown = document.getElementById('packingTypeAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = packingTypes.filter(function(type) {
                return type.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayTypes = value === '' ? packingTypes : matches;
                displayTypes.slice(0, 10).forEach(function(type) {
                    html += '<div onclick="selectPackingTypeBulk(' + index + ', \'' + type.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + type + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hidePackingTypeAutocompleteBulk(index) {
            var dropdown = document.getElementById('packingTypeAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectPackingTypeBulk(index, typeName) {
            var input = document.getElementById('bulkPackingType_' + index);
            if (input) input.value = typeName;
            hidePackingTypeAutocompleteBulk(index);
        }

        // Produced By autocomplete for bulk editor
        function showProducedByAutocompleteBulk(index) {
            var input = document.getElementById('bulkProducedBy_' + index);
            var dropdown = document.getElementById('producedByAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = producedByNames.filter(function(name) {
                return name.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayNames = value === '' ? producedByNames : matches;
                displayNames.slice(0, 10).forEach(function(name) {
                    html += '<div onclick="selectProducedByBulk(' + index + ', \'' + name.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + name + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideProducedByAutocompleteBulk(index) {
            var dropdown = document.getElementById('producedByAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectProducedByBulk(index, name) {
            var input = document.getElementById('bulkProducedBy_' + index);
            if (input) input.value = name;
            hideProducedByAutocompleteBulk(index);
        }

        // Country autocomplete for bulk editor
        function showCountryAutocompleteBulk(index) {
            var input = document.getElementById('bulkCountry_' + index);
            var dropdown = document.getElementById('countryAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = countryNames.filter(function(country) {
                return country.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayCountries = value === '' ? countryNames : matches;
                displayCountries.slice(0, 10).forEach(function(country) {
                    html += '<div onclick="selectCountryBulk(' + index + ', \'' + country.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + country + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideCountryAutocompleteBulk(index) {
            var dropdown = document.getElementById('countryAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectCountryBulk(index, country) {
            var input = document.getElementById('bulkCountry_' + index);
            if (input) input.value = country;
            hideCountryAutocompleteBulk(index);
        }

        // Raising Claims autocomplete for bulk editor
        function showRaisingClaimsAutocompleteBulk(index) {
            var input = document.getElementById('bulkRaisingClaims_' + index);
            var dropdown = document.getElementById('raisingClaimsAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = raisingClaims.filter(function(claim) {
                return claim.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayClaims = value === '' ? raisingClaims : matches;
                displayClaims.slice(0, 10).forEach(function(claim) {
                    html += '<div onclick="selectRaisingClaimBulk(' + index + ', \'' + claim.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + claim + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideRaisingClaimsAutocompleteBulk(index) {
            var dropdown = document.getElementById('raisingClaimsAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectRaisingClaimBulk(index, claim) {
            var input = document.getElementById('bulkRaisingClaims_' + index);
            if (input) input.value = claim;
            hideRaisingClaimsAutocompleteBulk(index);
        }

        // Meat Type autocomplete for bulk editor
        function showMeatTypeAutocompleteBulk(index) {
            var input = document.getElementById('bulkMeatType_' + index);
            var dropdown = document.getElementById('meatTypeAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = meatTypes.filter(function(type) {
                return type.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayTypes = value === '' ? meatTypes : matches;
                displayTypes.slice(0, 10).forEach(function(type) {
                    html += '<div onclick="selectMeatTypeBulk(' + index + ', \'' + type.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + type + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideMeatTypeAutocompleteBulk(index) {
            var dropdown = document.getElementById('meatTypeAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectMeatTypeBulk(index, type) {
            var input = document.getElementById('bulkMeatType_' + index);
            if (input) input.value = type;
            hideMeatTypeAutocompleteBulk(index);
        }

        // Fat % autocomplete for bulk editor
        function showFatPercentAutocompleteBulk(index) {
            var input = document.getElementById('bulkFatPercent_' + index);
            var dropdown = document.getElementById('fatPercentAutocomplete_' + index);
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = fatPercentages.filter(function(pct) {
                return pct.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayPcts = value === '' ? fatPercentages : matches;
                displayPcts.slice(0, 10).forEach(function(pct) {
                    html += '<div onclick="selectFatPercentBulk(' + index + ', \'' + pct.replace(/'/g, "\\'") + '\')" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + pct + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideFatPercentAutocompleteBulk(index) {
            var dropdown = document.getElementById('fatPercentAutocomplete_' + index);
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectFatPercentBulk(index, pct) {
            var input = document.getElementById('bulkFatPercent_' + index);
            if (input) input.value = pct;
            hideFatPercentAutocompleteBulk(index);
        }

        // Single Sample Form Autocomplete Functions
        function showStoreAutocompleteSingle() {
            var input = document.getElementById('foodStoreNum');
            var dropdown = document.getElementById('storeAutocompleteSingle');

            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();

            // Filter store names based on input
            var matches = storeNames.filter(function(store) {
                return store.toLowerCase().indexOf(value) !== -1;
            });

            // Show dropdown if there are matches or if input is empty (show all)
            if (matches.length > 0 || value === '') {
                var html = '';
                var displayStores = value === '' ? storeNames : matches;

                // Limit to 10 results
                displayStores.slice(0, 10).forEach(function(store) {
                    html += '<div onclick="selectStoreSingle(\'' + store.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + store + '</div>';
                });

                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideStoreAutocompleteSingle() {
            var dropdown = document.getElementById('storeAutocompleteSingle');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function selectStoreSingle(storeName) {
            var input = document.getElementById('foodStoreNum');
            if (input) {
                input.value = storeName;
            }
            hideStoreAutocompleteSingle();
        }

        // Sample ID Autocomplete - Predictive (like Google)
        function showSampleIdAutocomplete() {
            var input = document.getElementById('foodSampleId');
            var dropdown = document.getElementById('sampleIdAutocomplete');

            if (!input || !dropdown) return;

            var value = input.value.toUpperCase().trim();

            if (value === '') {
                dropdown.style.display = 'none';
                return;
            }

            // Get all existing food sample IDs
            var existingSampleIds = samples
                .filter(function(s) { return s.sampleType === 'food'; })
                .map(function(s) { return s.id; });

            // Find IDs that START with what the user has typed
            var matches = existingSampleIds.filter(function(id) {
                return id.startsWith(value);
            });

            // Get unique suggestions by finding what comes next after the current input
            var suggestions = [];
            var seen = {};

            matches.forEach(function(id) {
                // Find the next character/segment after what user typed
                if (id.length > value.length) {
                    // Suggest next 1-2 characters intelligently
                    var remaining = id.substring(value.length);
                    var suggestion = '';

                    // If next chars are letters, suggest up to 2 letters
                    // If next chars are digits, suggest up to 2 digits
                    if (/^[A-Z]/.test(remaining)) {
                        suggestion = remaining.match(/^[A-Z]{1,2}/)[0];
                    } else if (/^\d/.test(remaining)) {
                        suggestion = remaining.match(/^\d{1,2}/)[0];
                    }

                    var fullSuggestion = value + suggestion;
                    if (!seen[fullSuggestion]) {
                        seen[fullSuggestion] = true;
                        suggestions.push({
                            text: fullSuggestion,
                            full: id
                        });
                    }
                }
            });

            // Show dropdown if there are suggestions
            if (suggestions.length > 0) {
                var html = '';

                // Limit to 10 results
                suggestions.slice(0, 10).forEach(function(sugg) {
                    // Highlight the part user has already typed
                    var displayText = '<strong>' + value + '</strong>' + sugg.text.substring(value.length);
                    if (sugg.full !== sugg.text) {
                        displayText += '<span style="color: #999; font-size: 12px; margin-left: 8px;">(' + sugg.full + ')</span>';
                    }

                    html += '<div onclick="selectSampleId(\'' + sugg.text.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + displayText + '</div>';
                });

                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideSampleIdAutocomplete() {
            var dropdown = document.getElementById('sampleIdAutocomplete');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function selectSampleId(sampleId) {
            var input = document.getElementById('foodSampleId');
            if (input) {
                input.value = sampleId;
                // Trigger auto-detection
                autoDetectSampleType();
            }
            hideSampleIdAutocomplete();
        }

        // Brand Autocomplete and Brand Code Auto-fill
        function showBrandAutocomplete() {
            var input = document.getElementById('foodBrand');
            var dropdown = document.getElementById('brandAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = brandNames.filter(function(brand) {
                return brand.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var displayBrands = value === '' ? brandNames : matches;
                displayBrands.slice(0, 10).forEach(function(brand) {
                    html += '<div onclick="selectBrand(\'' + brand.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + brand + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideBrandAutocomplete() {
            var dropdown = document.getElementById('brandAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectBrand(brandName) {
            var input = document.getElementById('foodBrand');
            if (input) {
                input.value = brandName;
                autofillBrandCode();
            }
            hideBrandAutocomplete();
        }

        function autofillBrandCode() {
            var brandInput = document.getElementById('foodBrand');
            var codeInput = document.getElementById('foodBrandCode');
            if (!brandInput || !codeInput) return;

            var brandName = brandInput.value.trim();
            if (brandCodeMap[brandName]) {
                codeInput.value = brandCodeMap[brandName];
            }
        }

        function addBrandToHistory(brandName) {
            if (!brandName || brandName.trim() === '') return;
            var trimmedName = brandName.trim();
            if (!brandNames.some(function(b) { return b.toLowerCase() === trimmedName.toLowerCase(); })) {
                brandNames.push(trimmedName);
                brandNames.sort();
            }
        }

        function saveBrandCodeMapping(brandName, code) {
            if (brandName && code) {
                brandCodeMap[brandName.trim()] = code.trim();
            }
        }

        // Packing Type Autocomplete
        function showPackingTypeAutocomplete() {
            var input = document.getElementById('foodPackingType');
            var dropdown = document.getElementById('packingTypeAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = packingTypes.filter(function(type) {
                return type.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? packingTypes : matches;
                display.slice(0, 10).forEach(function(type) {
                    html += '<div onclick="selectPackingType(\'' + type.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + type + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hidePackingTypeAutocomplete() {
            var dropdown = document.getElementById('packingTypeAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectPackingType(type) {
            var input = document.getElementById('foodPackingType');
            if (input) input.value = type;
            hidePackingTypeAutocomplete();
        }

        function addPackingTypeToHistory(type) {
            if (!type || type.trim() === '') return;
            var trimmed = type.trim();
            if (!packingTypes.some(function(t) { return t.toLowerCase() === trimmed.toLowerCase(); })) {
                packingTypes.push(trimmed);
                packingTypes.sort();
            }
        }

        // Produced By Autocomplete
        function showProducedByAutocomplete() {
            var input = document.getElementById('foodProducedBy');
            var dropdown = document.getElementById('producedByAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = producedByNames.filter(function(name) {
                return name.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? producedByNames : matches;
                display.slice(0, 10).forEach(function(name) {
                    html += '<div onclick="selectProducedBy(\'' + name.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + name + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideProducedByAutocomplete() {
            var dropdown = document.getElementById('producedByAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectProducedBy(name) {
            var input = document.getElementById('foodProducedBy');
            if (input) input.value = name;
            hideProducedByAutocomplete();
        }

        function addProducedByToHistory(name) {
            if (!name || name.trim() === '') return;
            var trimmed = name.trim();
            if (!producedByNames.some(function(n) { return n.toLowerCase() === trimmed.toLowerCase(); })) {
                producedByNames.push(trimmed);
                producedByNames.sort();
            }
        }

        // Country Autocomplete
        function showCountryAutocomplete() {
            var input = document.getElementById('foodCountry');
            var dropdown = document.getElementById('countryAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = countryNames.filter(function(country) {
                return country.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? countryNames : matches;
                display.slice(0, 10).forEach(function(country) {
                    html += '<div onclick="selectCountry(\'' + country.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + country + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideCountryAutocomplete() {
            var dropdown = document.getElementById('countryAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectCountry(country) {
            var input = document.getElementById('foodCountry');
            if (input) input.value = country;
            hideCountryAutocomplete();
        }

        function addCountryToHistory(country) {
            if (!country || country.trim() === '') return;
            var trimmed = country.trim();
            if (!countryNames.some(function(c) { return c.toLowerCase() === trimmed.toLowerCase(); })) {
                countryNames.push(trimmed);
                countryNames.sort();
            }
        }

        // Raising Claims Autocomplete
        function showRaisingClaimsAutocomplete() {
            var input = document.getElementById('foodRaisingClaims');
            var dropdown = document.getElementById('raisingClaimsAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = raisingClaims.filter(function(claim) {
                return claim.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? raisingClaims : matches;
                display.slice(0, 10).forEach(function(claim) {
                    html += '<div onclick="selectRaisingClaim(\'' + claim.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + claim + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideRaisingClaimsAutocomplete() {
            var dropdown = document.getElementById('raisingClaimsAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectRaisingClaim(claim) {
            var input = document.getElementById('foodRaisingClaims');
            if (input) input.value = claim;
            hideRaisingClaimsAutocomplete();
        }

        function addRaisingClaimToHistory(claim) {
            if (!claim || claim.trim() === '') return;
            var trimmed = claim.trim();
            if (!raisingClaims.some(function(c) { return c.toLowerCase() === trimmed.toLowerCase(); })) {
                raisingClaims.push(trimmed);
                raisingClaims.sort();
            }
        }

        // Meat Type Autocomplete
        function showMeatTypeAutocomplete() {
            var input = document.getElementById('foodMeatTypeDetail');
            var dropdown = document.getElementById('meatTypeAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = meatTypes.filter(function(type) {
                return type.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? meatTypes : matches;
                display.slice(0, 10).forEach(function(type) {
                    html += '<div onclick="selectMeatType(\'' + type.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + type + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideMeatTypeAutocomplete() {
            var dropdown = document.getElementById('meatTypeAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectMeatType(type) {
            var input = document.getElementById('foodMeatTypeDetail');
            if (input) input.value = type;
            hideMeatTypeAutocomplete();
        }

        function addMeatTypeToHistory(type) {
            if (!type || type.trim() === '') return;
            var trimmed = type.trim();
            if (!meatTypes.some(function(t) { return t.toLowerCase() === trimmed.toLowerCase(); })) {
                meatTypes.push(trimmed);
                meatTypes.sort();
            }
        }

        // Fat Percent Autocomplete
        function showFatPercentAutocomplete() {
            var input = document.getElementById('foodFatPercent');
            var dropdown = document.getElementById('fatPercentAutocomplete');
            if (!input || !dropdown) return;

            var value = input.value.toLowerCase().trim();
            var matches = fatPercentages.filter(function(percent) {
                return percent.toLowerCase().indexOf(value) !== -1;
            });

            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? fatPercentages : matches;
                display.slice(0, 10).forEach(function(percent) {
                    html += '<div onclick="selectFatPercent(\'' + percent.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + percent + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function hideFatPercentAutocomplete() {
            var dropdown = document.getElementById('fatPercentAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }

        function selectFatPercent(percent) {
            var input = document.getElementById('foodFatPercent');
            if (input) input.value = percent;
            hideFatPercentAutocomplete();
        }

        function addFatPercentToHistory(percent) {
            if (!percent || percent.trim() === '') return;
            var trimmed = percent.trim();
            if (!fatPercentages.some(function(p) { return p.toLowerCase() === trimmed.toLowerCase(); })) {
                fatPercentages.push(trimmed);
                fatPercentages.sort();
            }
        }

        // Toggle Packed in Store Other field
        function togglePackedInStoreOther() {
            var select = document.getElementById('foodPackedInStore');
            var otherContainer = document.getElementById('packedInStoreOtherContainer');
            if (select && otherContainer) {
                if (select.value === 'Other') {
                    otherContainer.style.display = 'block';
                } else {
                    otherContainer.style.display = 'none';
                }
            }
        }

        // Toggle Seafood Raising Claim Other field
        function toggleSeafoodRaisingClaimOther() {
            var select = document.getElementById('foodSeafoodRaisingClaim');
            var otherContainer = document.getElementById('seafoodRaisingClaimOtherContainer');
            if (select && otherContainer) {
                if (select.value === 'Other') {
                    otherContainer.style.display = 'block';
                } else {
                    otherContainer.style.display = 'none';
                }
            }
        }

        // SEAFOOD AUTOCOMPLETE FUNCTIONS

        // Seafood Brand autocomplete
        function showSeafoodBrandAutocomplete() {
            var input = document.getElementById('foodSeafoodBrand');
            var dropdown = document.getElementById('seafoodBrandAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodBrands.filter(function(brand) {
                return brand.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodBrands : matches;
                display.slice(0, 10).forEach(function(brand) {
                    html += '<div onclick="selectSeafoodBrand(\'' + brand.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + brand + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideSeafoodBrandAutocomplete() {
            var dropdown = document.getElementById('seafoodBrandAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectSeafoodBrand(brand) {
            var input = document.getElementById('foodSeafoodBrand');
            if (input) input.value = brand;
            hideSeafoodBrandAutocomplete();
        }
        function addSeafoodBrandToHistory(brand) {
            if (!brand || brand.trim() === '') return;
            var trimmed = brand.trim();
            if (!seafoodBrands.some(function(b) { return b.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodBrands.push(trimmed);
                seafoodBrands.sort();
            }
        }

        // Seafood Produced By autocomplete
        function showSeafoodProducedByAutocomplete() {
            var input = document.getElementById('foodSeafoodProducedBy');
            var dropdown = document.getElementById('seafoodProducedByAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodProducedBy.filter(function(name) {
                return name.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodProducedBy : matches;
                display.slice(0, 10).forEach(function(name) {
                    html += '<div onclick="selectSeafoodProducedBy(\'' + name.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + name + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideSeafoodProducedByAutocomplete() {
            var dropdown = document.getElementById('seafoodProducedByAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectSeafoodProducedBy(name) {
            var input = document.getElementById('foodSeafoodProducedBy');
            if (input) input.value = name;
            hideSeafoodProducedByAutocomplete();
        }
        function addSeafoodProducedByToHistory(name) {
            if (!name || name.trim() === '') return;
            var trimmed = name.trim();
            if (!seafoodProducedBy.some(function(n) { return n.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodProducedBy.push(trimmed);
                seafoodProducedBy.sort();
            }
        }

        // Packaged For autocomplete
        function showPackagedForAutocomplete() {
            var input = document.getElementById('foodPackagedFor');
            var dropdown = document.getElementById('packagedForAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodPackagedFor.filter(function(name) {
                return name.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodPackagedFor : matches;
                display.slice(0, 10).forEach(function(name) {
                    html += '<div onclick="selectPackagedFor(\'' + name.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + name + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hidePackagedForAutocomplete() {
            var dropdown = document.getElementById('packagedForAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectPackagedFor(name) {
            var input = document.getElementById('foodPackagedFor');
            if (input) input.value = name;
            hidePackagedForAutocomplete();
        }
        function addPackagedForToHistory(name) {
            if (!name || name.trim() === '') return;
            var trimmed = name.trim();
            if (!seafoodPackagedFor.some(function(n) { return n.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodPackagedFor.push(trimmed);
                seafoodPackagedFor.sort();
            }
        }

        // Seafood Country autocomplete
        function showSeafoodCountryAutocomplete() {
            var input = document.getElementById('foodSeafoodCountry');
            var dropdown = document.getElementById('seafoodCountryAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodCountries.filter(function(country) {
                return country.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodCountries : matches;
                display.slice(0, 10).forEach(function(country) {
                    html += '<div onclick="selectSeafoodCountry(\'' + country.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + country + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideSeafoodCountryAutocomplete() {
            var dropdown = document.getElementById('seafoodCountryAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectSeafoodCountry(country) {
            var input = document.getElementById('foodSeafoodCountry');
            if (input) input.value = country;
            hideSeafoodCountryAutocomplete();
        }
        function addSeafoodCountryToHistory(country) {
            if (!country || country.trim() === '') return;
            var trimmed = country.trim();
            if (!seafoodCountries.some(function(c) { return c.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodCountries.push(trimmed);
                seafoodCountries.sort();
            }
        }

        // Organic Claims autocomplete
        function showOrganicClaimsAutocomplete() {
            var input = document.getElementById('foodOrganicClaims');
            var dropdown = document.getElementById('organicClaimsAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodOrganicClaims.filter(function(claim) {
                return claim.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodOrganicClaims : matches;
                display.slice(0, 10).forEach(function(claim) {
                    html += '<div onclick="selectOrganicClaim(\'' + claim.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + claim + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideOrganicClaimsAutocomplete() {
            var dropdown = document.getElementById('organicClaimsAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectOrganicClaim(claim) {
            var input = document.getElementById('foodOrganicClaims');
            if (input) input.value = claim;
            hideOrganicClaimsAutocomplete();
        }
        function addOrganicClaimToHistory(claim) {
            if (!claim || claim.trim() === '') return;
            var trimmed = claim.trim();
            if (!seafoodOrganicClaims.some(function(c) { return c.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodOrganicClaims.push(trimmed);
                seafoodOrganicClaims.sort();
            }
        }

        // Meat Cut autocomplete
        function showMeatCutAutocomplete() {
            var input = document.getElementById('foodMeatCut');
            var dropdown = document.getElementById('meatCutAutocomplete');
            if (!input || !dropdown) return;
            var value = input.value.toLowerCase().trim();
            var matches = seafoodMeatCuts.filter(function(cut) {
                return cut.toLowerCase().indexOf(value) !== -1;
            });
            if (matches.length > 0 || value === '') {
                var html = '';
                var display = value === '' ? seafoodMeatCuts : matches;
                display.slice(0, 10).forEach(function(cut) {
                    html += '<div onclick="selectMeatCut(\'' + cut.replace(/'/g, "\\'") + '\')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">' + cut + '</div>';
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        function hideMeatCutAutocomplete() {
            var dropdown = document.getElementById('meatCutAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
        function selectMeatCut(cut) {
            var input = document.getElementById('foodMeatCut');
            if (input) input.value = cut;
            hideMeatCutAutocomplete();
        }
        function addMeatCutToHistory(cut) {
            if (!cut || cut.trim() === '') return;
            var trimmed = cut.trim();
            if (!seafoodMeatCuts.some(function(c) { return c.toLowerCase() === trimmed.toLowerCase(); })) {
                seafoodMeatCuts.push(trimmed);
                seafoodMeatCuts.sort();
            }
        }

        // Create E. coli workflow
        function createEcoliWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1A - Pending', // Starting status (BPW Prep)
                finalResult: null, // 'positive', 'negative', 'in-progress'
                resultDate: null,
                stages: {
                    day1A_BPWPrep: {completed: false},      // Day 1A - BPW Sample Prep
                    day1B_MacBroth: {completed: false},     // Day 1B - MAC Broth Enrichment
                    day2_MacAgar: {completed: false},       // Day 2 - MAC Agar
                    day3_PinkColonies: {                    // Day 3 - Pink Colonies Check (DECISION POINT)
                        completed: false,
                        hasPinkColonies: null,              // null, 'yes', 'no'
                        dateChecked: null
                    },
                    day4_MALDI: {                           // Day 4 - MALDI (only if pink colonies)
                        completed: false,
                        dateSent: null,
                        result: null,                       // 'positive', 'negative'
                        speciesId: null                     // If negative, what species was it?
                    },
                    day5_Storage: {                         // Day 5 - Storage (only if MALDI positive)
                        completed: false,
                        vialId: null,                       // Auto: "25KS10CB01-EC"
                        dateStored: null,
                        freezer: null,
                        box: null,
                        shelf: null,
                        rack: null,
                        position: null
                    }
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Campylobacter workflow
        function createCampyloWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1A - Pending', // Starting status (BPW Prep)
                finalResult: null, // 'positive', 'negative', 'in-progress'
                resultDate: null,
                stages: {
                    day1A_BPWPrep: {completed: false},      // Day 1A - BPW Sample Prep (shared)
                    day1B_BoltonBroth: {completed: false},  // Day 1B - Bolton Broth Enrichment
                    day2_CCA: {                             // Day 2 - Campy-Cefex Agar
                        completed: false,
                        hasGrowth: null,                    // null, 'yes', 'no'
                        reincubationCount: 0,               // Track how many times re-incubated
                        reincubationDates: []               // Array of dates when re-incubated
                    },
                    day3_BAP: {completed: false},           // Day 3 - BAP Confirmation
                    day4_MALDI: {completed: false},         // Day 4 - MALDI Identification
                    day5_Storage: {                         // Day 5 - Storage (after MALDI positive)
                        completed: false,
                        vialId: null,
                        dateStored: null,
                        freezer: null,
                        box: null,
                        shelf: null,
                        rack: null,
                        position: null
                    }
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Salmonella workflow
        function createSalmonellaWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1 - Pending', // BPW already done, waiting for Day 2
                finalResult: null, // 'positive', 'negative', 'in-progress'
                resultDate: null,
                stages: {
                    day1_BPWIncubation: {completed: false},    // Day 1 - BPW incubation (from Day 1A remaining)
                    day2_RVR_LAMP: {completed: false},         // Day 2 - RVR + LAMP
                    day3_XLT4: {completed: false},             // Day 3 - XLT4 Agar
                    day4_MALDI: {completed: false},            // Day 4 - MALDI Identification
                    day5_Storage: {                            // Day 5 - Storage (after MALDI positive)
                        completed: false,
                        vialId: null,
                        dateStored: null,
                        freezer: null,
                        box: null,
                        shelf: null,
                        rack: null,
                        position: null
                    }
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Enterococcus workflow (RETAIL MEAT)
        function createEnterococcusWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1A - Pending',
                workflowType: 'retail-meat',  // Flag to identify workflow type
                stages: {
                    day1A_BPWPrep: {completed: false},         // Day 1A - BPW Sample Prep (shared)
                    day2_Enterococcosel: {completed: false},   // Day 2 - Enterococcosel Agar
                    day3_BHI: {completed: false},              // Day 3 - BHI Broth Confirmation
                    day4_MALDI: {completed: false}             // Day 4 - MALDI Identification
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Enterococcus workflow (SEAFOOD)
        function createEnterococcusSeafoodWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1 - Pending',
                workflowType: 'seafood',  // Flag to identify workflow type
                stages: {
                    day1_BPWIncubation: {completed: false},    // Day 1 - BPW Incubation (25g/225ml)
                    day2_BileEsculin: {completed: false},      // Day 2 - Bile Esculin Agar (streak from BPW bag)
                    day3_BHI: {completed: false},              // Day 3 - BHI Broth Confirmation
                    day4_MALDI: {completed: false}             // Day 4 - MALDI Identification
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Aeromonas workflow (SEAFOOD)
        function createAeromonasWorkflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1 - Pending',
                workflowType: 'seafood',
                stages: {
                    day1_BPWIncubation: {completed: false},    // Day 1 - BPW Incubation (25g/225ml)
                    day2_AeromonasMedium: {completed: false},  // Day 2 - Aeromonas Medium (streak from BPW bag)
                    day3_BAP: {completed: false},              // Day 3 - BAP Confirmation
                    day4_MALDI: {completed: false}             // Day 4 - MALDI Identification
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Vibrio V1 workflow (SEAFOOD)
        function createVibrioV1Workflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1 - Pending',
                workflowType: 'seafood',
                stages: {
                    day1_APW: {completed: false},              // Day 1 - APW (25g/225ml, 6-8h)
                    day2_TCBS: {completed: false},             // Day 2 - TCBS Agar (yellow/green colonies)
                    day3_BAP: {completed: false},              // Day 3 - BAP Confirmation
                    day4_MALDI: {completed: false}             // Day 4 - MALDI Identification
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Create Vibrio V2 (parahaemolyticus) workflow (SEAFOOD)
        function createVibrioV2Workflow(foodSampleId, pathogenCode) {
            var workflow = {
                id: foodSampleId + '-WF-' + pathogenCode,
                foodSampleId: foodSampleId,
                pathogenCode: pathogenCode,
                pathogenName: pathogens[pathogenCode].name,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Day 1 - Pending',
                workflowType: 'seafood',
                stages: {
                    day1_APW: {completed: false},              // Day 1 - APW (25g/225ml, 6-8h)
                    day2_CHROMagar: {completed: false},        // Day 2 - CHROMagar Vibrio (mauve colonies)
                    day3_BAP: {completed: false},              // Day 3 - BAP Confirmation
                    day4_MALDI: {completed: false}             // Day 4 - MALDI Identification
                },
                isolateGenerated: false,
                isolateId: null
            };

            pathogenWorkflows.push(workflow);
        }

        // Render E. coli Tab
        function renderEcoliTab() {
            var container = document.getElementById('foodTabContentEcoli');
            var html = '';

            // Filter E. coli workflows
            var ecoliWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'EC';
            });

            html += '<div style="background: white; padding: 18px 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üß´ E. coli Testing Workflows (' + ecoliWorkflows.length + ')</h3>';

            if (ecoliWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üß´</div>';
                html += '<div style="font-size: 16px;">No E. coli workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add food samples with E. coli testing to create workflows</div>';
                html += '</div>';
            } else {
                // Kanban board for E. coli workflows - 6 STAGES (all on one row)
                html += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">';

                var stages = [
                    {name: 'Day 1A - BPW Prep', key: 'day1A_BPWPrep', emoji: 'üíß', color: '#00bcd4'},
                    {name: 'Day 1B - MAC Broth', key: 'day1B_MacBroth', emoji: 'üß™', color: '#e91e63'},
                    {name: 'Day 2 - MAC Agar', key: 'day2_MacAgar', emoji: 'üß´', color: '#9c27b0'},
                    {name: 'Day 3 - Pink Check', key: 'day3_PinkColonies', emoji: 'üî¨', color: '#673ab7'},
                    {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: 'üß¨', color: '#3f51b5'},
                    {name: 'Day 5 - Storage', key: 'day5_Storage', emoji: '‚ùÑÔ∏è', color: '#4caf50'}
                ];

                stages.forEach(function(stage) {
                    html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 300px;">';
                    html += '<div style="font-weight: 700; font-size: 14px; margin-bottom: 10px; color: ' + stage.color + ';">';
                    html += stage.emoji + ' ' + stage.name;
                    html += '</div>';

                    // Count workflows in this stage
                    var count = 0;
                    ecoliWorkflows.forEach(function(wf) {
                        // Skip if workflow is complete (negative or stored)
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure all stages exist
                        if (!wf.stages.day4_MALDI) wf.stages.day4_MALDI = {completed: false, dateSent: null, result: null, speciesId: null};
                        if (!wf.stages.day5_Storage) wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};

                        if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') count++;
                        else if (wf.stages.day1A_BPWPrep.completed && !wf.stages.day1B_MacBroth.completed && stage.key === 'day1B_MacBroth') count++;
                        else if (wf.stages.day1B_MacBroth.completed && !wf.stages.day2_MacAgar.completed && stage.key === 'day2_MacAgar') count++;
                        else if (wf.stages.day2_MacAgar.completed && !wf.stages.day3_PinkColonies.completed && stage.key === 'day3_PinkColonies') count++;
                        else if (wf.stages.day3_PinkColonies.completed && wf.stages.day3_PinkColonies.hasPinkColonies === 'yes' && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        else if (wf.stages.day4_MALDI.completed && wf.stages.day4_MALDI.result === 'positive' && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') count++;
                    });

                    html += '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                    // Bulk selection buttons
                    if (count > 0) {
                        html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                        html += '<button onclick="selectAllEcoliInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                        html += '<button onclick="processSelectedEcoli(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCount_' + stage.key + '">0</span>)</button>';
                        html += '</div>';
                    }

                    // Render workflow cards in this stage
                    ecoliWorkflows.forEach(function(wf) {
                        var shouldShow = false;

                        // Skip if workflow is complete (negative or stored)
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure all stages exist
                        if (!wf.stages.day4_MALDI) wf.stages.day4_MALDI = {completed: false, dateSent: null, result: null, speciesId: null};
                        if (!wf.stages.day5_Storage) wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};

                        if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') shouldShow = true;
                        else if (wf.stages.day1A_BPWPrep.completed && !wf.stages.day1B_MacBroth.completed && stage.key === 'day1B_MacBroth') shouldShow = true;
                        else if (wf.stages.day1B_MacBroth.completed && !wf.stages.day2_MacAgar.completed && stage.key === 'day2_MacAgar') shouldShow = true;
                        else if (wf.stages.day2_MacAgar.completed && !wf.stages.day3_PinkColonies.completed && stage.key === 'day3_PinkColonies') shouldShow = true;
                        else if (wf.stages.day3_PinkColonies.completed && wf.stages.day3_PinkColonies.hasPinkColonies === 'yes' && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;
                        else if (wf.stages.day4_MALDI.completed && wf.stages.day4_MALDI.result === 'positive' && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') shouldShow = true;

                        if (shouldShow) {
                            html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 10px; margin-bottom: 8px; position: relative;">';
                            html += '<input type="checkbox" class="ecoli-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateEcoliSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                            html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openEcoliWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                            html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 5px;">' + wf.foodSampleId + '</div>';
                            html += '<div style="font-size: 11px; color: #666;">Click to process ‚Üí</div>';
                            html += '</div>';
                            html += '</div>';
                        }
                    });

                    html += '</div>'; // End column
                });

                html += '</div>'; // End kanban grid

                // Completed Samples Section
                var completedWorkflows = ecoliWorkflows.filter(function(wf) {
                    return wf.finalResult === 'negative' || wf.finalResult === 'positive';
                });

                if (completedWorkflows.length > 0) {
                    html += '<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">';
                    html += '<h4 style="margin: 0 0 15px 0; color: #495057;">‚úÖ Completed Samples (' + completedWorkflows.length + ')</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">';

                    completedWorkflows.forEach(function(wf) {
                        var isPositive = wf.finalResult === 'positive';
                        var bgColor = isPositive ? '#d4edda' : '#e2e3e5';
                        var borderColor = isPositive ? '#28a745' : '#6c757d';
                        var textColor = isPositive ? '#155724' : '#383d41';
                        var resultText = isPositive ? '‚úÖ POSITIVE' : '‚ùå NEGATIVE';

                        html += '<div style="background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 6px; padding: 12px;">';
                        html += '<div style="font-weight: 600; font-size: 13px; color: ' + textColor + '; margin-bottom: 5px;">' + wf.foodSampleId + '</div>';
                        html += '<div style="font-size: 12px; font-weight: 600; color: ' + borderColor + ';">' + resultText + '</div>';
                        if (wf.resultDate) {
                            html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">Completed: ' + wf.resultDate + '</div>';
                        }
                        if (isPositive && wf.stages.day5_Storage.vialId) {
                            html += '<div style="font-size: 11px; color: #666; margin-top: 3px;">Vial: ' + wf.stages.day5_Storage.vialId + '</div>';
                        }
                        html += '</div>';
                    });

                    html += '</div>'; // End grid
                    html += '</div>'; // End completed section
                }
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // ========== E. COLI BULK SELECTION FUNCTIONS ==========

        function updateEcoliSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.ecoli-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCount_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllEcoliInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.ecoli-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;

            // Check if all are already checked
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });

            // Toggle: if all checked, uncheck all. Otherwise, check all.
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });

            updateEcoliSelectedCount(stageKey);
        }

        function processSelectedEcoli(stageKey) {
            var checkboxes = document.querySelectorAll('.ecoli-bulk-checkbox[data-stage="' + stageKey + '"]:checked');

            console.log('üîç Found', checkboxes.length, 'checked checkboxes for stage:', stageKey);

            if (checkboxes.length === 0) {
                alert('No samples selected. Please select at least one sample.');
                return;
            }

            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                var id = cb.getAttribute('data-workflow-id');
                console.log('üìå Collecting workflow ID:', id);
                workflowIds.push(id);
            });

            console.log('üì¶ Total workflow IDs collected:', workflowIds);
            openEcoliBulkProcessModal(workflowIds, stageKey);
        }

        function openEcoliBulkProcessModal(workflowIds, stageKey) {
            var workflows = workflowIds.map(function(id) {
                return pathogenWorkflows.find(function(wf) { return wf.id === id; });
            }).filter(function(wf) { return wf != null; });

            if (workflows.length === 0) {
                alert('No valid workflows found');
                return;
            }

            var modal = document.getElementById('ecoliBulkModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ecoliBulkModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                document.body.appendChild(modal);
            }

            var stageTitle = '';
            if (stageKey === 'day1A_BPWPrep') stageTitle = 'Day 1A - BPW Prep';
            else if (stageKey === 'day1B_MacBroth') stageTitle = 'Day 1B - MAC Broth';
            else if (stageKey === 'day2_MacAgar') stageTitle = 'Day 2 - MAC Agar';
            else if (stageKey === 'day3_PinkColonies') stageTitle = 'Day 3 - Pink Colonies';
            else if (stageKey === 'day4_BAP') stageTitle = 'Day 4 - BAP';
            else if (stageKey === 'day5_MALDI') stageTitle = 'Day 5 - MALDI';

            var html = '';
            html += '<div style="background: white; margin: 3% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto;">';
            html += '<h3 style="margin-top: 0; color: #00bcd4; border-bottom: 3px solid #00bcd4; padding-bottom: 10px;">üß´ Bulk Process E. coli</h3>';
            html += '<h4 style="color: #555; margin-bottom: 20px;">' + stageTitle + ' - ' + workflows.length + ' sample(s)</h4>';

            // List of samples
            html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">';
            html += '<div style="font-weight: 600; margin-bottom: 10px;">Samples to process:</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
            workflows.forEach(function(wf) {
                html += '<span style="background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; font-weight: 600;">' + wf.foodSampleId + '</span>';
            });
            html += '</div>';
            html += '</div>';

            // Store workflow IDs and stage in hidden inputs
            html += '<input type="hidden" id="bulk_workflowIds" value="' + workflowIds.join(',') + '" />';
            html += '<input type="hidden" id="bulk_stageKey" value="' + stageKey + '" />';

            // Stage-specific form fields (same for all samples)
            if (stageKey === 'day1A_BPWPrep') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';

                html += '<div class="form-group" style="position: relative;">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="bulk_bpwLot" placeholder="LOT-BPW-001" oninput="showReagentLotAutocomplete(\'bulk_bpwLot\', \'bpwLot\')" onfocus="showReagentLotAutocomplete(\'bulk_bpwLot\', \'bpwLot\')" onblur="setTimeout(function(){ hideReagentLotAutocomplete(\'bulk_bpwLot\'); }, 200)" />';
                html += '<div id="bulk_bpwLot_autocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="bulk_sampleWeight" value="50" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="bulk_bpwVolume" value="250" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Stomach Time (minutes):</label>';
                html += '<input type="number" id="bulk_stomachTime" value="2" step="0.5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Volume Pulled for EC (ml):</label>';
                html += '<input type="number" id="bulk_volumePulled" value="50" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Remaining BPW to Incubator?:</label>';
                html += '<select id="bulk_bpwToIncubator">';
                html += '<option value="Yes">Yes (for Salmonella)</option>';
                html += '<option value="No">No</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="bulk_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day1B_MacBroth') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';

                html += '<div class="form-group" style="position: relative;">';
                html += '<label>MAC Broth Lot #:</label>';
                html += '<input type="text" id="bulk_macBrothLot" placeholder="LOT-MAC-001" oninput="showReagentLotAutocomplete(\'bulk_macBrothLot\', \'macBrothLot\')" onfocus="showReagentLotAutocomplete(\'bulk_macBrothLot\', \'macBrothLot\')" onblur="setTimeout(function(){ hideReagentLotAutocomplete(\'bulk_macBrothLot\'); }, 200)" />';
                html += '<div id="bulk_macBrothLot_autocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="bulk_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="bulk_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="bulk_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="bulk_timeOut" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="bulk_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_MacAgar') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';

                html += '<div class="form-group" style="position: relative;">';
                html += '<label>MAC Agar Plate Lot #:</label>';
                html += '<input type="text" id="bulk_macAgarLot" placeholder="LOT-MAC-001" oninput="showReagentLotAutocomplete(\'bulk_macAgarLot\', \'macAgarLot\')" onfocus="showReagentLotAutocomplete(\'bulk_macAgarLot\', \'macAgarLot\')" onblur="setTimeout(function(){ hideReagentLotAutocomplete(\'bulk_macAgarLot\'); }, 200)" />';
                html += '<div id="bulk_macAgarLot_autocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="bulk_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="bulk_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="bulk_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="bulk_timeOut" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="bulk_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day3_PinkColonies') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Note:</strong> Only samples with pink colonies will be marked as completed.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Pink Colonies Present?</label>';
                html += '<select id="bulk_pinkColonies">';
                html += '<option value="Yes">Yes - Pink colonies present</option>';
                html += '<option value="No">No - No pink colonies</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Colony Count (approx):</label>';
                html += '<input type="number" id="bulk_colonyCount" placeholder="e.g., 20" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="bulk_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day4_BAP') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BAP Plate Lot #:</label>';
                html += '<input type="text" id="bulk_bapLot" placeholder="LOT-BAP-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="bulk_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="bulk_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="bulk_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day5_MALDI') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Note:</strong> MALDI stage cannot be bulk processed. Please process samples individually to enter species ID for each.';
                html += '</div>';
                html += '<div style="text-align: center; padding: 20px;">';
                html += '<button onclick="closeEcoliBulkModal()" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>';
                html += '</div>';
                modal.innerHTML = html;
                modal.style.display = 'block';
                return;
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeEcoliBulkStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Process All ' + workflows.length + ' Samples</button>';
            html += '<button onclick="closeEcoliBulkModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeEcoliBulkModal() {
            var modal = document.getElementById('ecoliBulkModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeEcoliBulkStage() {
            var workflowIds = document.getElementById('bulk_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_stageKey').value;

            var stageData = {};
            var techInitials = document.getElementById('bulk_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            // Collect common data based on stage
            if (stageKey === 'day1A_BPWPrep') {
                stageData.bpwLot = document.getElementById('bulk_bpwLot').value;
                addReagentLotToHistory('bpwLot', stageData.bpwLot);
                stageData.sampleWeight = document.getElementById('bulk_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('bulk_bpwVolume').value;
                stageData.stomachTime = document.getElementById('bulk_stomachTime').value;
                stageData.volumePulled = document.getElementById('bulk_volumePulled').value;
                stageData.bpwToIncubator = document.getElementById('bulk_bpwToIncubator').value;
            } else if (stageKey === 'day1B_MacBroth') {
                stageData.macBrothLot = document.getElementById('bulk_macBrothLot').value;
                addReagentLotToHistory('macBrothLot', stageData.macBrothLot);
                stageData.temperature = document.getElementById('bulk_temperature').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
                stageData.timeIn = document.getElementById('bulk_timeIn').value;
                stageData.timeOut = document.getElementById('bulk_timeOut').value;
            } else if (stageKey === 'day2_MacAgar') {
                stageData.macAgarLot = document.getElementById('bulk_macAgarLot').value;
                addReagentLotToHistory('macAgarLot', stageData.macAgarLot);
                stageData.temperature = document.getElementById('bulk_temperature').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
                stageData.timeIn = document.getElementById('bulk_timeIn').value;
                stageData.timeOut = document.getElementById('bulk_timeOut').value;
            } else if (stageKey === 'day3_PinkColonies') {
                stageData.pinkColonies = document.getElementById('bulk_pinkColonies').value;
                stageData.colonyCount = document.getElementById('bulk_colonyCount').value;
            } else if (stageKey === 'day4_BAP') {
                stageData.bapLot = document.getElementById('bulk_bapLot').value;
                addReagentLotToHistory('bapLot', stageData.bapLot);
                stageData.temperature = document.getElementById('bulk_temperature').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            // Apply to all selected workflows
            var processedCount = 0;
            console.log('üîÑ Bulk processing', workflowIds.length, 'workflows for stage:', stageKey);
            console.log('üìã Workflow IDs:', workflowIds);

            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    console.log('‚úÖ Processing workflow:', workflow.foodSampleId, 'Stage:', stageKey);
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData)); // Deep copy
                    processedCount++;
                } else {
                    console.warn('‚ö†Ô∏è Workflow not found:', id);
                }
            });

            console.log('‚úÖ Bulk complete:', processedCount, 'samples processed');
            saveData();
            closeEcoliBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' samples!');
            renderEcoliTab();
        }

        // ========== CAMPYLOBACTER BULK SELECTION FUNCTIONS ==========

        function updateCampyloSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.campylo-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountC1_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllCampyloInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.campylo-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateCampyloSelectedCount(stageKey);
        }

        function processSelectedCampylo(stageKey) {
            var checkboxes = document.querySelectorAll('.campylo-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected. Please select at least one sample.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openCampyloBulkModal(workflowIds, stageKey);
        }

        function openCampyloBulkModal(workflowIds, stageKey) {
            var workflows = workflowIds.map(function(id) {
                return pathogenWorkflows.find(function(wf) { return wf.id === id; });
            }).filter(function(wf) { return wf != null; });

            if (workflows.length === 0) {
                alert('No valid workflows found');
                return;
            }

            var modal = document.getElementById('campyloBulkModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'campyloBulkModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                document.body.appendChild(modal);
            }

            var stageTitle = '';
            if (stageKey === 'day1A_BPWPrep') stageTitle = 'Day 1A - BPW Prep';
            else if (stageKey === 'day1B_BoltonBroth') stageTitle = 'Day 1B - Bolton Broth';
            else if (stageKey === 'day2_CCA') stageTitle = 'Day 2 - CCA';
            else if (stageKey === 'day3_BAP') stageTitle = 'Day 3 - BAP';

            var html = '';
            html += '<div style="background: white; margin: 3% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto;">';
            html += '<h3 style="margin-top: 0; color: #9c27b0; border-bottom: 3px solid #9c27b0; padding-bottom: 10px;">ü¶† Bulk Process Campylobacter</h3>';
            html += '<h4 style="color: #555; margin-bottom: 20px;">' + stageTitle + ' - ' + workflows.length + ' sample(s)</h4>';

            html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">';
            html += '<div style="font-weight: 600; margin-bottom: 10px;">Samples to process:</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
            workflows.forEach(function(wf) {
                html += '<span style="background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; font-weight: 600;">' + wf.foodSampleId + '</span>';
            });
            html += '</div>';
            html += '</div>';

            html += '<input type="hidden" id="bulk_c1_workflowIds" value="' + workflowIds.join(',') + '" />';
            html += '<input type="hidden" id="bulk_c1_stageKey" value="' + stageKey + '" />';

            if (stageKey === 'day1A_BPWPrep') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';
                html += '<div class="form-group"><label>BPW Lot #:</label><input type="text" id="bulk_c1_bpwLot" placeholder="LOT-BPW-001" /></div>';
                html += '<div class="form-group"><label>Technician Initials:</label><input type="text" id="bulk_c1_techInitials" maxlength="3" /></div>';
            } else if (stageKey === 'day1B_BoltonBroth') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';
                html += '<div class="form-group" style="position: relative;"><label>Bolton Broth Lot #:</label><input type="text" id="bulk_c1_boltonLot" placeholder="LOT-BOLTON-001" oninput="showReagentLotAutocomplete(\'bulk_c1_boltonLot\', \'boltonLot\')" onfocus="showReagentLotAutocomplete(\'bulk_c1_boltonLot\', \'boltonLot\')" onblur="setTimeout(function(){ hideReagentLotAutocomplete(\'bulk_c1_boltonLot\'); }, 200)" /><div id="bulk_c1_boltonLot_autocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px;"></div></div>';
                html += '<div class="form-group"><label>Temperature:</label><select id="bulk_c1_temperature"><option value="42">42¬∞C</option><option value="37">37¬∞C</option></select></div>';
                html += '<div class="form-group"><label>Incubator:</label><select id="bulk_c1_incubator"><option value="INC-1">Incubator 1</option><option value="INC-2">Incubator 2</option><option value="INC-3">Incubator 3</option></select></div>';
                html += '<div class="form-group"><label>Technician Initials:</label><input type="text" id="bulk_c1_techInitials" maxlength="3" /></div>';
            } else if (stageKey === 'day2_CCA') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';
                html += '<div class="form-group"><label>CCA Plate Lot #:</label><input type="text" id="bulk_c1_ccaLot" placeholder="LOT-CCA-001" /></div>';
                html += '<div class="form-group"><label>Temperature:</label><select id="bulk_c1_temperature"><option value="42">42¬∞C</option><option value="37">37¬∞C</option></select></div>';
                html += '<div class="form-group"><label>Incubator:</label><select id="bulk_c1_incubator"><option value="INC-1">Incubator 1</option><option value="INC-2">Incubator 2</option><option value="INC-3">Incubator 3</option></select></div>';
                html += '<div class="form-group"><label>Technician Initials:</label><input type="text" id="bulk_c1_techInitials" maxlength="3" /></div>';
            } else if (stageKey === 'day3_BAP') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> All samples will use the same lot numbers and settings below.';
                html += '</div>';
                html += '<div class="form-group"><label>BAP Plate Lot #:</label><input type="text" id="bulk_c1_bapLot" placeholder="LOT-BAP-001" /></div>';
                html += '<div class="form-group"><label>Temperature:</label><select id="bulk_c1_temperature"><option value="37">37¬∞C</option><option value="35">35¬∞C</option></select></div>';
                html += '<div class="form-group"><label>Incubator:</label><select id="bulk_c1_incubator"><option value="INC-1">Incubator 1</option><option value="INC-2">Incubator 2</option><option value="INC-3">Incubator 3</option></select></div>';
                html += '<div class="form-group"><label>Technician Initials:</label><input type="text" id="bulk_c1_techInitials" maxlength="3" /></div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeCampyloBulkStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Process All ' + workflows.length + ' Samples</button>';
            html += '<button onclick="closeCampyloBulkModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';
            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeCampyloBulkModal() {
            var modal = document.getElementById('campyloBulkModal');
            if (modal) modal.style.display = 'none';
        }

        function completeCampyloBulkStage() {
            var workflowIds = document.getElementById('bulk_c1_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_c1_stageKey').value;

            var stageData = {};
            var techInitials = document.getElementById('bulk_c1_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (stageKey === 'day1A_BPWPrep') {
                stageData.bpwLot = document.getElementById('bulk_c1_bpwLot').value;
                addReagentLotToHistory('bpwLot', stageData.bpwLot);
            } else if (stageKey === 'day1B_BoltonBroth') {
                stageData.boltonLot = document.getElementById('bulk_c1_boltonLot').value;
                addReagentLotToHistory('boltonLot', stageData.boltonLot);
                stageData.temperature = document.getElementById('bulk_c1_temperature').value;
                stageData.incubator = document.getElementById('bulk_c1_incubator').value;
            } else if (stageKey === 'day2_CCA') {
                stageData.ccaLot = document.getElementById('bulk_c1_ccaLot').value;
                stageData.temperature = document.getElementById('bulk_c1_temperature').value;
                stageData.incubator = document.getElementById('bulk_c1_incubator').value;
            } else if (stageKey === 'day3_BAP') {
                stageData.bapLot = document.getElementById('bulk_c1_bapLot').value;
                stageData.temperature = document.getElementById('bulk_c1_temperature').value;
                stageData.incubator = document.getElementById('bulk_c1_incubator').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeCampyloBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Campylobacter samples!');
            renderCampyloTab();
        }

        // Render Campylobacter Tab
        function renderCampyloTab() {
            var container = document.getElementById('foodTabContentCampylo');
            var html = '';

            // Filter Campylobacter workflows
            var campyloWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'C1';
            });

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">ü¶† Campylobacter Testing Workflows (' + campyloWorkflows.length + ')</h3>';

            if (campyloWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">ü¶†</div>';
                html += '<div style="font-size: 16px;">No Campylobacter workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add food samples with Campylobacter testing to create workflows</div>';
                html += '</div>';
            } else {
                // Kanban board for Campylobacter workflows - 6 STAGES (all on one row)
                html += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">';

                var stages = [
                    {name: 'Day 1A - BPW Prep', key: 'day1A_BPWPrep', emoji: 'üíß', color: '#00bcd4'},
                    {name: 'Day 1B - Bolton Broth', key: 'day1B_BoltonBroth', emoji: 'ü¶†', color: '#9c27b0'},
                    {name: 'Day 2 - CCA', key: 'day2_CCA', emoji: 'üß´', color: '#673ab7'},
                    {name: 'Day 3 - BAP', key: 'day3_BAP', emoji: 'üß´', color: '#3f51b5'},
                    {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: 'üß¨', color: '#2196f3'},
                    {name: 'Day 5 - Storage', key: 'day5_Storage', emoji: '‚ùÑÔ∏è', color: '#4caf50'}
                ];

                stages.forEach(function(stage) {
                    html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 300px;">';
                    html += '<div style="font-weight: 700; font-size: 14px; margin-bottom: 10px; color: ' + stage.color + ';">';
                    html += stage.emoji + ' ' + stage.name;
                    html += '</div>';

                    // Count workflows in this stage
                    var count = 0;
                    campyloWorkflows.forEach(function(wf) {
                        // Skip if workflow is complete
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure day5_Storage exists
                        if (!wf.stages.day5_Storage) {
                            wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};
                        }

                        // Safety check: migrate old day2_CCA structure
                        if (typeof wf.stages.day2_CCA !== 'object' || wf.stages.day2_CCA.hasGrowth === undefined) {
                            var wasCompleted = wf.stages.day2_CCA ? wf.stages.day2_CCA.completed : false;
                            wf.stages.day2_CCA = {
                                completed: wasCompleted,
                                hasGrowth: wasCompleted ? 'yes' : null,
                                reincubationCount: 0,
                                reincubationDates: []
                            };
                        }

                        if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') count++;
                        else if (wf.stages.day1A_BPWPrep.completed && !wf.stages.day1B_BoltonBroth.completed && stage.key === 'day1B_BoltonBroth') count++;
                        else if (wf.stages.day1B_BoltonBroth.completed && !wf.stages.day2_CCA.completed && stage.key === 'day2_CCA') count++;
                        else if (wf.stages.day2_CCA.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') count++;
                        else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        else if (wf.stages.day4_MALDI.completed && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') count++;
                    });

                    html += '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                    // Bulk selection buttons (exclude MALDI and Storage from bulk processing)
                    if (count > 0 && stage.key !== 'day4_MALDI' && stage.key !== 'day5_Storage') {
                        html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                        html += '<button onclick="selectAllCampyloInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                        html += '<button onclick="processSelectedCampylo(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountC1_' + stage.key + '">0</span>)</button>';
                        html += '</div>';
                    }

                    // Render workflow cards in this stage
                    campyloWorkflows.forEach(function(wf) {
                        var shouldShow = false;

                        // Skip if workflow is complete
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure day5_Storage exists
                        if (!wf.stages.day5_Storage) {
                            wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};
                        }

                        // Safety check: migrate old day2_CCA structure
                        if (typeof wf.stages.day2_CCA !== 'object' || wf.stages.day2_CCA.hasGrowth === undefined) {
                            var wasCompleted = wf.stages.day2_CCA ? wf.stages.day2_CCA.completed : false;
                            wf.stages.day2_CCA = {
                                completed: wasCompleted,
                                hasGrowth: wasCompleted ? 'yes' : null,
                                reincubationCount: 0,
                                reincubationDates: []
                            };
                        }

                        if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') shouldShow = true;
                        else if (wf.stages.day1A_BPWPrep.completed && !wf.stages.day1B_BoltonBroth.completed && stage.key === 'day1B_BoltonBroth') shouldShow = true;
                        else if (wf.stages.day1B_BoltonBroth.completed && !wf.stages.day2_CCA.completed && stage.key === 'day2_CCA') shouldShow = true;
                        else if (wf.stages.day2_CCA.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') shouldShow = true;
                        else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;
                        else if (wf.stages.day4_MALDI.completed && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') shouldShow = true;

                        if (shouldShow) {
                            html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 10px; margin-bottom: 8px; position: relative;">';
                            if (stage.key !== 'day4_MALDI' && stage.key !== 'day5_Storage') {
                                html += '<input type="checkbox" class="campylo-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateCampyloSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                            }
                            html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openCampyloWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                            html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 5px;">' + wf.foodSampleId + '</div>';

                            // Show re-incubation badge for Day 2
                            if (stage.key === 'day2_CCA' && wf.stages.day2_CCA.reincubationCount > 0) {
                                html += '<div style="display: inline-block; background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-bottom: 3px;">üîÑ Re-incubated ' + wf.stages.day2_CCA.reincubationCount + 'x</div>';
                            }

                            html += '<div style="font-size: 11px; color: #666;">Click to process ‚Üí</div>';
                            html += '</div>';
                            html += '</div>';
                        }
                    });

                    html += '</div>'; // End column
                });

                html += '</div>'; // End grid
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // Render Salmonella Tab
        function renderSalmonellaTab() {
            var container = document.getElementById('foodTabContentSalmonella');
            var html = '';

            // Filter Salmonella workflows
            var salmonellaWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'S1';
            });

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üî¥ Salmonella Testing Workflows (' + salmonellaWorkflows.length + ')</h3>';

            if (salmonellaWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üî¥</div>';
                html += '<div style="font-size: 16px;">No Salmonella workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add food samples with Salmonella testing to create workflows</div>';
                html += '</div>';
            } else {
                // Kanban board for Salmonella workflows - 5 STAGES (all on one row)
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';

                var stages = [
                    {name: 'Day 1 - BPW Incubation', key: 'day1_BPWIncubation', emoji: 'üíß', color: '#00bcd4'},
                    {name: 'Day 2 - RVR + LAMP', key: 'day2_RVR_LAMP', emoji: 'üî¨', color: '#f44336'},
                    {name: 'Day 3 - XLT4 Agar', key: 'day3_XLT4', emoji: 'üß´', color: '#e91e63'},
                    {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: 'üß¨', color: '#2196f3'},
                    {name: 'Day 5 - Storage', key: 'day5_Storage', emoji: '‚ùÑÔ∏è', color: '#4caf50'}
                ];

                stages.forEach(function(stage) {
                    html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 300px;">';
                    html += '<div style="font-weight: 700; font-size: 14px; margin-bottom: 10px; color: ' + stage.color + ';">';
                    html += stage.emoji + ' ' + stage.name;
                    html += '</div>';

                    // Count workflows in this stage
                    var count = 0;
                    salmonellaWorkflows.forEach(function(wf) {
                        // Skip if workflow is complete
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure day5_Storage exists
                        if (!wf.stages.day5_Storage) {
                            wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};
                        }

                        if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') count++;
                        else if (wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_RVR_LAMP.completed && stage.key === 'day2_RVR_LAMP') count++;
                        else if (wf.stages.day2_RVR_LAMP.completed && !wf.stages.day3_XLT4.completed && stage.key === 'day3_XLT4') count++;
                        else if (wf.stages.day3_XLT4.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        else if (wf.stages.day4_MALDI.completed && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') count++;
                    });

                    html += '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                    // Bulk selection buttons (exclude MALDI and Storage)
                    if (count > 0 && stage.key !== 'day4_MALDI' && stage.key !== 'day5_Storage') {
                        html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                        html += '<button onclick="selectAllSalmonellaInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                        html += '<button onclick="processSelectedSalmonella(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountS1_' + stage.key + '">0</span>)</button>';
                        html += '</div>';
                    }

                    // Render workflow cards in this stage
                    salmonellaWorkflows.forEach(function(wf) {
                        var shouldShow = false;

                        // Skip if workflow is complete
                        if (wf.finalResult === 'negative' || wf.finalResult === 'positive') return;

                        // Safety check: ensure day5_Storage exists
                        if (!wf.stages.day5_Storage) {
                            wf.stages.day5_Storage = {completed: false, vialId: null, dateStored: null, freezer: null, box: null, shelf: null, rack: null, position: null};
                        }

                        if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') shouldShow = true;
                        else if (wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_RVR_LAMP.completed && stage.key === 'day2_RVR_LAMP') shouldShow = true;
                        else if (wf.stages.day2_RVR_LAMP.completed && !wf.stages.day3_XLT4.completed && stage.key === 'day3_XLT4') shouldShow = true;
                        else if (wf.stages.day3_XLT4.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;
                        else if (wf.stages.day4_MALDI.completed && !wf.stages.day5_Storage.completed && stage.key === 'day5_Storage') shouldShow = true;

                        if (shouldShow) {
                            html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 10px; margin-bottom: 8px; position: relative;">';
                            if (stage.key !== 'day4_MALDI' && stage.key !== 'day5_Storage') {
                                html += '<input type="checkbox" class="salmonella-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateSalmonellaSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                            }
                            html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openSalmonellaWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                            html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 5px;">' + wf.foodSampleId + '</div>';
                            html += '<div style="font-size: 11px; color: #666;">Click to process ‚Üí</div>';
                            html += '</div>';
                            html += '</div>';
                        }
                    });

                    html += '</div>'; // End column
                });

                html += '</div>'; // End grid
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // ========== SALMONELLA BULK SELECTION FUNCTIONS ==========

        function updateSalmonellaSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.salmonella-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountS1_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllSalmonellaInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.salmonella-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateSalmonellaSelectedCount(stageKey);
        }

        function processSelectedSalmonella(stageKey) {
            var checkboxes = document.querySelectorAll('.salmonella-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openSalmonellaBulkModal(workflowIds, stageKey);
        }

        function openSalmonellaBulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="salmonellaBulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #d32f2f;">ü¶† Bulk Process Salmonella - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_s1_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_s1_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1_BPWIncubation') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1 - BPW Incubation:</strong> Using remaining BPW from Day 1A (after pulling 50ml for EC/C1/E).<br>';
                modalHtml += 'Incubate at 35¬∞C for 24 hours.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bpw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Incubator:</label>';
                modalHtml += '<select id="bulk_incubator" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHtml += '<option value="INC-1">INC-1</option>';
                modalHtml += '<option value="INC-2">INC-2</option>';
                modalHtml += '<option value="INC-3">INC-3</option>';
                modalHtml += '</select>';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_RVR_LAMP') {
                modalHtml += '<div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">';
                modalHtml += '<strong>Day 2 - RVR Enrichment + LAMP Screening:</strong><br>';
                modalHtml += '‚Ä¢ Pull 0.5ml from BPW ‚Üí 10ml RVR broth (42¬∞C, 24h)<br>';
                modalHtml += '‚Ä¢ LAMP Test for presumptive Salmonella';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">RVR Broth Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_rvr_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">LAMP Result:</label>';
                modalHtml += '<select id="bulk_lamp_result" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHtml += '<option value="">Select result...</option>';
                modalHtml += '<option value="Positive">Positive (proceed to XLT4)</option>';
                modalHtml += '<option value="Negative">Negative (may still plate)</option>';
                modalHtml += '</select>';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_XLT4') {
                modalHtml += '<div style="background: #f3e5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #9c27b0;">';
                modalHtml += '<strong>Day 3 - XLT4 Agar Confirmation:</strong><br>';
                modalHtml += 'Streak RVR onto XLT4 agar. Look for black-centered colonies (H2S producers).';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">XLT4 Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_xlt4_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeSalmonellaBulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeSalmonellaBulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeSalmonellaBulkModal() {
            var modal = document.getElementById('salmonellaBulkModal');
            if (modal) modal.remove();
        }

        function completeSalmonellaBulkStage() {
            var workflowIds = document.getElementById('bulk_s1_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_s1_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1_BPWIncubation') {
                stageData.bpw_lot = document.getElementById('bulk_bpw_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_RVR_LAMP') {
                stageData.rvr_lot = document.getElementById('bulk_rvr_lot').value;
                stageData.lamp_result = document.getElementById('bulk_lamp_result').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_XLT4') {
                stageData.xlt4_lot = document.getElementById('bulk_xlt4_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeSalmonellaBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Salmonella samples!');
            renderSalmonellaTab();
        }

        // Render Enterococcus Tab
        function renderEnterococcusTab() {
            var container = document.getElementById('foodTabContentEnterococcus');
            var html = '';

            // Filter Enterococcus workflows (both retail meat and seafood)
            var enterococcusWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'E';
            });

            // Separate by workflow type
            var retailMeatWf = enterococcusWorkflows.filter(function(wf) { return wf.workflowType === 'retail-meat'; });
            var seafoodWf = enterococcusWorkflows.filter(function(wf) { return wf.workflowType === 'seafood'; });

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üü† Enterococcus Testing Workflows (' + enterococcusWorkflows.length + ')</h3>';

            if (enterococcusWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üü†</div>';
                html += '<div style="font-size: 16px;">No Enterococcus workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add food samples with Enterococcus testing to create workflows</div>';
                html += '</div>';
            } else {
                // RETAIL MEAT WORKFLOWS
                if (retailMeatWf.length > 0) {
                    html += '<div style="margin-bottom: 30px;">';
                    html += '<h4 style="color: #ff9800; margin-bottom: 15px;">ü•© Retail Meat (' + retailMeatWf.length + ')</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';

                    var rmStages = [
                        {name: 'Day 1A - BPW Prep', key: 'day1A_BPWPrep', emoji: 'üíß', color: '#00bcd4'},
                        {name: 'Day 2 - Enterococcosel', key: 'day2_Enterococcosel', emoji: 'üü†', color: '#ff9800'},
                        {name: 'Day 3 - BHI Broth', key: 'day3_BHI', emoji: 'üß™', color: '#f57c00'},
                        {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: '‚úÖ', color: '#4caf50'}
                    ];

                    rmStages.forEach(function(stage) {
                        html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 250px;">';
                        html += '<div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: ' + stage.color + ';">' + stage.emoji + ' ' + stage.name + '</div>';

                        var count = 0;
                        retailMeatWf.forEach(function(wf) {
                            if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') count++;
                            else if (wf.stages.day1A_BPWPrep && wf.stages.day1A_BPWPrep.completed && !wf.stages.day2_Enterococcosel.completed && stage.key === 'day2_Enterococcosel') count++;
                            else if (wf.stages.day2_Enterococcosel && wf.stages.day2_Enterococcosel.completed && !wf.stages.day3_BHI.completed && stage.key === 'day3_BHI') count++;
                            else if (wf.stages.day3_BHI && wf.stages.day3_BHI.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        });

                        html += '<div style="font-size: 11px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                        // Bulk selection buttons (exclude MALDI)
                        if (count > 0 && stage.key !== 'day4_MALDI') {
                            html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                            html += '<button onclick="selectAllEnteroRMInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                            html += '<button onclick="processSelectedEnteroRM(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountERM_' + stage.key + '">0</span>)</button>';
                            html += '</div>';
                        }

                        retailMeatWf.forEach(function(wf) {
                            var shouldShow = false;
                            if (!wf.stages.day1A_BPWPrep.completed && stage.key === 'day1A_BPWPrep') shouldShow = true;
                            else if (wf.stages.day1A_BPWPrep && wf.stages.day1A_BPWPrep.completed && !wf.stages.day2_Enterococcosel.completed && stage.key === 'day2_Enterococcosel') shouldShow = true;
                            else if (wf.stages.day2_Enterococcosel && wf.stages.day2_Enterococcosel.completed && !wf.stages.day3_BHI.completed && stage.key === 'day3_BHI') shouldShow = true;
                            else if (wf.stages.day3_BHI && wf.stages.day3_BHI.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;

                            if (shouldShow) {
                                html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 8px; margin-bottom: 6px; position: relative;">';
                                html += '<input type="checkbox" class="entero-rm-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateEnteroRMSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                                html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openEnterococcusWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                                html += '<div style="font-weight: 600; font-size: 12px; margin-bottom: 3px;">' + wf.foodSampleId + '</div>';
                                html += '<div style="font-size: 10px; color: #666;">Click to process ‚Üí</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        });

                        html += '</div>';
                    });

                    html += '</div></div>';
                }

                // SEAFOOD WORKFLOWS
                if (seafoodWf.length > 0) {
                    html += '<div>';
                    html += '<h4 style="color: #00bcd4; margin-bottom: 15px;">üêü Seafood (' + seafoodWf.length + ')</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';

                    var sfStages = [
                        {name: 'Day 1 - BPW Incubation', key: 'day1_BPWIncubation', emoji: 'üíß', color: '#00bcd4'},
                        {name: 'Day 2 - Bile Esculin', key: 'day2_BileEsculin', emoji: 'üü£', color: '#9c27b0'},
                        {name: 'Day 3 - BHI Broth', key: 'day3_BHI', emoji: 'üß™', color: '#f57c00'},
                        {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: '‚úÖ', color: '#4caf50'}
                    ];

                    sfStages.forEach(function(stage) {
                        html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 250px;">';
                        html += '<div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: ' + stage.color + ';">' + stage.emoji + ' ' + stage.name + '</div>';

                        var count = 0;
                        seafoodWf.forEach(function(wf) {
                            if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') count++;
                            else if (wf.stages.day1_BPWIncubation && wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_BileEsculin.completed && stage.key === 'day2_BileEsculin') count++;
                            else if (wf.stages.day2_BileEsculin && wf.stages.day2_BileEsculin.completed && !wf.stages.day3_BHI.completed && stage.key === 'day3_BHI') count++;
                            else if (wf.stages.day3_BHI && wf.stages.day3_BHI.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        });

                        html += '<div style="font-size: 11px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                        // Bulk selection buttons (exclude MALDI)
                        if (count > 0 && stage.key !== 'day4_MALDI') {
                            html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                            html += '<button onclick="selectAllEnteroSFInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                            html += '<button onclick="processSelectedEnteroSF(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountESF_' + stage.key + '">0</span>)</button>';
                            html += '</div>';
                        }

                        seafoodWf.forEach(function(wf) {
                            var shouldShow = false;
                            if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') shouldShow = true;
                            else if (wf.stages.day1_BPWIncubation && wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_BileEsculin.completed && stage.key === 'day2_BileEsculin') shouldShow = true;
                            else if (wf.stages.day2_BileEsculin && wf.stages.day2_BileEsculin.completed && !wf.stages.day3_BHI.completed && stage.key === 'day3_BHI') shouldShow = true;
                            else if (wf.stages.day3_BHI && wf.stages.day3_BHI.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;

                            if (shouldShow) {
                                html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 8px; margin-bottom: 6px; position: relative;">';
                                html += '<input type="checkbox" class="entero-sf-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateEnteroSFSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                                html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openEnterococcusSeafoodWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                                html += '<div style="font-weight: 600; font-size: 12px; margin-bottom: 3px;">' + wf.foodSampleId + '</div>';
                                html += '<div style="font-size: 10px; color: #666;">Click to process ‚Üí</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        });

                        html += '</div>';
                    });

                    html += '</div></div>';
                }
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // ========== ENTEROCOCCUS RETAIL MEAT BULK SELECTION FUNCTIONS ==========

        function updateEnteroRMSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-rm-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountERM_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllEnteroRMInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-rm-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateEnteroRMSelectedCount(stageKey);
        }

        function processSelectedEnteroRM(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-rm-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openEnteroRMBulkModal(workflowIds, stageKey);
        }

        function openEnteroRMBulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="enteroRMBulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #ff9800;">üü† Bulk Process Enterococcus RM - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_erm_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_erm_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1A_BPWPrep') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1A - BPW Sample Prep:</strong> 50g sample + 250ml BPW (retail meat sizing).<br>';
                modalHtml += 'Stomach for 2 minutes, then pull 50ml for Enterococcus.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bpw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Sample Weight (g):</label>';
                modalHtml += '<input type="number" id="bulk_sample_weight" value="50" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Volume (ml):</label>';
                modalHtml += '<input type="number" id="bulk_bpw_volume" value="250" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Stomach Time (minutes):</label>';
                modalHtml += '<input type="number" id="bulk_stomach_time" value="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Volume Pulled for Enterococcus (ml):</label>';
                modalHtml += '<input type="number" id="bulk_volume_pulled" value="50" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_Enterococcosel') {
                modalHtml += '<div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">';
                modalHtml += '<strong>Day 2 - Enterococcosel Agar:</strong><br>';
                modalHtml += 'Streak 50ml pull onto Enterococcosel Agar. Incubate at 35¬∞C for 24-48h.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_plate_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_BHI') {
                modalHtml += '<div style="background: #f3e5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #9c27b0;">';
                modalHtml += '<strong>Day 3 - BHI Broth Confirmation:</strong><br>';
                modalHtml += 'Pick colonies from Enterococcosel into BHI broth. Confirm typical growth.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BHI Broth Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bhi_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeEnteroRMBulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeEnteroRMBulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEnteroRMBulkModal() {
            var modal = document.getElementById('enteroRMBulkModal');
            if (modal) modal.remove();
        }

        function completeEnteroRMBulkStage() {
            var workflowIds = document.getElementById('bulk_erm_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_erm_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1A_BPWPrep') {
                stageData.bpw_lot = document.getElementById('bulk_bpw_lot').value;
                stageData.sample_weight = document.getElementById('bulk_sample_weight').value;
                stageData.bpw_volume = document.getElementById('bulk_bpw_volume').value;
                stageData.stomach_time = document.getElementById('bulk_stomach_time').value;
                stageData.volume_pulled = document.getElementById('bulk_volume_pulled').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_Enterococcosel') {
                stageData.plate_lot = document.getElementById('bulk_plate_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_BHI') {
                stageData.bhi_lot = document.getElementById('bulk_bhi_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeEnteroRMBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Enterococcus RM samples!');
            renderEnterococcusTab();
        }

        // ========== ENTEROCOCCUS SEAFOOD BULK SELECTION FUNCTIONS ==========

        function updateEnteroSFSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-sf-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountESF_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllEnteroSFInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-sf-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateEnteroSFSelectedCount(stageKey);
        }

        function processSelectedEnteroSF(stageKey) {
            var checkboxes = document.querySelectorAll('.entero-sf-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openEnteroSFBulkModal(workflowIds, stageKey);
        }

        function openEnteroSFBulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="enteroSFBulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #00bcd4;">üêü Bulk Process Enterococcus Seafood - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_esf_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_esf_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1_BPWIncubation') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1 - BPW Incubation:</strong> 25g sample + 225ml BPW (seafood sizing).<br>';
                modalHtml += 'Incubate at 35¬∞C for 24 hours.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bpw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Sample Weight (g):</label>';
                modalHtml += '<input type="number" id="bulk_sample_weight" value="25" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Volume (ml):</label>';
                modalHtml += '<input type="number" id="bulk_bpw_volume" value="225" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Incubator:</label>';
                modalHtml += '<select id="bulk_incubator" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHtml += '<option value="INC-1">INC-1</option>';
                modalHtml += '<option value="INC-2">INC-2</option>';
                modalHtml += '<option value="INC-3">INC-3</option>';
                modalHtml += '</select>';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_BileEsculin') {
                modalHtml += '<div style="background: #f3e5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #9c27b0;">';
                modalHtml += '<strong>Day 2 - Bile Esculin Agar:</strong><br>';
                modalHtml += 'Pull loopful directly from BPW bag. Streak onto Bile Esculin Agar. Look for black colonies.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_plate_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_BHI') {
                modalHtml += '<div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">';
                modalHtml += '<strong>Day 3 - BHI Broth Confirmation:</strong><br>';
                modalHtml += 'Pick colonies from Bile Esculin into BHI broth. Confirm typical growth.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BHI Broth Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bhi_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="35" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeEnteroSFBulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeEnteroSFBulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEnteroSFBulkModal() {
            var modal = document.getElementById('enteroSFBulkModal');
            if (modal) modal.remove();
        }

        function completeEnteroSFBulkStage() {
            var workflowIds = document.getElementById('bulk_esf_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_esf_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1_BPWIncubation') {
                stageData.bpw_lot = document.getElementById('bulk_bpw_lot').value;
                stageData.sample_weight = document.getElementById('bulk_sample_weight').value;
                stageData.bpw_volume = document.getElementById('bulk_bpw_volume').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_BileEsculin') {
                stageData.plate_lot = document.getElementById('bulk_plate_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_BHI') {
                stageData.bhi_lot = document.getElementById('bulk_bhi_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeEnteroSFBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Enterococcus Seafood samples!');
            renderEnterococcusTab();
        }

        // Render Aeromonas Tab
        function renderAeromonasTab() {
            var container = document.getElementById('foodTabContentAeromonas');
            var html = '';

            // Filter Aeromonas workflows
            var aeromonasWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'A';
            });

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üêü Aeromonas Testing Workflows (' + aeromonasWorkflows.length + ')</h3>';

            if (aeromonasWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üêü</div>';
                html += '<div style="font-size: 16px;">No Aeromonas workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add seafood samples with Aeromonas testing to create workflows</div>';
                html += '</div>';
            } else {
                // Kanban board for Aeromonas workflows - 4 STAGES
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';

                var stages = [
                    {name: 'Day 1 - BPW Incubation', key: 'day1_BPWIncubation', emoji: 'üíß', color: '#00bcd4'},
                    {name: 'Day 2 - Aeromonas Medium', key: 'day2_AeromonasMedium', emoji: 'üü°', color: '#ffc107'},
                    {name: 'Day 3 - BAP', key: 'day3_BAP', emoji: 'üß´', color: '#3f51b5'},
                    {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: '‚úÖ', color: '#4caf50'}
                ];

                stages.forEach(function(stage) {
                    html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 300px;">';
                    html += '<div style="font-weight: 700; font-size: 14px; margin-bottom: 10px; color: ' + stage.color + ';">';
                    html += stage.emoji + ' ' + stage.name;
                    html += '</div>';

                    // Count workflows in this stage
                    var count = 0;
                    aeromonasWorkflows.forEach(function(wf) {
                        if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') count++;
                        else if (wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_AeromonasMedium.completed && stage.key === 'day2_AeromonasMedium') count++;
                        else if (wf.stages.day2_AeromonasMedium.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') count++;
                        else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                    });

                    html += '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                    // Bulk selection buttons (exclude MALDI)
                    if (count > 0 && stage.key !== 'day4_MALDI') {
                        html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                        html += '<button onclick="selectAllAeromonasInStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                        html += '<button onclick="processSelectedAeromonas(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountA_' + stage.key + '">0</span>)</button>';
                        html += '</div>';
                    }

                    // Render workflow cards in this stage
                    aeromonasWorkflows.forEach(function(wf) {
                        var shouldShow = false;

                        if (!wf.stages.day1_BPWIncubation.completed && stage.key === 'day1_BPWIncubation') shouldShow = true;
                        else if (wf.stages.day1_BPWIncubation.completed && !wf.stages.day2_AeromonasMedium.completed && stage.key === 'day2_AeromonasMedium') shouldShow = true;
                        else if (wf.stages.day2_AeromonasMedium.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') shouldShow = true;
                        else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;

                        if (shouldShow) {
                            html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 10px; margin-bottom: 8px; position: relative;">';
                            html += '<input type="checkbox" class="aeromonas-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateAeromonasSelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                            html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openAeromonasWorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                            html += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 5px;">' + wf.foodSampleId + '</div>';
                            html += '<div style="font-size: 11px; color: #666;">Click to process ‚Üí</div>';
                            html += '</div>';
                            html += '</div>';
                        }
                    });

                    html += '</div>'; // End column
                });

                html += '</div>'; // End grid
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // ========== AEROMONAS BULK SELECTION FUNCTIONS ==========

        function updateAeromonasSelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.aeromonas-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountA_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllAeromonasInStage(stageKey) {
            var checkboxes = document.querySelectorAll('.aeromonas-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateAeromonasSelectedCount(stageKey);
        }

        function processSelectedAeromonas(stageKey) {
            var checkboxes = document.querySelectorAll('.aeromonas-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openAeromonasBulkModal(workflowIds, stageKey);
        }

        function openAeromonasBulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="aeromonasBulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #ffc107;">üêü Bulk Process Aeromonas - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_a_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_a_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1_BPWIncubation') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1 - BPW Incubation:</strong> 25g sample + 225ml BPW (seafood sizing).<br>';
                modalHtml += 'Incubate at 37¬∞C for 24 hours.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BPW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bpw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Incubator:</label>';
                modalHtml += '<select id="bulk_incubator" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHtml += '<option value="INC-1">INC-1</option>';
                modalHtml += '<option value="INC-2">INC-2</option>';
                modalHtml += '<option value="INC-3">INC-3</option>';
                modalHtml += '</select>';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_AeromonasMedium') {
                modalHtml += '<div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ff9800;">';
                modalHtml += '<strong>Day 2 - Aeromonas Medium:</strong><br>';
                modalHtml += 'Pull loopful directly from BPW bag. Streak onto Aeromonas Medium. Look for yellow colonies.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_plate_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_BAP') {
                modalHtml += '<div style="background: #e8eaf6; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3f51b5;">';
                modalHtml += '<strong>Day 3 - BAP Confirmation:</strong><br>';
                modalHtml += 'Pick colonies from Aeromonas Medium onto Blood Agar Plate. Confirm typical growth.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BAP Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bap_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeAeromonasBulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeAeromonasBulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAeromonasBulkModal() {
            var modal = document.getElementById('aeromonasBulkModal');
            if (modal) modal.remove();
        }

        function completeAeromonasBulkStage() {
            var workflowIds = document.getElementById('bulk_a_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_a_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1_BPWIncubation') {
                stageData.bpw_lot = document.getElementById('bulk_bpw_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.incubator = document.getElementById('bulk_incubator').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_AeromonasMedium') {
                stageData.plate_lot = document.getElementById('bulk_plate_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_BAP') {
                stageData.bap_lot = document.getElementById('bulk_bap_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeAeromonasBulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Aeromonas samples!');
            renderAeromonasTab();
        }

        // Render Vibrio Tab (shows both V1 and V2)
        function renderVibrioV1Tab() {
            var container = document.getElementById('foodTabContentVibrioV1');
            var html = '';

            // Filter Vibrio workflows (both V1 and V2)
            var vibrioV1Workflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'V1';
            });
            var vibrioV2Workflows = pathogenWorkflows.filter(function(wf) {
                return wf.pathogenCode === 'V2';
            });

            var totalVibrio = vibrioV1Workflows.length + vibrioV2Workflows.length;

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üåä Vibrio Testing Workflows (' + totalVibrio + ')</h3>';

            if (totalVibrio === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üåä</div>';
                html += '<div style="font-size: 16px;">No Vibrio workflows yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add seafood samples with Vibrio testing to create workflows</div>';
                html += '</div>';
            } else {
                // V1 WORKFLOWS
                if (vibrioV1Workflows.length > 0) {
                    html += '<div style="margin-bottom: 30px;">';
                    html += '<h4 style="color: #00bcd4; margin-bottom: 15px;">Vibrio V1 (' + vibrioV1Workflows.length + ')</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';

                    var v1Stages = [
                        {name: 'Day 1 - APW', key: 'day1_APW', emoji: 'üíß', color: '#00bcd4'},
                        {name: 'Day 2 - TCBS', key: 'day2_TCBS', emoji: 'üü¢', color: '#4caf50'},
                        {name: 'Day 3 - BAP', key: 'day3_BAP', emoji: 'üß´', color: '#3f51b5'},
                        {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: '‚úÖ', color: '#2196f3'}
                    ];

                    v1Stages.forEach(function(stage) {
                        html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 250px;">';
                        html += '<div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: ' + stage.color + ';">' + stage.emoji + ' ' + stage.name + '</div>';

                        var count = 0;
                        vibrioV1Workflows.forEach(function(wf) {
                            if (!wf.stages.day1_APW.completed && stage.key === 'day1_APW') count++;
                            else if (wf.stages.day1_APW.completed && !wf.stages.day2_TCBS.completed && stage.key === 'day2_TCBS') count++;
                            else if (wf.stages.day2_TCBS.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') count++;
                            else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        });

                        html += '<div style="font-size: 11px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                        // Bulk selection buttons (exclude MALDI)
                        if (count > 0 && stage.key !== 'day4_MALDI') {
                            html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                            html += '<button onclick="selectAllVibrioV1InStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                            html += '<button onclick="processSelectedVibrioV1(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountV1_' + stage.key + '">0</span>)</button>';
                            html += '</div>';
                        }

                        vibrioV1Workflows.forEach(function(wf) {
                            var shouldShow = false;
                            if (!wf.stages.day1_APW.completed && stage.key === 'day1_APW') shouldShow = true;
                            else if (wf.stages.day1_APW.completed && !wf.stages.day2_TCBS.completed && stage.key === 'day2_TCBS') shouldShow = true;
                            else if (wf.stages.day2_TCBS.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') shouldShow = true;
                            else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;

                            if (shouldShow) {
                                html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 8px; margin-bottom: 6px; position: relative;">';
                                html += '<input type="checkbox" class="vibrio-v1-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateVibrioV1SelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                                html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openVibrioV1WorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                                html += '<div style="font-weight: 600; font-size: 12px; margin-bottom: 3px;">' + wf.foodSampleId + '</div>';
                                html += '<div style="font-size: 10px; color: #666;">Click to process ‚Üí</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        });

                        html += '</div>';
                    });

                    html += '</div></div>';
                }

                // V2 WORKFLOWS
                if (vibrioV2Workflows.length > 0) {
                    html += '<div>';
                    html += '<h4 style="color: #9c27b0; margin-bottom: 15px;">Vibrio parahaemolyticus V2 (' + vibrioV2Workflows.length + ')</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';

                    var v2Stages = [
                        {name: 'Day 1 - APW', key: 'day1_APW', emoji: 'üíß', color: '#00bcd4'},
                        {name: 'Day 2 - CHROMagar', key: 'day2_CHROMagar', emoji: 'üü£', color: '#9c27b0'},
                        {name: 'Day 3 - BAP', key: 'day3_BAP', emoji: 'üß´', color: '#3f51b5'},
                        {name: 'Day 4 - MALDI', key: 'day4_MALDI', emoji: '‚úÖ', color: '#2196f3'}
                    ];

                    v2Stages.forEach(function(stage) {
                        html += '<div style="background: ' + stage.color + '15; border: 2px solid ' + stage.color + '; border-radius: 8px; padding: 15px; min-height: 250px;">';
                        html += '<div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: ' + stage.color + ';">' + stage.emoji + ' ' + stage.name + '</div>';

                        var count = 0;
                        vibrioV2Workflows.forEach(function(wf) {
                            if (!wf.stages.day1_APW.completed && stage.key === 'day1_APW') count++;
                            else if (wf.stages.day1_APW.completed && !wf.stages.day2_CHROMagar.completed && stage.key === 'day2_CHROMagar') count++;
                            else if (wf.stages.day2_CHROMagar.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') count++;
                            else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') count++;
                        });

                        html += '<div style="font-size: 11px; color: #666; margin-bottom: 10px;">' + count + ' sample(s)</div>';

                        // Bulk selection buttons (exclude MALDI)
                        if (count > 0 && stage.key !== 'day4_MALDI') {
                            html += '<div style="display: flex; gap: 5px; margin-bottom: 10px;">';
                            html += '<button onclick="selectAllVibrioV2InStage(\'' + stage.key + '\')" style="flex: 1; background: ' + stage.color + '; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Select All</button>';
                            html += '<button onclick="processSelectedVibrioV2(\'' + stage.key + '\')" style="flex: 1; background: #28a745; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Process (<span id="selectedCountV2_' + stage.key + '">0</span>)</button>';
                            html += '</div>';
                        }

                        vibrioV2Workflows.forEach(function(wf) {
                            var shouldShow = false;
                            if (!wf.stages.day1_APW.completed && stage.key === 'day1_APW') shouldShow = true;
                            else if (wf.stages.day1_APW.completed && !wf.stages.day2_CHROMagar.completed && stage.key === 'day2_CHROMagar') shouldShow = true;
                            else if (wf.stages.day2_CHROMagar.completed && !wf.stages.day3_BAP.completed && stage.key === 'day3_BAP') shouldShow = true;
                            else if (wf.stages.day3_BAP.completed && !wf.stages.day4_MALDI.completed && stage.key === 'day4_MALDI') shouldShow = true;

                            if (shouldShow) {
                                html += '<div style="background: white; border: 2px solid ' + stage.color + '; border-radius: 6px; padding: 8px; margin-bottom: 6px; position: relative;">';
                                html += '<input type="checkbox" class="vibrio-v2-bulk-checkbox" data-workflow-id="' + wf.id + '" data-stage="' + stage.key + '" onchange="updateVibrioV2SelectedCount(\'' + stage.key + '\')" style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; cursor: pointer;" />';
                                html += '<div style="cursor: pointer; padding-right: 25px;" onclick="openVibrioV2WorkflowModal(\'' + wf.id + '\', \'' + stage.key + '\')">';
                                html += '<div style="font-weight: 600; font-size: 12px; margin-bottom: 3px;">' + wf.foodSampleId + '</div>';
                                html += '<div style="font-size: 10px; color: #666;">Click to process ‚Üí</div>';
                                html += '</div>';
                                html += '</div>';
                            }
                        });

                        html += '</div>';
                    });

                    html += '</div></div>';
                }
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // ========== VIBRIO V1 BULK SELECTION FUNCTIONS ==========

        function updateVibrioV1SelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v1-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountV1_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllVibrioV1InStage(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v1-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateVibrioV1SelectedCount(stageKey);
        }

        function processSelectedVibrioV1(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v1-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openVibrioV1BulkModal(workflowIds, stageKey);
        }

        function openVibrioV1BulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="vibrioV1BulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #00bcd4;">üåä Bulk Process Vibrio V1 - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_v1_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_v1_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1_APW') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1 - APW Incubation:</strong> 25g sample + 225ml APW (Alkaline Peptone Water - seafood).<br>';
                modalHtml += 'Incubate at 37¬∞C for 6-8 hours (shorter than BPW!).';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">APW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_apw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out (6-8h):</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_TCBS') {
                modalHtml += '<div style="background: #e8f5e9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #4caf50;">';
                modalHtml += '<strong>Day 2 - TCBS Agar:</strong><br>';
                modalHtml += 'Pull loopful directly from APW bag. Streak onto TCBS. Look for yellow or green colonies.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">TCBS Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_tcbs_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_BAP') {
                modalHtml += '<div style="background: #e8eaf6; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3f51b5;">';
                modalHtml += '<strong>Day 3 - BAP Confirmation:</strong><br>';
                modalHtml += 'Pick colonies from TCBS onto Blood Agar Plate. Confirm typical growth.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BAP Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bap_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeVibrioV1BulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeVibrioV1BulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeVibrioV1BulkModal() {
            var modal = document.getElementById('vibrioV1BulkModal');
            if (modal) modal.remove();
        }

        function completeVibrioV1BulkStage() {
            var workflowIds = document.getElementById('bulk_v1_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_v1_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1_APW') {
                stageData.apw_lot = document.getElementById('bulk_apw_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_TCBS') {
                stageData.tcbs_lot = document.getElementById('bulk_tcbs_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_BAP') {
                stageData.bap_lot = document.getElementById('bulk_bap_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeVibrioV1BulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Vibrio V1 samples!');
            renderVibrioV1Tab();
        }

        // ========== VIBRIO V2 BULK SELECTION FUNCTIONS ==========

        function updateVibrioV2SelectedCount(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v2-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            var countSpan = document.getElementById('selectedCountV2_' + stageKey);
            if (countSpan) {
                countSpan.textContent = checkboxes.length;
            }
        }

        function selectAllVibrioV2InStage(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v2-bulk-checkbox[data-stage="' + stageKey + '"]');
            var allChecked = true;
            checkboxes.forEach(function(cb) {
                if (!cb.checked) allChecked = false;
            });
            checkboxes.forEach(function(cb) {
                cb.checked = !allChecked;
            });
            updateVibrioV2SelectedCount(stageKey);
        }

        function processSelectedVibrioV2(stageKey) {
            var checkboxes = document.querySelectorAll('.vibrio-v2-bulk-checkbox[data-stage="' + stageKey + '"]:checked');
            if (checkboxes.length === 0) {
                alert('No samples selected.');
                return;
            }
            var workflowIds = [];
            checkboxes.forEach(function(cb) {
                workflowIds.push(cb.getAttribute('data-workflow-id'));
            });
            openVibrioV2BulkModal(workflowIds, stageKey);
        }

        function openVibrioV2BulkModal(workflowIds, stageKey) {
            var modalHtml = '<div id="vibrioV2BulkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">';
            modalHtml += '<div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">';
            modalHtml += '<h3 style="margin-top: 0; color: #9c27b0;">üåä Bulk Process Vibrio V2 - ' + workflowIds.length + ' samples</h3>';

            modalHtml += '<input type="hidden" id="bulk_v2_workflowIds" value="' + workflowIds.join(',') + '" />';
            modalHtml += '<input type="hidden" id="bulk_v2_stageKey" value="' + stageKey + '" />';

            // Stage-specific fields
            if (stageKey === 'day1_APW') {
                modalHtml += '<div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">';
                modalHtml += '<strong>Day 1 - APW Incubation:</strong> 25g sample + 225ml APW (Alkaline Peptone Water - seafood).<br>';
                modalHtml += 'Incubate at 37¬∞C for 6-8 hours (shorter than BPW!).';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">APW Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_apw_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out (6-8h):</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day2_CHROMagar') {
                modalHtml += '<div style="background: #f3e5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #9c27b0;">';
                modalHtml += '<strong>Day 2 - CHROMagar Vibrio:</strong><br>';
                modalHtml += 'Pull loopful directly from APW bag. Streak onto CHROMagar. Look for mauve (purple) colonies.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">CHROMagar Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_chromagar_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

            } else if (stageKey === 'day3_BAP') {
                modalHtml += '<div style="background: #e8eaf6; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3f51b5;">';
                modalHtml += '<strong>Day 3 - BAP Confirmation:</strong><br>';
                modalHtml += 'Pick colonies from CHROMagar onto Blood Agar Plate. Confirm typical growth.';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">BAP Plate Lot #:</label>';
                modalHtml += '<input type="text" id="bulk_bap_lot" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (¬∞C):</label>';
                modalHtml += '<input type="number" id="bulk_temp" value="37" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';

                modalHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time In:</label>';
                modalHtml += '<input type="time" id="bulk_time_in" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '<div>';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Time Out:</label>';
                modalHtml += '<input type="time" id="bulk_time_out" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '<div style="margin-bottom: 15px;">';
                modalHtml += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">Technician Initials:</label>';
                modalHtml += '<input type="text" id="bulk_tech_initials" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />';
                modalHtml += '</div>';
            }

            modalHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            modalHtml += '<button onclick="completeVibrioV2BulkStage()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚úì Complete All</button>';
            modalHtml += '<button onclick="closeVibrioV2BulkModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancel</button>';
            modalHtml += '</div>';

            modalHtml += '</div>';
            modalHtml += '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeVibrioV2BulkModal() {
            var modal = document.getElementById('vibrioV2BulkModal');
            if (modal) modal.remove();
        }

        function completeVibrioV2BulkStage() {
            var workflowIds = document.getElementById('bulk_v2_workflowIds').value.split(',');
            var stageKey = document.getElementById('bulk_v2_stageKey').value;

            var stageData = {};

            if (stageKey === 'day1_APW') {
                stageData.apw_lot = document.getElementById('bulk_apw_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day2_CHROMagar') {
                stageData.chromagar_lot = document.getElementById('bulk_chromagar_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            } else if (stageKey === 'day3_BAP') {
                stageData.bap_lot = document.getElementById('bulk_bap_lot').value;
                stageData.temperature = document.getElementById('bulk_temp').value;
                stageData.time_in = document.getElementById('bulk_time_in').value;
                stageData.time_out = document.getElementById('bulk_time_out').value;
                stageData.tech_initials = document.getElementById('bulk_tech_initials').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            var processedCount = 0;
            workflowIds.forEach(function(id) {
                var workflow = pathogenWorkflows.find(function(wf) { return wf.id === id; });
                if (workflow) {
                    workflow.stages[stageKey] = JSON.parse(JSON.stringify(stageData));
                    processedCount++;
                }
            });

            saveData();
            closeVibrioV2BulkModal();
            showSuccessNotification('‚úì Processed ' + processedCount + ' Vibrio V2 samples!');
            renderVibrioV1Tab();
        }

        // Render Isolates Tab
        function renderIsolatesTab() {
            var container = document.getElementById('foodTabContentIsolates');
            var html = '';

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üß¨ Generated Isolates (' + isolates.length + ')</h3>';

            if (isolates.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üß¨</div>';
                html += '<div style="font-size: 16px;">No isolates generated yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Complete pathogen testing workflows to generate isolates</div>';
                html += '</div>';
            } else {
                // Render isolates
                isolates.forEach(function(isolate) {
                    var pathogen = pathogens[isolate.pathogenCode];

                    html += '<div style="border: 2px solid ' + pathogen.color + '; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);">';

                    // Header
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                    html += '<div style="display: flex; align-items: center; gap: 10px;">';
                    html += '<span style="font-size: 24px;">üß¨</span>';
                    html += '<div>';
                    html += '<div style="font-weight: 700; font-size: 16px;">' + isolate.id + '</div>';
                    html += '<div style="font-size: 13px; color: #666;">From: ' + isolate.foodSampleId + '</div>';
                    html += '</div>';
                    html += '</div>';

                    // Pathogen badge
                    html += '<span style="background: ' + pathogen.color + '; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">' + isolate.pathogenCode + ' - ' + pathogen.name + '</span>';

                    html += '</div>'; // End header

                    // Details
                    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px; padding-top: 10px; border-top: 1px solid #e0e0e0;">';
                    html += '<div><strong>Species:</strong> ' + isolate.species + '</div>';
                    html += '<div><strong>Generated:</strong> ' + isolate.dateGenerated + '</div>';
                    html += '<div><strong>Status:</strong> ' + (isolate.sentToSequencing ? '‚úÖ Sent to Sequencing' : '‚è≥ Pending') + '</div>';
                    html += '</div>';

                    // If sent to sequencing, show link
                    if (isolate.sentToSequencing && isolate.sequencingSampleId) {
                        html += '<div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px;">';
                        html += '<span style="font-weight: 600; color: #2e7d32;">üß¨ Sequencing Sample: </span>';
                        html += '<a href="#" onclick="switchModule(\'sequencing\'); highlightSample(\'' + isolate.sequencingSampleId + '\'); return false;" style="color: #1976d2; text-decoration: underline;">' + isolate.sequencingSampleId + '</a>';
                        html += '</div>';
                    }

                    html += '</div>'; // End isolate card
                });
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // Render Results Summary Tab
        function renderResultsSummaryTab() {
            var container = document.getElementById('foodTabContentResults');
            var html = '';

            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin-top: 0;">üìä Results Summary - All Samples</h3>';

            // Group samples by month
            var samplesByMonth = {};
            foodSamples.forEach(function(sample) {
                // Extract month from sample ID (e.g., "25KS10CB01" -> "2025-10")
                if (sample.id && sample.id.length >= 6) {
                    var year = '20' + sample.id.substring(0, 2);
                    var month = sample.id.substring(4, 6);
                    var monthKey = year + '-' + month;

                    if (!samplesByMonth[monthKey]) {
                        samplesByMonth[monthKey] = [];
                    }
                    samplesByMonth[monthKey].push(sample);
                }
            });

            // Sort months (most recent first)
            var monthKeys = Object.keys(samplesByMonth).sort().reverse();

            if (monthKeys.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üìä</div>';
                html += '<div style="font-size: 16px;">No samples yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Add food samples to see results summary</div>';
                html += '</div>';
            } else {
                // Render each month's results
                monthKeys.forEach(function(monthKey) {
                    var samples = samplesByMonth[monthKey];
                    var monthName = new Date(monthKey + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

                    // Separate by category
                    var meatSamples = samples.filter(function(s) {
                        var type = sampleTypes[s.sampleTypeCode];
                        return type && type.category === 'meat';
                    });

                    var seafoodSamples = samples.filter(function(s) {
                        var type = sampleTypes[s.sampleTypeCode];
                        return type && type.category === 'seafood';
                    });

                    html += '<div style="margin-bottom: 40px;">';
                    html += '<h4 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' + monthName + ' (' + samples.length + ' samples)</h4>';

                    // Retail Meat Section
                    if (meatSamples.length > 0) {
                        html += '<div style="margin-bottom: 30px;">';
                        html += '<h5 style="color: #333; margin-bottom: 15px;">ü•© Results - Retail Meat (' + meatSamples.length + ' samples)</h5>';

                        html += '<div style="overflow-x: auto;">';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                        html += '<thead>';
                        html += '<tr style="background: #f8f9fa;">';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 700;">Sample</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">S1</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">C1</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">EC</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">E</th>';
                        html += '</tr>';
                        html += '</thead>';
                        html += '<tbody>';

                        meatSamples.forEach(function(sample) {
                            html += '<tr>';
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; font-weight: 600;">' + sample.id + '</td>';

                            // S1 (Salmonella)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'S1') + '</td>';

                            // C1 (Campylobacter)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'C1') + '</td>';

                            // EC (E. coli)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'EC') + '</td>';

                            // E (Enterococcus)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'E') + '</td>';

                            html += '</tr>';
                        });

                        html += '</tbody>';
                        html += '</table>';
                        html += '</div>'; // End overflow container
                        html += '</div>'; // End meat section
                    }

                    // Seafood Section
                    if (seafoodSamples.length > 0) {
                        html += '<div style="margin-bottom: 30px;">';
                        html += '<h5 style="color: #333; margin-bottom: 15px;">üêü Results - Seafood (' + seafoodSamples.length + ' samples)</h5>';

                        html += '<div style="overflow-x: auto;">';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                        html += '<thead>';
                        html += '<tr style="background: #f8f9fa;">';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: 700;">Sample</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">V1</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">V2</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">E</th>';
                        html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; font-weight: 700;">A</th>';
                        html += '</tr>';
                        html += '</thead>';
                        html += '<tbody>';

                        seafoodSamples.forEach(function(sample) {
                            html += '<tr>';
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; font-weight: 600;">' + sample.id + '</td>';

                            // V1 (Vibrio yellow)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'V1') + '</td>';

                            // V2 (Vibrio green)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'V2') + '</td>';

                            // E (Enterococcus)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'E') + '</td>';

                            // A (Aeromonas)
                            html += '<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">' + getPathogenStatus(sample.id, 'A') + '</td>';

                            html += '</tr>';
                        });

                        html += '</tbody>';
                        html += '</table>';
                        html += '</div>'; // End overflow container
                        html += '</div>'; // End seafood section
                    }

                    html += '</div>'; // End month section
                });
            }

            html += '</div>'; // End container

            container.innerHTML = html;
        }

        // Helper function to get pathogen status for a sample
        function getPathogenStatus(sampleId, pathogenCode) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.foodSampleId === sampleId && wf.pathogenCode === pathogenCode;
            });

            if (!workflow) {
                return '<span style="color: #6c757d;">NT</span>'; // Not Tested
            }

            if (workflow.finalResult === 'positive') {
                return '<span style="color: #28a745; font-weight: 700;">Positive</span>';
            } else if (workflow.finalResult === 'negative') {
                return '<span style="color: #dc3545; font-weight: 700;">Negative</span>';
            } else {
                // In progress - show current stage
                var stage = '';
                if (!workflow.stages.day1A_BPWPrep || !workflow.stages.day1A_BPWPrep.completed) {
                    stage = 'Day 1A';
                } else if (pathogenCode === 'EC') {
                    if (!workflow.stages.day1B_MacBroth.completed) stage = 'Day 1B';
                    else if (!workflow.stages.day2_MacAgar.completed) stage = 'Day 2';
                    else if (!workflow.stages.day3_PinkColonies.completed) stage = 'Day 3';
                    else if (!workflow.stages.day4_MALDI.completed) stage = 'Day 4';
                    else if (!workflow.stages.day5_Storage.completed) stage = 'Day 5';
                }
                // Add other pathogen stage logic as needed

                return '<span style="color: #ffc107; font-weight: 600;">üî¨ ' + (stage || '?') + '</span>';
            }
        }

        // Open E. coli Workflow Modal
        var currentEcoliWorkflow = null;
        var currentEcoliStage = null;

        function openEcoliWorkflowModal(workflowId, stageKey) {
            // Find the workflow
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentEcoliWorkflow = workflow;
            currentEcoliStage = stageKey;

            // Create modal
            var modal = document.getElementById('ecoliWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ecoliWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeEcoliWorkflowModal()">&times;</span>';

            // Title based on stage
            var stageTitle = '';
            if (stageKey === 'day1A_BPWPrep') stageTitle = 'üíß Day 1A - BPW Sample Prep';
            else if (stageKey === 'day1B_MacBroth') stageTitle = 'üß™ Day 1B - MAC Broth Enrichment';
            else if (stageKey === 'day2_MacAgar') stageTitle = 'üß´ Day 2 - Streak to MAC Agar';
            else if (stageKey === 'day3_PinkColonies') stageTitle = 'üî¨ Day 3 - Check for Pink Colonies';
            else if (stageKey === 'day4_MALDI') stageTitle = 'üß¨ Day 4 - MALDI Identification';
            else if (stageKey === 'day5_Storage') stageTitle = '‚ùÑÔ∏è Day 5 - Store in -80¬∞C Freezer';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong></p>';

            // Form fields based on stage
            if (stageKey === 'day1A_BPWPrep') {
                html += '<div class="form-group">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="ecoli_bpwLot" placeholder="LOT-BPW-2025-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="ecoli_sampleWeight" value="50" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="ecoli_bpwVolume" value="250" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Stomach Time (minutes):</label>';
                html += '<input type="number" id="ecoli_stomachTime" value="2" step="0.5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Volume Pulled for EC (ml):</label>';
                html += '<input type="number" id="ecoli_volumePulled" value="50" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Remaining BPW to Incubator?:</label>';
                html += '<select id="ecoli_bpwToIncubator">';
                html += '<option value="Yes">Yes (for Salmonella)</option>';
                html += '<option value="No">No</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day1B_MacBroth') {
                html += '<div class="form-group">';
                html += '<label>MAC Broth Lot #:</label>';
                html += '<input type="text" id="ecoli_macBrothLot" placeholder="LOT-MAC-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="ecoli_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="ecoli_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="ecoli_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="ecoli_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day2_MacAgar') {
                html += '<div class="form-group">';
                html += '<label>MAC Agar Plate Lot #:</label>';
                html += '<input type="text" id="ecoli_macAgarLot" placeholder="LOT-MACAGAR-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="ecoli_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="ecoli_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="ecoli_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="ecoli_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day3_PinkColonies') {
                html += '<div class="form-group">';
                html += '<label>Pink Colonies Present?</label>';
                html += '<select id="ecoli_pinkColonies">';
                html += '<option value="Yes">Yes - Presumptive Positive</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Colony Count (approx):</label>';
                html += '<input type="number" id="ecoli_colonyCount" placeholder="e.g., 20" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div class="form-group">';
                html += '<label>Date Sent to MALDI:</label>';
                html += '<input type="date" id="ecoli_maldiDateSent" value="' + new Date().toISOString().split('T')[0] + '" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Result:</label>';
                html += '<select id="ecoli_maldiResult" onchange="toggleMALDISpeciesField()">';
                html += '<option value="">-- Select Result --</option>';
                html += '<option value="positive">Positive - E. coli confirmed</option>';
                html += '<option value="negative">Negative - Not E. coli</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group" id="maldiSpeciesGroup" style="display: none;">';
                html += '<label>Species Identified (if negative):</label>';
                html += '<input type="text" id="ecoli_maldiSpecies" placeholder="e.g., Citrobacter freundii" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day5_Storage') {
                var autoVialId = workflow.foodSampleId + '-EC';

                html += '<div class="form-group">';
                html += '<label>Vial ID:</label>';
                html += '<input type="text" id="ecoli_vialId" value="' + autoVialId + '" />';
                html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">Auto-generated, editable</div>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Date Stored:</label>';
                html += '<input type="date" id="ecoli_dateStored" value="' + new Date().toISOString().split('T')[0] + '" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Freezer:</label>';
                html += '<select id="ecoli_freezer">';
                html += '<option value="">-- Select Freezer --</option>';
                html += '<option value="Freezer-1">Freezer 1</option>';
                html += '<option value="Freezer-2">Freezer 2</option>';
                html += '<option value="-80-1">-80¬∞C Freezer 1</option>';
                html += '<option value="-80-2">-80¬∞C Freezer 2</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Box:</label>';
                html += '<input type="text" id="ecoli_box" placeholder="e.g., Box 5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Shelf:</label>';
                html += '<input type="text" id="ecoli_shelf" placeholder="e.g., Shelf A or 2" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Rack:</label>';
                html += '<input type="text" id="ecoli_rack" placeholder="e.g., Rack 3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Position:</label>';
                html += '<input type="text" id="ecoli_position" placeholder="e.g., A1, B5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="ecoli_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeEcoliStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeEcoliWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>'; // End modal-content

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function toggleMALDISpeciesField() {
            var result = document.getElementById('ecoli_maldiResult');
            var speciesGroup = document.getElementById('maldiSpeciesGroup');
            if (result && speciesGroup) {
                speciesGroup.style.display = (result.value === 'negative') ? 'block' : 'none';
            }
        }

        function closeEcoliWorkflowModal() {
            var modal = document.getElementById('ecoliWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentEcoliWorkflow = null;
            currentEcoliStage = null;
        }

        function completeEcoliStage() {
            if (!currentEcoliWorkflow || !currentEcoliStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('ecoli_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            // Collect stage-specific data
            if (currentEcoliStage === 'day1A_BPWPrep') {
                stageData.bpwLot = document.getElementById('ecoli_bpwLot').value;
                stageData.sampleWeight = document.getElementById('ecoli_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('ecoli_bpwVolume').value;
                stageData.stomachTime = document.getElementById('ecoli_stomachTime').value;
                stageData.volumePulled = document.getElementById('ecoli_volumePulled').value;
                stageData.bpwToIncubator = document.getElementById('ecoli_bpwToIncubator').value;
            } else if (currentEcoliStage === 'day1B_MacBroth') {
                stageData.macBrothLot = document.getElementById('ecoli_macBrothLot').value;
                stageData.temperature = document.getElementById('ecoli_temperature').value;
                stageData.incubator = document.getElementById('ecoli_incubator').value;
                stageData.timeIn = document.getElementById('ecoli_timeIn').value;
                stageData.timeOut = document.getElementById('ecoli_timeOut').value;
            } else if (currentEcoliStage === 'day2_MacAgar') {
                stageData.macAgarLot = document.getElementById('ecoli_macAgarLot').value;
                stageData.temperature = document.getElementById('ecoli_temperature').value;
                stageData.incubator = document.getElementById('ecoli_incubator').value;
                stageData.timeIn = document.getElementById('ecoli_timeIn').value;
                stageData.timeOut = document.getElementById('ecoli_timeOut').value;
            } else if (currentEcoliStage === 'day3_PinkColonies') {
                var pinkColonies = document.getElementById('ecoli_pinkColonies').value;
                stageData.hasPinkColonies = pinkColonies === 'Yes' ? 'yes' : 'no';
                stageData.colonyCount = document.getElementById('ecoli_colonyCount').value;
                stageData.dateChecked = new Date().toISOString().split('T')[0];

                // If NO pink colonies, mark as NEGATIVE and end workflow
                if (stageData.hasPinkColonies === 'no') {
                    currentEcoliWorkflow.finalResult = 'negative';
                    currentEcoliWorkflow.resultDate = new Date().toISOString().split('T')[0];
                }
            } else if (currentEcoliStage === 'day4_MALDI') {
                var maldiResult = document.getElementById('ecoli_maldiResult').value;
                var maldiDateSent = document.getElementById('ecoli_maldiDateSent').value;

                if (!maldiResult) {
                    alert('Please select MALDI result');
                    return;
                }

                stageData.dateSent = maldiDateSent;
                stageData.result = maldiResult;

                if (maldiResult === 'negative') {
                    var species = document.getElementById('ecoli_maldiSpecies').value;
                    if (!species || species.trim() === '') {
                        alert('Please enter the species identified');
                        return;
                    }
                    stageData.speciesId = species;

                    // Mark as NEGATIVE (not E. coli)
                    currentEcoliWorkflow.finalResult = 'negative';
                    currentEcoliWorkflow.resultDate = new Date().toISOString().split('T')[0];
                }
                // If positive, continue to storage (finalResult stays null for now)
            } else if (currentEcoliStage === 'day5_Storage') {
                var vialId = document.getElementById('ecoli_vialId').value;
                var freezer = document.getElementById('ecoli_freezer').value;

                if (!vialId || !freezer) {
                    alert('Please fill in Vial ID and Freezer location');
                    return;
                }

                stageData.vialId = vialId;
                stageData.dateStored = document.getElementById('ecoli_dateStored').value;
                stageData.freezer = freezer;
                stageData.box = document.getElementById('ecoli_box').value;
                stageData.shelf = document.getElementById('ecoli_shelf').value;
                stageData.rack = document.getElementById('ecoli_rack').value;
                stageData.position = document.getElementById('ecoli_position').value;

                // Mark as POSITIVE - confirmed E. coli and stored
                currentEcoliWorkflow.finalResult = 'positive';
                currentEcoliWorkflow.resultDate = new Date().toISOString().split('T')[0];

                // Generate isolate for sequencing
                generateIsolate(currentEcoliWorkflow, 'Escherichia coli');
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            // Update workflow
            currentEcoliWorkflow.stages[currentEcoliStage] = stageData;

            // Save and close
            saveData();
            closeEcoliWorkflowModal();
            showSuccessNotification('E. coli stage completed!');

            // Refresh view
            renderEcoliTab();
        }

        // ========== CAMPYLOBACTER WORKFLOW FUNCTIONS ==========

        var currentCampyloWorkflow = null;
        var currentCampyloStage = null;

        function openCampyloWorkflowModal(workflowId, stageKey) {
            // Find the workflow
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentCampyloWorkflow = workflow;
            currentCampyloStage = stageKey;

            // Create modal
            var modal = document.getElementById('campyloWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'campyloWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeCampyloWorkflowModal()">&times;</span>';

            // Title based on stage
            var stageTitle = '';
            if (stageKey === 'day1A_BPWPrep') stageTitle = 'üíß Day 1A - BPW Sample Prep';
            else if (stageKey === 'day1B_BoltonBroth') stageTitle = 'ü¶† Day 1B - Bolton Broth Enrichment';
            else if (stageKey === 'day2_CCA') stageTitle = 'üß´ Day 2 - Campy-Cefex Agar';
            else if (stageKey === 'day3_BAP') stageTitle = 'üß´ Day 3 - BAP Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = 'üß¨ Day 4 - MALDI Identification';
            else if (stageKey === 'day5_Storage') stageTitle = '‚ùÑÔ∏è Day 5 - Storage';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong></p>';

            // Form fields based on stage
            if (stageKey === 'day1A_BPWPrep') {
                // Same as E. coli Day 1A
                html += '<div class="form-group">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="campylo_bpwLot" placeholder="LOT-BPW-2025-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="campylo_sampleWeight" value="50" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="campylo_bpwVolume" value="250" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Stomach Time (minutes):</label>';
                html += '<input type="number" id="campylo_stomachTime" value="2" step="0.5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Volume Pulled for C1 (ml):</label>';
                html += '<input type="number" id="campylo_volumePulled" value="50" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Remaining BPW to Incubator?:</label>';
                html += '<select id="campylo_bpwToIncubator">';
                html += '<option value="Yes">Yes (for Salmonella)</option>';
                html += '<option value="No">No</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="campylo_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day1B_BoltonBroth') {
                html += '<div class="form-group">';
                html += '<label>Bolton Broth Lot #:</label>';
                html += '<input type="text" id="campylo_boltonLot" placeholder="LOT-BOLTON-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="campylo_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="campylo_temperature">';
                html += '<option value="42">42¬∞C (Microaerobic)</option>';
                html += '<option value="37">37¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="campylo_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="campylo_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="campylo_timeOut" />';
                html += '</div>';

                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-top: 10px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Note:</strong> Microaerobic conditions required (5-10% O‚ÇÇ, 10% CO‚ÇÇ)';
                html += '</div>';

            } else if (stageKey === 'day2_CCA') {
                html += '<div class="form-group">';
                html += '<label>CCA Plate Lot #:</label>';
                html += '<input type="text" id="campylo_ccaLot" placeholder="LOT-CCA-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="campylo_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="campylo_temperature">';
                html += '<option value="42">42¬∞C (Microaerobic)</option>';
                html += '<option value="37">37¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="campylo_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="campylo_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="campylo_timeOut" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies Present?</label>';
                html += '<select id="campylo_typicalColonies">';
                html += '<option value="Yes">Yes - Presumptive Positive</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label><strong>Growth Observed?</strong></label>';
                html += '<select id="campylo_growthObserved">';
                html += '<option value="">-- Select --</option>';
                html += '<option value="yes">‚úì Yes - Continue to BAP</option>';
                html += '<option value="no">üîÑ No - Re-incubate for 24h</option>';
                html += '</select>';
                html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">If no growth, sample will stay in Day 2 for another check</div>';
                html += '</div>';

            } else if (stageKey === 'day3_BAP') {
                html += '<div class="form-group">';
                html += '<label>BAP Plate Lot #:</label>';
                html += '<input type="text" id="campylo_bapLot" placeholder="LOT-BAP-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Growth?</label>';
                html += '<select id="campylo_typicalGrowth">';
                html += '<option value="Yes">Yes</option>';
                html += '<option value="No">No</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="campylo_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="campylo_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="campylo_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="campylo_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="campylo_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="campylo_maldiSpecies" placeholder="e.g., Campylobacter jejuni" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="campylo_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Campylobacter?</label>';
                html += '<select id="campylo_confirmed">';
                html += '<option value="Yes">Yes - Continue to Storage</option>';
                html += '<option value="No">No - Mark as Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="campylo_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day5_Storage') {
                var autoVialId = workflow.foodSampleId + '-C1';

                html += '<div class="form-group">';
                html += '<label>Vial ID:</label>';
                html += '<input type="text" id="campylo_vialId" value="' + autoVialId + '" />';
                html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">Auto-generated, editable</div>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Freezer:</label>';
                html += '<select id="campylo_freezer">';
                html += '<option value="">-- Select Freezer --</option>';
                html += '<option value="Freezer-1">Freezer 1</option>';
                html += '<option value="Freezer-2">Freezer 2</option>';
                html += '<option value="-80-1">-80¬∞C Freezer 1</option>';
                html += '<option value="-80-2">-80¬∞C Freezer 2</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Box:</label>';
                html += '<input type="text" id="campylo_box" placeholder="e.g., Box 12" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Shelf:</label>';
                html += '<input type="text" id="campylo_shelf" placeholder="e.g., Shelf 3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Rack:</label>';
                html += '<input type="text" id="campylo_rack" placeholder="e.g., Rack A" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Position:</label>';
                html += '<input type="text" id="campylo_position" placeholder="e.g., A1" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeCampyloStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeCampyloWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>'; // End modal-content

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeCampyloWorkflowModal() {
            var modal = document.getElementById('campyloWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentCampyloWorkflow = null;
            currentCampyloStage = null;
        }

        function completeCampyloStage() {
            if (!currentCampyloWorkflow || !currentCampyloStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('campylo_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            // Collect stage-specific data
            if (currentCampyloStage === 'day1A_BPWPrep') {
                stageData.bpwLot = document.getElementById('campylo_bpwLot').value;
                stageData.sampleWeight = document.getElementById('campylo_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('campylo_bpwVolume').value;
                stageData.stomachTime = document.getElementById('campylo_stomachTime').value;
                stageData.volumePulled = document.getElementById('campylo_volumePulled').value;
                stageData.bpwToIncubator = document.getElementById('campylo_bpwToIncubator').value;
            } else if (currentCampyloStage === 'day1B_BoltonBroth') {
                stageData.boltonLot = document.getElementById('campylo_boltonLot').value;
                stageData.temperature = document.getElementById('campylo_temperature').value;
                stageData.incubator = document.getElementById('campylo_incubator').value;
                stageData.timeIn = document.getElementById('campylo_timeIn').value;
                stageData.timeOut = document.getElementById('campylo_timeOut').value;
            } else if (currentCampyloStage === 'day2_CCA') {
                stageData.ccaLot = document.getElementById('campylo_ccaLot').value;
                stageData.temperature = document.getElementById('campylo_temperature').value;
                stageData.incubator = document.getElementById('campylo_incubator').value;
                stageData.timeIn = document.getElementById('campylo_timeIn').value;
                stageData.timeOut = document.getElementById('campylo_timeOut').value;
                stageData.typicalColonies = document.getElementById('campylo_typicalColonies').value;

                var growthObserved = document.getElementById('campylo_growthObserved').value;

                if (!growthObserved) {
                    alert('Please select whether growth was observed');
                    return;
                }

                stageData.hasGrowth = growthObserved;

                // If no growth, mark for re-incubation (don't complete stage)
                if (growthObserved === 'no') {
                    // Initialize arrays if they don't exist
                    if (!currentCampyloWorkflow.stages.day2_CCA.reincubationDates) {
                        currentCampyloWorkflow.stages.day2_CCA.reincubationDates = [];
                    }
                    if (!currentCampyloWorkflow.stages.day2_CCA.reincubationCount) {
                        currentCampyloWorkflow.stages.day2_CCA.reincubationCount = 0;
                    }

                    // Track re-incubation
                    currentCampyloWorkflow.stages.day2_CCA.reincubationCount++;
                    currentCampyloWorkflow.stages.day2_CCA.reincubationDates.push(new Date().toISOString().split('T')[0]);
                    currentCampyloWorkflow.stages.day2_CCA.lastChecked = new Date().toISOString().split('T')[0];

                    // Don't mark as completed - stays in Day 2
                    saveData();
                    closeCampyloWorkflowModal();
                    showSuccessNotification('Sample marked for re-incubation (24h)');
                    renderCampyloTab();
                    return; // Exit early - don't complete the stage
                }
            } else if (currentCampyloStage === 'day3_BAP') {
                stageData.bapLot = document.getElementById('campylo_bapLot').value;
                stageData.typicalGrowth = document.getElementById('campylo_typicalGrowth').value;
                stageData.temperature = document.getElementById('campylo_temperature').value;
                stageData.incubator = document.getElementById('campylo_incubator').value;
                stageData.timeIn = document.getElementById('campylo_timeIn').value;
                stageData.timeOut = document.getElementById('campylo_timeOut').value;
            } else if (currentCampyloStage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('campylo_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('campylo_maldiConfidence').value;
                stageData.confirmed = document.getElementById('campylo_confirmed').value;

                // If not confirmed, mark as negative
                if (stageData.confirmed === 'No') {
                    currentCampyloWorkflow.finalResult = 'negative';
                    currentCampyloWorkflow.resultDate = new Date().toISOString().split('T')[0];
                }
            } else if (currentCampyloStage === 'day5_Storage') {
                stageData.vialId = document.getElementById('campylo_vialId').value;
                stageData.dateStored = new Date().toISOString().split('T')[0];
                stageData.freezer = document.getElementById('campylo_freezer').value;
                stageData.box = document.getElementById('campylo_box').value;
                stageData.shelf = document.getElementById('campylo_shelf').value;
                stageData.rack = document.getElementById('campylo_rack').value;
                stageData.position = document.getElementById('campylo_position').value;

                // Mark as positive and generate isolate when stored
                currentCampyloWorkflow.finalResult = 'positive';
                currentCampyloWorkflow.resultDate = new Date().toISOString().split('T')[0];

                // Generate isolate with species from MALDI stage
                var maldiSpecies = currentCampyloWorkflow.stages.day4_MALDI.maldiSpecies || 'Campylobacter sp.';
                generateIsolate(currentCampyloWorkflow, maldiSpecies);
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            // Update workflow
            currentCampyloWorkflow.stages[currentCampyloStage] = stageData;

            // Save and close
            saveData();
            closeCampyloWorkflowModal();
            showSuccessNotification('Campylobacter stage completed!');

            // Refresh view
            renderCampyloTab();
        }

        // ========== SALMONELLA WORKFLOW FUNCTIONS ==========

        var currentSalmonellaWorkflow = null;
        var currentSalmonellaStage = null;

        function openSalmonellaWorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentSalmonellaWorkflow = workflow;
            currentSalmonellaStage = stageKey;

            var modal = document.getElementById('salmonellaWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'salmonellaWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeSalmonellaWorkflowModal()">&times;</span>';

            var stageTitle = '';
            if (stageKey === 'day1_BPWIncubation') stageTitle = 'üíß Day 1 - BPW Incubation';
            else if (stageKey === 'day2_RVR_LAMP') stageTitle = 'üî¨ Day 2 - RVR + LAMP Screening';
            else if (stageKey === 'day3_XLT4') stageTitle = 'üß´ Day 3 - XLT4 Agar';
            else if (stageKey === 'day4_MALDI') stageTitle = '‚úÖ Day 4 - MALDI Identification';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong></p>';

            if (stageKey === 'day1_BPWIncubation') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> This is the remaining BPW from Day 1A sample prep, now incubated for Salmonella.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW was incubated?:</label>';
                html += '<select id="salm_bpwIncubated">';
                html += '<option value="Yes">Yes - Incubated 35¬∞C for 24h</option>';
                html += '<option value="No">No - Not incubated</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="salm_temperature">';
                html += '<option value="35">35¬∞C</option>';
                html += '<option value="37">37¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="salm_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="salm_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_RVR_LAMP') {
                html += '<div class="form-group">';
                html += '<label>RVR Lot #:</label>';
                html += '<input type="text" id="salm_rvrLot" placeholder="LOT-RVR-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>LAMP Result:</label>';
                html += '<select id="salm_lampResult">';
                html += '<option value="Positive">Positive - Presumptive Salmonella</option>';
                html += '<option value="Negative">Negative - No Salmonella</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="salm_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="salm_temperature">';
                html += '<option value="42">42¬∞C</option>';
                html += '<option value="37">37¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="salm_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="salm_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="salm_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day3_XLT4') {
                html += '<div class="form-group">';
                html += '<label>XLT4 Plate Lot #:</label>';
                html += '<input type="text" id="salm_xlt4Lot" placeholder="LOT-XLT4-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies Present?</label>';
                html += '<select id="salm_typicalColonies">';
                html += '<option value="Yes">Yes - Black centers</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="salm_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="salm_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="salm_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="salm_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="salm_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="salm_maldiSpecies" placeholder="e.g., Salmonella enterica" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="salm_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Salmonella?</label>';
                html += '<select id="salm_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate</option>';
                html += '<option value="No">No - Not Salmonella</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="salm_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeSalmonellaStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeSalmonellaWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeSalmonellaWorkflowModal() {
            var modal = document.getElementById('salmonellaWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentSalmonellaWorkflow = null;
            currentSalmonellaStage = null;
        }

        function completeSalmonellaStage() {
            if (!currentSalmonellaWorkflow || !currentSalmonellaStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('salm_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentSalmonellaStage === 'day1_BPWIncubation') {
                stageData.bpwIncubated = document.getElementById('salm_bpwIncubated').value;
                stageData.temperature = document.getElementById('salm_temperature').value;
                stageData.incubator = document.getElementById('salm_incubator').value;
            } else if (currentSalmonellaStage === 'day2_RVR_LAMP') {
                stageData.rvrLot = document.getElementById('salm_rvrLot').value;
                stageData.lampResult = document.getElementById('salm_lampResult').value;
                stageData.temperature = document.getElementById('salm_temperature').value;
                stageData.incubator = document.getElementById('salm_incubator').value;
                stageData.timeIn = document.getElementById('salm_timeIn').value;
                stageData.timeOut = document.getElementById('salm_timeOut').value;
            } else if (currentSalmonellaStage === 'day3_XLT4') {
                stageData.xlt4Lot = document.getElementById('salm_xlt4Lot').value;
                stageData.typicalColonies = document.getElementById('salm_typicalColonies').value;
                stageData.temperature = document.getElementById('salm_temperature').value;
                stageData.incubator = document.getElementById('salm_incubator').value;
                stageData.timeIn = document.getElementById('salm_timeIn').value;
                stageData.timeOut = document.getElementById('salm_timeOut').value;
            } else if (currentSalmonellaStage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('salm_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('salm_maldiConfidence').value;
                stageData.confirmed = document.getElementById('salm_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentSalmonellaWorkflow.stages[currentSalmonellaStage] = stageData;

            if (currentSalmonellaStage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentSalmonellaWorkflow, stageData.maldiSpecies);
            }

            saveData();
            closeSalmonellaWorkflowModal();
            showSuccessNotification('Salmonella stage completed!');
            renderSalmonellaTab();
        }

        // Enterococcus Workflow Modal Functions
        var currentEnterococcusWorkflow = null;
        var currentEnterococcusStage = null;

        function openEnterococcusWorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentEnterococcusWorkflow = workflow;
            currentEnterococcusStage = stageKey;

            var modal = document.getElementById('enterococcusWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'enterococcusWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeEnterococcusWorkflowModal()">&times;</span>';

            var stageTitle = '';
            if (stageKey === 'day1A_BPWPrep') stageTitle = 'üíß Day 1A - BPW Sample Prep';
            else if (stageKey === 'day2_Enterococcosel') stageTitle = 'üü† Day 2 - Enterococcosel Agar';
            else if (stageKey === 'day3_BHI') stageTitle = 'üß™ Day 3 - BHI Broth Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = '‚úÖ Day 4 - MALDI Identification';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong></p>';

            if (stageKey === 'day1A_BPWPrep') {
                html += '<div class="form-group">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="entero_bpwLot" placeholder="LOT-BPW-2025-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="entero_sampleWeight" value="50" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="entero_bpwVolume" value="250" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Stomach Time (min):</label>';
                html += '<input type="number" id="entero_stomachTime" value="2" step="0.5" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Volume Pulled for Enterococcus (ml):</label>';
                html += '<input type="number" id="entero_volumePulled" value="50" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="entero_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_Enterococcosel') {
                html += '<div class="form-group">';
                html += '<label>Enterococcosel Plate Lot #:</label>';
                html += '<input type="text" id="entero_plateLot" placeholder="LOT-ENT-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies Present?</label>';
                html += '<select id="entero_typicalColonies">';
                html += '<option value="Yes">Yes - Dark red/maroon colonies</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="entero_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="entero_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="entero_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="entero_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="entero_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day3_BHI') {
                html += '<div class="form-group">';
                html += '<label>BHI Broth Lot #:</label>';
                html += '<input type="text" id="entero_bhiLot" placeholder="LOT-BHI-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Growth in BHI?</label>';
                html += '<select id="entero_bhiGrowth">';
                html += '<option value="Yes">Yes - Turbid growth</option>';
                html += '<option value="No">No - No growth</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="entero_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="entero_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="entero_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> Enterococcus isolates are report-only and will NOT be automatically sent to sequencing.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="entero_maldiSpecies" placeholder="e.g., Enterococcus faecalis" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="entero_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Enterococcus?</label>';
                html += '<select id="entero_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate (Report Only)</option>';
                html += '<option value="No">No - Not Enterococcus</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="entero_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeEnterococcusStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeEnterococcusWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeEnterococcusWorkflowModal() {
            var modal = document.getElementById('enterococcusWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeEnterococcusStage() {
            if (!currentEnterococcusWorkflow || !currentEnterococcusStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('entero_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentEnterococcusStage === 'day1A_BPWPrep') {
                stageData.bpwLot = document.getElementById('entero_bpwLot').value;
                stageData.sampleWeight = document.getElementById('entero_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('entero_bpwVolume').value;
                stageData.stomachTime = document.getElementById('entero_stomachTime').value;
                stageData.volumePulled = document.getElementById('entero_volumePulled').value;
            } else if (currentEnterococcusStage === 'day2_Enterococcosel') {
                stageData.plateLot = document.getElementById('entero_plateLot').value;
                stageData.typicalColonies = document.getElementById('entero_typicalColonies').value;
                stageData.temperature = document.getElementById('entero_temperature').value;
                stageData.incubator = document.getElementById('entero_incubator').value;
                stageData.timeIn = document.getElementById('entero_timeIn').value;
                stageData.timeOut = document.getElementById('entero_timeOut').value;
            } else if (currentEnterococcusStage === 'day3_BHI') {
                stageData.bhiLot = document.getElementById('entero_bhiLot').value;
                stageData.bhiGrowth = document.getElementById('entero_bhiGrowth').value;
                stageData.temperature = document.getElementById('entero_temperature').value;
                stageData.incubator = document.getElementById('entero_incubator').value;
            } else if (currentEnterococcusStage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('entero_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('entero_maldiConfidence').value;
                stageData.confirmed = document.getElementById('entero_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentEnterococcusWorkflow.stages[currentEnterococcusStage] = stageData;

            // Generate isolate if confirmed (but don't auto-send to sequencing)
            if (currentEnterococcusStage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentEnterococcusWorkflow, stageData.maldiSpecies);
                showSuccessNotification('Enterococcus isolate generated! (Report only - not sent to sequencing)');
            }

            saveData();
            closeEnterococcusWorkflowModal();
            showSuccessNotification('Enterococcus stage completed!');
            renderEnterococcusTab();
        }

        // Enterococcus SEAFOOD Workflow Modal Functions
        var currentEnterococcusSeafoodWorkflow = null;
        var currentEnterococcusSeafoodStage = null;

        function openEnterococcusSeafoodWorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentEnterococcusSeafoodWorkflow = workflow;
            currentEnterococcusSeafoodStage = stageKey;

            var modal = document.getElementById('enterococcusSeafoodWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'enterococcusSeafoodWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeEnterococcusSeafoodWorkflowModal()">&times;</span>';

            var stageTitle = '';
            if (stageKey === 'day1_BPWIncubation') stageTitle = 'üíß Day 1 - BPW Incubation (Seafood)';
            else if (stageKey === 'day2_BileEsculin') stageTitle = 'üü£ Day 2 - Bile Esculin Agar';
            else if (stageKey === 'day3_BHI') stageTitle = 'üß™ Day 3 - BHI Broth Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = '‚úÖ Day 4 - MALDI Identification';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong> (Seafood)</p>';

            if (stageKey === 'day1_BPWIncubation') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Seafood Protocol:</strong> 25g sample + 225ml BPW (different from retail meat!)';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="enteroSF_bpwLot" placeholder="LOT-BPW-2025-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="enteroSF_sampleWeight" value="25" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="enteroSF_bpwVolume" value="225" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="enteroSF_temperature">';
                html += '<option value="35">35¬∞C</option>';
                html += '<option value="37">37¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="enteroSF_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="enteroSF_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_BileEsculin') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Seafood Protocol:</strong> Pull loopful directly from BPW bag and streak onto Bile Esculin Agar';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Bile Esculin Plate Lot #:</label>';
                html += '<input type="text" id="enteroSF_plateLot" placeholder="LOT-BE-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies Present?</label>';
                html += '<select id="enteroSF_typicalColonies">';
                html += '<option value="Yes">Yes - Purple/black colonies</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="enteroSF_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="enteroSF_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="enteroSF_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="enteroSF_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="enteroSF_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day3_BHI') {
                html += '<div class="form-group">';
                html += '<label>BHI Broth Lot #:</label>';
                html += '<input type="text" id="enteroSF_bhiLot" placeholder="LOT-BHI-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Growth in BHI?</label>';
                html += '<select id="enteroSF_bhiGrowth">';
                html += '<option value="Yes">Yes - Turbid growth</option>';
                html += '<option value="No">No - No growth</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="enteroSF_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="enteroSF_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="enteroSF_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> Enterococcus isolates are report-only and will NOT be automatically sent to sequencing.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="enteroSF_maldiSpecies" placeholder="e.g., Enterococcus faecalis" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="enteroSF_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Enterococcus?</label>';
                html += '<select id="enteroSF_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate (Report Only)</option>';
                html += '<option value="No">No - Not Enterococcus</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="enteroSF_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeEnterococcusSeafoodStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeEnterococcusSeafoodWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeEnterococcusSeafoodWorkflowModal() {
            var modal = document.getElementById('enterococcusSeafoodWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeEnterococcusSeafoodStage() {
            if (!currentEnterococcusSeafoodWorkflow || !currentEnterococcusSeafoodStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('enteroSF_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentEnterococcusSeafoodStage === 'day1_BPWIncubation') {
                stageData.bpwLot = document.getElementById('enteroSF_bpwLot').value;
                stageData.sampleWeight = document.getElementById('enteroSF_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('enteroSF_bpwVolume').value;
                stageData.temperature = document.getElementById('enteroSF_temperature').value;
                stageData.incubator = document.getElementById('enteroSF_incubator').value;
            } else if (currentEnterococcusSeafoodStage === 'day2_BileEsculin') {
                stageData.plateLot = document.getElementById('enteroSF_plateLot').value;
                stageData.typicalColonies = document.getElementById('enteroSF_typicalColonies').value;
                stageData.temperature = document.getElementById('enteroSF_temperature').value;
                stageData.incubator = document.getElementById('enteroSF_incubator').value;
                stageData.timeIn = document.getElementById('enteroSF_timeIn').value;
                stageData.timeOut = document.getElementById('enteroSF_timeOut').value;
            } else if (currentEnterococcusSeafoodStage === 'day3_BHI') {
                stageData.bhiLot = document.getElementById('enteroSF_bhiLot').value;
                stageData.bhiGrowth = document.getElementById('enteroSF_bhiGrowth').value;
                stageData.temperature = document.getElementById('enteroSF_temperature').value;
                stageData.incubator = document.getElementById('enteroSF_incubator').value;
            } else if (currentEnterococcusSeafoodStage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('enteroSF_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('enteroSF_maldiConfidence').value;
                stageData.confirmed = document.getElementById('enteroSF_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentEnterococcusSeafoodWorkflow.stages[currentEnterococcusSeafoodStage] = stageData;

            // Generate isolate if confirmed (but don't auto-send to sequencing)
            if (currentEnterococcusSeafoodStage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentEnterococcusSeafoodWorkflow, stageData.maldiSpecies);
                showSuccessNotification('Enterococcus isolate generated! (Report only - not sent to sequencing)');
            }

            saveData();
            closeEnterococcusSeafoodWorkflowModal();
            showSuccessNotification('Enterococcus seafood stage completed!');
            renderEnterococcusTab();
        }

        // Aeromonas Workflow Modal Functions
        var currentAeromonasWorkflow = null;
        var currentAeromonasStage = null;

        function openAeromonasWorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentAeromonasWorkflow = workflow;
            currentAeromonasStage = stageKey;

            var modal = document.getElementById('aeromonasWorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'aeromonasWorkflowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            var html = '';
            html += '<div class="modal-content" style="max-width: 600px;">';
            html += '<span class="close-btn" onclick="closeAeromonasWorkflowModal()">&times;</span>';

            var stageTitle = '';
            if (stageKey === 'day1_BPWIncubation') stageTitle = 'üíß Day 1 - BPW Incubation (Seafood)';
            else if (stageKey === 'day2_AeromonasMedium') stageTitle = 'üü° Day 2 - Aeromonas Medium';
            else if (stageKey === 'day3_BAP') stageTitle = 'üß´ Day 3 - BAP Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = '‚úÖ Day 4 - MALDI Identification';

            html += '<h3 style="margin-top: 0;">' + stageTitle + '</h3>';
            html += '<p>Sample: <strong>' + workflow.foodSampleId + '</strong> (Seafood - Aeromonas)</p>';

            if (stageKey === 'day1_BPWIncubation') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Seafood Protocol:</strong> 25g sample + 225ml BPW';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Lot #:</label>';
                html += '<input type="text" id="aero_bpwLot" placeholder="LOT-BPW-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="number" id="aero_sampleWeight" value="25" step="0.1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BPW Volume (ml):</label>';
                html += '<input type="number" id="aero_bpwVolume" value="225" step="1" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="aero_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="aero_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="aero_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_AeromonasMedium') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Protocol:</strong> Pull loopful directly from BPW bag and streak onto Aeromonas medium';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Aeromonas Medium Plate Lot #:</label>';
                html += '<input type="text" id="aero_plateLot" placeholder="LOT-AERO-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies Present?</label>';
                html += '<select id="aero_typicalColonies">';
                html += '<option value="Yes">Yes - Yellow colonies</option>';
                html += '<option value="No">No - Negative</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="aero_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="aero_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="aero_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="aero_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="aero_timeOut" />';
                html += '</div>';

            } else if (stageKey === 'day3_BAP') {
                html += '<div class="form-group">';
                html += '<label>BAP Plate Lot #:</label>';
                html += '<input type="text" id="aero_bapLot" placeholder="LOT-BAP-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Growth?</label>';
                html += '<select id="aero_typicalGrowth">';
                html += '<option value="Yes">Yes - Typical growth</option>';
                html += '<option value="No">No - No growth</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="aero_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="aero_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="aero_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Note:</strong> Aeromonas isolates are report-only and will NOT be automatically sent to sequencing.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="aero_maldiSpecies" placeholder="e.g., Aeromonas hydrophila" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="aero_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Aeromonas?</label>';
                html += '<select id="aero_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate (Report Only)</option>';
                html += '<option value="No">No - Not Aeromonas</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="aero_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeAeromonasStage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeAeromonasWorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeAeromonasWorkflowModal() {
            var modal = document.getElementById('aeromonasWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeAeromonasStage() {
            if (!currentAeromonasWorkflow || !currentAeromonasStage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('aero_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentAeromonasStage === 'day1_BPWIncubation') {
                stageData.bpwLot = document.getElementById('aero_bpwLot').value;
                stageData.sampleWeight = document.getElementById('aero_sampleWeight').value;
                stageData.bpwVolume = document.getElementById('aero_bpwVolume').value;
                stageData.temperature = document.getElementById('aero_temperature').value;
                stageData.incubator = document.getElementById('aero_incubator').value;
            } else if (currentAeromonasStage === 'day2_AeromonasMedium') {
                stageData.plateLot = document.getElementById('aero_plateLot').value;
                stageData.typicalColonies = document.getElementById('aero_typicalColonies').value;
                stageData.temperature = document.getElementById('aero_temperature').value;
                stageData.incubator = document.getElementById('aero_incubator').value;
                stageData.timeIn = document.getElementById('aero_timeIn').value;
                stageData.timeOut = document.getElementById('aero_timeOut').value;
            } else if (currentAeromonasStage === 'day3_BAP') {
                stageData.bapLot = document.getElementById('aero_bapLot').value;
                stageData.typicalGrowth = document.getElementById('aero_typicalGrowth').value;
                stageData.temperature = document.getElementById('aero_temperature').value;
                stageData.incubator = document.getElementById('aero_incubator').value;
            } else if (currentAeromonasStage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('aero_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('aero_maldiConfidence').value;
                stageData.confirmed = document.getElementById('aero_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentAeromonasWorkflow.stages[currentAeromonasStage] = stageData;

            // Generate isolate if confirmed (but don't auto-send to sequencing - report only)
            if (currentAeromonasStage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentAeromonasWorkflow, stageData.maldiSpecies);
                showSuccessNotification('Aeromonas isolate generated! (Report only - not sent to sequencing)');
            }

            saveData();
            closeAeromonasWorkflowModal();
            showSuccessNotification('Aeromonas stage completed!');
            renderAeromonasTab();
        }

        // ========== VIBRIO V1 WORKFLOW MODAL FUNCTIONS ==========
        var currentVibrioV1Workflow = null;
        var currentVibrioV1Stage = null;

        function openVibrioV1WorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentVibrioV1Workflow = workflow;
            currentVibrioV1Stage = stageKey;

            var modal = document.getElementById('vibrioV1WorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'vibrioV1WorkflowModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                document.body.appendChild(modal);
            }

            var foodSample = foodSamples.find(function(fs) {
                return fs.id === workflow.foodSampleId;
            });
            var sampleName = foodSample ? foodSample.sampleId : workflow.foodSampleId;

            var html = '';
            html += '<div style="background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">';
            html += '<h3 style="margin-top: 0; color: #00bcd4; border-bottom: 3px solid #00bcd4; padding-bottom: 10px;">Vibrio V1 - ' + sampleName + '</h3>';

            var stageTitle = '';
            if (stageKey === 'day1_APW') stageTitle = 'Day 1 - APW Incubation';
            else if (stageKey === 'day2_TCBS') stageTitle = 'Day 2 - TCBS Agar';
            else if (stageKey === 'day3_BAP') stageTitle = 'Day 3 - BAP Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = 'Day 4 - MALDI Identification';

            html += '<h4 style="color: #555; margin-bottom: 20px;">' + stageTitle + '</h4>';

            if (stageKey === 'day1_APW') {
                html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Seafood Protocol:</strong> 25g sample + 225ml APW (Alkaline Peptone Water)<br>';
                html += '<strong>‚è±Ô∏è Incubation:</strong> 37¬∞C for 6-8 hours (shorter than BPW!)';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>APW Lot #:</label>';
                html += '<input type="text" id="v1_apwLot" placeholder="LOT-APW-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="text" id="v1_sampleWeight" value="25" placeholder="25g" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>APW Volume (ml):</label>';
                html += '<input type="text" id="v1_apwVolume" value="225" placeholder="225ml" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v1_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v1_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v1_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_TCBS') {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Protocol:</strong> Pull loopful directly from APW bag and streak onto TCBS (Thiosulfate-citrate-bile salts-sucrose) agar<br>';
                html += '<strong>üü¢ Look for:</strong> Yellow or green colonies';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>TCBS Plate Lot #:</label>';
                html += '<input type="text" id="v1_plateLot" placeholder="LOT-TCBS-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies (Yellow/Green)?</label>';
                html += '<select id="v1_typicalColonies">';
                html += '<option value="Yes">Yes - Yellow or green colonies present</option>';
                html += '<option value="No">No - No typical colonies</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v1_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v1_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="v1_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="v1_timeOut" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v1_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day3_BAP') {
                html += '<div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Protocol:</strong> Pick colonies from TCBS and confirm on BAP (Blood Agar Plate)<br>';
                html += '<strong>Note:</strong> If different color colonies observed (yellow vs. green), pick both types';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BAP Plate Lot #:</label>';
                html += '<input type="text" id="v1_bapLot" placeholder="LOT-BAP-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Growth?</label>';
                html += '<select id="v1_typicalGrowth">';
                html += '<option value="Yes">Yes - Typical growth</option>';
                html += '<option value="No">No - No growth</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v1_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v1_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v1_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div style="background: #e1f5fe; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚úÖ Auto-Sequencing:</strong> Vibrio V1 isolates will be automatically sent to sequencing upon confirmation.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="v1_maldiSpecies" placeholder="e.g., Vibrio parahaemolyticus" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="v1_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Vibrio?</label>';
                html += '<select id="v1_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate & Send to Sequencing</option>';
                html += '<option value="No">No - Not Vibrio</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v1_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeVibrioV1Stage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeVibrioV1WorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeVibrioV1WorkflowModal() {
            var modal = document.getElementById('vibrioV1WorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeVibrioV1Stage() {
            if (!currentVibrioV1Workflow || !currentVibrioV1Stage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('v1_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentVibrioV1Stage === 'day1_APW') {
                stageData.apwLot = document.getElementById('v1_apwLot').value;
                stageData.sampleWeight = document.getElementById('v1_sampleWeight').value;
                stageData.apwVolume = document.getElementById('v1_apwVolume').value;
                stageData.temperature = document.getElementById('v1_temperature').value;
                stageData.incubator = document.getElementById('v1_incubator').value;
            } else if (currentVibrioV1Stage === 'day2_TCBS') {
                stageData.plateLot = document.getElementById('v1_plateLot').value;
                stageData.typicalColonies = document.getElementById('v1_typicalColonies').value;
                stageData.temperature = document.getElementById('v1_temperature').value;
                stageData.incubator = document.getElementById('v1_incubator').value;
                stageData.timeIn = document.getElementById('v1_timeIn').value;
                stageData.timeOut = document.getElementById('v1_timeOut').value;
            } else if (currentVibrioV1Stage === 'day3_BAP') {
                stageData.bapLot = document.getElementById('v1_bapLot').value;
                stageData.typicalGrowth = document.getElementById('v1_typicalGrowth').value;
                stageData.temperature = document.getElementById('v1_temperature').value;
                stageData.incubator = document.getElementById('v1_incubator').value;
            } else if (currentVibrioV1Stage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('v1_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('v1_maldiConfidence').value;
                stageData.confirmed = document.getElementById('v1_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentVibrioV1Workflow.stages[currentVibrioV1Stage] = stageData;

            // Generate isolate if confirmed AND auto-send to sequencing
            if (currentVibrioV1Stage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentVibrioV1Workflow, stageData.maldiSpecies);
                // V1 auto-sequences (unlike Aeromonas)
                autoSendToSequencing(currentVibrioV1Workflow.foodSampleId + '-V1');
                showSuccessNotification('Vibrio V1 isolate generated and sent to sequencing!');
            }

            saveData();
            closeVibrioV1WorkflowModal();
            showSuccessNotification('Vibrio V1 stage completed!');
            renderVibrioV1Tab();
        }

        // ========== VIBRIO V2 WORKFLOW MODAL FUNCTIONS ==========
        var currentVibrioV2Workflow = null;
        var currentVibrioV2Stage = null;

        function openVibrioV2WorkflowModal(workflowId, stageKey) {
            var workflow = pathogenWorkflows.find(function(wf) {
                return wf.id === workflowId;
            });

            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            currentVibrioV2Workflow = workflow;
            currentVibrioV2Stage = stageKey;

            var modal = document.getElementById('vibrioV2WorkflowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'vibrioV2WorkflowModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                document.body.appendChild(modal);
            }

            var foodSample = foodSamples.find(function(fs) {
                return fs.id === workflow.foodSampleId;
            });
            var sampleName = foodSample ? foodSample.sampleId : workflow.foodSampleId;

            var html = '';
            html += '<div style="background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">';
            html += '<h3 style="margin-top: 0; color: #9c27b0; border-bottom: 3px solid #9c27b0; padding-bottom: 10px;">Vibrio parahaemolyticus V2 - ' + sampleName + '</h3>';

            var stageTitle = '';
            if (stageKey === 'day1_APW') stageTitle = 'Day 1 - APW Incubation';
            else if (stageKey === 'day2_CHROMagar') stageTitle = 'Day 2 - CHROMagar';
            else if (stageKey === 'day3_BAP') stageTitle = 'Day 3 - BAP Confirmation';
            else if (stageKey === 'day4_MALDI') stageTitle = 'Day 4 - MALDI Identification';

            html += '<h4 style="color: #555; margin-bottom: 20px;">' + stageTitle + '</h4>';

            if (stageKey === 'day1_APW') {
                html += '<div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Seafood Protocol:</strong> 25g sample + 225ml APW (Alkaline Peptone Water)<br>';
                html += '<strong>‚è±Ô∏è Incubation:</strong> 37¬∞C for 6-8 hours (shorter than BPW!)';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>APW Lot #:</label>';
                html += '<input type="text" id="v2_apwLot" placeholder="LOT-APW-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Sample Weight (g):</label>';
                html += '<input type="text" id="v2_sampleWeight" value="25" placeholder="25g" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>APW Volume (ml):</label>';
                html += '<input type="text" id="v2_apwVolume" value="225" placeholder="225ml" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v2_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v2_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v2_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day2_CHROMagar') {
                html += '<div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è Protocol:</strong> Pull loopful directly from APW bag and streak onto CHROMagar Vibrio<br>';
                html += '<strong>üü£ Look for:</strong> Mauve (purple) colonies characteristic of V. parahaemolyticus';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>CHROMagar Plate Lot #:</label>';
                html += '<input type="text" id="v2_plateLot" placeholder="LOT-CHR-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Colonies (Mauve)?</label>';
                html += '<select id="v2_typicalColonies">';
                html += '<option value="Yes">Yes - Mauve colonies present</option>';
                html += '<option value="No">No - No typical colonies</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v2_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v2_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time In:</label>';
                html += '<input type="time" id="v2_timeIn" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Time Out:</label>';
                html += '<input type="time" id="v2_timeOut" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v2_techInitials" maxlength="3" />';
                html += '</div>';

            } else if (stageKey === 'day3_BAP') {
                html += '<div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚ÑπÔ∏è Protocol:</strong> Pick mauve colonies from CHROMagar and confirm on BAP (Blood Agar Plate)';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>BAP Plate Lot #:</label>';
                html += '<input type="text" id="v2_bapLot" placeholder="LOT-BAP-001" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Typical Growth?</label>';
                html += '<select id="v2_typicalGrowth">';
                html += '<option value="Yes">Yes - Typical growth</option>';
                html += '<option value="No">No - No growth</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v2_techInitials" maxlength="3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Temperature:</label>';
                html += '<select id="v2_temperature">';
                html += '<option value="37">37¬∞C</option>';
                html += '<option value="35">35¬∞C</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Incubator:</label>';
                html += '<select id="v2_incubator">';
                html += '<option value="INC-1">Incubator 1</option>';
                html += '<option value="INC-2">Incubator 2</option>';
                html += '<option value="INC-3">Incubator 3</option>';
                html += '</select>';
                html += '</div>';

            } else if (stageKey === 'day4_MALDI') {
                html += '<div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                html += '<strong>‚úÖ Auto-Sequencing:</strong> Vibrio V2 isolates will be automatically sent to sequencing upon confirmation.';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>MALDI Species ID:</label>';
                html += '<input type="text" id="v2_maldiSpecies" placeholder="e.g., Vibrio parahaemolyticus" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confidence Score:</label>';
                html += '<input type="text" id="v2_maldiConfidence" placeholder="e.g., 2.3" />';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Confirmed as Vibrio parahaemolyticus?</label>';
                html += '<select id="v2_confirmed">';
                html += '<option value="Yes">Yes - Generate Isolate & Send to Sequencing</option>';
                html += '<option value="No">No - Not V. parahaemolyticus</option>';
                html += '</select>';
                html += '</div>';

                html += '<div class="form-group">';
                html += '<label>Technician Initials:</label>';
                html += '<input type="text" id="v2_techInitials" maxlength="3" />';
                html += '</div>';
            }

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button onclick="completeVibrioV2Stage()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úì Complete Stage</button>';
            html += '<button onclick="closeVibrioV2WorkflowModal()" style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeVibrioV2WorkflowModal() {
            var modal = document.getElementById('vibrioV2WorkflowModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function completeVibrioV2Stage() {
            if (!currentVibrioV2Workflow || !currentVibrioV2Stage) {
                alert('No workflow selected');
                return;
            }

            var stageData = {};
            var techInitials = document.getElementById('v2_techInitials');
            if (techInitials) stageData.techInitials = techInitials.value;

            if (currentVibrioV2Stage === 'day1_APW') {
                stageData.apwLot = document.getElementById('v2_apwLot').value;
                stageData.sampleWeight = document.getElementById('v2_sampleWeight').value;
                stageData.apwVolume = document.getElementById('v2_apwVolume').value;
                stageData.temperature = document.getElementById('v2_temperature').value;
                stageData.incubator = document.getElementById('v2_incubator').value;
            } else if (currentVibrioV2Stage === 'day2_CHROMagar') {
                stageData.plateLot = document.getElementById('v2_plateLot').value;
                stageData.typicalColonies = document.getElementById('v2_typicalColonies').value;
                stageData.temperature = document.getElementById('v2_temperature').value;
                stageData.incubator = document.getElementById('v2_incubator').value;
                stageData.timeIn = document.getElementById('v2_timeIn').value;
                stageData.timeOut = document.getElementById('v2_timeOut').value;
            } else if (currentVibrioV2Stage === 'day3_BAP') {
                stageData.bapLot = document.getElementById('v2_bapLot').value;
                stageData.typicalGrowth = document.getElementById('v2_typicalGrowth').value;
                stageData.temperature = document.getElementById('v2_temperature').value;
                stageData.incubator = document.getElementById('v2_incubator').value;
            } else if (currentVibrioV2Stage === 'day4_MALDI') {
                stageData.maldiSpecies = document.getElementById('v2_maldiSpecies').value;
                stageData.maldiConfidence = document.getElementById('v2_maldiConfidence').value;
                stageData.confirmed = document.getElementById('v2_confirmed').value;
            }

            stageData.completedDate = new Date().toISOString().split('T')[0];
            stageData.completed = true;

            currentVibrioV2Workflow.stages[currentVibrioV2Stage] = stageData;

            // Generate isolate if confirmed AND auto-send to sequencing
            if (currentVibrioV2Stage === 'day4_MALDI' && stageData.confirmed === 'Yes') {
                generateIsolate(currentVibrioV2Workflow, stageData.maldiSpecies);
                // V2 auto-sequences (unlike Aeromonas)
                autoSendToSequencing(currentVibrioV2Workflow.foodSampleId + '-V2');
                showSuccessNotification('Vibrio V2 isolate generated and sent to sequencing!');
            }

            saveData();
            closeVibrioV2WorkflowModal();
            showSuccessNotification('Vibrio V2 stage completed!');
            renderVibrioV1Tab();
        }

        // Generate Isolate and send to sequencing
        function generateIsolate(workflow, species) {
            var isolateId = workflow.foodSampleId + '-' + workflow.pathogenCode;

            var isolate = {
                id: isolateId,
                foodSampleId: workflow.foodSampleId,
                pathogenCode: workflow.pathogenCode,
                species: species,
                dateGenerated: new Date().toISOString().split('T')[0],
                sentToSequencing: false,
                sequencingSampleId: null
            };

            isolates.push(isolate);

            // Mark workflow as complete
            workflow.isolateGenerated = true;
            workflow.isolateId = isolateId;

            // Auto-send to sequencing if EC, C1, or S1
            if (workflow.pathogenCode === 'EC' || workflow.pathogenCode === 'C1' || workflow.pathogenCode === 'S1') {
                sendIsolateToSequencing(isolate);
            }
        }

        // Send isolate to sequencing module
        function sendIsolateToSequencing(isolate) {
            // Create a new sample in the sequencing module
            var seqSample = {
                id: isolate.id,
                dateAdded: isolate.dateGenerated,
                initials: 'AUTO',
                status: 'Received',
                sourceType: 'Food Testing Isolate',
                foodSampleId: isolate.foodSampleId,
                pathogen: isolate.pathogenCode,
                species: isolate.species
            };

            samples.push(seqSample);

            // Mark isolate as sent
            isolate.sentToSequencing = true;
            isolate.sequencingSampleId = isolate.id;

            showSuccessNotification('Isolate ' + isolate.id + ' automatically sent to sequencing!');
        }

        // Scroll to Section
        function scrollToSection(sectionId) {
            if (sectionId === 'samples') {
                document.querySelector('.sample-list').scrollIntoView({ behavior: 'smooth' });
            } else if (sectionId === 'addSamples') {
                document.querySelector('.add-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Toggle Filters
        function toggleFilters() {
            var filtersDiv = document.getElementById('advancedFilters');
            var btn = document.getElementById('toggleFiltersBtn');

            if (filtersDiv.style.display === 'none' || filtersDiv.style.display === '') {
                filtersDiv.style.display = 'block';
                btn.innerHTML = '‚öôÔ∏è Hide Filters';
                btn.style.background = '#28a745';
            } else {
                filtersDiv.style.display = 'none';
                btn.innerHTML = '‚öôÔ∏è Show Filters';
                btn.style.background = '#6c757d';
            }
        }

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('bacterialAuthenticated');
                location.reload();
            }
        }

        function toggleDarkMode() {
            var currentTheme = document.documentElement.getAttribute('data-theme');
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);

            // Update sidebar theme icon and text
            var themeIcon = document.getElementById('themeIcon');
            var themeText = document.getElementById('themeText');

            if (newTheme === 'dark') {
                if (themeIcon) themeIcon.innerHTML = '‚òÄÔ∏è';
                if (themeText) themeText.innerHTML = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                if (themeIcon) themeIcon.innerHTML = 'üåô';
                if (themeText) themeText.innerHTML = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            var button = document.getElementById('darkModeToggle');
            if (button) {
                if (savedTheme === 'dark') {
                    button.innerHTML = '‚òÄÔ∏è Light Mode';
                } else {
                    button.innerHTML = 'üåô Dark Mode';
                }
            }
        }

        var bulkSelectedSamples = [];
        var currentQRSampleId = null;

        function showQRCode(sampleId) {
            currentQRSampleId = sampleId;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            // Generate QR code data (JSON format for comprehensive info)
            var qrData = {
                id: sample.id,
                status: sample.status,
                added: sample.dateAdded,
                initials: sample.initials
            };

            // Add BAP number if exists
            if (sample.bapNumber) {
                qrData.bap = sample.bapNumber;
            }

            var qrDataString = JSON.stringify(qrData);

            // Generate QR code using Google Charts API
            var qrSize = 300;
            var qrCodeURL = 'https://chart.googleapis.com/chart?cht=qr&chs=' + qrSize + 'x' + qrSize + '&chl=' + encodeURIComponent(qrDataString);

            // Display QR code
            var qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '<img src="' + qrCodeURL + '" alt="QR Code for ' + sample.id + '" style="max-width: 100%; border: 2px solid var(--border-color); border-radius: 8px;">';

            // Display sample info
            var infoContainer = document.getElementById('qrSampleInfo');
            var html = '<h4 style="margin-top: 0;">' + sample.id + '</h4>';
            html += '<p><strong>Status:</strong> ' + sample.status + '</p>';
            html += '<p><strong>Added:</strong> ' + sample.dateAdded + '</p>';
            html += '<p><strong>Technician:</strong> ' + sample.initials + '</p>';
            if (sample.bapNumber) {
                html += '<p><strong>BAP #:</strong> ' + sample.bapNumber + '</p>';
            }
            if (sample.notes) {
                html += '<p><strong>Notes:</strong> ' + sample.notes + '</p>';
            }
            infoContainer.innerHTML = html;

            // Show modal
            document.getElementById('qrCodeModal').style.display = 'block';
        }

        function closeQRCodeModal() {
            document.getElementById('qrCodeModal').style.display = 'none';
            currentQRSampleId = null;
        }

        function printQRCode() {
            var modal = document.getElementById('qrCodeModal');
            var qrContainer = document.getElementById('qrCodeContainer').innerHTML;
            var sampleInfo = document.getElementById('qrSampleInfo').innerHTML;

            // Open print window with QR code
            var printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write('<html><head><title>QR Code Label - ' + currentQRSampleId + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }');
            printWindow.document.write('h2 { margin: 10px 0; }');
            printWindow.document.write('.label { border: 2px solid #000; padding: 20px; display: inline-block; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="label">');
            printWindow.document.write('<h2>Bacterial Isolation Sample</h2>');
            printWindow.document.write(qrContainer);
            printWindow.document.write(sampleInfo);
            printWindow.document.write('<p style="margin-top: 20px; font-size: 12px; color: #666;">Scan QR code to view sample details</p>');
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait a bit for images to load then print
            setTimeout(function() {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Batch Print Labels Feature
        function showPrintLabels() {
            var modal = document.getElementById('printLabelsModal');
            modal.style.display = 'block';
            updateLabelPreview();
            closeSidebar();
        }

        function closePrintLabelsModal() {
            var modal = document.getElementById('printLabelsModal');
            modal.style.display = 'none';
        }

        function updateLabelPreview() {
            var filterStatus = document.getElementById('labelFilterStatus').value;
            var includeQR = document.getElementById('includeQR').checked;
            var includeDate = document.getElementById('includeDate').checked;
            var includeStatus = document.getElementById('includeStatus').checked;
            var labelSize = document.getElementById('labelSize').value;

            // Filter samples
            var filteredSamples = samples.filter(function(s) {
                return filterStatus === 'all' || s.status === filterStatus;
            });

            // Update count
            document.getElementById('labelCount').textContent = filteredSamples.length;

            // Generate preview
            var container = document.getElementById('labelPreviewContainer');
            container.innerHTML = '';

            if (filteredSamples.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No samples match the selected filter</div>';
                return;
            }

            filteredSamples.forEach(function(sample) {
                var labelDiv = document.createElement('div');
                labelDiv.className = 'print-label-preview';
                labelDiv.style.cssText = 'border: 2px dashed #ccc; padding: 15px; background: white; border-radius: 8px;';

                var html = '<div style="text-align: center;">';
                html += '<div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">' + sample.id + '</div>';

                if (includeQR) {
                    html += '<div style="margin: 10px 0;"><canvas id="qr-preview-' + sample.id.replace(/[^a-zA-Z0-9]/g, '_') + '" style="width: 80px; height: 80px;"></canvas></div>';
                }

                if (includeDate) {
                    html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">Added: ' + sample.dateAdded + '</div>';
                }

                if (includeStatus) {
                    html += '<div style="font-size: 11px; color: #666; margin-top: 3px;">Status: ' + sample.status + '</div>';
                }

                html += '</div>';
                labelDiv.innerHTML = html;
                container.appendChild(labelDiv);

                // Generate QR code if enabled
                if (includeQR) {
                    setTimeout(function() {
                        var canvas = document.getElementById('qr-preview-' + sample.id.replace(/[^a-zA-Z0-9]/g, '_'));
                        if (canvas) {
                            try {
                                QRCode.toCanvas(canvas, sample.id, {width: 80, margin: 1}, function(error) {
                                    if (error) console.error('QR code error:', error);
                                });
                            } catch (e) {
                                console.log('QR code library not available, using placeholder');
                                canvas.style.background = '#f0f0f0';
                            }
                        }
                    }, 100);
                }
            });
        }

        function printLabels() {
            var filterStatus = document.getElementById('labelFilterStatus').value;
            var includeQR = document.getElementById('includeQR').checked;
            var includeDate = document.getElementById('includeDate').checked;
            var includeStatus = document.getElementById('includeStatus').checked;
            var labelSize = document.getElementById('labelSize').value;

            // Filter samples
            var filteredSamples = samples.filter(function(s) {
                return filterStatus === 'all' || s.status === filterStatus;
            });

            if (filteredSamples.length === 0) {
                alert('No samples to print!');
                return;
            }

            // Create print window
            var printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Sample Labels - ' + filteredSamples.length + ' labels</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@media print { @page { margin: 0.5in; } }');
            printWindow.document.write('body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }');
            printWindow.document.write('.label-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }');

            if (labelSize === 'small') {
                printWindow.document.write('.label { border: 1px solid #000; padding: 5px; text-align: center; font-size: 10px; page-break-inside: avoid; }');
                printWindow.document.write('.label-id { font-size: 11px; font-weight: bold; }');
                printWindow.document.write('.qr-code { width: 40px; height: 40px; margin: 3px auto; }');
            } else if (labelSize === 'large') {
                printWindow.document.write('.label { border: 2px solid #000; padding: 20px; text-align: center; font-size: 14px; page-break-inside: avoid; }');
                printWindow.document.write('.label-id { font-size: 20px; font-weight: bold; margin-bottom: 10px; }');
                printWindow.document.write('.qr-code { width: 120px; height: 120px; margin: 10px auto; }');
            } else {
                // Medium (default - Avery 5160 compatible)
                printWindow.document.write('.label { border: 1.5px solid #000; padding: 8px; text-align: center; font-size: 11px; height: 0.9in; page-break-inside: avoid; }');
                printWindow.document.write('.label-id { font-size: 14px; font-weight: bold; margin-bottom: 5px; }');
                printWindow.document.write('.qr-code { width: 60px; height: 60px; margin: 5px auto; }');
            }

            printWindow.document.write('.label-info { font-size: 9px; color: #555; margin-top: 3px; }');
            printWindow.document.write('</style></head><body>');

            printWindow.document.write('<h2 style="text-align: center; margin-bottom: 20px;">Bacterial Isolation Sample Labels (' + filteredSamples.length + ' labels)</h2>');
            printWindow.document.write('<div class="label-grid">');

            filteredSamples.forEach(function(sample) {
                printWindow.document.write('<div class="label">');
                printWindow.document.write('<div class="label-id">' + sample.id + '</div>');

                if (includeQR) {
                    var canvasId = 'qr-print-' + sample.id.replace(/[^a-zA-Z0-9]/g, '_');
                    printWindow.document.write('<canvas id="' + canvasId + '" class="qr-code"></canvas>');
                }

                if (includeDate) {
                    printWindow.document.write('<div class="label-info">Added: ' + sample.dateAdded + '</div>');
                }

                if (includeStatus) {
                    printWindow.document.write('<div class="label-info">' + sample.status + '</div>');
                }

                printWindow.document.write('</div>');
            });

            printWindow.document.write('</div></body></html>');
            printWindow.document.close();

            // Generate QR codes if enabled
            if (includeQR) {
                setTimeout(function() {
                    filteredSamples.forEach(function(sample) {
                        var canvasId = 'qr-print-' + sample.id.replace(/[^a-zA-Z0-9]/g, '_');
                        var canvas = printWindow.document.getElementById(canvasId);
                        if (canvas) {
                            try {
                                var size = labelSize === 'small' ? 40 : labelSize === 'large' ? 120 : 60;
                                QRCode.toCanvas(canvas, sample.id, {width: size, margin: 1}, function(error) {
                                    if (error) console.error('QR code error:', error);
                                });
                            } catch (e) {
                                console.log('QR code library not available');
                            }
                        }
                    });

                    // Wait for QR codes to render then print
                    setTimeout(function() {
                        printWindow.print();
                    }, 1000);
                }, 500);
            } else {
                // No QR codes, print immediately
                setTimeout(function() {
                    printWindow.print();
                }, 500);
            }
        }

        function toggleSampleSelection(sampleId, checkbox) {
            if (checkbox.checked) {
                if (bulkSelectedSamples.indexOf(sampleId) === -1) {
                    bulkSelectedSamples.push(sampleId);
                }
            } else {
                var index = bulkSelectedSamples.indexOf(sampleId);
                if (index > -1) {
                    bulkSelectedSamples.splice(index, 1);
                }
            }
            updateBulkOpsBar();
        }

        function toggleSelectAll() {
            var selectAll = document.getElementById('selectAllCheckbox').checked;
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            bulkSelectedSamples = [];

            for (var i = 0; i < checkboxes.length; i++) {
                var checkbox = checkboxes[i];
                var sampleItem = checkbox.closest('.sample-item');

                // Only select visible samples
                if (sampleItem && sampleItem.style.display !== 'none') {
                    checkbox.checked = selectAll;
                    if (selectAll) {
                        bulkSelectedSamples.push(checkbox.value);
                    }
                }
            }
            updateBulkOpsBar();
        }

        function clearSelection() {
            bulkSelectedSamples = [];
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkOpsBar();
        }

        function updateBulkOpsBar() {
            var bar = document.getElementById('bulkOpsBar');
            var count = bulkSelectedSamples.length;
            document.getElementById('selectedCount').textContent = count;

            if (count > 0) {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }
        }

        function bulkDelete() {
            if (bulkSelectedSamples.length === 0) return;

            var deleteCount = bulkSelectedSamples.length;
            var confirmed = confirm('Are you sure you want to delete ' + deleteCount + ' sample(s)?\n\nThis cannot be undone!');
            if (!confirmed) return;

            // Delete all selected samples (iterate backwards to avoid index issues)
            samples = samples.filter(function(sample) {
                return bulkSelectedSamples.indexOf(sample.id) === -1;
            });

            clearSelection();
            saveData();
            renderSamples();
            alert(deleteCount + ' sample(s) deleted successfully!');
        }

        function showBulkStatusChange() {
            if (bulkSelectedSamples.length === 0) return;

            var newStatus = prompt('Enter new status for ' + bulkSelectedSamples.length + ' sample(s):\n\n' +
                'Options:\n' +
                '- Received\n' +
                '- BAP Complete\n' +
                '- TSB Complete\n' +
                '- Extraction Complete\n' +
                '- Clean Extraction Complete\n' +
                '- Clean Extraction Qubit Complete\n' +
                '- Indexing Complete\n' +
                '- Qubit Complete');

            if (!newStatus) return;

            var validStatuses = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];

            if (validStatuses.indexOf(newStatus) === -1) {
                alert('Invalid status! Please use one of the listed options.');
                return;
            }

            // Update status for all selected samples
            var updated = 0;
            for (var i = 0; i < bulkSelectedSamples.length; i++) {
                var sampleId = bulkSelectedSamples[i];
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        samples[j].status = newStatus;
                        updated++;
                        break;
                    }
                }
            }

            clearSelection();
            saveData();
            renderSamples();
            alert(updated + ' sample(s) status updated to: ' + newStatus);
        }

        function showAnalytics() {
            document.getElementById('analyticsModal').style.display = 'block';
            renderAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        function showReagentSearch() {
            document.getElementById('reagentSearchModal').style.display = 'block';
            document.getElementById('reagentSearchInput').focus();
        }

        function closeReagentSearchModal() {
            document.getElementById('reagentSearchModal').style.display = 'none';
        }

        function searchReagentLot() {
            var searchLot = document.getElementById('reagentSearchInput').value.trim();
            if (!searchLot) {
                alert('Please enter a lot number to search');
                return;
            }

            var results = [];
            var searchLower = searchLot.toLowerCase();

            // Search through all samples
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var found = false;
                var foundIn = [];

                // Check main lot number field (BAP/TSB)
                if (sample.bapDetails && sample.bapDetails.lot && sample.bapDetails.lot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('BAP Lot');
                }
                if (sample.tsbDetails && sample.tsbDetails.lot && sample.tsbDetails.lot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('TSB Lot');
                }

                // Check Extraction reagent lots
                if (sample.extractionDetails && sample.extractionDetails.reagentLots) {
                    var lots = sample.extractionDetails.reagentLots;
                    if (lots.aw1 && lots.aw1.toLowerCase().includes(searchLower)) { found = true; foundIn.push('AW1'); }
                    if (lots.aw2 && lots.aw2.toLowerCase().includes(searchLower)) { found = true; foundIn.push('AW2'); }
                    if (lots.ethanol && lots.ethanol.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Ethanol'); }
                    if (lots.bufferAL && lots.bufferAL.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer AL'); }
                    if (lots.bufferATL && lots.bufferATL.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer ATL'); }
                    if (lots.bufferAE && lots.bufferAE.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer AE'); }
                    if (lots.proteinaseK && lots.proteinaseK.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Proteinase K'); }
                    if (lots.dneasy && lots.dneasy.toLowerCase().includes(searchLower)) { found = true; foundIn.push('DNeasy'); }
                }

                // Check Clean Extraction reagent lots
                if (sample.cleanExtractionDetails && sample.cleanExtractionDetails.reagentLots) {
                    var lots = sample.cleanExtractionDetails.reagentLots;
                    if (lots.bead && lots.bead.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Bead'); }
                    if (lots.nfH2oEtoh && lots.nfH2oEtoh.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O ETOH'); }
                    if (lots.etohDilution && lots.etohDilution.toLowerCase().includes(searchLower)) { found = true; foundIn.push('EtOH Dilution'); }
                    if (lots.nfH2oElution && lots.nfH2oElution.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O Elution'); }
                    if (lots.qubitReagent && lots.qubitReagent.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Qubit Reagent (CE)'); }
                }

                // Check Indexing reagent lots
                if (sample.indexingDetails && sample.indexingDetails.reagentLots) {
                    var lots = sample.indexingDetails.reagentLots;
                    if (lots.tdBuffer && lots.tdBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('TD Buffer'); }
                    if (lots.atmBuffer && lots.atmBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('ATM Buffer'); }
                    if (lots.ntBuffer && lots.ntBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NT Buffer'); }
                    if (lots.npm && lots.npm.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NPM'); }
                    if (lots.resuspensionBuffer && lots.resuspensionBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Resuspension Buffer'); }
                    if (lots.indexesKit && lots.indexesKit.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Indexes Kit'); }
                    if (lots.beads && lots.beads.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Beads (Indexing)'); }
                    if (lots.etoh && lots.etoh.toLowerCase().includes(searchLower)) { found = true; foundIn.push('EtOH (Indexing)'); }
                    if (lots.nfH2o && lots.nfH2o.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O (Indexing)'); }
                }

                // Check Qubit reagent lots
                if (sample.cleanExtractionQubitDetails && sample.cleanExtractionQubitDetails.reagentLot &&
                    sample.cleanExtractionQubitDetails.reagentLot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('CE Qubit Reagent');
                }
                if (sample.qubitDetails && sample.qubitDetails.reagentLot &&
                    sample.qubitDetails.reagentLot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('Final Qubit Reagent');
                }

                if (found) {
                    results.push({
                        sample: sample,
                        foundIn: foundIn
                    });
                }
            }

            // Display results
            var resultsDiv = document.getElementById('reagentSearchResults');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; text-align: center;"><strong>‚ö†Ô∏è No samples found</strong><br>No samples use reagent lot: ' + searchLot + '</div>';
            } else {
                var html = '<div style="background: #d4edda; border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<strong style="color: #155724;">‚úÖ Found ' + results.length + ' sample(s) using lot: ' + searchLot + '</strong>';
                html += '</div>';

                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
                html += '<th style="padding: 12px; text-align: left;">Sample ID</th>';
                html += '<th style="padding: 12px; text-align: left;">Status</th>';
                html += '<th style="padding: 12px; text-align: left;">Date Added</th>';
                html += '<th style="padding: 12px; text-align: left;">Found In</th>';
                html += '</tr>';

                for (var i = 0; i < results.length; i++) {
                    var r = results[i];
                    html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                    html += '<td style="padding: 12px; font-weight: 600;">' + r.sample.id + '</td>';
                    html += '<td style="padding: 12px;">' + r.sample.status + '</td>';
                    html += '<td style="padding: 12px;">' + r.sample.dateAdded + '</td>';
                    html += '<td style="padding: 12px; color: #fd7e14; font-weight: 600;">' + r.foundIn.join(', ') + '</td>';
                    html += '</tr>';
                }

                html += '</table></div>';

                html += '<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">';
                html += '<strong>üí° Tip:</strong> This is useful for quality control and recalls. Export this data or take a screenshot for your records.';
                html += '</div>';

                resultsDiv.innerHTML = html;
            }
        }

        // Reagent Templates System
        var reagentTemplates = JSON.parse(localStorage.getItem('reagentTemplates') || '[]');

        function showReagentTemplates() {
            document.getElementById('reagentTemplatesModal').style.display = 'block';
            renderTemplatesList();
        }

        function closeReagentTemplatesModal() {
            document.getElementById('reagentTemplatesModal').style.display = 'none';
        }

        function renderTemplatesList() {
            var listDiv = document.getElementById('templatesList');

            if (reagentTemplates.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No templates saved yet. Use "Save as Template" button when processing a sample to save reagent lots.</p>';
                return;
            }

            var html = '<div style="display: grid; gap: 15px;">';
            for (var i = 0; i < reagentTemplates.length; i++) {
                var template = reagentTemplates[i];
                html += '<div style="border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; background: #f0f9ff;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
                html += '<div>';
                html += '<h4 style="margin: 0 0 5px 0; color: #17a2b8;">' + template.name + '</h4>';
                html += '<small style="color: #666;">Stage: ' + template.stage + ' ‚Ä¢ Saved: ' + template.dateSaved + '</small>';
                html += '</div>';
                html += '<div>';
                html += '<button onclick="applyTemplate(' + i + ')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Apply</button>';
                html += '<button onclick="deleteTemplate(' + i + ')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>';
                html += '</div>';
                html += '</div>';

                // Show saved lots
                var lotsCount = Object.keys(template.lots).length;
                html += '<div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px;">';
                html += '<strong>' + lotsCount + ' reagent lots saved</strong>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div>';

            listDiv.innerHTML = html;
        }

        function saveAsTemplate() {
            var templateName = prompt('Enter a name for this template (e.g., "Week of Jan 15" or "Batch 2025-01"):');
            if (!templateName) return;

            var lots = {};
            var stage = currentProcessType;

            // Collect all visible reagent lot inputs
            var inputs = document.querySelectorAll('#specificFields input[type="text"], #lotNumber, #techInitials, #temperature, #incubator');
            for (var i = 0; i < inputs.length; i++) {
                var input = inputs[i];
                if (input.value && input.id) {
                    lots[input.id] = input.value;
                }
            }

            if (Object.keys(lots).length === 0) {
                alert('No reagent lots to save. Fill in some lot numbers first!');
                return;
            }

            var template = {
                name: templateName,
                stage: stage,
                lots: lots,
                dateSaved: new Date().toLocaleDateString()
            };

            reagentTemplates.push(template);
            localStorage.setItem('reagentTemplates', JSON.stringify(reagentTemplates));

            alert('‚úÖ Template "' + templateName + '" saved with ' + Object.keys(lots).length + ' fields!');
        }

        function loadTemplate() {
            if (reagentTemplates.length === 0) {
                alert('No templates saved yet. Use "Save as Template" first!');
                return;
            }

            // Filter templates for current stage
            var stage = currentProcessType;
            var stageTemplates = [];
            for (var i = 0; i < reagentTemplates.length; i++) {
                if (reagentTemplates[i].stage === stage) {
                    stageTemplates.push({index: i, template: reagentTemplates[i]});
                }
            }

            if (stageTemplates.length === 0) {
                alert('No templates saved for ' + stage + ' stage yet.');
                return;
            }

            // Show template selection
            var message = 'Select a template to load:\n\n';
            for (var i = 0; i < stageTemplates.length; i++) {
                var t = stageTemplates[i].template;
                message += (i+1) + '. ' + t.name + ' (saved ' + t.dateSaved + ')\n';
            }

            var choice = prompt(message, '1');
            if (!choice) return;

            var choiceNum = parseInt(choice);
            if (isNaN(choiceNum) || choiceNum < 1 || choiceNum > stageTemplates.length) {
                alert('Invalid selection');
                return;
            }

            var template = stageTemplates[choiceNum - 1].template;
            applyTemplateData(template.lots);
            alert('‚úÖ Template "' + template.name + '" loaded!');
        }

        function applyTemplate(templateIndex) {
            var template = reagentTemplates[templateIndex];
            applyTemplateData(template.lots);
            closeReagentTemplatesModal();
            alert('‚úÖ Template "' + template.name + '" applied!');
        }

        function applyTemplateData(lots) {
            // Fill in all matching input fields
            for (var fieldId in lots) {
                var input = document.getElementById(fieldId);
                if (input) {
                    input.value = lots[fieldId];
                }
            }
        }

        function deleteTemplate(templateIndex) {
            var template = reagentTemplates[templateIndex];
            if (confirm('Delete template "' + template.name + '"?')) {
                reagentTemplates.splice(templateIndex, 1);
                localStorage.setItem('reagentTemplates', JSON.stringify(reagentTemplates));
                renderTemplatesList();
            }
        }

        // Inventory Management System
        var inventory = JSON.parse(localStorage.getItem('reagentInventory') || '[]');

        function showInventory() {
            document.getElementById('inventoryModal').style.display = 'block';
            renderInventory();
        }

        function closeInventory() {
            document.getElementById('inventoryModal').style.display = 'none';
        }

        function addReagentToInventory() {
            var name = document.getElementById('newReagentName').value.trim();
            var lot = document.getElementById('newReagentLot').value.trim();
            var qty = parseFloat(document.getElementById('newReagentQty').value);
            var unit = document.getElementById('newReagentUnit').value;
            var expiry = document.getElementById('newReagentExpiry').value;
            var location = document.getElementById('newReagentLocation').value.trim();

            if (!name || !lot || isNaN(qty) || qty <= 0) {
                alert('Please fill in all required fields (name, lot, quantity)');
                return;
            }

            var reagent = {
                id: Date.now(),
                name: name,
                lot: lot,
                quantity: qty,
                unit: unit,
                initialQuantity: qty,
                expiry: expiry,
                location: location,
                dateAdded: new Date().toLocaleDateString(),
                usageHistory: []
            };

            inventory.push(reagent);
            localStorage.setItem('reagentInventory', JSON.stringify(inventory));

            // Clear form
            document.getElementById('newReagentName').value = '';
            document.getElementById('newReagentLot').value = '';
            document.getElementById('newReagentQty').value = '';
            document.getElementById('newReagentExpiry').value = '';
            document.getElementById('newReagentLocation').value = '';

            renderInventory();
            alert('‚úÖ Reagent "' + name + '" added to inventory!');
        }

        function renderInventory() {
            renderInventoryList();
            renderInventoryStats();
        }

        function renderInventoryStats() {
            var statsDiv = document.getElementById('inventoryStats');

            var totalReagents = inventory.length;
            var lowStock = 0;
            var expired = 0;
            var expiringSoon = 0;

            var today = new Date();
            var in30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            for (var i = 0; i < inventory.length; i++) {
                var r = inventory[i];
                var percentRemaining = (r.quantity / r.initialQuantity) * 100;

                if (percentRemaining < 20) lowStock++;

                if (r.expiry) {
                    var expiryDate = new Date(r.expiry);
                    if (expiryDate < today) expired++;
                    else if (expiryDate < in30Days) expiringSoon++;
                }
            }

            var html = '<div style="display: grid; gap: 15px;">';

            html += '<div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #17a2b8;">';
            html += '<div style="font-size: 24px; font-weight: bold; color: #17a2b8;">' + totalReagents + '</div>';
            html += '<div style="font-size: 13px; color: #666;">Total Reagents</div>';
            html += '</div>';

            html += '<div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid ' + (lowStock > 0 ? '#ffc107' : '#28a745') + ';">';
            html += '<div style="font-size: 24px; font-weight: bold; color: ' + (lowStock > 0 ? '#ffc107' : '#28a745') + ';">' + lowStock + '</div>';
            html += '<div style="font-size: 13px; color: #666;">Low Stock (<20%)</div>';
            html += '</div>';

            html += '<div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid ' + (expired > 0 ? '#dc3545' : '#28a745') + ';">';
            html += '<div style="font-size: 24px; font-weight: bold; color: ' + (expired > 0 ? '#dc3545' : '#28a745') + ';">' + expired + '</div>';
            html += '<div style="font-size: 13px; color: #666;">Expired</div>';
            html += '</div>';

            html += '<div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid ' + (expiringSoon > 0 ? '#fd7e14' : '#28a745') + ';">';
            html += '<div style="font-size: 24px; font-weight: bold; color: ' + (expiringSoon > 0 ? '#fd7e14' : '#28a745') + ';">' + expiringSoon + '</div>';
            html += '<div style="font-size: 13px; color: #666;">Expiring Soon (30d)</div>';
            html += '</div>';

            html += '</div>';
            statsDiv.innerHTML = html;
        }

        function renderInventoryList() {
            var listDiv = document.getElementById('inventoryList');

            if (inventory.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No reagents in inventory yet. Add some using the form above!</p>';
                return;
            }

            var today = new Date();
            var in30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            var html = '<div style="display: grid; gap: 15px;">';

            for (var i = 0; i < inventory.length; i++) {
                var r = inventory[i];
                var percentRemaining = (r.quantity / r.initialQuantity) * 100;
                var isLowStock = percentRemaining < 20;
                var isExpired = false;
                var isExpiringSoon = false;

                if (r.expiry) {
                    var expiryDate = new Date(r.expiry);
                    isExpired = expiryDate < today;
                    isExpiringSoon = !isExpired && expiryDate < in30Days;
                }

                var borderColor = isExpired ? '#dc3545' : isExpiringSoon ? '#fd7e14' : isLowStock ? '#ffc107' : '#28a745';

                html += '<div style="border: 2px solid ' + borderColor + '; border-radius: 8px; padding: 15px; background: white;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
                html += '<div style="flex: 1;">';
                html += '<h4 style="margin: 0 0 8px 0; color: ' + borderColor + ';">' + r.name + '</h4>';
                html += '<div style="font-size: 13px; color: #666; display: grid; gap: 5px;">';
                html += '<div><strong>Lot:</strong> ' + r.lot + '</div>';
                html += '<div><strong>Location:</strong> ' + (r.location || 'Not specified') + '</div>';
                html += '<div><strong>Added:</strong> ' + r.dateAdded + '</div>';
                if (r.expiry) {
                    var expiryText = r.expiry;
                    if (isExpired) expiryText += ' ‚ùå EXPIRED';
                    else if (isExpiringSoon) expiryText += ' ‚ö†Ô∏è Expiring soon';
                    html += '<div><strong>Expiry:</strong> ' + expiryText + '</div>';
                }
                html += '</div>';
                html += '</div>';

                html += '<div style="text-align: right;">';
                html += '<div style="font-size: 24px; font-weight: bold; color: ' + borderColor + ';">' + r.quantity.toFixed(1) + ' ' + r.unit + '</div>';
                html += '<div style="font-size: 11px; color: #999;">of ' + r.initialQuantity + ' ' + r.unit + '</div>';

                // Progress bar
                html += '<div style="width: 150px; height: 8px; background: #e9ecef; border-radius: 4px; margin: 8px 0; overflow: hidden;">';
                html += '<div style="width: ' + percentRemaining + '%; height: 100%; background: ' + borderColor + '; transition: width 0.3s;"></div>';
                html += '</div>';
                html += '<div style="font-size: 12px; font-weight: 600; color: ' + borderColor + ';">' + Math.round(percentRemaining) + '% remaining</div>';

                html += '<div style="margin-top: 10px;">';
                html += '<button onclick="adjustInventory(' + i + ', -10)" style="padding: 4px 8px; font-size: 11px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">-10</button>';
                html += '<button onclick="adjustInventory(' + i + ', -1)" style="padding: 4px 8px; font-size: 11px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">-1</button>';
                html += '<button onclick="adjustInventory(' + i + ', 1)" style="padding: 4px 8px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">+1</button>';
                html += '<button onclick="adjustInventory(' + i + ', 10)" style="padding: 4px 8px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">+10</button>';
                html += '</div>';
                html += '<button onclick="deleteReagent(' + i + ')" style="margin-top: 8px; padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
            listDiv.innerHTML = html;
        }

        function adjustInventory(index, amount) {
            inventory[index].quantity = Math.max(0, inventory[index].quantity + amount);
            inventory[index].usageHistory.push({
                date: new Date().toLocaleDateString(),
                change: amount,
                newQuantity: inventory[index].quantity
            });
            localStorage.setItem('reagentInventory', JSON.stringify(inventory));
            renderInventory();
        }

        function deleteReagent(index) {
            var r = inventory[index];
            if (confirm('Delete "' + r.name + '" (Lot: ' + r.lot + ') from inventory?')) {
                inventory.splice(index, 1);
                localStorage.setItem('reagentInventory', JSON.stringify(inventory));
                renderInventory();
            }
        }

        // Equipment Log (Placeholder for future implementation)
        // Equipment Log Module
        var equipmentLogs = JSON.parse(localStorage.getItem('equipmentLogs') || '[]');

        function showEquipmentLog() {
            var modal = document.getElementById('equipmentModal');
            if (!modal) {
                // Create modal
                var modalHTML = '<div id="equipmentModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">';
                modalHTML += '<div style="background: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 1000px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">';
                modalHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
                modalHTML += '<h2 style="margin: 0; color: #9c27b0;">üîß Equipment Log</h2>';
                modalHTML += '<button onclick="closeEquipmentModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>';
                modalHTML += '</div>';

                // Add new log entry form
                modalHTML += '<div style="border: 2px solid #9c27b0; border-radius: 8px; padding: 20px; background: #f9f3ff; margin-bottom: 20px;">';
                modalHTML += '<h3 style="margin-top: 0; color: #9c27b0;">‚ûï Add Log Entry</h3>';
                modalHTML += '<select id="newEquipmentType" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<option value="">Select Equipment...</option>';
                modalHTML += '<option value="Incubator">Incubator</option>';
                modalHTML += '<option value="Qubit">Qubit</option>';
                modalHTML += '<option value="Centrifuge">Centrifuge</option>';
                modalHTML += '<option value="PCR Machine">PCR Machine</option>';
                modalHTML += '<option value="Other">Other</option>';
                modalHTML += '</select>';
                modalHTML += '<input type="text" id="newEquipmentID" placeholder="Equipment ID (e.g., INC-1, Qubit-Main)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<select id="newLogType" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<option value="">Log Type...</option>';
                modalHTML += '<option value="Temperature Check">Temperature Check</option>';
                modalHTML += '<option value="Calibration">Calibration</option>';
                modalHTML += '<option value="Maintenance">Maintenance</option>';
                modalHTML += '<option value="Repair">Repair</option>';
                modalHTML += '<option value="Cleaning">Cleaning</option>';
                modalHTML += '<option value="Issue">Issue/Problem</option>';
                modalHTML += '</select>';
                modalHTML += '<input type="text" id="newLogValue" placeholder="Value (e.g., 37.2¬∞C, Pass, N/A)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<textarea id="newLogNotes" placeholder="Notes (optional)" style="width: 100%; height: 80px; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>';
                modalHTML += '<input type="text" id="newLogTech" placeholder="Your Initials" maxlength="3" style="width: 150px; padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<button onclick="addEquipmentLog()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚ûï Add Log</button>';
                modalHTML += '</div>';

                // Equipment log list
                modalHTML += '<div id="equipmentLogList"></div>';

                modalHTML += '</div></div>';

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('equipmentModal');
            }

            renderEquipmentLogs();
            modal.style.display = 'block';
        }

        function closeEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'none';
        }

        function addEquipmentLog() {
            var type = document.getElementById('newEquipmentType').value;
            var equipmentID = document.getElementById('newEquipmentID').value.trim();
            var logType = document.getElementById('newLogType').value;
            var value = document.getElementById('newLogValue').value.trim();
            var notes = document.getElementById('newLogNotes').value.trim();
            var tech = document.getElementById('newLogTech').value.trim().toUpperCase();

            if (!type || !equipmentID || !logType || !tech) {
                alert('Please fill in equipment type, ID, log type, and initials');
                return;
            }

            var log = {
                id: Date.now(),
                type: type,
                equipmentID: equipmentID,
                logType: logType,
                value: value,
                notes: notes,
                technician: tech,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            equipmentLogs.push(log);
            localStorage.setItem('equipmentLogs', JSON.stringify(equipmentLogs));

            // Clear form
            document.getElementById('newEquipmentType').value = '';
            document.getElementById('newEquipmentID').value = '';
            document.getElementById('newLogType').value = '';
            document.getElementById('newLogValue').value = '';
            document.getElementById('newLogNotes').value = '';
            document.getElementById('newLogTech').value = '';

            renderEquipmentLogs();
            alert('‚úÖ Log entry added!');
        }

        function renderEquipmentLogs() {
            var listDiv = document.getElementById('equipmentLogList');
            var html = '';

            if (equipmentLogs.length === 0) {
                html = '<p style="text-align: center; color: #6c757d; padding: 40px;">No equipment logs yet. Add your first log above!</p>';
            } else {
                // Show most recent first
                var sortedLogs = equipmentLogs.slice().reverse();

                html += '<div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">';
                html += '<h3 style="margin-top: 0;">Recent Logs</h3>';

                for (var i = 0; i < sortedLogs.length; i++) {
                    var log = sortedLogs[i];
                    var typeColor = log.logType === 'Issue' ? '#dc3545' : log.logType === 'Repair' ? '#ffc107' : log.logType === 'Calibration' ? '#17a2b8' : '#28a745';

                    html += '<div style="border-left: 4px solid ' + typeColor + '; background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 4px;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">';
                    html += '<div>';
                    html += '<strong style="color: #9c27b0;">' + log.type + ' - ' + log.equipmentID + '</strong>';
                    html += ' <span style="background: ' + typeColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">' + log.logType + '</span>';
                    html += '</div>';
                    html += '<button onclick="deleteEquipmentLog(' + log.id + ')" style="background: #dc3545; color: white; padding: 3px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Delete</button>';
                    html += '</div>';
                    if (log.value) html += '<div style="margin: 5px 0;"><strong>Value:</strong> ' + log.value + '</div>';
                    if (log.notes) html += '<div style="margin: 5px 0;"><strong>Notes:</strong> ' + log.notes + '</div>';
                    html += '<div style="font-size: 11px; color: #6c757d; margin-top: 5px;">' + log.date + ' ' + log.time + ' by ' + log.technician + '</div>';
                    html += '</div>';
                }

                html += '</div>';
            }

            listDiv.innerHTML = html;
        }

        function deleteEquipmentLog(id) {
            if (!confirm('Delete this log entry?')) return;

            equipmentLogs = equipmentLogs.filter(function(l) { return l.id !== id; });
            localStorage.setItem('equipmentLogs', JSON.stringify(equipmentLogs));
            renderEquipmentLogs();
        }

        // Weekly Report Generator
        function showWeeklyReport() {
            var today = new Date();
            var weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            var thisWeekSamples = samples.filter(function(s) {
                var sampleDate = new Date(s.dateAdded);
                return sampleDate >= weekAgo;
            });

            var completed = thisWeekSamples.filter(function(s) {
                return s.status === 'Qubit Complete';
            }).length;

            var techCounts = {};
            for (var i = 0; i < thisWeekSamples.length; i++) {
                var tech = thisWeekSamples[i].initials;
                techCounts[tech] = (techCounts[tech] || 0) + 1;
            }

            var report = 'üìä WEEKLY SUMMARY REPORT\n';
            report += '==================\n\n';
            report += 'Week: ' + weekAgo.toLocaleDateString() + ' - ' + today.toLocaleDateString() + '\n\n';
            report += 'üìà SAMPLES:\n';
            report += '‚Ä¢ Added this week: ' + thisWeekSamples.length + '\n';
            report += '‚Ä¢ Completed: ' + completed + '\n';
            report += '‚Ä¢ In progress: ' + (thisWeekSamples.length - completed) + '\n\n';
            report += 'üë• BY TECHNICIAN:\n';
            for (var tech in techCounts) {
                report += '‚Ä¢ ' + tech + ': ' + techCounts[tech] + ' samples\n';
            }

            alert(report);
        }

        // Advanced Search Module
        function showAdvancedSearch() {
            var modal = document.getElementById('advancedSearchModal');
            if (!modal) {
                // Create modal
                var modalHTML = '<div id="advancedSearchModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">';
                modalHTML += '<div style="background: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">';
                modalHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
                modalHTML += '<h2 style="margin: 0; color: #17a2b8;">üîé Advanced Search</h2>';
                modalHTML += '<button onclick="closeAdvancedSearchModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>';
                modalHTML += '</div>';

                modalHTML += '<div style="background: #e7f3f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
                modalHTML += '<p style="margin: 0 0 15px 0; color: #17a2b8; font-weight: 600;">Search across multiple fields simultaneously:</p>';

                // Sample ID
                modalHTML += '<div style="margin-bottom: 15px;">';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Sample ID:</label>';
                modalHTML += '<input type="text" id="advSearchID" placeholder="e.g., 25KS01-042" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';

                // Technician
                modalHTML += '<div style="margin-bottom: 15px;">';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Technician (Initials):</label>';
                modalHTML += '<input type="text" id="advSearchTech" placeholder="e.g., ABC" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';

                // Date Range
                modalHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHTML += '<div>';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Date From:</label>';
                modalHTML += '<input type="date" id="advSearchDateFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';
                modalHTML += '<div>';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Date To:</label>';
                modalHTML += '<input type="date" id="advSearchDateTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';
                modalHTML += '</div>';

                // Status
                modalHTML += '<div style="margin-bottom: 15px;">';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Status:</label>';
                modalHTML += '<select id="advSearchStatus" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<option value="">Any Status</option>';
                modalHTML += '<option value="Received">Received</option>';
                modalHTML += '<option value="BAP In Progress">BAP In Progress</option>';
                modalHTML += '<option value="BAP Complete">BAP Complete</option>';
                modalHTML += '<option value="TSB In Progress">TSB In Progress</option>';
                modalHTML += '<option value="TSB Complete">TSB Complete</option>';
                modalHTML += '<option value="Extraction Complete">Extraction Complete</option>';
                modalHTML += '<option value="Clean Extraction Complete">Clean Extraction Complete</option>';
                modalHTML += '<option value="Clean Extraction Qubit Complete">Clean Extraction Qubit Complete</option>';
                modalHTML += '<option value="Indexing Complete">Indexing Complete</option>';
                modalHTML += '<option value="Qubit Complete">Qubit Complete</option>';
                modalHTML += '</select>';
                modalHTML += '</div>';

                // Reagent Lot
                modalHTML += '<div style="margin-bottom: 15px;">';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Reagent Lot Number:</label>';
                modalHTML += '<input type="text" id="advSearchReagentLot" placeholder="Search across ALL reagent lots" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';

                // Plate/Well
                modalHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                modalHTML += '<div>';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Plate:</label>';
                modalHTML += '<input type="text" id="advSearchPlate" placeholder="e.g., Plate-001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';
                modalHTML += '<div>';
                modalHTML += '<label style="display: block; font-weight: 600; margin-bottom: 5px;">Well:</label>';
                modalHTML += '<input type="text" id="advSearchWell" placeholder="e.g., A01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '</div>';
                modalHTML += '</div>';

                // Buttons
                modalHTML += '</div>';
                modalHTML += '<div style="display: flex; gap: 10px; justify-content: flex-end;">';
                modalHTML += '<button onclick="clearAdvancedSearch()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Clear All</button>';
                modalHTML += '<button onclick="executeAdvancedSearch()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üîç Search</button>';
                modalHTML += '</div>';

                // Results
                modalHTML += '<div id="advancedSearchResults" style="margin-top: 20px;"></div>';

                modalHTML += '</div></div>';

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('advancedSearchModal');
            }

            modal.style.display = 'block';
        }

        function closeAdvancedSearchModal() {
            document.getElementById('advancedSearchModal').style.display = 'none';
        }

        function clearAdvancedSearch() {
            document.getElementById('advSearchID').value = '';
            document.getElementById('advSearchTech').value = '';
            document.getElementById('advSearchDateFrom').value = '';
            document.getElementById('advSearchDateTo').value = '';
            document.getElementById('advSearchStatus').value = '';
            document.getElementById('advSearchReagentLot').value = '';
            document.getElementById('advSearchPlate').value = '';
            document.getElementById('advSearchWell').value = '';
            document.getElementById('advancedSearchResults').innerHTML = '';
        }

        function executeAdvancedSearch() {
            var searchID = document.getElementById('advSearchID').value.trim().toLowerCase();
            var searchTech = document.getElementById('advSearchTech').value.trim().toUpperCase();
            var searchDateFrom = document.getElementById('advSearchDateFrom').value;
            var searchDateTo = document.getElementById('advSearchDateTo').value;
            var searchStatus = document.getElementById('advSearchStatus').value;
            var searchReagentLot = document.getElementById('advSearchReagentLot').value.trim().toLowerCase();
            var searchPlate = document.getElementById('advSearchPlate').value.trim().toLowerCase();
            var searchWell = document.getElementById('advSearchWell').value.trim().toUpperCase();

            var results = samples.filter(function(s) {
                // Sample ID match
                if (searchID && s.id.toLowerCase().indexOf(searchID) === -1) return false;

                // Technician match
                if (searchTech && s.initials.indexOf(searchTech) === -1) return false;

                // Date range match
                if (searchDateFrom) {
                    var sampleDate = new Date(s.dateAdded);
                    var fromDate = new Date(searchDateFrom);
                    if (sampleDate < fromDate) return false;
                }
                if (searchDateTo) {
                    var sampleDate = new Date(s.dateAdded);
                    var toDate = new Date(searchDateTo);
                    if (sampleDate > toDate) return false;
                }

                // Status match
                if (searchStatus && s.status !== searchStatus) return false;

                // Reagent lot match (search ALL reagent fields)
                if (searchReagentLot) {
                    var found = false;
                    // Check all possible reagent lot fields
                    if (s.bapDetails && s.bapDetails.lot && s.bapDetails.lot.toLowerCase().indexOf(searchReagentLot) !== -1) found = true;
                    if (s.tsbDetails && s.tsbDetails.lotNumber && s.tsbDetails.lotNumber.toLowerCase().indexOf(searchReagentLot) !== -1) found = true;
                    if (s.extractionDetails && s.extractionDetails.reagentLots) {
                        var lots = s.extractionDetails.reagentLots;
                        for (var key in lots) {
                            if (lots[key] && lots[key].toLowerCase().indexOf(searchReagentLot) !== -1) found = true;
                        }
                    }
                    if (s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots) {
                        var lots = s.cleanExtractionDetails.reagentLots;
                        for (var key in lots) {
                            if (lots[key] && lots[key].toLowerCase().indexOf(searchReagentLot) !== -1) found = true;
                        }
                    }
                    if (s.indexingDetails && s.indexingDetails.reagentLots) {
                        var lots = s.indexingDetails.reagentLots;
                        for (var key in lots) {
                            if (lots[key] && lots[key].toLowerCase().indexOf(searchReagentLot) !== -1) found = true;
                        }
                    }
                    if (!found) return false;
                }

                // Plate match
                if (searchPlate) {
                    var plateFound = false;
                    if (s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate && s.cleanExtractionDetails.storagePlate.toLowerCase().indexOf(searchPlate) !== -1) plateFound = true;
                    if (s.indexingDetails && s.indexingDetails.storagePlate && s.indexingDetails.storagePlate.toLowerCase().indexOf(searchPlate) !== -1) plateFound = true;
                    if (!plateFound) return false;
                }

                // Well match
                if (searchWell) {
                    var wellFound = false;
                    if (s.cleanExtractionDetails && s.cleanExtractionDetails.wellPosition && s.cleanExtractionDetails.wellPosition.indexOf(searchWell) !== -1) wellFound = true;
                    if (s.indexingDetails && s.indexingDetails.wellPosition && s.indexingDetails.wellPosition.indexOf(searchWell) !== -1) wellFound = true;
                    if (!wellFound) return false;
                }

                return true;
            });

            // Display results
            var resultsDiv = document.getElementById('advancedSearchResults');
            var html = '';

            if (results.length === 0) {
                html = '<div style="text-align: center; padding: 40px; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">';
                html += '<p style="font-size: 18px; margin: 0;">No samples found matching your criteria</p>';
                html += '</div>';
            } else {
                html = '<div style="border: 2px solid #28a745; border-radius: 8px; padding: 15px; background: #e6ffe6;">';
                html += '<h3 style="margin-top: 0; color: #28a745;">‚úÖ Found ' + results.length + ' sample' + (results.length === 1 ? '' : 's') + '</h3>';
                html += '<div style="max-height: 400px; overflow-y: auto;">';

                for (var i = 0; i < results.length; i++) {
                    var s = results[i];
                    html += '<div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #17a2b8;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<div>';
                    html += '<strong style="font-size: 16px; color: #17a2b8;">' + s.id + '</strong> ';
                    html += '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">' + s.status + '</span>';
                    html += '</div>';
                    html += '<div style="font-size: 12px; color: #6c757d;">' + s.dateAdded + ' by ' + s.initials + '</div>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                html += '<button onclick="closeAdvancedSearchModal()" style="background: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 10px;">Close & View Results</button>';
                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }

        // Protocol Library Module
        var protocols = JSON.parse(localStorage.getItem('protocolLibrary') || '[]');

        function showProtocolLibrary() {
            var modal = document.getElementById('protocolModal');
            if (!modal) {
                // Create modal
                var modalHTML = '<div id="protocolModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">';
                modalHTML += '<div style="background: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 900px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">';
                modalHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
                modalHTML += '<h2 style="margin: 0; color: #667eea;">üìö Protocol Library</h2>';
                modalHTML += '<button onclick="closeProtocolModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>';
                modalHTML += '</div>';

                // Add new protocol form
                modalHTML += '<div style="border: 2px solid #667eea; border-radius: 8px; padding: 20px; background: #f8f9ff; margin-bottom: 20px;">';
                modalHTML += '<h3 style="margin-top: 0; color: #667eea;">‚ûï Add New Protocol</h3>';
                modalHTML += '<input type="text" id="newProtocolName" placeholder="Protocol Name (e.g., BAP Incubation SOP)" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<select id="newProtocolStage" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                modalHTML += '<option value="">Select Stage...</option>';
                modalHTML += '<option value="BAP">BAP</option>';
                modalHTML += '<option value="TSB">TSB</option>';
                modalHTML += '<option value="Extraction">Extraction</option>';
                modalHTML += '<option value="Clean Extraction">Clean Extraction</option>';
                modalHTML += '<option value="Indexing">Indexing</option>';
                modalHTML += '<option value="Qubit">Qubit</option>';
                modalHTML += '<option value="General">General</option>';
                modalHTML += '</select>';
                modalHTML += '<textarea id="newProtocolContent" placeholder="Protocol steps, notes, reagents, etc." style="width: 100%; height: 120px; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical;"></textarea>';
                modalHTML += '<button onclick="addProtocol()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚ûï Add Protocol</button>';
                modalHTML += '</div>';

                // Protocol list
                modalHTML += '<div id="protocolList"></div>';

                modalHTML += '</div></div>';

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('protocolModal');
            }

            renderProtocolList();
            modal.style.display = 'block';
        }

        function closeProtocolModal() {
            document.getElementById('protocolModal').style.display = 'none';
        }

        function addProtocol() {
            var name = document.getElementById('newProtocolName').value.trim();
            var stage = document.getElementById('newProtocolStage').value;
            var content = document.getElementById('newProtocolContent').value.trim();

            if (!name || !stage || !content) {
                alert('Please fill in all fields');
                return;
            }

            var protocol = {
                id: Date.now(),
                name: name,
                stage: stage,
                content: content,
                dateAdded: new Date().toLocaleDateString(),
                lastModified: new Date().toLocaleDateString()
            };

            protocols.push(protocol);
            localStorage.setItem('protocolLibrary', JSON.stringify(protocols));

            // Clear form
            document.getElementById('newProtocolName').value = '';
            document.getElementById('newProtocolStage').value = '';
            document.getElementById('newProtocolContent').value = '';

            renderProtocolList();
            alert('‚úÖ Protocol "' + name + '" added!');
        }

        function renderProtocolList() {
            var listDiv = document.getElementById('protocolList');
            var html = '';

            if (protocols.length === 0) {
                html = '<p style="text-align: center; color: #6c757d; padding: 40px;">No protocols yet. Add your first protocol above!</p>';
            } else {
                // Group by stage
                var byStage = {};
                for (var i = 0; i < protocols.length; i++) {
                    var p = protocols[i];
                    if (!byStage[p.stage]) byStage[p.stage] = [];
                    byStage[p.stage].push(p);
                }

                for (var stage in byStage) {
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h3 style="background: #667eea; color: white; padding: 10px; border-radius: 6px; margin: 0 0 10px 0;">' + stage + '</h3>';

                    for (var i = 0; i < byStage[stage].length; i++) {
                        var p = byStage[stage][i];
                        html += '<div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: white;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                        html += '<h4 style="margin: 0; color: #667eea;">' + p.name + '</h4>';
                        html += '<div>';
                        html += '<button onclick="deleteProtocol(' + p.id + ')" style="background: #dc3545; color: white; padding: 4px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>';
                        html += '</div>';
                        html += '</div>';
                        html += '<pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-size: 12px; margin: 0; border: 1px solid #dee2e6;">' + p.content + '</pre>';
                        html += '<div style="font-size: 11px; color: #6c757d; margin-top: 8px;">Added: ' + p.dateAdded + ' | Last modified: ' + p.lastModified + '</div>';
                        html += '</div>';
                    }

                    html += '</div>';
                }
            }

            listDiv.innerHTML = html;
        }

        function deleteProtocol(id) {
            if (!confirm('Delete this protocol?')) return;

            protocols = protocols.filter(function(p) { return p.id !== id; });
            localStorage.setItem('protocolLibrary', JSON.stringify(protocols));
            renderProtocolList();
        }

        // Tech Performance Dashboard
        function showTechDashboard() {
            var techStats = {};

            // Collect per-tech statistics
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Track who added the sample
                if (s.initials) {
                    if (!techStats[s.initials]) {
                        techStats[s.initials] = {
                            samplesAdded: 0,
                            bapProcessed: 0,
                            tsbProcessed: 0,
                            extractionProcessed: 0,
                            cleanExtractionProcessed: 0,
                            indexingProcessed: 0,
                            qcPasses: 0,
                            qcFails: 0,
                            completed: 0
                        };
                    }
                    techStats[s.initials].samplesAdded++;
                    if (s.status === 'Qubit Complete') techStats[s.initials].completed++;
                }

                // Track who processed BAP
                if (s.bapDetails && s.bapDetails.technician) {
                    var tech = s.bapDetails.technician;
                    if (!techStats[tech]) techStats[tech] = { samplesAdded: 0, bapProcessed: 0, tsbProcessed: 0, extractionProcessed: 0, cleanExtractionProcessed: 0, indexingProcessed: 0, qcPasses: 0, qcFails: 0, completed: 0 };
                    techStats[tech].bapProcessed++;
                }

                // Track who processed TSB
                if (s.tsbDetails && s.tsbDetails.technician) {
                    var tech = s.tsbDetails.technician;
                    if (!techStats[tech]) techStats[tech] = { samplesAdded: 0, bapProcessed: 0, tsbProcessed: 0, extractionProcessed: 0, cleanExtractionProcessed: 0, indexingProcessed: 0, qcPasses: 0, qcFails: 0, completed: 0 };
                    techStats[tech].tsbProcessed++;
                }

                // Track who processed Extraction
                if (s.extractionDetails && s.extractionDetails.technician) {
                    var tech = s.extractionDetails.technician;
                    if (!techStats[tech]) techStats[tech] = { samplesAdded: 0, bapProcessed: 0, tsbProcessed: 0, extractionProcessed: 0, cleanExtractionProcessed: 0, indexingProcessed: 0, qcPasses: 0, qcFails: 0, completed: 0 };
                    techStats[tech].extractionProcessed++;
                }

                // Track who processed Clean Extraction
                if (s.cleanExtractionDetails && s.cleanExtractionDetails.technician) {
                    var tech = s.cleanExtractionDetails.technician;
                    if (!techStats[tech]) techStats[tech] = { samplesAdded: 0, bapProcessed: 0, tsbProcessed: 0, extractionProcessed: 0, cleanExtractionProcessed: 0, indexingProcessed: 0, qcPasses: 0, qcFails: 0, completed: 0 };
                    techStats[tech].cleanExtractionProcessed++;

                    // Track QC pass/fail
                    if (s.cleanExtractionDetails.qubitConcentration) {
                        var qc = checkQCThreshold(parseFloat(s.cleanExtractionDetails.qubitConcentration), 'CE');
                        if (qc.pass) techStats[tech].qcPasses++;
                        else techStats[tech].qcFails++;
                    }
                }

                // Track who processed Indexing
                if (s.indexingDetails && s.indexingDetails.technician) {
                    var tech = s.indexingDetails.technician;
                    if (!techStats[tech]) techStats[tech] = { samplesAdded: 0, bapProcessed: 0, tsbProcessed: 0, extractionProcessed: 0, cleanExtractionProcessed: 0, indexingProcessed: 0, qcPasses: 0, qcFails: 0, completed: 0 };
                    techStats[tech].indexingProcessed++;

                    // Track QC pass/fail
                    if (s.indexingDetails.qubitConcentration) {
                        var qc = checkQCThreshold(parseFloat(s.indexingDetails.qubitConcentration), 'Final');
                        if (qc.pass) techStats[tech].qcPasses++;
                        else techStats[tech].qcFails++;
                    }
                }
            }

            // Build report
            var report = 'üìä TECH PERFORMANCE DASHBOARD\n';
            report += '================================\n\n';

            for (var tech in techStats) {
                var stats = techStats[tech];
                var totalProcessed = stats.bapProcessed + stats.tsbProcessed + stats.extractionProcessed + stats.cleanExtractionProcessed + stats.indexingProcessed;
                var qcPassRate = (stats.qcPasses + stats.qcFails) > 0 ? Math.round((stats.qcPasses / (stats.qcPasses + stats.qcFails)) * 100) : 0;
                var completionRate = stats.samplesAdded > 0 ? Math.round((stats.completed / stats.samplesAdded) * 100) : 0;

                report += 'üë§ ' + tech + '\n';
                report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                report += '‚Ä¢ Samples Added: ' + stats.samplesAdded + '\n';
                report += '‚Ä¢ Completed: ' + stats.completed + ' (' + completionRate + '%)\n';
                report += '‚Ä¢ Total Processes: ' + totalProcessed + '\n';
                report += '  - BAP: ' + stats.bapProcessed + '\n';
                report += '  - TSB: ' + stats.tsbProcessed + '\n';
                report += '  - Extraction: ' + stats.extractionProcessed + '\n';
                report += '  - Clean Extraction: ' + stats.cleanExtractionProcessed + '\n';
                report += '  - Indexing: ' + stats.indexingProcessed + '\n';
                report += '‚Ä¢ QC Performance:\n';
                report += '  - Passes: ' + stats.qcPasses + '\n';
                report += '  - Fails: ' + stats.qcFails + '\n';
                report += '  - Pass Rate: ' + qcPassRate + '%\n';
                report += '\n';
            }

            alert(report);
        }

        function renderAnalytics() {
            var html = '';

            // Calculate analytics
            var totalSamples = samples.length;
            var statusCounts = {};
            var techCounts = {};
            var dailyThroughput = {};
            var avgTimePerStage = {};
            var flagCounts = { 'Rush': 0, 'Hold': 0, 'Review': 0 };
            var weeklyThroughput = {};
            var monthlyThroughput = {};

            // Define pipeline stages for funnel
            var pipelineStages = [
                {name: 'Received', statuses: ['Received']},
                {name: 'BAP', statuses: ['BAP In Progress', 'BAP Complete']},
                {name: 'TSB', statuses: ['TSB In Progress', 'TSB Complete']},
                {name: 'Extraction', statuses: ['Extraction Complete']},
                {name: 'Clean Extraction', statuses: ['Clean Extraction Complete']},
                {name: 'CE Qubit', statuses: ['Clean Extraction Qubit Complete']},
                {name: 'Indexing', statuses: ['Indexing Complete']},
                {name: 'Complete', statuses: ['Qubit Complete']}
            ];

            var stageCounts = {};
            pipelineStages.forEach(function(stage) {
                stageCounts[stage.name] = 0;
            });

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Count by status
                statusCounts[s.status] = (statusCounts[s.status] || 0) + 1;

                // Count flags
                if (s.flag && flagCounts.hasOwnProperty(s.flag)) {
                    flagCounts[s.flag]++;
                }

                // Count samples in each pipeline stage (cumulative - samples that have reached each stage)
                pipelineStages.forEach(function(stage) {
                    if (stage.statuses.indexOf(s.status) !== -1 || hasPassedStage(s, stage.statuses)) {
                        stageCounts[stage.name]++;
                    }
                });

                // Count by technician
                if (s.initials) techCounts[s.initials] = (techCounts[s.initials] || 0) + 1;
                if (s.bapDetails && s.bapDetails.tech) techCounts[s.bapDetails.tech] = (techCounts[s.bapDetails.tech] || 0) + 1;
                if (s.tsbDetails && s.tsbDetails.tech) techCounts[s.tsbDetails.tech] = (techCounts[s.tsbDetails.tech] || 0) + 1;

                // Daily throughput (samples added per day)
                var dateKey = s.dateAdded.split('T')[0];
                dailyThroughput[dateKey] = (dailyThroughput[dateKey] || 0) + 1;

                // Weekly throughput (group by week)
                var weekKey = getWeekKey(dateKey);
                weeklyThroughput[weekKey] = (weeklyThroughput[weekKey] || 0) + 1;

                // Monthly throughput
                var monthKey = dateKey.substring(0, 7); // YYYY-MM
                monthlyThroughput[monthKey] = (monthlyThroughput[monthKey] || 0) + 1;
            }

            // Calculate bottlenecks (stages with most samples currently stuck)
            var bottlenecks = [];
            for (var status in statusCounts) {
                if (status !== 'Qubit Complete') {
                    bottlenecks.push({status: status, count: statusCounts[status]});
                }
            }
            bottlenecks.sort(function(a, b) { return b.count - a.count; });
            var topBottleneck = bottlenecks[0] || {status: 'None', count: 0};

            // Calculate throughput metrics
            var datesArray = Object.keys(dailyThroughput).sort();
            var avgDailyThroughput = datesArray.length > 0 ? Math.round(totalSamples / datesArray.length) : 0;

            // Calculate samples processed in last 7 days
            var last7Days = datesArray.slice(-7);
            var samplesLast7Days = last7Days.reduce(function(sum, date) {
                return sum + dailyThroughput[date];
            }, 0);

            // Top stats grid - enhanced with more metrics
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Samples</div><div class="stat-value" style="color: white;">' + totalSamples + '</div></div>';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">Completed</div><div class="stat-value" style="color: white;">' + (statusCounts['Qubit Complete'] || 0) + '</div></div>';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">In Progress</div><div class="stat-value" style="color: white;">' + (totalSamples - (statusCounts['Qubit Complete'] || 0)) + '</div></div>';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">Completion Rate</div><div class="stat-value" style="color: white;">' + (totalSamples > 0 ? Math.round(((statusCounts['Qubit Complete'] || 0) / totalSamples) * 100) : 0) + '%</div></div>';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">Avg/Day</div><div class="stat-value" style="color: white;">' + avgDailyThroughput + '</div></div>';
            html += '<div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;"><div class="stat-label" style="color: rgba(255,255,255,0.9);">Last 7 Days</div><div class="stat-value" style="color: white;">' + samplesLast7Days + '</div></div>';
            html += '</div>';

            // Alert cards for flags and bottlenecks
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">';
            html += '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px;">';
            html += '<div style="font-weight: 600; color: #92400e; margin-bottom: 10px;">‚ö†Ô∏è Flagged Samples</div>';
            html += '<div style="display: flex; gap: 15px; font-size: 14px;">';
            html += '<span>üî¥ Rush: <strong>' + flagCounts['Rush'] + '</strong></span>';
            html += '<span>‚è∏Ô∏è Hold: <strong>' + flagCounts['Hold'] + '</strong></span>';
            html += '<span>‚ö†Ô∏è Review: <strong>' + flagCounts['Review'] + '</strong></span>';
            html += '</div></div>';
            html += '<div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px;">';
            html += '<div style="font-weight: 600; color: #1e40af; margin-bottom: 10px;">üîç Largest Bottleneck</div>';
            html += '<div style="font-size: 14px;">' + topBottleneck.status + ': <strong style="font-size: 20px;">' + topBottleneck.count + ' samples</strong></div>';
            html += '</div></div>';

            // Charts grid
            html += '<div class="analytics-grid">';

            // WORKFLOW FUNNEL CHART - New!
            html += '<div class="chart-container" style="grid-column: 1 / -1;">';
            html += '<div class="chart-title">üîÄ Workflow Funnel - Sample Flow Through Pipeline</div>';
            html += '<div style="padding: 20px;">';
            var maxStageCount = totalSamples;
            pipelineStages.forEach(function(stage, index) {
                var count = stageCounts[stage.name];
                var percentage = maxStageCount > 0 ? (count / maxStageCount) * 100 : 0;
                var barWidth = Math.max(percentage, 5); // Min 5% so it's visible
                var dropoff = index > 0 ? stageCounts[pipelineStages[index - 1].name] - count : 0;

                // Color gradient for funnel
                var colors = ['#6c757d', '#28a745', '#ffc107', '#9c27b0', '#4caf50', '#17a2b8', '#007bff', '#10b981'];
                var bgColor = colors[index];

                html += '<div style="margin-bottom: 15px;">';
                html += '<div style="display: flex; align-items: center; margin-bottom: 5px;">';
                html += '<span style="width: 120px; font-weight: 600; font-size: 13px;">' + stage.name + '</span>';
                html += '<div style="flex: 1; background: #e9ecef; border-radius: 8px; height: 32px; position: relative; overflow: hidden;">';
                html += '<div style="background: linear-gradient(90deg, ' + bgColor + ' 0%, ' + bgColor + 'dd 100%); height: 100%; width: ' + barWidth + '%; display: flex; align-items: center; padding: 0 12px; color: white; font-weight: 600; font-size: 14px; transition: width 0.5s; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                html += count + ' samples (' + Math.round(percentage) + '%)';
                html += '</div></div>';
                if (dropoff > 0) {
                    html += '<span style="margin-left: 10px; color: #dc3545; font-size: 12px; font-weight: 600;">‚Üì ' + dropoff + ' dropped</span>';
                }
                html += '</div></div>';
            });
            html += '</div></div>';

            // THROUGHPUT TREND LINE CHART - New!
            html += '<div class="chart-container" style="grid-column: 1 / -1;">';
            html += '<div class="chart-title">üìà Throughput Trend - Samples Per Day (Last 30 Days)</div>';
            html += '<div style="padding: 20px; position: relative; height: 200px;">';

            var last30Days = datesArray.slice(-30);
            if (last30Days.length > 0) {
                var maxDaily = Math.max.apply(null, last30Days.map(function(d) { return dailyThroughput[d]; }));
                var chartHeight = 150;

                html += '<div style="display: flex; height: ' + chartHeight + 'px; align-items: flex-end; gap: 3px; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">';

                last30Days.forEach(function(date, index) {
                    var count = dailyThroughput[date];
                    var barHeight = maxDaily > 0 ? (count / maxDaily) * chartHeight : 0;
                    var isWeekend = new Date(date).getDay() === 0 || new Date(date).getDay() === 6;
                    var barColor = isWeekend ? '#fbbf24' : '#3b82f6';

                    html += '<div style="flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer;" title="' + date + ': ' + count + ' samples">';
                    html += '<div style="background: linear-gradient(180deg, ' + barColor + ' 0%, ' + barColor + 'aa 100%); width: 100%; height: ' + barHeight + 'px; border-radius: 3px 3px 0 0; transition: opacity 0.2s; box-shadow: 0 -2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.opacity=\'0.7\'" onmouseout="this.style.opacity=\'1\'"></div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '<div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #6c757d;">';
                html += '<span>' + last30Days[0] + '</span>';
                html += '<span>Peak: ' + maxDaily + ' samples</span>';
                html += '<span>' + last30Days[last30Days.length - 1] + '</span>';
                html += '</div>';
            } else {
                html += '<div style="text-align: center; color: #adb5bd; padding: 60px 0;">No data available</div>';
            }

            html += '</div></div>';

            // Status distribution chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üìä Samples by Status</div>';
            html += '<div class="bar-chart">';
            var maxStatusCount = Math.max.apply(null, Object.values(statusCounts));
            for (var status in statusCounts) {
                var count = statusCounts[status];
                var percentage = maxStatusCount > 0 ? (count / maxStatusCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + status + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%;">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Technician workload chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üë• Work by Technician</div>';
            html += '<div class="bar-chart">';
            var maxTechCount = Math.max.apply(null, Object.values(techCounts));
            var sortedTechs = Object.keys(techCounts).sort(function(a, b) {
                return techCounts[b] - techCounts[a];
            });
            for (var t = 0; t < sortedTechs.length && t < 10; t++) {
                var tech = sortedTechs[t];
                var count = techCounts[tech];
                var percentage = maxTechCount > 0 ? (count / maxTechCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + tech + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Daily throughput chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üìÖ Daily Sample Input</div>';
            html += '<div class="bar-chart">';
            var sortedDates = Object.keys(dailyThroughput).sort().slice(-14); // Last 14 days
            var maxDailyCount = Math.max.apply(null, sortedDates.map(function(d) { return dailyThroughput[d]; }));
            for (var d = 0; d < sortedDates.length; d++) {
                var date = sortedDates[d];
                var count = dailyThroughput[date];
                var percentage = maxDailyCount > 0 ? (count / maxDailyCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + date + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Stage completion rates
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üéØ Stage Completion Rates</div>';
            html += '<div class="bar-chart">';
            var stages = [
                { name: 'BAP', key: 'BAP Complete' },
                { name: 'TSB', key: 'TSB Complete' },
                { name: 'Extraction', key: 'Extraction Complete' },
                { name: 'Clean Extract', key: 'Clean Extraction Complete' },
                { name: 'CE Qubit', key: 'Clean Extraction Qubit Complete' },
                { name: 'Indexing', key: 'Indexing Complete' },
                { name: 'Final Qubit', key: 'Qubit Complete' }
            ];

            for (var st = 0; st < stages.length; st++) {
                var stage = stages[st];
                var completed = 0;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].status === stage.key || isStageComplete(samples[i], stage.key)) {
                        completed++;
                    }
                }
                var percentage = totalSamples > 0 ? (completed / totalSamples) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + stage.name + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);">' + completed + ' (' + Math.round(percentage) + '%)</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            html += '</div>'; // Close analytics-grid

            document.getElementById('analyticsContainer').innerHTML = html;
        }

        function isStageComplete(sample, stage) {
            var stageOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete', 'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];
            var currentIndex = stageOrder.indexOf(sample.status);
            var checkIndex = stageOrder.indexOf(stage);
            return currentIndex >= checkIndex;
        }

        // Helper function to check if sample has passed a specific stage
        function hasPassedStage(sample, statuses) {
            var stageOrder = ['Received', 'BAP In Progress', 'BAP Complete', 'TSB In Progress', 'TSB Complete', 'Extraction Complete', 'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];
            var currentIndex = stageOrder.indexOf(sample.status);

            for (var i = 0; i < statuses.length; i++) {
                var stageIndex = stageOrder.indexOf(statuses[i]);
                if (currentIndex >= stageIndex) {
                    return true;
                }
            }
            return false;
        }

        // Helper function to get week key for grouping (returns ISO week string)
        function getWeekKey(dateString) {
            var date = new Date(dateString);
            var year = date.getFullYear();
            var firstDayOfYear = new Date(year, 0, 1);
            var pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            var weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            return year + '-W' + String(weekNumber).padStart(2, '0');
        }

        function showTimeline() {
            document.getElementById('timelineModal').style.display = 'block';
            renderTimeline();
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        // Close timeline modal when clicking outside
        window.addEventListener('click', function(event) {
            var modal = document.getElementById('timelineModal');
            if (event.target === modal) {
                closeTimelineModal();
            }
        });

        function renderTimeline() {
            var view = document.getElementById('timelineView').value;
            var events = [];

            // Collect all events from samples
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Add sample received event
                events.push({
                    date: s.dateAdded,
                    sampleId: s.id,
                    stage: 'Received',
                    tech: s.initials,
                    details: 'Sample received and logged'
                });

                // Add BAP event
                if (s.bapDetails) {
                    var bapDetails = 'Lot: ' + s.bapDetails.lotNumber + ', ' + s.bapDetails.temperature + '¬∞C, ' + s.bapDetails.incubator;
                    if (s.bapDetails.timeIn) bapDetails += ', In: ' + s.bapDetails.timeIn;
                    if (s.bapDetails.timeOut) bapDetails += ', Out: ' + s.bapDetails.timeOut;
                    events.push({
                        date: s.bapDetails.completionDate,
                        sampleId: s.id,
                        stage: 'BAP Complete',
                        tech: s.bapDetails.tech,
                        details: bapDetails
                    });
                }

                // Add TSB event
                if (s.tsbDetails) {
                    var tsbDetails = 'Lot: ' + s.tsbDetails.lotNumber;
                    if (s.tsbDetails.temperature && s.tsbDetails.incubator) {
                        tsbDetails += ', ' + s.tsbDetails.temperature + '¬∞C, ' + s.tsbDetails.incubator;
                    }
                    if (s.tsbDetails.timeIn) tsbDetails += ', In: ' + s.tsbDetails.timeIn;
                    if (s.tsbDetails.timeOut) tsbDetails += ', Out: ' + s.tsbDetails.timeOut;
                    if (s.tsbDetails.storagePlate) {
                        tsbDetails += ', Plate: ' + s.tsbDetails.storagePlate + ', Well: ' + s.tsbDetails.wellPosition;
                    }
                    events.push({
                        date: s.tsbDetails.completionDate,
                        sampleId: s.id,
                        stage: 'TSB Complete',
                        tech: s.tsbDetails.tech,
                        details: tsbDetails
                    });
                }

                // Add Extraction event
                if (s.extractionDetails) {
                    events.push({
                        date: s.extractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Extraction Complete',
                        tech: s.extractionDetails.tech,
                        details: 'Run: ' + s.extractionDetails.extractionRun + ', Plate: ' + s.extractionDetails.storagePlate
                    });
                }

                // Add Clean Extraction event
                if (s.cleanExtractionDetails) {
                    events.push({
                        date: s.cleanExtractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Clean Extraction Complete',
                        tech: s.cleanExtractionDetails.tech,
                        details: 'Run: ' + s.cleanExtractionDetails.extractionRun + ', Plate: ' + s.cleanExtractionDetails.storagePlate
                    });
                }

                // Add CE Qubit event
                if (s.cleanExtractionQubitDetails) {
                    events.push({
                        date: s.cleanExtractionQubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'CE Qubit Complete',
                        tech: s.cleanExtractionQubitDetails.tech,
                        details: 'Concentration: ' + s.cleanExtractionQubitDetails.concentration + ' ng/uL'
                    });
                }

                // Add Indexing event
                if (s.indexingDetails) {
                    events.push({
                        date: s.indexingDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Indexing Complete',
                        tech: s.indexingDetails.tech,
                        details: 'i5: ' + s.indexingDetails.i5Index + ', i7: ' + s.indexingDetails.i7Index
                    });
                }

                // Add Final Qubit event
                if (s.qubitDetails) {
                    events.push({
                        date: s.qubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Qubit Complete',
                        tech: s.qubitDetails.tech,
                        details: 'Concentration: ' + s.qubitDetails.concentration + ' ng/uL'
                    });
                }
            }

            // Filter by view
            var now = new Date();
            if (view === 'recent') {
                var sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= sevenDaysAgo;
                });
            } else if (view === 'month') {
                var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= thirtyDaysAgo;
                });
            }

            // Sort by date (newest first)
            events.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });

            // Render timeline
            var html = '<div class="timeline">';

            if (events.length === 0) {
                html += '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No events to display</p>';
            } else {
                for (var i = 0; i < events.length; i++) {
                    var event = events[i];
                    var stageColor = getStageColor(event.stage);

                    html += '<div class="timeline-item">';
                    html += '<div class="timeline-date">' + formatDate(event.date) + '</div>';
                    html += '<div class="timeline-marker" style="background: ' + stageColor + ';"></div>';
                    html += '<div class="timeline-content" style="border-left-color: ' + stageColor + ';">';
                    html += '<h4>' + event.sampleId + ' <span class="timeline-stage" style="background: ' + stageColor + '; color: white;">' + event.stage + '</span></h4>';
                    html += '<p>üë§ Technician: ' + event.tech + '</p>';
                    html += '<p>üìã ' + event.details + '</p>';
                    html += '</div>';
                    html += '</div>';
                }
            }

            html += '</div>';
            document.getElementById('timelineContainer').innerHTML = html;
        }

        function getStageColor(stage) {
            var colors = {
                'Received': '#6c757d',
                'BAP Complete': '#28a745',
                'TSB Complete': '#ffc107',
                'Extraction Complete': '#9c27b0',
                'Clean Extraction Complete': '#4caf50',
                'CE Qubit Complete': '#2196f3',
                'Indexing Complete': '#00bcd4',
                'Qubit Complete': '#ff9800'
            };
            return colors[stage] || '#007bff';
        }

        function formatDate(dateString) {
            var date = new Date(dateString);
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            var year = date.getFullYear();
            var hours = date.getHours().toString().padStart(2, '0');
            var minutes = date.getMinutes().toString().padStart(2, '0');
            return month + '/' + day + '/' + year + ' ' + hours + ':' + minutes;
        }

        function editNotes(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var currentNotes = sample.notes || '';
            var newNotes = prompt('Edit notes for sample: ' + sampleId, currentNotes);

            if (newNotes !== null) {
                sample.notes = newNotes;
                saveData();
                renderSamples();
            }
        }

        function deleteSample(sampleId) {
            // Show deletion reason modal
            var modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';

            var html = '';
            html += '<h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Delete Sample: ' + sampleId + '</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">This action cannot be undone. Please select a reason for deletion:</p>';

            html += '<div style="margin-bottom: 20px;">';
            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="deleteReason" value="Entered by mistake" style="margin-right: 10px;"> Entered by mistake';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="deleteReason" value="Duplicate sample" style="margin-right: 10px;"> Duplicate sample';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="deleteReason" value="Invalid sample" style="margin-right: 10px;"> Invalid sample';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="deleteReason" value="Test/Training entry" style="margin-right: 10px;"> Test/Training entry';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="deleteReason" value="Other" id="deleteReasonOther" style="margin-right: 10px;" onchange="document.getElementById(\'deleteReasonOtherText\').style.display = this.checked ? \'block\' : \'none\'"> Other';
            html += '</label>';

            html += '<textarea id="deleteReasonOtherText" placeholder="Please specify reason..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; display: none; font-family: inherit;" rows="3"></textarea>';
            html += '</div>';

            html += '<div style="display: flex; gap: 10px; justify-content: flex-end;">';
            html += '<button id="cancelDeleteBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>';
            html += '<button id="confirmDeleteBtn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Delete Sample</button>';
            html += '</div>';

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelDeleteBtn').onclick = function() {
                document.body.removeChild(modal);
            };

            // Confirm delete button
            document.getElementById('confirmDeleteBtn').onclick = function() {
                var selectedReason = document.querySelector('input[name="deleteReason"]:checked');

                if (!selectedReason) {
                    alert('Please select a reason for deletion');
                    return;
                }

                var reason = selectedReason.value;
                if (reason === 'Other') {
                    var otherText = document.getElementById('deleteReasonOtherText').value.trim();
                    if (!otherText) {
                        alert('Please specify the reason in the text box');
                        return;
                    }
                    reason = 'Other: ' + otherText;
                }

                try {
                    // Find and delete the sample from foodSamples array
                    for (var i = 0; i < foodSamples.length; i++) {
                        if (foodSamples[i].id === sampleId) {
                            var deletedSample = foodSamples.splice(i, 1)[0];

                            // Add to deleted samples audit trail
                            deletedSamples.push({
                                sample: deletedSample,
                                deletedDate: new Date().toISOString(),
                                deletedBy: currentUser || 'Unknown',
                                reason: reason
                            });

                            break;
                        }
                    }

                    // Also delete associated pathogen workflows
                    pathogenWorkflows = pathogenWorkflows.filter(function(wf) {
                        return wf.foodSampleId !== sampleId;
                    });

                    saveData();

                    // Close modal first
                    if (modal && modal.parentNode) {
                        document.body.removeChild(modal);
                    }

                    // Then re-render
                    renderFoodSamplesTab();  // Refresh the food samples view

                    alert('Sample ' + sampleId + ' deleted successfully.\nReason: ' + reason);
                } catch (error) {
                    console.error('Error deleting sample:', error);
                    alert('Error deleting sample: ' + error.message);
                    // Try to close modal
                    if (modal && modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                }
            };

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // Toggle individual sample selection
        function toggleSampleSelectionForDelete(sampleId) {
            var index = selectedSamplesForDelete.indexOf(sampleId);

            if (index === -1) {
                // Add to selection
                selectedSamplesForDelete.push(sampleId);
            } else {
                // Remove from selection
                selectedSamplesForDelete.splice(index, 1);
            }

            renderFoodSamplesTab();
            updateBulkDeleteButton();
        }

        // Select all samples
        function selectAllSamples() {
            selectedSamplesForDelete = foodSamples.map(function(s) { return s.id; });
            renderFoodSamplesTab();
            updateBulkDeleteButton();
        }

        // Deselect all samples
        function deselectAllSamples() {
            selectedSamplesForDelete = [];
            renderFoodSamplesTab();
            updateBulkDeleteButton();
        }

        // Update bulk action buttons visibility and count
        function updateBulkDeleteButton() {
            var deleteBtn = document.getElementById('bulkDeleteBtn');
            var deleteCountSpan = document.getElementById('selectedCountFood');
            var editBtn = document.getElementById('bulkEditSelectedBtn');
            var editCountSpan = document.getElementById('selectedEditCount');

            // Update delete button
            if (deleteBtn && deleteCountSpan) {
                if (selectedSamplesForDelete.length > 0) {
                    deleteBtn.style.display = 'inline-block';
                    deleteCountSpan.textContent = selectedSamplesForDelete.length;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }

            // Update edit button
            if (editBtn && editCountSpan) {
                if (selectedSamplesForDelete.length > 0) {
                    editBtn.style.display = 'inline-block';
                    editCountSpan.textContent = selectedSamplesForDelete.length;
                } else {
                    editBtn.style.display = 'none';
                }
            }
        }

        // Bulk delete selected samples
        function bulkDeleteSamples() {
            if (selectedSamplesForDelete.length === 0) {
                alert('No samples selected for deletion');
                return;
            }

            var count = selectedSamplesForDelete.length;
            var samplesList = selectedSamplesForDelete.join(', ');

            // Show deletion reason modal
            var modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto;';

            var html = '';
            html += '<h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Delete ' + count + ' Sample' + (count > 1 ? 's' : '') + '</h3>';
            html += '<p style="color: #666; margin-bottom: 15px;">This action cannot be undone. This will delete the selected samples and all associated pathogen workflows.</p>';

            html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">';
            html += '<strong>Samples to be deleted:</strong><br>';
            html += '<div style="margin-top: 8px; font-size: 13px; color: #333;">';
            selectedSamplesForDelete.forEach(function(id) {
                html += '‚Ä¢ ' + id + '<br>';
            });
            html += '</div>';
            html += '</div>';

            html += '<p style="color: #666; margin-bottom: 20px;">Please select a reason for deletion:</p>';

            html += '<div style="margin-bottom: 20px;">';
            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="bulkDeleteReason" value="Entered by mistake" style="margin-right: 10px;"> Entered by mistake';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="bulkDeleteReason" value="Duplicate samples" style="margin-right: 10px;"> Duplicate samples';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="bulkDeleteReason" value="Invalid samples" style="margin-right: 10px;"> Invalid samples';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="bulkDeleteReason" value="Test/Training entries" style="margin-right: 10px;"> Test/Training entries';
            html += '</label>';

            html += '<label style="display: block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
            html += '<input type="radio" name="bulkDeleteReason" value="Other" id="bulkDeleteReasonOther" style="margin-right: 10px;" onchange="document.getElementById(\'bulkDeleteReasonOtherText\').style.display = this.checked ? \'block\' : \'none\'"> Other';
            html += '</label>';

            html += '<textarea id="bulkDeleteReasonOtherText" placeholder="Please specify reason..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; display: none; font-family: inherit;" rows="3"></textarea>';
            html += '</div>';

            html += '<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">';
            html += '<button id="cancelBulkDeleteBtn" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; min-width: 120px;">Cancel</button>';
            html += '<button id="confirmBulkDeleteBtn" style="padding: 12px 30px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; min-width: 140px;">Delete ' + count + ' Sample' + (count > 1 ? 's' : '') + '</button>';
            html += '</div>';

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelBulkDeleteBtn').onclick = function() {
                document.body.removeChild(modal);
            };

            // Confirm delete button
            document.getElementById('confirmBulkDeleteBtn').onclick = function() {
                var selectedReason = document.querySelector('input[name="bulkDeleteReason"]:checked');

                if (!selectedReason) {
                    alert('Please select a reason for deletion');
                    return;
                }

                var reason = selectedReason.value;
                if (reason === 'Other') {
                    var otherText = document.getElementById('bulkDeleteReasonOtherText').value.trim();
                    if (!otherText) {
                        alert('Please specify the reason in the text box');
                        return;
                    }
                    reason = 'Other: ' + otherText;
                }

                // Show processing message for large deletions
                var deleteBtn = document.getElementById('confirmBulkDeleteBtn');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.style.opacity = '0.6';

                // Use setTimeout to allow UI to update
                setTimeout(function() {
                    try {
                        // Delete all selected samples
                        var deletedCount = 0;
                        var samplesToDelete = selectedSamplesForDelete.slice(); // Make a copy of the array

                        // Delete pathogen workflows in one pass (more efficient)
                        pathogenWorkflows = pathogenWorkflows.filter(function(wf) {
                            return samplesToDelete.indexOf(wf.foodSampleId) === -1;
                        });

                        // Delete food samples
                        samplesToDelete.forEach(function(sampleId) {
                            for (var i = 0; i < foodSamples.length; i++) {
                                if (foodSamples[i].id === sampleId) {
                                    var deletedSample = foodSamples.splice(i, 1)[0];

                                    // Add to deleted samples audit trail
                                    deletedSamples.push({
                                        sample: deletedSample,
                                        deletedDate: new Date().toISOString(),
                                        deletedBy: currentUser || 'Unknown',
                                        reason: reason
                                    });

                                    deletedCount++;
                                    break;
                                }
                            }
                        });

                        // Clear selection
                        selectedSamplesForDelete = [];

                        saveData();

                        // Close modal first
                        if (modal && modal.parentNode) {
                            document.body.removeChild(modal);
                        }

                        // Then re-render
                        renderFoodSamplesTab();

                        // Use the count from the original selection (always accurate)
                        alert(count + ' sample' + (count > 1 ? 's' : '') + ' deleted successfully.\nReason: ' + reason);
                    } catch (error) {
                        console.error('Error deleting samples:', error);
                        alert('Error deleting samples: ' + error.message);
                        // Re-enable button on error
                        if (deleteBtn) {
                            deleteBtn.disabled = false;
                            deleteBtn.textContent = 'Delete Samples';
                            deleteBtn.style.opacity = '1';
                        }
                        // Try to close modal
                        if (modal && modal.parentNode) {
                            document.body.removeChild(modal);
                        }
                    }
                }, 100);
            };

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // View workflow history for a food sample
        function viewSampleHistory(sampleId) {
            // Find the food sample
            var foodSample = foodSamples.find(function(s) { return s.id === sampleId; });
            if (!foodSample) {
                alert('Sample not found');
                return;
            }

            // Find all workflows for this sample
            var sampleWorkflows = pathogenWorkflows.filter(function(wf) {
                return wf.foodSampleId === sampleId;
            });

            // Create modal
            var modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';

            var html = '';
            html += '<h2 style="margin-top: 0; color: #667eea;">üìã Workflow History: ' + sampleId + '</h2>';
            html += '<p style="color: #666; margin-bottom: 20px;">View and edit all completed stages for this sample</p>';

            // Sample info
            html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 13px;">';
            html += '<div><strong>Store:</strong> ' + foodSample.storeNum + '</div>';
            html += '<div><strong>Brand:</strong> ' + (foodSample.brand || 'N/A') + '</div>';
            html += '<div><strong>Received:</strong> ' + foodSample.dateReceived + '</div>';
            html += '</div>';
            html += '</div>';

            if (sampleWorkflows.length === 0) {
                html += '<div style="text-align: center; padding: 40px; color: #999;">';
                html += '<div style="font-size: 48px; margin-bottom: 10px;">üî¨</div>';
                html += '<div style="font-size: 16px;">No workflow stages completed yet</div>';
                html += '<div style="font-size: 14px; margin-top: 5px;">Process samples in the pathogen testing tabs to see history here</div>';
                html += '</div>';
            } else {
                // Show workflows by pathogen
                sampleWorkflows.forEach(function(wf) {
                    var pathogen = pathogens[wf.pathogenCode];
                    if (!pathogen) return;

                    html += '<div style="border: 2px solid ' + pathogen.color + '; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: ' + pathogen.color + '08;">';
                    html += '<h3 style="margin-top: 0; color: ' + pathogen.color + ';">' + pathogen.icon + ' ' + pathogen.name + ' (' + wf.pathogenCode + ')</h3>';

                    // List all completed stages
                    var hasCompletedStages = false;
                    var stageKeys = Object.keys(wf.stages);

                    html += '<div style="display: flex; flex-direction: column; gap: 10px;">';

                    stageKeys.forEach(function(stageKey) {
                        var stage = wf.stages[stageKey];
                        if (stage && stage.completed) {
                            hasCompletedStages = true;
                            var edited = stage.edited || false;

                            html += '<div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">';
                            html += '<div style="display: flex; justify-content: space-between; align-items: start;">';

                            // Stage info
                            html += '<div style="flex: 1;">';
                            html += '<div style="font-weight: 600; margin-bottom: 5px;">' + getStageName(stageKey);
                            if (edited) {
                                html += ' <span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">‚úèÔ∏è EDITED</span>';
                            }
                            html += '</div>';
                            html += '<div style="font-size: 12px; color: #666;">';
                            if (stage.date) html += 'üìÖ ' + stage.date + '<br>';
                            if (stage.time) html += 'üïê ' + stage.time + '<br>';
                            if (stage.reagentLot) html += 'üß™ Lot: ' + stage.reagentLot + '<br>';
                            if (stage.result) html += 'üìä Result: ' + stage.result;
                            html += '</div>';
                            html += '</div>';

                            // Edit button
                            html += '<div>';
                            html += '<button onclick="editWorkflowStage(\'' + wf.id + '\', \'' + stageKey + '\')" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úèÔ∏è Edit</button>';
                            html += '</div>';

                            html += '</div>'; // End flex container

                            // Show edit history if exists
                            if (stage.editHistory && stage.editHistory.length > 0) {
                                html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">';
                                html += '<div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 5px;">EDIT HISTORY:</div>';
                                stage.editHistory.forEach(function(edit) {
                                    html += '<div style="font-size: 11px; color: #888; margin-bottom: 3px;">';
                                    html += '‚Ä¢ ' + edit.timestamp + ' by ' + edit.user;
                                    if (edit.reason) html += ' - ' + edit.reason;
                                    html += '</div>';
                                });
                                html += '</div>';
                            }

                            html += '</div>'; // End stage card
                        }
                    });

                    html += '</div>'; // End stages list

                    if (!hasCompletedStages) {
                        html += '<div style="text-align: center; padding: 20px; color: #999; font-style: italic;">No stages completed yet for this pathogen</div>';
                    }

                    html += '</div>'; // End pathogen section
                });
            }

            html += '<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">';
            html += '<button onclick="closeHistoryModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>';
            html += '</div>';

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeHistoryModal();
                }
            };
        }

        function closeHistoryModal() {
            var modal = document.getElementById('historyModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Edit a completed workflow stage with audit trail
        function editWorkflowStage(workflowId, stageKey) {
            // Find the workflow
            var workflow = pathogenWorkflows.find(function(wf) { return wf.id === workflowId; });
            if (!workflow) {
                alert('Workflow not found');
                return;
            }

            var stage = workflow.stages[stageKey];
            if (!stage) {
                alert('Stage not found');
                return;
            }

            // Store original values for audit trail
            var originalValues = JSON.parse(JSON.stringify(stage));

            // Determine which fields this stage has (based on pathogen/stage type)
            var fields = getStageFields(workflow.pathogenCode, stageKey);

            // Create edit modal
            var modal = document.createElement('div');
            modal.id = 'editStageModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';

            var html = '';
            html += '<h3 style="margin-top: 0; color: #17a2b8;">‚úèÔ∏è Edit Stage: ' + getStageName(stageKey) + '</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">Sample: ' + workflow.foodSampleId + ' - ' + workflow.pathogenCode + '</p>';

            // Render editable fields
            fields.forEach(function(field) {
                var value = stage[field.key] || '';

                html += '<div style="margin-bottom: 15px;">';
                html += '<label style="display: block; margin-bottom: 5px; font-weight: 600;">' + field.label + '</label>';

                if (field.type === 'date') {
                    html += '<input type="date" id="edit_' + field.key + '" value="' + value + '" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                } else if (field.type === 'time') {
                    html += '<input type="time" id="edit_' + field.key + '" value="' + value + '" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                } else if (field.type === 'select') {
                    html += '<select id="edit_' + field.key + '" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">';
                    field.options.forEach(function(opt) {
                        var selected = opt === value ? 'selected' : '';
                        html += '<option value="' + opt + '" ' + selected + '>' + opt + '</option>';
                    });
                    html += '</select>';
                } else {
                    html += '<input type="text" id="edit_' + field.key + '" value="' + value + '" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />';
                }

                html += '</div>';
            });

            // Reason for edit
            html += '<div style="margin-bottom: 15px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">';
            html += '<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #dc3545;">Reason for Edit *</label>';
            html += '<textarea id="edit_reason" placeholder="Required: Why are you making this change?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; min-height: 60px;"></textarea>';
            html += '<div style="font-size: 11px; color: #666; margin-top: 5px;">This will be recorded in the audit trail</div>';
            html += '</div>';

            // Buttons
            html += '<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">';
            html += '<button id="cancelEditBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>';
            html += '<button id="saveEditBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save Changes</button>';
            html += '</div>';

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Cancel button
            document.getElementById('cancelEditBtn').onclick = function() {
                document.body.removeChild(modal);
            };

            // Save button
            document.getElementById('saveEditBtn').onclick = function() {
                var reason = document.getElementById('edit_reason').value.trim();
                if (!reason) {
                    alert('Please provide a reason for this edit');
                    return;
                }

                // Collect new values
                var changes = [];
                fields.forEach(function(field) {
                    var newValue = document.getElementById('edit_' + field.key).value;
                    var oldValue = originalValues[field.key] || '';
                    if (newValue !== oldValue) {
                        changes.push({
                            field: field.label,
                            oldValue: oldValue,
                            newValue: newValue
                        });
                        stage[field.key] = newValue;
                    }
                });

                if (changes.length === 0) {
                    alert('No changes detected');
                    return;
                }

                // Add to edit history
                if (!stage.editHistory) {
                    stage.editHistory = [];
                }

                var now = new Date();
                var timestamp = now.toLocaleString();

                stage.editHistory.push({
                    timestamp: timestamp,
                    user: currentUser || 'Unknown',
                    reason: reason,
                    changes: changes
                });

                // Mark as edited
                stage.edited = true;

                // Save and refresh
                saveData();
                document.body.removeChild(modal);

                // Refresh the history modal
                closeHistoryModal();
                setTimeout(function() {
                    viewSampleHistory(workflow.foodSampleId);
                }, 100);

                alert('Changes saved successfully!\n\n' + changes.length + ' field(s) updated.');
            };
        }

        function getStageFields(pathogenCode, stageKey) {
            // Returns array of editable fields for a given pathogen/stage combination
            // Format: [{key: 'date', label: 'Date', type: 'date'}, ...]

            var commonFields = [
                {key: 'date', label: 'Date', type: 'date'},
                {key: 'time', label: 'Time', type: 'time'}
            ];

            // Most stages have similar fields, customize as needed
            if (stageKey.includes('MALDI')) {
                return [
                    ...commonFields,
                    {key: 'reagentLot', label: 'MALDI Plate Lot', type: 'text'},
                    {key: 'result', label: 'Result', type: 'select', options: ['Positive', 'Negative', 'Inconclusive']}
                ];
            } else if (stageKey.includes('Incubation') || stageKey.includes('Broth') || stageKey.includes('Prep')) {
                return [
                    ...commonFields,
                    {key: 'reagentLot', label: 'Media Lot', type: 'text'},
                    {key: 'incubationStart', label: 'Incubation Start', type: 'time'},
                    {key: 'incubationEnd', label: 'Incubation End', type: 'time'}
                ];
            } else if (stageKey.includes('Agar') || stageKey.includes('TCBS') || stageKey.includes('XLT4')) {
                return [
                    ...commonFields,
                    {key: 'reagentLot', label: 'Agar Lot', type: 'text'},
                    {key: 'platingTime', label: 'Plating Time', type: 'time'}
                ];
            } else if (stageKey.includes('Colonies')) {
                return [
                    ...commonFields,
                    {key: 'coloniesPicked', label: 'Colonies Picked', type: 'text'},
                    {key: 'notes', label: 'Notes', type: 'text'}
                ];
            } else {
                // Default fields
                return [
                    ...commonFields,
                    {key: 'reagentLot', label: 'Reagent/Media Lot', type: 'text'},
                    {key: 'notes', label: 'Notes', type: 'text'}
                ];
            }
        }

        function getStageName(stageKey) {
            // Convert stage keys to human-readable names
            var names = {
                // Salmonella
                'day1_BPWIncubation': 'Day 1 - BPW Incubation',
                'day2_RVR_LAMP': 'Day 2 - RVR + LAMP',
                'day3_XLT4': 'Day 3 - XLT4 Agar',
                'day4_MALDI': 'Day 4 - MALDI',
                // E. coli
                'day1A_BPWPrep': 'Day 1A - BPW Preparation',
                'day1B_MacBroth': 'Day 1B - Mac Broth',
                'day2_MacAgar': 'Day 2 - Mac Agar',
                'day3_PinkColonies': 'Day 3 - Pink Colonies',
                'day4_BAP': 'Day 4 - BAP',
                'day5_MALDI': 'Day 5 - MALDI',
                // Campylobacter
                'day1_BoltonBroth': 'Day 1 - Bolton Broth',
                'day2_mCCDA': 'Day 2 - mCCDA',
                'day3_Colonies': 'Day 3 - Colonies',
                'day4_MALDI': 'Day 4 - MALDI',
                // Enterococcus (Retail Meat)
                'day1_AzidePrep': 'Day 1 - Azide Preparation',
                'day2_BEAAgar': 'Day 2 - BEA Agar',
                'day3_Colonies': 'Day 3 - Colonies',
                'day4_MALDI': 'Day 4 - MALDI',
                // Enterococcus (Seafood)
                'day1_APWPrep': 'Day 1 - APW Preparation',
                'day2_BEAAgar': 'Day 2 - BEA Agar',
                'day3_Colonies': 'Day 3 - Colonies',
                'day4_MALDI': 'Day 4 - MALDI',
                // Aeromonas
                'day1_BPWPrep': 'Day 1 - BPW Preparation',
                'day2_GSPRAgar': 'Day 2 - GSPR Agar',
                'day3_Colonies': 'Day 3 - Colonies',
                'day4_MALDI': 'Day 4 - MALDI',
                // Vibrio V1
                'day1_APWIncubation': 'Day 1 - APW Incubation',
                'day2_TCBSAgar': 'Day 2 - TCBS Agar',
                'day3_YellowColonies': 'Day 3 - Yellow Colonies',
                'day4_MALDI': 'Day 4 - MALDI',
                // Vibrio V2
                'day1_APWIncubation': 'Day 1 - APW Incubation',
                'day2_TCBSAgar': 'Day 2 - TCBS Agar',
                'day3_GreenColonies': 'Day 3 - Green Colonies',
                'day4_MALDI': 'Day 4 - MALDI'
            };
            return names[stageKey] || stageKey;
        }

        function viewSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h4 style="margin-top: 0;">Sample Information</h4>';
            html += '<p><strong>Sample ID:</strong> ' + sample.id + '</p>';
            html += '<p><strong>Current Status:</strong> <span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span></p>';
            html += '<p><strong>Date Added:</strong> ' + sample.dateAdded + '</p>';
            html += '<p><strong>Added By:</strong> ' + sample.initials + '</p>';
            if (sample.flag && sample.flag !== 'None') {
                var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                html += '<p><strong>Flag:</strong> ' + flagIcon + ' ' + sample.flag + '</p>';
            }
            if (sample.notes) {
                html += '<p><strong>Notes:</strong> ' + sample.notes + '</p>';
            }
            html += '</div>';

            // Timeline of events
            html += '<h4>üìÖ Processing Timeline</h4>';
            html += '<div style="border-left: 4px solid #007bff; padding-left: 20px;">';

            // Received
            html += '<div style="margin-bottom: 20px;">';
            html += '<div style="background: #e9ecef; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">RECEIVED</div>';
            html += '<p style="margin: 5px 0;"><strong>Date:</strong> ' + sample.dateAdded + '</p>';
            html += '<p style="margin: 5px 0;"><strong>Technician:</strong> ' + sample.initials + '</p>';
            html += '</div>';

            // BAP
            if (sample.bapDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #d4edda; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">BAP</div>';
                html += '<p style="margin: 5px 0;"><strong>BAP Number:</strong> ' + sample.bapNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Lot:</strong> ' + sample.bapDetails.lotNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Temperature:</strong> ' + sample.bapDetails.temperature + '¬∞C</p>';
                html += '<p style="margin: 5px 0;"><strong>Incubator:</strong> ' + sample.bapDetails.incubator + '</p>';
                if (sample.bapDetails.timeIn) html += '<p style="margin: 5px 0;"><strong>Time In:</strong> ' + sample.bapDetails.timeIn + '</p>';
                if (sample.bapDetails.timeOut) html += '<p style="margin: 5px 0;"><strong>Time Out:</strong> ' + sample.bapDetails.timeOut + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.bapDetails.completionDate + ' by ' + sample.bapDetails.technician + '</p>';
                html += '</div>';
            }

            // TSB
            if (sample.tsbDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #fff3cd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">TSB</div>';
                html += '<p style="margin: 5px 0;"><strong>TSB Number:</strong> ' + sample.tsbNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Lot:</strong> ' + sample.tsbDetails.lotNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Temperature:</strong> ' + sample.tsbDetails.temperature + '¬∞C</p>';
                html += '<p style="margin: 5px 0;"><strong>Incubator:</strong> ' + sample.tsbDetails.incubator + '</p>';
                if (sample.tsbDetails.timeIn) html += '<p style="margin: 5px 0;"><strong>Time In:</strong> ' + sample.tsbDetails.timeIn + '</p>';
                if (sample.tsbDetails.timeOut) html += '<p style="margin: 5px 0;"><strong>Time Out:</strong> ' + sample.tsbDetails.timeOut + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.tsbDetails.completionDate + ' by ' + sample.tsbDetails.technician + '</p>';
                html += '</div>';
            }

            // Extraction
            if (sample.extractionDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #f3e5f5; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">EXTRACTION</div>';
                html += '<p style="margin: 5px 0;"><strong>Extraction Number:</strong> ' + sample.extractionNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Run:</strong> ' + sample.extractionDetails.extractionRun + '</p>';
                if (sample.extractionDetails.reagentLots) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lots:</strong></p>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    if (sample.extractionDetails.reagentLots.aw1) html += '<li>AW1: ' + sample.extractionDetails.reagentLots.aw1 + '</li>';
                    if (sample.extractionDetails.reagentLots.aw2) html += '<li>AW2: ' + sample.extractionDetails.reagentLots.aw2 + '</li>';
                    if (sample.extractionDetails.reagentLots.ethanol) html += '<li>Ethanol: ' + sample.extractionDetails.reagentLots.ethanol + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferAL) html += '<li>Buffer AL: ' + sample.extractionDetails.reagentLots.bufferAL + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferATL) html += '<li>Buffer ATL: ' + sample.extractionDetails.reagentLots.bufferATL + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferAE) html += '<li>Buffer AE: ' + sample.extractionDetails.reagentLots.bufferAE + '</li>';
                    if (sample.extractionDetails.reagentLots.proteinaseK) html += '<li>Proteinase K: ' + sample.extractionDetails.reagentLots.proteinaseK + '</li>';
                    if (sample.extractionDetails.reagentLots.dneasy) html += '<li>DNeasy Column: ' + sample.extractionDetails.reagentLots.dneasy + '</li>';
                    html += '</ul>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.extractionDetails.completedDate + ' by ' + sample.extractionDetails.technician + '</p>';
                html += '</div>';
            }

            // Clean Extraction
            if (sample.cleanExtractionDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e8f5e8; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">CLEAN EXTRACTION</div>';
                html += '<p style="margin: 5px 0;"><strong>Clean Extraction Number:</strong> ' + sample.cleanExtractionNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Plate:</strong> ' + sample.cleanExtractionDetails.storagePlate + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Well:</strong> ' + sample.cleanExtractionDetails.wellPosition + '</p>';
                if (sample.cleanExtractionDetails.volumes) {
                    html += '<p style="margin: 5px 0;"><strong>Cleanup Volume:</strong> ' + sample.cleanExtractionDetails.volumes.cleanup + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Elution In:</strong> ' + sample.cleanExtractionDetails.volumes.elutionIn + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Elution Out:</strong> ' + sample.cleanExtractionDetails.volumes.elutionOut + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.cleanExtractionDetails.completedDate + ' by ' + sample.cleanExtractionDetails.technician + '</p>';
                html += '</div>';
            }

            // CE Qubit
            if (sample.cleanExtractionQubitDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e8f4fd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">CE QUBIT</div>';
                html += '<p style="margin: 5px 0;"><strong>Concentration:</strong> ' + sample.cleanExtractionQubitDetails.concentration + ' ng/uL</p>';
                if (sample.cleanExtractionQubitDetails.reagentLot) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lot:</strong> ' + sample.cleanExtractionQubitDetails.reagentLot + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.cleanExtractionQubitDetails.completedDate + ' by ' + sample.cleanExtractionQubitDetails.technician + '</p>';
                html += '</div>';
            }

            // Indexing
            if (sample.indexingDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e3f2fd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">INDEXING</div>';
                html += '<p style="margin: 5px 0;"><strong>Indexing Number:</strong> ' + sample.indexingNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Plate:</strong> ' + sample.indexingDetails.storagePlate + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Well:</strong> ' + sample.indexingDetails.wellPosition + '</p>';
                if (sample.indexingDetails.indexes) {
                    html += '<p style="margin: 5px 0;"><strong>i5 Index:</strong> ' + sample.indexingDetails.indexes.i5 + ' (Thaws: ' + sample.indexingDetails.indexes.i5Thaws + ')</p>';
                    html += '<p style="margin: 5px 0;"><strong>i7 Index:</strong> ' + sample.indexingDetails.indexes.i7 + ' (Thaws: ' + sample.indexingDetails.indexes.i7Thaws + ')</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.indexingDetails.completedDate + ' by ' + sample.indexingDetails.technician + '</p>';
                html += '</div>';
            }

            // Final Qubit
            if (sample.qubitDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #fff3e0; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">FINAL QUBIT</div>';
                html += '<p style="margin: 5px 0;"><strong>Concentration:</strong> ' + sample.qubitDetails.concentration + ' ng/uL</p>';
                if (sample.qubitDetails.reagentLot) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lot:</strong> ' + sample.qubitDetails.reagentLot + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.qubitDetails.completedDate + ' by ' + sample.qubitDetails.technician + '</p>';
                html += '</div>';
            }

            html += '</div>';

            // QC Failures
            if (sample.qcFailures && sample.qcFailures.length > 0) {
                html += '<h4 style="color: #dc3545;">‚ö†Ô∏è QC Failure History</h4>';
                html += '<div style="background: #ffe6e6; border-left: 4px solid #dc3545; padding: 15px;">';
                for (var f = 0; f < sample.qcFailures.length; f++) {
                    var failure = sample.qcFailures[f];
                    html += '<div style="margin-bottom: 10px;">';
                    html += '<p style="margin: 5px 0;"><strong>Failure #' + (f + 1) + ':</strong></p>';
                    html += '<p style="margin: 5px 0;"><strong>Stage:</strong> ' + failure.stage + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Reason:</strong> ' + failure.reason + '</p>';
                    if (failure.notes) html += '<p style="margin: 5px 0;"><strong>Notes:</strong> ' + failure.notes + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Date:</strong> ' + failure.date + ' at ' + failure.time + '</p>';
                    if (f < sample.qcFailures.length - 1) html += '<hr style="border-top: 1px solid #dc3545;">';
                    html += '</div>';
                }
                if (sample.reprocessCount) {
                    html += '<p style="margin: 10px 0; font-weight: bold;">Total re-process count: ' + sample.reprocessCount + '</p>';
                }
                html += '</div>';
            }

            document.getElementById('auditTrailContent').innerHTML = html;
            document.getElementById('auditTrailModal').style.display = 'block';
        }

        function closeAuditTrailModal() {
            document.getElementById('auditTrailModal').style.display = 'none';
        }

        // View sample timeline - Gantt-chart style visualization
        function viewSampleTimeline(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            // Calculate stage durations and dates
            var stages = [
                {name: 'Received', date: sample.dateAdded, key: null},
                {name: 'BAP', date: sample.bapDetails ? sample.bapDetails.completionDate : null, key: 'bapDetails'},
                {name: 'TSB', date: sample.tsbDetails ? sample.tsbDetails.completionDate : null, key: 'tsbDetails'},
                {name: 'Extraction', date: sample.extractionDetails ? sample.extractionDetails.completedDate : null, key: 'extractionDetails'},
                {name: 'Clean Extraction', date: sample.cleanExtractionDetails ? sample.cleanExtractionDetails.completedDate : null, key: 'cleanExtractionDetails'},
                {name: 'CE Qubit', date: sample.cleanExtractionQubitDetails ? sample.cleanExtractionQubitDetails.completedDate : null, key: 'cleanExtractionQubitDetails'},
                {name: 'Indexing', date: sample.indexingDetails ? sample.indexingDetails.completedDate : null, key: 'indexingDetails'},
                {name: 'Final Qubit', date: sample.qubitDetails ? sample.qubitDetails.completedDate : null, key: 'qubitDetails'}
            ];

            // Calculate durations between stages
            var timeline = [];
            var startDate = new Date(sample.dateAdded);
            var currentDate = startDate;

            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];
                if (i === 0 || stage.date) {
                    var endDate = stage.date ? new Date(stage.date) : new Date();
                    var durationDays = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                    if (durationDays < 0) durationDays = 0;

                    var status = 'completed';
                    var color = '#28a745';
                    if (!stage.date && i > 0) {
                        status = 'in-progress';
                        color = '#ffc107';
                        durationDays = Math.ceil((new Date() - currentDate) / (1000 * 60 * 60 * 24));
                    }

                    // Warn if stage took too long
                    if (durationDays > 3 && status === 'completed') {
                        color = '#fd7e14'; // Orange for slow
                    }
                    if (durationDays > 7) {
                        color = '#dc3545'; // Red for very slow
                        status = 'delayed';
                    }

                    timeline.push({
                        name: stage.name,
                        durationDays: durationDays,
                        startDate: currentDate.toLocaleDateString(),
                        endDate: stage.date || 'In Progress',
                        status: status,
                        color: color,
                        completed: !!stage.date
                    });

                    if (stage.date) {
                        currentDate = endDate;
                    }
                } else {
                    break; // Stop at first incomplete stage
                }
            }

            // Create modal
            var modal = document.createElement('div');
            modal.id = 'timelineModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;';

            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';

            var html = '';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            html += '<h2 style="margin: 0; color: #667eea;">üìä Sample Timeline</h2>';
            html += '<button onclick="closeTimelineModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>';
            html += '</div>';

            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;">' + sample.id + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Current Status: ' + sample.status + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Total Time: ' + calculateTurnaroundDays(sample) + ' days</div>';
            html += '</div>';

            // Legend
            html += '<div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap;">';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div><span style="font-size: 12px;">Completed (‚â§3 days)</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 20px; background: #fd7e14; border-radius: 4px;"></div><span style="font-size: 12px;">Slow (3-7 days)</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div><span style="font-size: 12px;">Delayed (>7 days)</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 20px; background: #ffc107; border-radius: 4px;"></div><span style="font-size: 12px;">In Progress</span></div>';
            html += '</div>';

            // Gantt chart
            html += '<div style="font-weight: 600; margin-bottom: 15px; color: #495057;">üìÖ Stage Duration Timeline:</div>';

            var maxDays = Math.max.apply(null, timeline.map(function(t) { return t.durationDays; }));
            if (maxDays === 0) maxDays = 1;

            timeline.forEach(function(item) {
                var barWidth = (item.durationDays / maxDays) * 100;
                if (barWidth < 5) barWidth = 5; // Minimum width for visibility

                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">';
                html += '<span style="font-weight: 600; font-size: 14px; color: #495057;">' + item.name + '</span>';
                html += '<span style="font-size: 12px; color: #6c757d;">' + item.durationDays + ' day' + (item.durationDays === 1 ? '' : 's') + '</span>';
                html += '</div>';

                html += '<div style="background: #e9ecef; border-radius: 8px; height: 36px; position: relative; overflow: hidden;">';
                html += '<div style="background: linear-gradient(90deg, ' + item.color + ' 0%, ' + item.color + 'dd 100%); height: 100%; width: ' + barWidth + '%; display: flex; align-items: center; padding: 0 12px; color: white; font-weight: 600; font-size: 13px; transition: width 0.5s; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';

                if (item.status === 'in-progress') {
                    html += '‚è≥ In Progress';
                } else if (item.status === 'delayed') {
                    html += '‚ö†Ô∏è Delayed';
                } else {
                    html += '‚úì Done';
                }

                html += '</div>';
                html += '</div>';

                html += '<div style="font-size: 11px; color: #6c757d; margin-top: 3px;">';
                html += item.startDate + ' ‚Üí ' + (typeof item.endDate === 'string' ? item.endDate : new Date(item.endDate).toLocaleDateString());
                html += '</div>';
                html += '</div>';
            });

            // Summary
            var totalDays = calculateTurnaroundDays(sample);
            if (totalDays === null) {
                totalDays = Math.ceil((new Date() - new Date(sample.dateAdded)) / (1000 * 60 * 60 * 24));
            }
            var avgDaysPerStage = timeline.length > 0 ? (totalDays / timeline.length).toFixed(1) : 0;

            html += '<div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin-top: 20px; border-radius: 4px;">';
            html += '<div style="font-weight: 600; margin-bottom: 8px; color: #004085;">üìà Summary:</div>';
            html += '<div style="font-size: 13px; color: #004085; line-height: 1.6;">';
            html += '‚Ä¢ Total Duration: <strong>' + totalDays + ' days</strong><br>';
            html += '‚Ä¢ Stages Completed: <strong>' + timeline.filter(function(t) { return t.completed; }).length + '/' + stages.length + '</strong><br>';
            html += '‚Ä¢ Average per Stage: <strong>' + avgDaysPerStage + ' days</strong><br>';
            var delayedStages = timeline.filter(function(t) { return t.status === 'delayed'; }).length;
            if (delayedStages > 0) {
                html += '‚Ä¢ ‚ö†Ô∏è Delayed Stages: <strong>' + delayedStages + '</strong>';
            }
            html += '</div>';
            html += '</div>';

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeTimelineModal();
                }
            };
        }

        function updateQuickStats() {
            var statsPanel = document.getElementById('quickStats');

            // Calculate stats
            var totalSamples = samples.length;
            var completedSamples = 0;
            var inProgressSamples = 0;
            var qcFailures = 0;
            var lastAdded = null;

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                if (s.status === 'Qubit Complete') {
                    completedSamples++;
                } else if (s.status !== 'Received') {
                    inProgressSamples++;
                }

                // Check for QC failures
                if (s.cleanExtractionQubitDetails) {
                    var ceQC = checkQCThreshold(s.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
                    if (!ceQC.pass) qcFailures++;
                }
                if (s.qubitDetails) {
                    var fqQC = checkQCThreshold(s.qubitDetails.concentration, 'finalQubit');
                    if (!fqQC.pass) qcFailures++;
                }

                // Track last added
                if (!lastAdded || new Date(s.dateAdded) > new Date(lastAdded.dateAdded)) {
                    lastAdded = s;
                }
            }

            var completionRate = totalSamples > 0 ? Math.round((completedSamples / totalSamples) * 100) : 0;

            var html = '';

            // Total samples
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + totalSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Total Samples</div>';
            html += '</div>';

            // Completion rate
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + completionRate + '%</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Completion Rate</div>';
            html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + completedSamples + ' of ' + totalSamples + ' complete</div>';
            html += '</div>';

            // In progress
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + inProgressSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">In Progress</div>';
            html += '</div>';

            // QC Failures
            var qcColor = qcFailures > 0 ? '#ff6b6b' : '#51cf66';
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold; color: ' + qcColor + ';">' + qcFailures + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">QC Warnings</div>';
            html += '</div>';

            // Average turnaround time
            var turnaroundDays = [];
            for (var i = 0; i < samples.length; i++) {
                var days = calculateTurnaroundDays(samples[i]);
                if (days !== null) {
                    turnaroundDays.push(days);
                }
            }
            var avgTurnaround = turnaroundDays.length > 0
                ? Math.round(turnaroundDays.reduce(function(a, b) { return a + b; }, 0) / turnaroundDays.length)
                : 0;

            if (turnaroundDays.length > 0) {
                var turnaroundColor = avgTurnaround <= 7 ? '#51cf66' : avgTurnaround <= 14 ? '#ffc107' : '#ff6b6b';
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
                html += '<div style="font-size: 32px; font-weight: bold; color: ' + turnaroundColor + ';">' + avgTurnaround + '</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Avg Days to Complete</div>';
                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Based on ' + turnaroundDays.length + ' samples</div>';
                html += '</div>';
            }

            // Last added
            if (lastAdded) {
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
                html += '<div style="font-size: 16px; font-weight: bold;">' + lastAdded.id + '</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Last Added</div>';
                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + lastAdded.dateAdded + '</div>';
                html += '</div>';
            }

            // Inventory Alerts (Low Stock + Expiring)
            var lowStockCount = 0;
            var expiredCount = 0;
            var expiringSoonCount = 0;
            var today = new Date();
            var in30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            for (var i = 0; i < inventory.length; i++) {
                var r = inventory[i];
                var percentRemaining = (r.quantity / r.initialQuantity) * 100;

                if (percentRemaining < 20) lowStockCount++;

                if (r.expiry) {
                    var expiryDate = new Date(r.expiry);
                    if (expiryDate < today) expiredCount++;
                    else if (expiryDate < in30Days) expiringSoonCount++;
                }
            }

            // Show inventory alerts if there are any issues
            var totalInventoryAlerts = lowStockCount + expiredCount + expiringSoonCount;
            if (totalInventoryAlerts > 0) {
                var alertColor = expiredCount > 0 ? '#ff6b6b' : lowStockCount > 0 ? '#ffc107' : '#ffa500';
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px); cursor: pointer; border: 2px solid ' + alertColor + ';" onclick="showInventory()">';
                html += '<div style="font-size: 32px; font-weight: bold; color: ' + alertColor + ';">‚ö†Ô∏è</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Inventory Alerts</div>';

                var alerts = [];
                if (expiredCount > 0) alerts.push(expiredCount + ' expired');
                if (expiringSoonCount > 0) alerts.push(expiringSoonCount + ' expiring soon');
                if (lowStockCount > 0) alerts.push(lowStockCount + ' low stock');

                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + alerts.join(', ') + '</div>';
                html += '<div style="font-size: 11px; opacity: 0.6; margin-top: 5px;">Click to view inventory</div>';
                html += '</div>';
            }

            statsPanel.innerHTML = html;
        }

        function updateDashboard() {
            var statusCounts = {
                'Received': 0,
                'BAP Complete': 0,
                'TSB Complete': 0,
                'Extraction Complete': 0,
                'Clean Extraction Complete': 0,
                'Clean Extraction Qubit Complete': 0,
                'Indexing Complete': 0,
                'Qubit Complete': 0
            };

            for (var i = 0; i < samples.length; i++) {
                var status = samples[i].status;
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            }

            var dashboard = document.getElementById('statusDashboard');
            var html = '';

            var statuses = [
                {name: 'Received', icon: 'üì•', color: '#495057', bg: '#e9ecef'},
                {name: 'BAP Complete', icon: 'üß´', color: '#155724', bg: '#d4edda'},
                {name: 'TSB Complete', icon: 'üß™', color: '#856404', bg: '#fff3cd'},
                {name: 'Extraction Complete', icon: 'üß¨', color: '#7b1fa2', bg: '#f3e5f5'},
                {name: 'Clean Extraction Complete', icon: 'üßΩ', color: '#2e7d32', bg: '#e8f5e8'},
                {name: 'Clean Extraction Qubit Complete', icon: 'üìä', color: '#1565c0', bg: '#e8f4fd'},
                {name: 'Indexing Complete', icon: 'üî¨', color: '#1976d2', bg: '#e3f2fd'},
                {name: 'Qubit Complete', icon: '‚úÖ', color: '#f57c00', bg: '#fff3e0'}
            ];

            for (var i = 0; i < statuses.length; i++) {
                var s = statuses[i];
                html += '<div style="background: ' + s.bg + '; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ' + s.color + '20;">';
                html += '<div style="font-size: 24px;">' + s.icon + '</div>';
                html += '<div style="font-size: 28px; font-weight: bold; color: ' + s.color + '; margin: 5px 0;">' + statusCounts[s.name] + '</div>';
                html += '<div style="font-size: 11px; color: ' + s.color + '; font-weight: 600;">' + s.name.toUpperCase() + '</div>';
                html += '</div>';
            }

            html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #dee2e6;">';
            html += '<div style="font-size: 24px;">üì¶</div>';
            html += '<div style="font-size: 28px; font-weight: bold; color: #212529; margin: 5px 0;">' + samples.length + '</div>';
            html += '<div style="font-size: 11px; color: #495057; font-weight: 600;">TOTAL SAMPLES</div>';
            html += '</div>';

            dashboard.innerHTML = html;
        }

        function sortSamples() {
            var sortType = document.getElementById('sortSelect').value;

            if (sortType === 'dateDesc') {
                // Newest first (reverse chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(b) - samples.indexOf(a);
                });
            } else if (sortType === 'dateAsc') {
                // Oldest first (chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(a) - samples.indexOf(b);
                });
            } else if (sortType === 'idAsc') {
                // ID A-Z
                samples.sort(function(a, b) {
                    return a.id.localeCompare(b.id);
                });
            } else if (sortType === 'idDesc') {
                // ID Z-A
                samples.sort(function(a, b) {
                    return b.id.localeCompare(a.id);
                });
            } else if (sortType === 'status') {
                // By workflow status
                var statusOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                                  'Clean Extraction Complete', 'Clean Extraction Qubit Complete',
                                  'Indexing Complete', 'Qubit Complete'];
                samples.sort(function(a, b) {
                    var aIndex = statusOrder.indexOf(a.status);
                    var bIndex = statusOrder.indexOf(b.status);
                    return aIndex - bIndex;
                });
            }

            saveData();
            renderSamples();
        }

        // Sample Sorting Function
        function sortSamples() {
            var sortValue = document.getElementById('sortSelect').value;
            var parts = sortValue.split('-');
            var sortBy = parts[0];
            var order = parts[1]; // 'asc' or 'desc'

            samples.sort(function(a, b) {
                var valA, valB;

                if (sortBy === 'dateAdded') {
                    valA = new Date(a.dateAdded);
                    valB = new Date(b.dateAdded);
                } else if (sortBy === 'id') {
                    valA = a.id.toLowerCase();
                    valB = b.id.toLowerCase();
                } else if (sortBy === 'status') {
                    valA = a.status.toLowerCase();
                    valB = b.status.toLowerCase();
                } else if (sortBy === 'progress') {
                    // Calculate progress percentage
                    valA = calculateProgress(a);
                    valB = calculateProgress(b);
                } else if (sortBy === 'technician') {
                    valA = (a.initials || '').toLowerCase();
                    valB = (b.initials || '').toLowerCase();
                }

                // Compare values
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            saveData();
            renderSamples();
        }

        function calculateProgress(sample) {
            var stages = ['status'];
            var completed = 0;
            var total = 7;

            if (sample.status === 'Received') completed = 0;
            else if (sample.status === 'BAP In Progress') completed = 1;
            else if (sample.status === 'BAP Complete') completed = 1;
            else if (sample.status === 'TSB In Progress') completed = 2;
            else if (sample.status === 'TSB Complete') completed = 2;
            else if (sample.status === 'Extraction Complete') completed = 3;
            else if (sample.status === 'Clean Extraction Complete') completed = 4;
            else if (sample.status === 'Clean Extraction Qubit Complete') completed = 5;
            else if (sample.status === 'Indexing Complete') completed = 6;
            else if (sample.status === 'Qubit Complete') completed = 7;

            return (completed / total) * 100;
        }

        // View Mode Management
        var currentView = 'kanban'; // default view

        function switchView(viewMode) {
            currentView = viewMode;

            // Hide all views
            document.getElementById('kanbanView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            document.getElementById('tableView').style.display = 'none';

            // Update button styles
            var kanbanBtn = document.getElementById('viewKanban');
            var listBtn = document.getElementById('viewList');
            var tableBtn = document.getElementById('viewTable');

            // Reset all buttons
            kanbanBtn.style.background = 'white';
            kanbanBtn.style.color = '#6366f1';
            kanbanBtn.style.border = '2px solid #6366f1';
            listBtn.style.background = 'white';
            listBtn.style.color = '#6366f1';
            listBtn.style.border = '2px solid #6366f1';
            tableBtn.style.background = 'white';
            tableBtn.style.color = '#6366f1';
            tableBtn.style.border = '2px solid #6366f1';

            // Show selected view and update button
            if (viewMode === 'kanban') {
                document.getElementById('kanbanView').style.display = 'block';
                kanbanBtn.style.background = '#6366f1';
                kanbanBtn.style.color = 'white';
                kanbanBtn.style.border = 'none';
            } else if (viewMode === 'list') {
                document.getElementById('listView').style.display = 'block';
                listBtn.style.background = '#6366f1';
                listBtn.style.color = 'white';
                listBtn.style.border = 'none';
            } else if (viewMode === 'table') {
                document.getElementById('tableView').style.display = 'block';
                tableBtn.style.background = '#6366f1';
                tableBtn.style.color = 'white';
                tableBtn.style.border = 'none';
            }

            // Re-render in the new view
            renderSamples();
        }

        function renderSamples() {
            // Route to appropriate render function based on current view
            if (currentView === 'kanban') {
                renderKanbanView();
            } else if (currentView === 'table') {
                renderTableView();
            } else {
                renderListView();
            }

            updateQuickStats();
            updateDashboard();
        }

        // Kanban Pipeline View Rendering
        function renderKanbanView() {
            var container = document.getElementById('kanbanContainer');

            if (samples.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; width: 100%;">No samples yet. Add one above to see the pipeline!</div>';
                return;
            }

            // Define pipeline stages
            var stages = [
                {name: 'Received', emoji: 'üì•', color: '#6c757d', statuses: ['Received']},
                {name: 'BAP', emoji: 'üß´', color: '#28a745', statuses: ['BAP In Progress', 'BAP Complete']},
                {name: 'TSB', emoji: 'üß™', color: '#ffc107', statuses: ['TSB In Progress', 'TSB Complete']},
                {name: 'Extraction', emoji: 'üî¨', color: '#9c27b0', statuses: ['Extraction Complete']},
                {name: 'Clean Extraction', emoji: '‚ú®', color: '#4caf50', statuses: ['Clean Extraction Complete']},
                {name: 'CE Qubit', emoji: 'üìä', color: '#17a2b8', statuses: ['Clean Extraction Qubit Complete']},
                {name: 'Indexing', emoji: 'üè∑Ô∏è', color: '#007bff', statuses: ['Indexing Complete']},
                {name: 'Complete', emoji: '‚úÖ', color: '#10b981', statuses: ['Qubit Complete']}
            ];

            var html = '';

            stages.forEach(function(stage) {
                // Filter samples for this stage
                var stageSamples = samples.filter(function(s) {
                    return stage.statuses.indexOf(s.status) !== -1;
                });

                html += '<div class="kanban-column" data-stage="' + stage.statuses[stage.statuses.length - 1] + '" ondrop="handleKanbanDrop(event)" ondragover="handleKanbanDragOver(event)" ondragleave="handleKanbanDragLeave(event)">';
                html += '<div class="kanban-header" style="background: ' + stage.color + '; color: white;">';
                html += '<span>' + stage.emoji + ' ' + stage.name + '</span>';
                html += '<span class="kanban-count">' + stageSamples.length + '</span>';
                html += '</div>';

                if (stageSamples.length === 0) {
                    html += '<div style="padding: 20px; text-align: center; color: #adb5bd; font-size: 12px; min-height: 80px;">Drop samples here</div>';
                } else {
                    stageSamples.forEach(function(sample) {
                        var progress = getSampleProgress(sample);
                        var borderColor = sample.flag === 'Rush' ? '#dc3545' : sample.flag === 'Hold' ? '#ffc107' : sample.flag === 'Review' ? '#fd7e14' : '#e9ecef';

                        html += '<div class="kanban-card" style="border-left-color: ' + borderColor + '; cursor: move;" draggable="true" ondragstart="handleKanbanDragStart(event, \'' + sample.id.replace(/'/g, "\\'") + '\')" onclick="viewSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" data-sample-id="' + sample.id.replace(/'/g, "\\'") + '">';
                        html += '<div class="kanban-card-header">';
                        html += '<span>‚ãÆ‚ãÆ ' + sample.id + '</span>';
                        if (sample.flag && sample.flag !== 'None') {
                            var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                            html += '<span>' + flagIcon + '</span>';
                        }
                        html += '</div>';

                        // Progress bar
                        var progressColor = progress.percentage === 100 ? '#10b981' : progress.percentage >= 75 ? '#17a2b8' : progress.percentage >= 50 ? '#ffc107' : '#fd7e14';
                        html += '<div style="background: #e9ecef; border-radius: 4px; height: 6px; margin: 8px 0; overflow: hidden;">';
                        html += '<div style="background: ' + progressColor + '; height: 100%; width: ' + progress.percentage + '%;"></div>';
                        html += '</div>';

                        html += '<div class="kanban-card-meta">';
                        html += '<span>üìÖ ' + sample.dateAdded + '</span>';
                        html += '<span>üë§ ' + sample.initials + '</span>';
                        html += '<span>' + progress.completed + '/' + progress.total + '</span>';
                        html += '</div>';

                        html += '</div>';
                    });
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // Kanban Drag and Drop Handlers
        var draggedSampleId = null;

        function handleKanbanDragStart(event, sampleId) {
            draggedSampleId = sampleId;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);

            // Add visual feedback
            event.target.style.opacity = '0.4';
            event.stopPropagation(); // Prevent click event from firing
        }

        function handleKanbanDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';

            // Add visual feedback to drop zone
            var column = event.currentTarget;
            if (column.classList.contains('kanban-column')) {
                column.style.background = '#e3f2fd';
                column.style.transform = 'scale(1.02)';
            }

            return false;
        }

        function handleKanbanDragLeave(event) {
            var column = event.currentTarget;
            if (column.classList.contains('kanban-column')) {
                column.style.background = '';
                column.style.transform = '';
            }
        }

        function handleKanbanDrop(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }

            var column = event.currentTarget;
            column.style.background = '';
            column.style.transform = '';

            if (!draggedSampleId) {
                return false;
            }

            var targetStatus = column.getAttribute('data-stage');

            // Find the sample
            var sample = samples.find(function(s) { return s.id === draggedSampleId; });

            if (!sample) {
                draggedSampleId = null;
                return false;
            }

            // Map status to batch type for stages that need data entry
            var stageRequiresDataEntry = {
                'BAP Complete': 'BAP',
                'TSB Complete': 'TSB',
                'Extraction Complete': 'Extraction',
                'Clean Extraction Complete': 'Clean Extraction',
                'Clean Extraction Qubit Complete': 'Clean Extraction Qubit',
                'Indexing Complete': 'Indexing',
                'Qubit Complete': 'Final Qubit'
            };

            var batchType = stageRequiresDataEntry[targetStatus];

            if (batchType) {
                // This stage requires detailed data entry - open batch modal
                draggedSampleId = null; // Clear before opening modal
                openBatchModal([sample.id], batchType);
            } else {
                // Simple status change (like "Received" or intermediate stages)
                var statusName = targetStatus;
                var confirmMsg = 'Move sample ' + sample.id + ' to stage: ' + statusName + '?';

                if (confirm(confirmMsg)) {
                    // Update the sample status
                    sample.status = targetStatus;

                    // Save and re-render
                    saveData();
                    renderSamples();

                    // Show success message
                    showSuccessNotification('‚úì Moved ' + sample.id + ' to ' + statusName);
                } else {
                    // User canceled - just re-render to restore original position
                    renderSamples();
                }
            }

            draggedSampleId = null;
            return false;
        }

        // Helper function for success notifications
        function showSuccessNotification(message) {
            var successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 600; animation: slideInRight 0.3s ease-out;';
            successDiv.innerHTML = message;
            document.body.appendChild(successDiv);

            setTimeout(function() {
                successDiv.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(function() {
                    if (successDiv.parentNode) {
                        document.body.removeChild(successDiv);
                    }
                }, 300);
            }, 2000);
        }

        // Table View Rendering
        function renderTableView() {
            var container = document.getElementById('tableContainer');

            if (samples.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No samples yet. Add one above!</div>';
                return;
            }

            var html = '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">';
            html += '<thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
            html += '<tr>';
            html += '<th style="padding: 16px; text-align: left; font-weight: 600;">Sample ID</th>';
            html += '<th style="padding: 16px; text-align: left; font-weight: 600;">Status</th>';
            html += '<th style="padding: 16px; text-align: left; font-weight: 600;">Progress</th>';
            html += '<th style="padding: 16px; text-align: left; font-weight: 600;">Date Added</th>';
            html += '<th style="padding: 16px; text-align: left; font-weight: 600;">Technician</th>';
            html += '<th style="padding: 16px; text-align: center; font-weight: 600;">Actions</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';

            samples.forEach(function(sample, index) {
                var progress = getSampleProgress(sample);
                var bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

                html += '<tr style="background: ' + bgColor + '; border-bottom: 1px solid #e9ecef; transition: background 0.2s;" onmouseover="this.style.background=\'#e3f2fd\'" onmouseout="this.style.background=\'' + bgColor + '\'">';

                // Sample ID with flag
                html += '<td style="padding: 16px; font-weight: 600;">';
                html += sample.id;
                if (sample.flag && sample.flag !== 'None') {
                    var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                    html += ' ' + flagIcon;
                }
                html += '</td>';

                // Status badge
                html += '<td style="padding: 16px;">';
                var statusColor = sample.status === 'Qubit Complete' ? '#10b981' : sample.status.includes('Complete') ? '#17a2b8' : '#6c757d';
                html += '<span style="background: ' + statusColor + '; color: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">' + sample.status + '</span>';
                html += '</td>';

                // Progress bar
                html += '<td style="padding: 16px;">';
                var progressColor = progress.percentage === 100 ? '#10b981' : progress.percentage >= 75 ? '#17a2b8' : progress.percentage >= 50 ? '#ffc107' : '#fd7e14';
                html += '<div style="display: flex; align-items: center; gap: 10px;">';
                html += '<div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">';
                html += '<div style="background: ' + progressColor + '; height: 100%; width: ' + progress.percentage + '%;"></div>';
                html += '</div>';
                html += '<span style="font-size: 12px; font-weight: 600; color: ' + progressColor + '; min-width: 45px;">' + progress.percentage + '%</span>';
                html += '</div>';
                html += '</td>';

                // Date and Technician
                html += '<td style="padding: 16px; color: #6c757d;">' + sample.dateAdded + '</td>';
                html += '<td style="padding: 16px; color: #6c757d;">' + sample.initials + '</td>';

                // Actions
                html += '<td style="padding: 16px; text-align: center;">';
                html += '<button onclick="viewSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px; font-size: 12px;" title="View">üëÅ</button>';
                html += '<button onclick="editSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #ffc107; color: #333; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px; font-size: 12px;" title="Edit">‚úèÔ∏è</button>';
                html += '<button onclick="deleteSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Delete">üóë</button>';
                html += '</td>';

                html += '</tr>';
            });

            html += '</tbody>';
            html += '</table>';

            container.innerHTML = html;
        }

        // Original list view rendering
        function renderListView() {
            var container = document.getElementById('sampleContainer');

            if (samples.length === 0) {
                container.innerHTML = '<p>No samples yet. Add one above!</p>';
                return;
            }

            var receivedCount = 0;
var bapCount = 0;
var tsbCount = 0;
var extractionCount = 0;
var cleanExtractionCount = 0;
var cleanExtractionQubitCount = 0;
var indexingCount = 0;
            
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].status === 'Received') receivedCount++;
else if (samples[i].status === 'BAP Complete') bapCount++;
else if (samples[i].status === 'TSB Complete') tsbCount++;
else if (samples[i].status === 'Extraction Complete') extractionCount++;
else if (samples[i].status === 'Clean Extraction Complete') cleanExtractionCount++;
else if (samples[i].status === 'Clean Extraction Qubit Complete') cleanExtractionQubitCount++;
else if (samples[i].status === 'Indexing Complete') indexingCount++;
            }
            
            var html = '';
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var showCheckbox = false;
                
                if (receivedCount >= 2 && sample.status === 'Received') showCheckbox = true;
                else if (bapCount >= 2 && sample.status === 'BAP Complete') showCheckbox = true;
                else if (tsbCount >= 2 && sample.status === 'TSB Complete') showCheckbox = true;
                else if (extractionCount >= 2 && sample.status === 'Extraction Complete') showCheckbox = true;
                else if (cleanExtractionCount >= 2 && sample.status === 'Clean Extraction Complete') showCheckbox = true;
                else if (cleanExtractionQubitCount >= 2 && sample.status === 'Clean Extraction Qubit Complete') showCheckbox = true;
                else if (indexingCount >= 2 && sample.status === 'Indexing Complete') showCheckbox = true;
                
                html += '<div class="sample-item">';
                html += '<div class="sample-info">';

                // Always show checkbox for bulk operations
                var isChecked = bulkSelectedSamples.indexOf(sample.id) !== -1 ? ' checked' : '';
                html += '<input type="checkbox" class="sample-checkbox" data-sample-id="' + sample.id + '" value="' + sample.id + '" onchange="toggleSampleSelection(\'' + sample.id.replace(/'/g, "\\'") + '\', this); updateSelection();"' + isChecked + '> ';

                if (showCheckbox) {
                    // Batch processing checkbox (keep for compatibility)
                    html += '<input type="checkbox" class="sample-checkbox-batch" value="' + sample.id + '" onchange="updateSelection()"> ';
                }
                
                // Add expand/collapse toggle button
                var isExpanded = expandedSamples[sample.id] !== false; // Default is expanded
                var toggleIcon = isExpanded ? '‚ñº' : '‚ñ∂';
                html += '<button id="toggle-btn-' + sample.id + '" onclick="toggleSampleExpansion(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: none; border: none; cursor: pointer; font-size: 14px; color: #6c757d; padding: 0 8px 0 0; vertical-align: middle;" title="' + (isExpanded ? 'Collapse' : 'Expand') + '">' + toggleIcon + '</button>';

                html += '<strong>' + sample.id + '</strong> ';
                html += '<span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span>';

                // Show flag if not None
                if (sample.flag && sample.flag !== 'None') {
                    var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                    var flagColor = sample.flag === 'Rush' ? '#dc3545' : sample.flag === 'Hold' ? '#ffc107' : '#fd7e14';
                    html += ' <span style="background: ' + flagColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 4px;">' + flagIcon + ' ' + sample.flag + '</span>';
                }

                // Show turnaround time for completed samples
                var turnaroundDays = calculateTurnaroundDays(sample);
                if (turnaroundDays !== null) {
                    var turnaroundColor = turnaroundDays <= 7 ? '#28a745' : turnaroundDays <= 14 ? '#ffc107' : '#dc3545';
                    html += ' <span style="background: ' + turnaroundColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px;">‚è±Ô∏è ' + turnaroundDays + ' days</span>';
                }

                html += '<br><small>Added: ' + sample.dateAdded + ' | ' + sample.initials + '</small>';

                // Add progress bar
                html += getProgressBarHTML(sample);

                // Start collapsible details section
                var displayStyle = isExpanded ? 'block' : 'none';
                html += '<div id="sample-details-' + sample.id + '" style="display: ' + displayStyle + '; transition: all 0.3s ease;">';

                // In compact view, skip all the detailed info
                if (!isCompactView) {
                if (sample.bapDetails) {
                    html += '<br>BAP: ' + sample.bapNumber;
                    if (sample.bapDetails.timeIn || sample.bapDetails.timeOut) {
                        html += '<br><small>' + sample.bapDetails.temperature + '¬∞C, ' + sample.bapDetails.incubator;
                        if (sample.bapDetails.timeIn) html += ' | In: ' + sample.bapDetails.timeIn;
                        if (sample.bapDetails.timeOut) html += ' | Out: ' + sample.bapDetails.timeOut;
                        html += '</small>';
                    }
                }
                if (sample.tsbDetails) {
                    html += '<br>TSB: ' + sample.tsbNumber;
                    if (sample.tsbDetails.timeIn || sample.tsbDetails.timeOut) {
                        html += '<br><small>' + sample.tsbDetails.temperature + '¬∞C, ' + sample.tsbDetails.incubator;
                        if (sample.tsbDetails.timeIn) html += ' | In: ' + sample.tsbDetails.timeIn;
                        if (sample.tsbDetails.timeOut) html += ' | Out: ' + sample.tsbDetails.timeOut;
                        html += '</small>';
                    }
                }
                if (sample.extractionDetails) {
                    html += '<br>Extraction: ' + sample.extractionNumber + ' | Run: ' + sample.extractionDetails.extractionRun;
                    if (sample.extractionDetails.reagentLots && sample.extractionDetails.reagentLots.aw1) {
                        html += '<br><small>AW1: ' + sample.extractionDetails.reagentLots.aw1 + ' | AW2: ' + sample.extractionDetails.reagentLots.aw2 + '</small>';
                    }
                }
                if (sample.cleanExtractionDetails) {
                    html += '<br>Clean Extraction: ' + sample.cleanExtractionNumber + ' | Plate: ' + sample.cleanExtractionDetails.storagePlate + ' | Well: ' + sample.cleanExtractionDetails.wellPosition;
                    if (sample.cleanExtractionDetails.volumes && sample.cleanExtractionDetails.volumes.cleanup) {
                        html += '<br><small>Cleanup: ' + sample.cleanExtractionDetails.volumes.cleanup + ' | In: ' + sample.cleanExtractionDetails.volumes.elutionIn + ' | Out: ' + sample.cleanExtractionDetails.volumes.elutionOut + '</small>';
                    }
                }
                if (sample.indexingDetails) {
                    html += '<br>Indexing: ' + sample.indexingNumber + ' | Plate: ' + sample.indexingDetails.storagePlate + ' | Well: ' + sample.indexingDetails.wellPosition;
                    if (sample.indexingDetails.indexes && sample.indexingDetails.indexes.i5 && sample.indexingDetails.indexes.i7) {
                        html += '<br><small>i5: ' + sample.indexingDetails.indexes.i5 + ' | i7: ' + sample.indexingDetails.indexes.i7 + ' | Thaws: ' + sample.indexingDetails.indexes.i5Thaws + '/' + sample.indexingDetails.indexes.i7Thaws + '</small>';
                    }
                }
                if (sample.cleanExtractionQubitDetails) {
    var ceQC = checkQCThreshold(sample.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
    var ceStyle = ceQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Clean Extraction Qubit: <span' + ceStyle + '>' + sample.cleanExtractionQubitDetails.concentration + ' ng/uL</span>';
    if (!ceQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + ceQC.message + '</span>';
    }
    if (sample.cleanExtractionQubitDetails.reagentLot) {
        html += '<br><small>CE Qubit Reagent: ' + sample.cleanExtractionQubitDetails.reagentLot + ' | Date: ' + (sample.cleanExtractionQubitDetails.dateQubited || sample.cleanExtractionQubitDetails.completedDate) + '</small>';
    }
}
if (sample.qubitDetails) {
    var fqQC = checkQCThreshold(sample.qubitDetails.concentration, 'finalQubit');
    var fqStyle = fqQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Final Qubit: <span' + fqStyle + '>' + sample.qubitDetails.concentration + ' ng/uL</span>';
    if (!fqQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + fqQC.message + '</span>';
    }
    if (sample.qubitDetails.reagentLot) {
        html += '<br><small>Final Qubit Reagent: ' + sample.qubitDetails.reagentLot + ' | Date: ' + (sample.qubitDetails.dateQubited || sample.qubitDetails.completedDate) + '</small>';
    }
}
                
                // Show notes if they exist
                if (sample.notes && sample.notes.trim()) {
                    html += '<br><small style="color: #6c757d; font-style: italic;">üìù ' + sample.notes + '</small>';
                }

                // Show QC failure history if exists
                if (sample.qcFailures && sample.qcFailures.length > 0) {
                    html += '<br><div style="background: #ffe6e6; border-left: 4px solid #dc3545; padding: 8px; margin-top: 8px; border-radius: 4px;">';
                    html += '<strong style="color: #dc3545;">‚ö†Ô∏è QC Failures (' + sample.qcFailures.length + '):</strong>';
                    for (var f = 0; f < sample.qcFailures.length; f++) {
                        var failure = sample.qcFailures[f];
                        html += '<br><small>' + (f + 1) + '. ' + failure.stage + ': ' + failure.reason;
                        if (failure.notes) html += ' - ' + failure.notes;
                        html += ' (' + failure.date + ')';
                        html += '</small>';
                    }
                    if (sample.reprocessCount) {
                        html += '<br><small><strong>Re-processed: ' + sample.reprocessCount + ' time(s)</strong></small>';
                    }
                    html += '</div>';
                }
                } // End of !isCompactView

                html += '</div>'; // Close collapsible details div

                html += '</div>';
                html += '<div class="sample-actions">';
                html += '<button onclick="viewSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">View</button><br>';
                html += '<button onclick="viewSampleTimeline(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; margin-bottom: 4px;" title="View timeline">üìä Timeline</button><br>';
                html += '<button onclick="editSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #ffc107; color: #212529; border: none; border-radius: 4px; margin-bottom: 4px; font-weight: 600;">Edit</button><br>';
                html += '<button onclick="editNotes(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Notes</button><br>';
                html += '<button onclick="changeFlag(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #fd7e14; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Flag</button><br>';
                html += '<button onclick="cloneSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Clone</button><br>';
                html += '<button onclick="showQRCode(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">QR Code</button><br>';
                html += '<button onclick="deleteSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Delete</button><br>';

                if (sample.status === 'Received') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'BAP\')">Start BAP</button>';
                } else if (sample.status === 'BAP In Progress') {
                    html += '<button onclick="finishProcess(\'' + sample.id + '\', \'BAP\')" style="background: #28a745;">Finish BAP</button>';
                } else if (sample.status === 'BAP Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'TSB\')">Start TSB</button>';
                    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn">Continue</button>';
                } else if (sample.status === 'TSB In Progress') {
                    html += '<button onclick="finishProcess(\'' + sample.id + '\', \'TSB\')" style="background: #28a745;">Finish TSB</button>';
                } else if (sample.status === 'TSB Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Extraction\')">Start Extraction</button>';
                    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn">Continue</button>';
                } else if (sample.status === 'Extraction Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction\')">Start Clean Extraction</button>';
                    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn">Continue</button>';
                } else if (sample.status === 'Clean Extraction Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction Qubit\')">Start Qubit</button>';
    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn">Continue</button>';
} else if (sample.status === 'Clean Extraction Qubit Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Indexing\')">Start Indexing</button><br>';
    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn" style="display: block; width: 100%;">Continue</button>';
    html += '<button onclick="markQCFailed(\'' + sample.id.replace(/'/g, "\\'") + '\', \'CE Qubit\')" style="background: #dc3545; margin-top: 4px;">QC Failed</button>';
} else if (sample.status === 'Indexing Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Final Qubit\')">Start Final Qubit</button>';
    html += '<button onclick="continueToNextStage(\'' + sample.id.replace(/'/g, "\\'") + '\')" class="continue-btn">Continue</button>';
                } else if (sample.status === 'Qubit Complete') {
                    html += '<button onclick="markQCFailed(\'' + sample.id.replace(/'/g, "\\'") + '\', \'Final Qubit\')" style="background: #dc3545;">QC Failed</button><br>';
                    html += '<div style="color: green; font-weight: bold; text-align: center; margin-top: 4px;">‚úì Complete</div>';
                } else if (sample.status === 'QC Failed') {
                    html += '<div style="color: red; font-weight: bold; text-align: center;">‚úó QC Failed</div>';
                    html += '<button onclick="reprocessSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #28a745; margin-top: 4px;">Re-process</button>';
                } else {
                    html += '<div style="color: green; font-weight: bold; text-align: center;">‚úì Complete</div>';
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            updateSelection();
            updateQuickStats();
            updateDashboard();
        }

        // Initialize on page load
        loadData();
        loadExpansionState(); // Load saved expansion state
        renderSamples();
        switchModule(currentModule);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {

            // Ctrl/Cmd + F - Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
                document.getElementById('searchInput').select();
            }

            // Ctrl/Cmd + E - Export JSON
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }

            // Ctrl/Cmd + Shift + E - Export CSV
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                exportCSV();
            }

            // Ctrl/Cmd + I - Import
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                importData();
            }

            // Ctrl/Cmd + N - Focus new sample input
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('sampleId').focus();
            }

            // Number keys 1-5 for quick filters
            if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                var activeElement = document.activeElement;
                // Only if not typing in input/textarea
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    var filters = document.getElementsByName('statusFilter');
                    if (filters[parseInt(e.key) - 1]) {
                        filters[parseInt(e.key) - 1].checked = true;
                        filterSamples();
                    }
                }
            }

            // Ctrl/Cmd + T - Timeline
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                showTimeline();
            }

            // Ctrl/Cmd + A - Analytics
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                showAnalytics();
            }

            // Ctrl/Cmd + R - Reagent Search
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showReagentSearch();
            }

            // Ctrl/Cmd + P - Plate Map
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                showPlateMap();
            }

            // Ctrl/Cmd + K - Keyboard Shortcuts
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                showKeyboardShortcuts();
            }

            // Ctrl/Cmd + B - Toggle Bulk Input
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleBulkInput();
            }

            // Ctrl/Cmd + D - Toggle Dark Mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }

            // Ctrl/Cmd + M - Toggle Compact View
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                toggleCompactView();
            }

            // Ctrl/Cmd + 1 - Switch to Kanban View
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
                e.preventDefault();
                switchView('kanban');
            }

            // Ctrl/Cmd + 2 - Switch to List View
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
                e.preventDefault();
                switchView('list');
            }

            // Ctrl/Cmd + 3 - Switch to Table View
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
                e.preventDefault();
                switchView('table');
            }

            // Ctrl/Cmd + L - Print Labels
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                showPrintLabels();
            }

            // Ctrl/Cmd + S - Save/Export backup (override browser default)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                exportData();
            }

            // Ctrl/Cmd + G - Go to sample (search focus)
            if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
                document.getElementById('searchInput').select();
            }

            // Escape - Close modals
            if (e.key === 'Escape') {
                closeModal();
                closeBatchModal();
                closeEditModal();
                closeShortcutsModal();
                closePlateMapModal();
                closeTimelineModal();
                closeAnalyticsModal();
                closeQRCodeModal();
                closeReagentSearchModal();
                closeAuditTrailModal();
            }
        });

        // Barcode Scanner Support
        // USB barcode scanners act as keyboards and send Enter at the end
        var barcodeBuffer = '';
        var barcodeTimeout = null;

        document.getElementById('sampleId').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();

                var sampleIdInput = document.getElementById('sampleId');
                var scannedValue = sampleIdInput.value.trim();

                if (scannedValue) {
                    // Show barcode scan feedback
                    sampleIdInput.style.borderColor = '#28a745';
                    sampleIdInput.style.background = '#e6ffe6';
                    sampleIdInput.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';

                    // Flash animation
                    setTimeout(function() {
                        sampleIdInput.style.borderColor = '';
                        sampleIdInput.style.background = '';
                        sampleIdInput.style.boxShadow = '';
                    }, 800);

                    // If initials are filled, auto-add the sample
                    var initialsInput = document.getElementById('initials');
                    if (initialsInput.value.trim()) {
                        // Auto-add after short delay to show the flash
                        setTimeout(function() {
                            addSample(true); // Use Quick Add mode to keep adding
                        }, 200);
                    } else {
                        // Focus initials field
                        initialsInput.focus();
                    }
                }
            }
        });

        // Add visual indicator for barcode scanner mode
        document.getElementById('sampleId').addEventListener('focus', function() {
            this.setAttribute('placeholder', 'Sample ID (or scan barcode)');
        });

        document.getElementById('sampleId').addEventListener('blur', function() {
            this.setAttribute('placeholder', 'Sample ID');
        });

        // Load theme preference on page load (before authentication check)
        loadTheme();

        // Load saved data and render on page load (only if authenticated)
        if (sessionStorage.getItem('bacterialAuthenticated') === 'true') {
            loadData();
            renderSamples();
            switchModule(currentModule);
        }
        console.log('Lab Workflow Tracker loaded successfully!');
        console.log('Keyboard shortcuts: Ctrl+F (search), Ctrl+E (export), Ctrl+N (new sample), Esc (close), 1-5 (filters)');
        console.log('‚úÖ Barcode scanner support enabled - scan barcodes directly into Sample ID field');
        console.log('Lab Workflow Tracker loaded successfully!');
        console.log('Keyboard shortcuts: Ctrl+F (search), Ctrl+E (export), Ctrl+N (new sample), Esc (close), 1-5 (filters)');
        console.log('‚úÖ Barcode scanner support enabled - scan barcodes directly into Sample ID field');
        console.log('üé® Sidebar navigation enabled - toggle with hamburger menu');

        // ========================================
        // REAGENT LOT AUTOCOMPLETE SYSTEM
        // ========================================

        // Store and retrieve recent lot numbers
        function getRecentLots(fieldName) {
            var key = 'recentLots_' + fieldName;
            var stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }

        function addRecentLot(fieldName, lotNumber) {
            if (!lotNumber || lotNumber.trim() === '') return;

            var lots = getRecentLots(fieldName);

            // Remove if already exists (we'll add to front)
            lots = lots.filter(function(lot) { return lot !== lotNumber; });

            // Add to front
            lots.unshift(lotNumber);

            // Keep only last 20
            if (lots.length > 20) {
                lots = lots.slice(0, 20);
            }

            var key = 'recentLots_' + fieldName;
            localStorage.setItem(key, JSON.stringify(lots));
        }

        // Create datalist for autocomplete
        function createLotDatalist(fieldName) {
            var datalistId = 'lotList_' + fieldName;

            // Remove existing datalist if it exists
            var existing = document.getElementById(datalistId);
            if (existing) {
                existing.remove();
            }

            // Create new datalist
            var datalist = document.createElement('datalist');
            datalist.id = datalistId;

            var lots = getRecentLots(fieldName);
            lots.forEach(function(lot) {
                var option = document.createElement('option');
                option.value = lot;
                datalist.appendChild(option);
            });

            document.body.appendChild(datalist);
            return datalistId;
        }

        // Attach autocomplete to lot number inputs
        function setupLotAutocomplete(inputId, fieldName) {
            var input = document.getElementById(inputId);
            if (!input) return;

            var datalistId = createLotDatalist(fieldName);
            input.setAttribute('list', datalistId);

            // Update recent lots when input changes
            input.addEventListener('blur', function() {
                if (this.value && this.value.trim() !== '') {
                    addRecentLot(fieldName, this.value.trim());
                }
            });
        }

        // Initialize autocomplete for all lot number fields
        function initializeLotAutocomplete() {
            // Batch modal lot fields
            setupLotAutocomplete('batchLotNumber', 'batch_lot');

            // Individual modal lot fields (these are dynamically created, so we'll hook into the modal opening)
            // We'll set up a MutationObserver or hook into modal functions
        }

        // Hook into modal opening to setup autocomplete for dynamic fields
        var originalStartBatch = window.startBatchProcess;
        window.startBatchProcess = function() {
            originalStartBatch.apply(this, arguments);
            // After modal opens, setup autocomplete
            setTimeout(function() {
                setupLotAutocomplete('batchLotNumber', 'batch_lot');
            }, 100);
        };

        // Initialize on page load
        initializeLotAutocomplete();
        console.log('‚ú® Reagent lot autocomplete enabled - recently used lots will appear as suggestions');

        // ========================================
        // ENHANCED BULK ACTIONS
        // ========================================

        // Bulk process to next stage
        function bulkProcessNext() {
            if (bulkSelectedSamples.length === 0) {
                alert('Please select samples first');
                return;
            }

            // Group samples by their current status
            var statusGroups = {};
            var selectedSampleObjects = samples.filter(function(s) {
                return bulkSelectedSamples.indexOf(s.id) !== -1;
            });

            selectedSampleObjects.forEach(function(s) {
                if (!statusGroups[s.status]) {
                    statusGroups[s.status] = [];
                }
                statusGroups[s.status].push(s);
            });

            // Check if all samples are at the same stage
            var statuses = Object.keys(statusGroups);
            if (statuses.length > 1) {
                alert('Selected samples are at different stages!\n\nTo process together, samples must be at the same workflow stage.\n\nCurrent stages:\n' +
                    statuses.map(function(s) { return '‚Ä¢ ' + s + ' (' + statusGroups[s].length + ' samples)'; }).join('\n'));
                return;
            }

            var currentStatus = statuses[0];
            var nextAction = getNextAction(currentStatus);

            if (!nextAction) {
                alert('Selected samples are already complete!');
                return;
            }

            // Confirm and launch batch modal
            if (confirm('Process ' + bulkSelectedSamples.length + ' samples from "' + currentStatus + '" to "' + nextAction.nextStage + '"?')) {
                // Set up batch processing
                selectedSamplesForBatch = bulkSelectedSamples.slice(); // Copy array
                startBatchProcess();
            }
        }

        // Helper: Determine next action for a status
        function getNextAction(status) {
            var actions = {
                'Received': {nextStage: 'BAP Complete', action: 'BAP'},
                'BAP Complete': {nextStage: 'TSB Complete', action: 'TSB'},
                'TSB Complete': {nextStage: 'Extraction Complete', action: 'Extraction'},
                'Extraction Complete': {nextStage: 'Clean Extraction Complete', action: 'Clean Extraction'},
                'Clean Extraction Complete': {nextStage: 'Clean Extraction Qubit Complete', action: 'CE Qubit'},
                'Clean Extraction Qubit Complete': {nextStage: 'Indexing Complete', action: 'Indexing'},
                'Indexing Complete': {nextStage: 'Qubit Complete', action: 'Qubit'}
            };
            return actions[status] || null;
        }

        // Bulk export selected samples only
        function bulkExport() {
            if (bulkSelectedSamples.length === 0) {
                alert('Please select samples first');
                return;
            }

            var selectedSampleObjects = samples.filter(function(s) {
                return bulkSelectedSamples.indexOf(s.id) !== -1;
            });

            // Export as CSV
            var csv = 'Sample ID,Status,Date Added,Initials,BAP Number,TSB Number,Extraction Number,Indexing Number\n';

            selectedSampleObjects.forEach(function(sample) {
                csv += sample.id + ',';
                csv += sample.status + ',';
                csv += sample.dateAdded + ',';
                csv += sample.initials + ',';
                csv += (sample.bapNumber || '') + ',';
                csv += (sample.tsbNumber || '') + ',';
                csv += (sample.extractionNumber || '') + ',';
                csv += (sample.indexingNumber || '') + '\n';
            });

            var blob = new Blob([csv], {type: 'text/csv'});
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'selected_samples_' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Exported ' + bulkSelectedSamples.length + ' samples to CSV!');
        }

        console.log('‚ú® Enhanced bulk actions enabled - process multiple samples at once from any view!');

        // ========================================
        // UNDO SYSTEM
        // ========================================

        var undoStack = [];
        var maxUndoSteps = 10;

        // Save current state before making changes
        function saveUndoState(action, data) {
            var state = {
                action: action,
                data: data,
                timestamp: new Date().toISOString(),
                samplesBefore: JSON.parse(JSON.stringify(samples)) // Deep copy
            };

            undoStack.push(state);

            // Keep only last N steps
            if (undoStack.length > maxUndoSteps) {
                undoStack.shift();
            }

            updateUndoButton();
        }

        // Undo last action
        function undoLastAction() {
            if (undoStack.length === 0) {
                alert('Nothing to undo!');
                return;
            }

            var lastState = undoStack.pop();

            // Restore samples to previous state
            samples = lastState.samplesBefore;
            saveData();
            renderSamples();
            updateUndoButton();

            // Show what was undone
            var message = 'Undone: ' + lastState.action;
            if (lastState.data && lastState.data.sampleId) {
                message += ' (Sample: ' + lastState.data.sampleId + ')';
            }

            // Show toast notification
            showToast(message, 'success');
        }

        // Update undo button state
        function updateUndoButton() {
            var btn = document.getElementById('undoButton');
            if (btn) {
                if (undoStack.length > 0) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.title = 'Undo: ' + undoStack[undoStack.length - 1].action;
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'Nothing to undo';
                }
            }
        }

        // Toast notification helper
        function showToast(message, type) {
            var toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: ' +
                (type === 'success' ? '#28a745' : '#dc3545') +
                '; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600; animation: slideIn 0.3s ease;';
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(function() {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(function() {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Wrap existing delete function
        var originalDeleteSample = window.deleteSample;
        if (originalDeleteSample) {
            window.deleteSample = function(sampleId) {
                saveUndoState('Delete sample', {sampleId: sampleId});
                return originalDeleteSample(sampleId);
            };
        }

        // Keyboard shortcut: Ctrl+Z for undo
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoLastAction();
            }
        });

        console.log('‚ú® Undo system enabled - press Ctrl+Z or click Undo button to revert changes!');

        // ========================================
        // STICKY STATS HEADER WITH TOGGLE
        // ========================================

        var statsCompact = false;

        function toggleStatsCompact() {
            var panel = document.getElementById('stickyStatsPanel');
            var quickStats = document.getElementById('quickStats');
            var toggleBtn = document.getElementById('statsToggle');

            statsCompact = !statsCompact;

            if (statsCompact) {
                // Minimize - show only key numbers in one row
                quickStats.style.display = 'none';
                toggleBtn.textContent = 'Expand ‚ñº';
                panel.style.padding = '12px 20px';
            } else {
                // Expand - show full grid
                quickStats.style.display = 'grid';
                toggleBtn.textContent = 'Minimize ‚ñ≤';
                panel.style.padding = '20px';
            }

            // Save preference
            localStorage.setItem('statsCompactMode', statsCompact);
        }

        // Restore compact mode preference on load
        var savedCompactMode = localStorage.getItem('statsCompactMode');
        if (savedCompactMode === 'true') {
            toggleStatsCompact();
        }

        console.log('‚ú® Sticky stats header enabled - stats stay visible when scrolling!');

        // ========================================
        // QUICK ACTIONS & USABILITY FEATURES
        // ========================================

        // Track selected samples for batch operations
        var selectedSamples = [];
        var quickActionsCollapsed = false;

        // Show quick actions toolbar when authenticated
        if (sessionStorage.getItem('bacterialAuthenticated') === 'true') {
            document.getElementById('quickActionsToolbar').style.display = 'flex';
        }

        // Toggle quick actions toolbar
        function toggleQuickActions() {
            quickActionsCollapsed = !quickActionsCollapsed;
            var toolbar = document.getElementById('quickActionsToolbar');
            var content = document.getElementById('quickActionsContent');

            if (quickActionsCollapsed) {
                toolbar.classList.add('collapsed');
                content.style.display = 'none';
            } else {
                toolbar.classList.remove('collapsed');
                content.style.display = 'flex';
            }
        }

        // Quick export selected samples
        function quickExportSelected() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected. Select samples to export.', 'warning');
                return;
            }
            exportSelectedSamples();
        }

        // Quick batch process
        function quickBatchProcess() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected. Select samples to batch process.', 'warning');
                return;
            }
            batchProcessSelected();
        }

        // Quick add sample (focus on input)
        function quickAddSample() {
            scrollToSection('addSamples');
            setTimeout(function() {
                document.getElementById('sampleId').focus();
            }, 300);
        }

        // Update selection tracking
        function updateSelection() {
            selectedSamples = [];
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            checkboxes.forEach(function(checkbox) {
                selectedSamples.push(checkbox.getAttribute('data-sample-id'));
            });

            // Update batch action bar
            var batchBar = document.getElementById('batchActionBar');
            var selectedCount = document.getElementById('selectedCount');

            if (selectedSamples.length > 0) {
                batchBar.classList.add('show');
                selectedCount.textContent = selectedSamples.length;
            } else {
                batchBar.classList.remove('show');
            }

            // Update sample visual styling
            var allSamples = document.querySelectorAll('.sample');
            allSamples.forEach(function(sampleEl) {
                var sampleId = sampleEl.querySelector('.sample-checkbox')?.getAttribute('data-sample-id');
                if (sampleId && selectedSamples.indexOf(sampleId) !== -1) {
                    sampleEl.classList.add('selected');
                } else {
                    sampleEl.classList.remove('selected');
                }
            });
        }

        // Clear all selections
        function clearSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = false;
            });
            selectedSamples = [];
            updateSelection();
            showToast('Selection cleared', 'info');
        }

        // Export only selected samples to CSV
        function exportSelectedSamples() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected', 'warning');
                return;
            }

            // Filter samples by selection
            var samplesToExport = samples.filter(function(s) {
                return selectedSamples.indexOf(s.id) !== -1;
            });

            // Generate CSV
            var csv = 'Sample ID,Date Added,Added By,Status,BAP Lot,TSB Lot,Extraction Lot,Notes\n';

            samplesToExport.forEach(function(sample) {
                var row = [
                    sample.id,
                    sample.dateAdded || '',
                    sample.initials || '',
                    sample.status || '',
                    sample.bapDetails?.lotNumber || '',
                    sample.tsbDetails?.lotNumber || '',
                    sample.extractionDetails?.lotNumber || '',
                    (sample.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
                ];
                csv += row.join(',') + '\n';
            });

            // Download
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'selected_samples_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();

            showToast('‚úÖ Exported ' + samplesToExport.length + ' samples', 'success');
            showAutoSaveIndicator('üì• Exported ' + samplesToExport.length + ' samples', 'success');
        }

        // Batch process selected samples
        function batchProcessSelected() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected', 'warning');
                return;
            }

            // Validate all samples are at same stage
            var samplesToProcess = samples.filter(function(s) {
                return selectedSamples.indexOf(s.id) !== -1;
            });

            var statuses = samplesToProcess.map(function(s) { return s.status; });
            var uniqueStatuses = statuses.filter(function(v, i, a) { return a.indexOf(v) === i; });

            if (uniqueStatuses.length > 1) {
                showToast('‚ö†Ô∏è Selected samples must all be at the same workflow stage', 'error');
                return;
            }

            // Process based on current status
            var status = uniqueStatuses[0];
            showToast('üöÄ Starting batch process for ' + samplesToProcess.length + ' samples at "' + status + '"', 'info');

            // Trigger the existing bulk process functionality
            startBulkProcessing();
        }

        // Batch flag selected samples
        function batchFlag() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected', 'warning');
                return;
            }

            var flag = prompt('Set flag for ' + selectedSamples.length + ' samples:\n\n1 = Rush üî¥\n2 = Hold ‚è∏Ô∏è\n3 = Review ‚ö†Ô∏è\n4 = None\n\nEnter number:');

            if (!flag) return;

            var flagValue = flag === '1' ? 'Rush' : flag === '2' ? 'Hold' : flag === '3' ? 'Review' : 'None';

            selectedSamples.forEach(function(sampleId) {
                var sample = samples.find(function(s) { return s.id === sampleId; });
                if (sample) {
                    sample.flag = flagValue;
                }
            });

            saveData();
            renderSamples();
            showToast('‚úÖ Flagged ' + selectedSamples.length + ' samples as: ' + flagValue, 'success');
        }

        // Batch delete selected samples
        function batchDelete() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected', 'warning');
                return;
            }

            if (!confirm('‚ö†Ô∏è DELETE ' + selectedSamples.length + ' SAMPLES?\n\nThis cannot be undone!')) {
                return;
            }

            if (!confirm('Are you ABSOLUTELY SURE? This will permanently delete ' + selectedSamples.length + ' samples!')) {
                return;
            }

            var deletedCount = 0;
            selectedSamples.forEach(function(sampleId) {
                var index = samples.findIndex(function(s) { return s.id === sampleId; });
                if (index !== -1) {
                    samples.splice(index, 1);
                    deletedCount++;
                }
            });

            selectedSamples = [];
            saveData();
            renderSamples();
            updateSelection();
            showToast('üóëÔ∏è Deleted ' + deletedCount + ' samples', 'success');
        }

        // Auto-save indicator
        function showAutoSaveIndicator(message, type) {
            var indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = message || 'üíæ Saved';

            // Reset classes
            indicator.className = '';

            // Add type class
            if (type === 'saving') {
                indicator.classList.add('saving');
            } else if (type === 'error') {
                indicator.classList.add('error');
            }

            // Show indicator
            indicator.classList.add('show');

            // Hide after 2 seconds
            setTimeout(function() {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Enhance the existing saveData function to show indicator
        var originalSaveData = saveData;
        saveData = function() {
            try {
                originalSaveData();
                showAutoSaveIndicator('üíæ Auto-saved', 'success');
            } catch (err) {
                showAutoSaveIndicator('‚ùå Save failed', 'error');
                console.error('Save error:', err);
            }
        };

        // Sample validation before processing
        function validateSampleProcessing(sampleId, processType) {
            var sample = samples.find(function(s) { return s.id === sampleId; });
            if (!sample) {
                showToast('‚ùå Sample not found', 'error');
                return false;
            }

            var warnings = [];

            // Validate based on process type
            if (processType === 'BAP') {
                if (!sample.initials) {
                    warnings.push('Missing technician initials');
                }
            }

            if (processType === 'TSB') {
                if (!sample.bapDetails || !sample.bapDetails.completionDate) {
                    warnings.push('BAP processing not complete');
                    return false;
                }
            }

            if (processType === 'Extraction') {
                if (!sample.tsbDetails || !sample.tsbDetails.completionDate) {
                    warnings.push('TSB processing not complete');
                    return false;
                }
            }

            // Show warnings if any
            if (warnings.length > 0) {
                var msg = '‚ö†Ô∏è Validation warnings for ' + sampleId + ':\n\n' + warnings.join('\n') + '\n\nContinue anyway?';
                return confirm(msg);
            }

            return true;
        }

        // Add validation warnings to process modals
        function showProcessValidationWarnings(sampleId) {
            var sample = samples.find(function(s) { return s.id === sampleId; });
            if (!sample) return '';

            var warnings = [];

            // Check for missing critical data
            if (!sample.initials) {
                warnings.push('Missing technician initials');
            }

            if (sample.flag === 'Hold') {
                warnings.push('Sample is on HOLD');
            }

            if (warnings.length === 0) return '';

            var html = '<div class="validation-warning">';
            html += warnings.join('<br>');
            html += '</div>';

            return html;
        }

        // Toast notification system (lightweight)
        function showToast(message, type) {
            // Reuse auto-save indicator for toast messages
            showAutoSaveIndicator(message, type);
        }

        console.log('‚úÖ Quick Actions & Usability Features loaded!');
        console.log('üìã Features: Export Selected, Batch Process, Auto-save, Validation, Mobile Responsive');

        // ========================================
        // CONTINUE TO NEXT STAGE FEATURE
        // ========================================

        /**
         * One-click advancement to next workflow stage
         * Opens the appropriate modal with minimal user input required
         */
        function continueToNextStage(sampleId) {
            var sample = samples.find(function(s) { return s.id === sampleId; });
            if (!sample) {
                showToast('‚ùå Sample not found', 'error');
                return;
            }

            // Map current status to next action
            var nextActions = {
                'BAP Complete': {
                    action: 'TSB',
                    message: 'Continue to TSB?',
                    icon: 'üß™'
                },
                'TSB Complete': {
                    action: 'Extraction',
                    message: 'Continue to Extraction?',
                    icon: 'üî¨'
                },
                'Extraction Complete': {
                    action: 'Clean Extraction',
                    message: 'Continue to Clean Extraction?',
                    icon: '‚ú®'
                },
                'Clean Extraction Complete': {
                    action: 'Clean Extraction Qubit',
                    message: 'Continue to Qubit?',
                    icon: 'üìä'
                },
                'Clean Extraction Qubit Complete': {
                    action: 'Indexing',
                    message: 'Continue to Indexing?',
                    icon: 'üè∑Ô∏è'
                },
                'Indexing Complete': {
                    action: 'Final Qubit',
                    message: 'Continue to Final Qubit?',
                    icon: '‚úÖ'
                }
            };

            var next = nextActions[sample.status];

            if (!next) {
                showToast('‚ö†Ô∏è No next stage available for this sample', 'warning');
                return;
            }

            // Show confirmation with icon
            if (confirm(next.icon + ' ' + next.message + '\n\nSample: ' + sampleId + '\nCurrent: ' + sample.status + '\nNext: ' + next.action)) {
                // Call the appropriate start process function
                startProcess(sampleId, next.action);
                showToast('üöÄ Continuing to ' + next.action + '...', 'info');
            }
        }

        /**
         * Batch continue - advance multiple samples to their next stages
         */
        function batchContinueToNextStage() {
            if (selectedSamples.length === 0) {
                showToast('‚ö†Ô∏è No samples selected', 'warning');
                return;
            }

            // Get selected samples
            var samplesToAdvance = samples.filter(function(s) {
                return selectedSamples.indexOf(s.id) !== -1;
            });

            // Check if all samples can advance
            var canAdvance = samplesToAdvance.filter(function(s) {
                return s.status === 'BAP Complete' ||
                       s.status === 'TSB Complete' ||
                       s.status === 'Extraction Complete' ||
                       s.status === 'Clean Extraction Complete' ||
                       s.status === 'Clean Extraction Qubit Complete' ||
                       s.status === 'Indexing Complete';
            });

            if (canAdvance.length === 0) {
                showToast('‚ö†Ô∏è No selected samples can be advanced', 'warning');
                return;
            }

            if (canAdvance.length !== samplesToAdvance.length) {
                var msg = '‚ö†Ô∏è Only ' + canAdvance.length + ' of ' + samplesToAdvance.length + ' selected samples can be advanced.\n\nContinue with those ' + canAdvance.length + ' samples?';
                if (!confirm(msg)) {
                    return;
                }
            }

            // Confirm batch continue
            if (!confirm('üöÄ Continue ' + canAdvance.length + ' samples to their next stages?')) {
                return;
            }

            // Advance each sample
            var advanced = 0;
            canAdvance.forEach(function(sample) {
                // Determine next action without showing modal
                var nextActions = {
                    'BAP Complete': 'TSB',
                    'TSB Complete': 'Extraction',
                    'Extraction Complete': 'Clean Extraction',
                    'Clean Extraction Complete': 'Clean Extraction Qubit',
                    'Clean Extraction Qubit Complete': 'Indexing',
                    'Indexing Complete': 'Final Qubit'
                };

                var nextAction = nextActions[sample.status];
                if (nextAction) {
                    // This will open the modal for the first sample
                    // For true batch processing, would need to call openBatchModal
                    startProcess(sample.id, nextAction);
                    advanced++;
                }
            });

            if (advanced > 0) {
                showToast('‚úÖ Advanced ' + advanced + ' samples', 'success');
            }
        }

        console.log('‚úÖ Continue to Next Stage feature loaded!');
        console.log('‚è≠Ô∏è Feature: One-click stage advancement with "Continue ‚Üí" button');

        // ========================================
        // WORK QUEUE DASHBOARD - "WHAT TO WORK ON NOW"
        // ========================================

        /**
         * Analyzes all samples and shows actionable items
         * Updates automatically when samples change
         */
        function updateWorkQueue() {
            var queue = [];

            // 1. URGENT: Rush samples
            var rushSamples = samples.filter(function(s) {
                return s.flag === 'Rush' && s.status !== 'Qubit Complete';
            });
            if (rushSamples.length > 0) {
                queue.push({
                    type: 'urgent',
                    icon: 'üî¥',
                    count: rushSamples.length,
                    label: 'Rush Samples Need Attention',
                    action: 'Click to view rush samples',
                    filter: function() { filterByFlag('Rush'); }
                });
            }

            // 2. READY: BAP incubations complete (ready for TSB)
            var bapReady = samples.filter(function(s) {
                return s.status === 'BAP Complete';
            });
            if (bapReady.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: 'üß™',
                    count: bapReady.length,
                    label: 'Ready for TSB Processing',
                    action: 'Click to start TSB',
                    filter: function() {
                        var radios = document.getElementsByName('statusFilter');
                        for (var i = 0; i < radios.length; i++) {
                            if (radios[i].value === 'BAP Complete') {
                                radios[i].checked = true;
                                filterSamples();
                                break;
                            }
                        }
                        scrollToSection('samples');
                    }
                });
            }

            // 3. READY: TSB incubations complete (ready for Extraction)
            var tsbReady = samples.filter(function(s) {
                return s.status === 'TSB Complete';
            });
            if (tsbReady.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: 'üî¨',
                    count: tsbReady.length,
                    label: 'Ready for Extraction',
                    action: 'Click to start extraction',
                    filter: function() {
                        var radios = document.getElementsByName('statusFilter');
                        for (var i = 0; i < radios.length; i++) {
                            if (radios[i].value === 'TSB Complete') {
                                radios[i].checked = true;
                                filterSamples();
                                break;
                            }
                        }
                        scrollToSection('samples');
                    }
                });
            }

            // 4. READY: Extraction complete (ready for Clean Extraction)
            var extractionReady = samples.filter(function(s) {
                return s.status === 'Extraction Complete';
            });
            if (extractionReady.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: '‚ú®',
                    count: extractionReady.length,
                    label: 'Ready for Clean Extraction',
                    action: 'Click to start',
                    filter: function() {
                        var radios = document.getElementsByName('statusFilter');
                        for (var i = 0; i < radios.length; i++) {
                            if (radios[i].value === 'Extraction Complete') {
                                radios[i].checked = true;
                                filterSamples();
                                break;
                            }
                        }
                        scrollToSection('samples');
                    }
                });
            }

            // 5. READY: Clean Extraction Qubit Complete (ready for Indexing)
            var qubitReady = samples.filter(function(s) {
                return s.status === 'Clean Extraction Qubit Complete';
            });
            if (qubitReady.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: 'üè∑Ô∏è',
                    count: qubitReady.length,
                    label: 'Ready for Indexing',
                    action: 'Click to start indexing',
                    filter: function() {
                        var radios = document.getElementsByName('statusFilter');
                        for (var i = 0; i < radios.length; i++) {
                            if (radios[i].value === 'Clean Extraction Qubit Complete') {
                                radios[i].checked = true;
                                filterSamples();
                                break;
                            }
                        }
                        scrollToSection('samples');
                    }
                });
            }

            // 6. READY: Indexing Complete (ready for Final Qubit)
            var indexingReady = samples.filter(function(s) {
                return s.status === 'Indexing Complete';
            });
            if (indexingReady.length > 0) {
                queue.push({
                    type: 'ready',
                    icon: '‚úÖ',
                    count: indexingReady.length,
                    label: 'Ready for Final Qubit',
                    action: 'Click to complete',
                    filter: function() {
                        var radios = document.getElementsByName('statusFilter');
                        for (var i = 0; i < radios.length; i++) {
                            if (radios[i].value === 'Indexing Complete') {
                                radios[i].checked = true;
                                filterSamples();
                                break;
                            }
                        }
                        scrollToSection('samples');
                    }
                });
            }

            // 7. WAITING: Samples on Hold
            var onHold = samples.filter(function(s) {
                return s.flag === 'Hold';
            });
            if (onHold.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: '‚è∏Ô∏è',
                    count: onHold.length,
                    label: 'Samples on Hold',
                    action: 'Click to review',
                    filter: function() { filterByFlag('Hold'); }
                });
            }

            // 8. WAITING: Samples pending review
            var needsReview = samples.filter(function(s) {
                return s.flag === 'Review';
            });
            if (needsReview.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: '‚ö†Ô∏è',
                    count: needsReview.length,
                    label: 'Samples Need Review',
                    action: 'Click to review',
                    filter: function() { filterByFlag('Review'); }
                });
            }

            // 9. IN PROGRESS: Currently incubating
            var incubating = samples.filter(function(s) {
                return s.status === 'BAP In Progress' || s.status === 'TSB In Progress';
            });
            if (incubating.length > 0) {
                queue.push({
                    type: 'waiting',
                    icon: '‚è±Ô∏è',
                    count: incubating.length,
                    label: 'Currently Incubating',
                    action: 'Click to view',
                    filter: function() {
                        // Filter to show in-progress samples
                        var radios = document.getElementsByName('statusFilter');
                        radios[0].checked = true; // Show all
                        filterSamples();
                        scrollToSection('samples');
                    }
                });
            }

            // Render the work queue
            var container = document.getElementById('workQueue');
            var noWorkMsg = document.getElementById('noWorkMessage');

            if (queue.length === 0) {
                container.style.display = 'none';
                noWorkMsg.style.display = 'block';
            } else {
                container.style.display = 'grid';
                noWorkMsg.style.display = 'none';

                var html = '';
                queue.forEach(function(item) {
                    html += '<div class="work-queue-card ' + item.type + '" onclick="(' + item.filter.toString() + ')()">';
                    html += '<div class="work-queue-number">' + item.icon + ' ' + item.count + '</div>';
                    html += '<div class="work-queue-label">' + item.label + '</div>';
                    html += '<div class="work-queue-action">' + item.action + '</div>';
                    html += '</div>';
                });

                container.innerHTML = html;
            }
        }

        // Refresh work queue manually
        function refreshWorkQueue() {
            updateWorkQueue();
            showToast('üîÑ Work queue refreshed', 'success');
        }

        // Update work queue whenever samples change
        var originalRenderSamples = renderSamples;
        renderSamples = function() {
            originalRenderSamples();
            updateWorkQueue();
        };

        // Initial load
        if (sessionStorage.getItem('bacterialAuthenticated') === 'true') {
            updateWorkQueue();
        }

        console.log('‚úÖ Work Queue Dashboard loaded!');
        console.log('üéØ Feature: "What to Work On Now" - shows actionable items at a glance');

    </script>

        </div> <!-- Close sequencingUI div -->
        </div> <!-- Close main-content div -->
    </div> <!-- Close appContent div -->

    <!-- Quick Actions Floating Toolbar -->
    <div id="quickActionsToolbar" style="display: none;">
        <button class="toggle-btn" onclick="toggleQuickActions()" title="Toggle Quick Actions">‚ö°</button>
        <div id="quickActionsContent">
            <button onclick="quickExportSelected()" title="Export selected samples">üì• Export</button>
            <button onclick="quickBatchProcess()" title="Batch process selected">‚öôÔ∏è Process</button>
            <button onclick="quickAddSample()" title="Quick add sample">‚ûï Add</button>
            <button onclick="scrollToSection('samples')" title="Go to samples">üß¨ Samples</button>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator">üíæ Saved</div>

    <!-- Batch Action Bar (shows when samples selected) -->
    <div id="batchActionBar">
        <div>
            <strong><span id="selectedCount">0</span> samples selected</strong>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="batchContinueToNextStage()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-weight: 700;">‚è≠Ô∏è Continue All</button>
            <button onclick="exportSelectedSamples()">üì• Export Selected</button>
            <button onclick="batchProcessSelected()">‚öôÔ∏è Batch Process</button>
            <button onclick="batchFlag()">üö© Flag</button>
            <button onclick="batchDelete()">üóëÔ∏è Delete</button>
            <button onclick="clearSelection()">‚úï Clear</button>
        </div>
    </div>

</body>
</html>
